<!-- Ongoing Test Alert Component -->
{% if ongoing_test %}
<div class="bg-indigo-50 dark:bg-indigo-900/20 border border-indigo-200 dark:border-indigo-800 rounded-xl p-4 mb-6">
    <div class="flex items-center">
        <div class="flex-shrink-0">
            <svg class="h-5 w-5 text-indigo-400" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
            </svg>
        </div>
        <div class="ml-3 flex-1">
            <h3 class="text-sm font-medium text-indigo-800 dark:text-indigo-200">
                ⏱️ Ujian Sedang Berlangsung
            </h3>
            <div class="mt-1 text-sm text-indigo-700 dark:text-indigo-300">
                {% if ongoing_test.tryout_package %}
                    <p>Anda memiliki ujian paket <strong>"{{ ongoing_test.tryout_package.package_name }}"</strong> yang sedang berlangsung.</p>
                {% elif ongoing_test.categories.exists %}
                    <p>Anda memiliki ujian <strong>"{{ ongoing_test.categories.first.category_name }}"</strong> yang sedang berlangsung.</p>
                {% else %}
                    <p>Anda memiliki ujian yang sedang berlangsung.</p>
                {% endif %}
                <p class="mt-1">
                    {% if ongoing_test.tryout_package %}
                        <strong>Jenis:</strong> Ujian Paket Tryout
                        <br>
                        <strong>Subtest:</strong> 
                        {% for category in ongoing_test.tryout_package.tryoutpackagecategory_set.all %}
                            {{ category.category.category_name }}{% if not forloop.last %}, {% endif %}
                        {% endfor %}
                    {% elif ongoing_test.categories.exists %}
                        <strong>Subtest:</strong> {{ ongoing_test.categories.first.category_name }}
                    {% endif %}
                    {% if ongoing_test.start_time %}
                        <br>
                        <strong>Dimulai:</strong> {{ ongoing_test.start_time|date:"d M Y H:i" }}
                        <br>
                        <strong>Sisa Waktu:</strong> <span class="font-mono" id="remaining-time-{{ ongoing_test.id }}">{{ ongoing_test.get_remaining_time }} detik</span>
                    {% endif %}
                </p>
            </div>
            <div class="mt-3">
                {% if ongoing_test.tryout_package %}
                    <!-- This is a package test -->
                    <a href="{% url 'take_package_test_question' ongoing_test.tryout_package.id ongoing_test.get_current_question_index %}" class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Lanjutkan Ujian
                    </a>
                {% elif ongoing_test.categories.exists %}
                    <!-- This is a category test -->
                    <a href="{% url 'take_test' ongoing_test.categories.first.id ongoing_test.get_current_question_index %}" class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Lanjutkan Ujian
                    </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Real-time countdown script -->
{% if ongoing_test.start_time %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const timeElement = document.getElementById('remaining-time-{{ ongoing_test.id }}');
    
    if (timeElement) {
        let remainingSeconds = {{ ongoing_test.get_remaining_time }};
        
        function updateTimer() {
            if (remainingSeconds <= 0) {
                timeElement.textContent = '0 detik (Waktu Habis!)';
                timeElement.classList.add('text-red-600', 'font-bold');
                // Redirect or auto-submit if needed
                setTimeout(function() {
                    window.location.reload();
                }, 2000);
                return;
            }
            
            const hours = Math.floor(remainingSeconds / 3600);
            const minutes = Math.floor((remainingSeconds % 3600) / 60);
            const seconds = remainingSeconds % 60;
            
            let timeString = '';
            if (hours > 0) {
                timeString = `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            } else {
                timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
            
            timeElement.textContent = timeString;
            
            // Change color when time is running low
            if (remainingSeconds <= 300) { // 5 minutes
                timeElement.classList.add('text-red-600');
            } else if (remainingSeconds <= 600) { // 10 minutes
                timeElement.classList.add('text-yellow-600');
            }
            
            remainingSeconds--;
        }
        
        // Update immediately and then every second
        updateTimer();
        setInterval(updateTimer, 1000);
    }
});
</script>
{% endif %}
{% endif %}
