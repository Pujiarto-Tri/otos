{% extends 'base.html' %}

{% block title %}{% if question %}Edit Question{% else %}Create Question{% endif %}{% endblock %}

{% block extrahead %}
  <!-- Quill.js Rich Text Editor (styling parity with admin) -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
  {% include 'includes/_quill_toolbar_css.html' %}
{% endblock %}

{% block content %}
<section class="bg-gray-50 dark:bg-gray-900 p-3 sm:p-5 antialiased question-form-section">
  <div class="mx-auto max-w-screen-xl px-4 lg:px-12">
    <div class="bg-white dark:bg-gray-800 relative shadow-md sm:rounded-lg overflow-hidden question-form-card">
      <div class="p-6">
        <div class="max-w-3xl mx-auto">
          <h1 class="text-xl font-bold mb-4 text-gray-900 dark:text-white">{% if question %}Edit Question{% else %}Create Question{% endif %}</h1>
          <form method="post" id="questionForm">
            {% csrf_token %}
            <div class="space-y-4">
              {{ form.non_field_errors }}
              <div>
                <label class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300">Question Text</label>
                {{ form.question_text }}
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300">Category</label>
                  {{ form.category }}
                </div>
                <div>
                  <label class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300">Custom Weight</label>
                  {{ form.custom_weight }}
                </div>
              </div>

              <div class="mt-4">
                <h3 class="text-sm font-medium text-gray-900 dark:text-white mb-2">Choices</h3>
                {{ formset.management_form }}
                {% if formset.non_form_errors %}
                  <div class="text-sm text-red-600">{{ formset.non_form_errors }}</div>
                {% endif %}

                <div id="choicesContainer" class="space-y-2">
                  {% for f in formset %}
                    <div class="choice-form p-2 border rounded bg-gray-50 dark:bg-gray-700 flex items-center gap-4" data-index="{{ forloop.counter0 }}">
                      {% for hidden in f.hidden_fields %}{{ hidden }}{% endfor %}
                      <div class="flex-1 w-full">
                        {{ f.choice_text }}
                        {% if f.choice_text.errors %}
                          <p class="text-sm text-red-600 mt-1">{{ f.choice_text.errors|striptags }}</p>
                        {% endif %}
                      </div>
                      <div class="flex items-center whitespace-nowrap">
                        <label class="inline-flex items-center">
                          {{ f.is_correct }}
                          <span class="ml-2 text-sm text-gray-900 dark:text-white">Correct Answer</span>
                        </label>
                      </div>
                    </div>
                  {% endfor %}
                </div>
              </div>

              <div class="flex items-center space-x-2 mt-6">
                <button id="questionSaveBtn" type="submit" class="px-4 py-2 bg-primary-600 text-white rounded">Save</button>
                <a href="{% url 'teacher_question_list' category.id %}" class="text-sm text-gray-600">Cancel</a>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock %}
{% block extra_js %}
  {% include 'includes/_quill_init.html' %}

  <script>
    // Fallback: if some JS prevented normal submit, force submit on click
    document.addEventListener('DOMContentLoaded', function(){
      var btn = document.getElementById('questionSaveBtn');
      var form = document.getElementById('questionForm');
      if(btn && form){
        btn.addEventListener('click', function(e){
          setTimeout(function(){
            if(!form.dataset.submitted){
              try{ form.submit(); } catch(err){ console.error(err); }
            }
          }, 10);
        });

        // Mark as submitted when native submit occurs
        form.addEventListener('submit', function(){ form.dataset.submitted = '1'; });
      }
    });
  </script>
{% endblock %}
