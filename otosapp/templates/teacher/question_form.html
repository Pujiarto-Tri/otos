{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}{% if question %}Edit Question{% else %}Create Question{% endif %}{% endblock %}

{% block extrahead %}
    <!-- Quill.js Rich Text Editor -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS_HTML"></script>
    <script src="https://unpkg.com/flowbite@1.7.0/dist/flowbite.min.js"></script>
  {% include 'includes/_quill_toolbar_css.html' %}
    <style>
      .section-fade-in { animation: fadeIn 0.25s ease-in-out; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }
    </style>
{% endblock %}

{% block content %}
<section class="bg-gray-50 dark:bg-gray-900 p-3 sm:p-5 antialiased">
  <div class="mx-auto max-w-screen-xl px-4 lg:px-12">
    {% with header_title=page_title|default:"Question Form" header_subtitle=page_subtitle show_back_button=True header_icon='<svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>' %}
      {% include 'admin/manage_questions/includes/question_header.html' %}
    {% endwith %}
    <div class="bg-white dark:bg-gray-800 relative shadow-md sm:rounded-lg overflow-hidden">
      <div class="p-6">
        <div class="max-w-4xl mx-auto">
          {% if form.errors %}
            <div class="mb-6 bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg dark:bg-red-900/20 dark:border-red-800 dark:text-red-400">
              <div class="flex">
                <div class="flex-shrink-0">
                  <svg class="h-5 w-5 text-red-400" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                  </svg>
                </div>
                <div class="ml-3">
                  <h3 class="text-sm font-medium">Please fix the following errors:</h3>
                  <div class="mt-2 text-sm">
                    <ul class="list-disc pl-5 space-y-1">
                      {% for field, errors in form.errors.items %}
                        {% for error in errors %}
                          <li>{{ field|capfirst }}: {{ error }}</li>
                        {% endfor %}
                      {% endfor %}
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          {% endif %}

          <form method="post" class="space-y-6">
            {% csrf_token %}

            <!-- Question Content -->
            <div class="bg-white dark:bg-gray-800 shadow-sm rounded-lg border border-gray-200 dark:border-gray-700">
              <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white">Question Content</h3>
                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                  {% if question %}Update your question content using the rich text editor{% else %}Enter your question content using the rich text editor{% endif %}
                </p>
              </div>
              <div class="px-6 py-4">
                <div class ="mb-4 p-4 border border-gray-200 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700">
                  <label for="id_question_text" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Question Text <span class="text-red-500">*</span>
                  </label>
                {{ form.question_text }}
                  {% if form.question_text.errors %}
                    {% for error in form.question_text.errors %}
                      <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ error }}</p>
                    {% endfor %}
                  {% endif %}
                </div>
              </div>
            </div>

            <!-- Weight and Category -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <!-- Weight Configuration -->
              <div class="bg-white dark:bg-gray-800 shadow-sm rounded-lg border border-gray-200 dark:border-gray-700">
                <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                  <h3 class="text-lg font-medium text-gray-900 dark:text-white">Weight Configuration</h3>
                </div>
                <div class="px-6 py-4">
                  <label for="id_custom_weight" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Custom Weight (Optional)</label>
                  {{ form.custom_weight }}
                  {% if form.custom_weight.help_text %}
                    <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">{{ form.custom_weight.help_text }}</p>
                  {% endif %}
                  {% if form.custom_weight.errors %}
                    {% for error in form.custom_weight.errors %}
                      <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ error }}</p>
                    {% endfor %}
                  {% endif %}
                </div>
              </div>

              <!-- Category (teachers can change) -->
              <div class="bg-white dark:bg-gray-800 shadow-sm rounded-lg border border-gray-200 dark:border-gray-700">
                <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                  <h3 class="text-lg font-medium text-gray-900 dark:text-white">Category</h3>
                </div>
                <div class="px-6 py-4">
                  <label for="id_category" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Question Category <span class="text-red-500">*</span></label>
                  {{ form.category }}
                  {% if form.category.errors %}
                    {% for error in form.category.errors %}
                      <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ error }}</p>
                    {% endfor %}
                  {% endif %}
                </div>
              </div>
            </div>

            <!-- Question Type as cards -->
            <div class="bg-white dark:bg-gray-800 shadow-sm rounded-lg border border-gray-200 dark:border-gray-700">
              <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white">Question Type</h3>
              </div>
              <div class="px-6 py-4">
                <fieldset>
                  <legend class="sr-only">Question Type</legend>
                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-4" id="questionTypeCards">
                    {% for choice in form.question_type %}
                      <label for="{{ choice.id_for_label }}" class="question-type-card group block border rounded-lg p-4 cursor-pointer transition-all duration-150 border-gray-200 dark:border-gray-700 hover:border-primary-400 dark:hover:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500 dark:focus:ring-primary-400">
                        <div class="flex items-start">
                          <div class="mt-1">{{ choice.tag|safe }}</div>
                          <div class="ml-3">
                            <div class="js-type-title text-sm font-medium text-gray-900 dark:text-white">{{ choice.choice_label }}</div>
                            <div class="mt-1 text-xs text-gray-600 dark:text-gray-400 js-type-desc">Pilih tipe pertanyaan yang sesuai.</div>
                          </div>
                        </div>
                      </label>
                    {% endfor %}
                  </div>
                </fieldset>
                {% if form.question_type.help_text %}
                  <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">{{ form.question_type.help_text }}</p>
                {% endif %}
              </div>
            </div>

            <!-- Multiple Choice Options -->
            <div id="choicesSection" class="bg-white dark:bg-gray-800 shadow-sm rounded-lg border border-gray-200 dark:border-gray-700" style="display: none;">
              <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <div class="flex items-center justify-between">
                  <div>
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white">Answer Choices</h3>
                    <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">{% if question %}Update multiple choice options for this question{% else %}Add multiple choice options for this question{% endif %}</p>
                  </div>
                </div>
              </div>
              <div class="px-6 py-6">
                {{ formset.management_form }}
                <div id="choice-forms" class="space-y-4">
                  {% for form in formset %}
                    <div class="choice-item relative group border-2 border-gray-200 dark:border-gray-600 rounded-xl overflow-hidden transition-all duration-200 hover:border-primary-300 dark:hover:border-primary-500 {% if form.is_correct.value %}correct-answer{% endif %}" data-choice="{{ forloop.counter }}">
                      {% for hidden in form.hidden_fields %}{{ hidden }}{% endfor %}
                      <div class="choice-header flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-700/50 border-b border-gray-200 dark:border-gray-600">
                        <div class="flex items-center space-x-3">
                          <div class="choice-badge flex items-center justify-center w-10 h-10 rounded-full font-bold text-lg {% if form.is_correct.value %}bg-green-600 text-white dark:bg-emerald-600 dark:text-emerald-50{% else %}bg-primary-100 text-primary-700 dark:bg-primary-900 dark:text-primary-300{% endif %}">
                            {% if forloop.counter == 1 %}A{% elif forloop.counter == 2 %}B{% elif forloop.counter == 3 %}C{% elif forloop.counter == 4 %}D{% elif forloop.counter == 5 %}E{% endif %}
                          </div>
                          <div>
                            <h4 class="text-lg font-semibold {% if form.is_correct.value %}text-white font-bold dark:text-emerald-50{% else %}text-gray-900 dark:text-white{% endif %}">Choice {% if forloop.counter == 1 %}A{% elif forloop.counter == 2 %}B{% elif forloop.counter == 3 %}C{% elif forloop.counter == 4 %}D{% elif forloop.counter == 5 %}E{% endif %}</h4>
                            <p class="choice-status text-sm {% if form.is_correct.value %}text-white font-medium dark:text-emerald-50{% else %}text-gray-500 dark:text-gray-400{% endif %}">{% if form.is_correct.value %}âœ“ Correct Answer{% else %}Option{% endif %}</p>
                          </div>
                        </div>
                        <div class="flex items-center space-x-3">
                          <label class="relative inline-flex items-center cursor-pointer">
                            {{ form.is_correct }}
                            <span class="ml-3 text-sm font-medium {% if form.is_correct.value %}text-white{% else %}text-gray-700 dark:text-gray-300{% endif %}">Mark as correct</span>
                          </label>
                        </div>
                      </div>
                      <div class="p-4">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                          <div class="lg:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Choice Text <span class="text-red-500">*</span></label>
                            {{ form.choice_text }}
                          </div>
                          <div class="lg:col-span-1">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Choice Image</label>
                            <div class="relative border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-4 text-center hover:border-primary-400 dark:hover:border-primary-500 transition-colors duration-200">
                              <!-- Preview -->
                              <div id="choice-image-preview-{{ forloop.counter }}" class="hidden">
                                <div class="relative inline-block">
                                  <img class="w-full h-24 object-cover rounded-lg border border-gray-200 dark:border-gray-600 shadow-sm cursor-pointer hover:opacity-80 transition-opacity" onclick="openImageModal(this.src, 'Choice {% if forloop.counter == 1 %}A{% elif forloop.counter == 2 %}B{% elif forloop.counter == 3 %}C{% elif forloop.counter == 4 %}D{% elif forloop.counter == 5 %}E{% endif %}')">
                                  <button type="button" onclick="removeChoiceImage({{ forloop.counter }}); event.stopPropagation(); return false;" class="absolute -top-2 -right-2 bg-red-500 hover:bg-red-600 text-white rounded-full p-2 shadow-lg transition-colors duration-200 z-20 border-2 border-white">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                  </button>
                                </div>
                              </div>
                              <!-- Upload Prompt -->
                              <div id="choice-upload-area-{{ forloop.counter }}">
                                <svg class="mx-auto h-8 w-8 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Click to upload</p>
                              </div>
                              <input type="file" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="uploadChoiceImage(this, {{ forloop.counter }})">
                              <p id="choice-image-status-{{ forloop.counter }}" class="mt-1 text-xs"></p>
                              <div class="hidden">{{ form.choice_image }}</div>
                              <input type="hidden" id="choice-image-url-{{ forloop.counter }}" name="choice_image_{{ forloop.counter }}" value="{{ initial_choice_images|get_choice_image:forloop.counter }}">
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  {% endfor %}
                </div>
              </div>
            </div>

            <!-- Essay Answer -->
            <div id="essayAnswerSection" class="bg-white dark:bg-gray-800 shadow-sm rounded-lg border border-gray-200 dark:border-gray-700" style="display: none;">
              <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white">Expected Answer</h3>
                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Provide the expected answer or key points for this essay question</p>
              </div>
              <div class="px-6 py-4">
                <label for="id_correct_answer_text" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Expected Answer</label>
                {{ form.correct_answer_text }}
                </div>
              </div>

            <!-- Explanation (optional) -->
            <div class="bg-white dark:bg-gray-800 shadow-sm rounded-lg border border-gray-200 dark:border-gray-700">
              <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white">Pembahasan Jawaban (Opsional)</h3>
                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Tambahkan penjelasan mengapa jawabannya seperti itu. Kosongkan jika tidak diperlukan.</p>
              </div>
              <div class="px-6 py-4">
                <div class ="mb-4 p-4 border border-gray-200 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700">
                  <label for="id_explanation" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Pembahasan</label>
                  {{ form.explanation }}
                </div>
              </div>
            </div>

            <!-- Submit -->
            <div class="flex justify-end space-x-3 pt-6 border-t border-gray-200 dark:border-gray-700">
              <a href="{% url 'teacher_question_list' category.id %}" class="bg-white dark:bg-gray-800 py-2 px-4 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">Cancel</a>
              <button type="submit" class="bg-primary-600 py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors duration-200">{% if question %}Update Question{% else %}Create Question{% endif %}</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const questionTextarea = document.querySelector('#id_question_text');
  const explanationTextarea = document.querySelector('#id_explanation');
  let quillEditor = null;
  let quillExplanation = null;

  if (questionTextarea) {
    const editorContainer = document.createElement('div');
    editorContainer.id = 'quill-editor';
    editorContainer.className = 'qf-editor-container rounded-lg shadow-sm';
    questionTextarea.parentNode.insertBefore(editorContainer, questionTextarea);
    try {
      quillEditor = new Quill('#quill-editor', { theme: 'snow', modules: { toolbar: [['bold','italic','underline'], ['link','blockquote'], [{ list: 'ordered' }, { list: 'bullet' }], [{ indent: '-1' }, { indent: '+1' }], ['image'], ['clean']] }, placeholder: 'Type your question here...' });
      if (questionTextarea.value) quillEditor.root.innerHTML = questionTextarea.value;
      quillEditor.on('text-change', function(){ questionTextarea.value = quillEditor.root.innerHTML; });
      questionTextarea.style.display = 'none';
    } catch(e) { questionTextarea.style.display = 'block'; }
  }

  if (explanationTextarea) {
    const explanationContainer = document.createElement('div');
    explanationContainer.id = 'quill-explanation';
    explanationContainer.className = 'qf-editor-container rounded-lg shadow-sm';
    explanationTextarea.parentNode.insertBefore(explanationContainer, explanationTextarea);
    try {
      quillExplanation = new Quill('#quill-explanation', { theme: 'snow', modules: { toolbar: [['bold','italic','underline'], ['link','blockquote'], [{ list: 'ordered' }, { list: 'bullet' }], [{ indent: '-1' }, { indent: '+1' }], ['image'], ['clean']] }, placeholder: 'Tulis pembahasan (opsional)...' });
      if (explanationTextarea.value) quillExplanation.root.innerHTML = explanationTextarea.value;
      quillExplanation.on('text-change', function(){ explanationTextarea.value = quillExplanation.root.innerHTML; });
      explanationTextarea.style.display = 'none';
    } catch(e) { explanationTextarea.style.display = 'block'; }
  }

  const questionTypeRadios = document.querySelectorAll('input[name="question_type"]');
  const choicesSection = document.getElementById('choicesSection');
  const essayAnswerSection = document.getElementById('essayAnswerSection');

  function refreshCards() {
    const descMap = { multiple_choice: 'Cocok untuk soal pilihan ganda dengan beberapa opsi jawaban.', essay: 'Jawaban berupa teks esai yang dinilai sesuai kebijakan penilaian.' };
    questionTypeRadios.forEach(function(radio){
      const label = document.querySelector('label[for="' + radio.id + '"]');
      if (!label) return;
      const desc = label.querySelector('.js-type-desc');
      const title = label.querySelector('.js-type-title');
      if (desc) desc.textContent = descMap[radio.value] || 'Pilih tipe pertanyaan yang sesuai.';
      if (radio.checked) {
        label.classList.add('ring-2','ring-primary-500','border-primary-400','bg-primary-100','dark:bg-primary-800/40','dark:border-primary-500','dark:ring-primary-400');
        if (title) title.classList.add('text-gray-900','dark:text-white');
        if (desc) { desc.classList.add('text-gray-700','dark:text-gray-300'); desc.classList.remove('text-gray-600','dark:text-gray-400'); }
      } else {
        label.classList.remove('ring-2','ring-primary-500','border-primary-400','bg-primary-100','dark:bg-primary-800/40','dark:border-primary-500','dark:ring-primary-400');
        if (desc) { desc.classList.remove('text-gray-700','dark:text-gray-300'); desc.classList.add('text-gray-600','dark:text-gray-400'); }
      }
    });
  }

  function toggleSections() {
    const selectedType = document.querySelector('input[name="question_type"]:checked');
    if (!selectedType) return;
    document.body.style.cursor = 'wait';
          setTimeout(function(){
      if (selectedType.value === 'multiple_choice') {
        choicesSection.style.display = 'block';
        essayAnswerSection.style.display = 'none';
        choicesSection.classList.add('section-fade-in');
      } else {
        choicesSection.style.display = 'none';
        essayAnswerSection.style.display = 'block';
        essayAnswerSection.classList.add('section-fade-in');
      }
      document.body.style.cursor = '';
      refreshCards();
    }, 100);
  }

  questionTypeRadios.forEach(function(radio){ radio.classList.add('sr-only'); radio.addEventListener('change', toggleSections); });
  toggleSections();

  const form = document.querySelector('form');
  if (form) {
    form.addEventListener('submit', function(e){
      const category = document.querySelector('#id_category');
      let questionContent = '';
      if (quillEditor) { questionContent = quillEditor.root.innerHTML.trim(); if (!quillEditor.getText().trim()) questionContent = ''; }
      else if (questionTextarea) { questionContent = questionTextarea.value.trim(); }
      if (quillExplanation && explanationTextarea) { explanationTextarea.value = quillExplanation.root.innerHTML; }
      if (!questionContent || (category && !category.value)) {
        e.preventDefault();
        alert('Please fill in all required fields');
        return;
      }
    });
  }

  // Image upload helpers (teacher)
  window.uploadChoiceImage = function(input, choiceNumber) {
    const file = input.files[0];
    if (!file) return;
    const formData = new FormData();
    formData.append('upload', file);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    const statusEl = document.getElementById(`choice-image-status-${choiceNumber}`);
    if (statusEl) { statusEl.textContent = 'Uploading...'; statusEl.className = 'mt-1 text-xs text-blue-600 dark:text-blue-400'; }
    fetch('/admin/image-upload/', { method: 'POST', body: formData, headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value } })
      .then(r => r.json())
      .then(data => {
        if (data && data.url) {
          const hiddenUrl = document.getElementById(`choice-image-url-${choiceNumber}`);
          if (hiddenUrl) hiddenUrl.value = data.url;
          const preview = document.getElementById(`choice-image-preview-${choiceNumber}`);
          const uploadArea = document.getElementById(`choice-upload-area-${choiceNumber}`);
          if (preview) {
            const img = preview.querySelector('img');
            if (img) img.src = data.url;
            preview.classList.remove('hidden');
          }
          if (uploadArea) uploadArea.classList.add('hidden');
          if (statusEl) { statusEl.textContent = 'Image uploaded successfully'; statusEl.className = 'mt-1 text-xs text-green-600 dark:text-green-400'; }
        } else {
          if (statusEl) { statusEl.textContent = 'Failed to upload image'; statusEl.className = 'mt-1 text-xs text-red-600 dark:text-red-400'; }
        }
      })
      .catch(() => { if (statusEl) { statusEl.textContent = 'Failed to upload image'; statusEl.className = 'mt-1 text-xs text-red-600 dark:text-red-400'; } })
      .finally(() => { input.value = ''; });
  };

  window.removeChoiceImage = function(choiceNumber) {
    const hiddenUrl = document.getElementById(`choice-image-url-${choiceNumber}`);
    if (hiddenUrl) hiddenUrl.value = '';
    const preview = document.getElementById(`choice-image-preview-${choiceNumber}`);
    const uploadArea = document.getElementById(`choice-upload-area-${choiceNumber}`);
    if (preview) preview.classList.add('hidden');
    if (uploadArea) uploadArea.classList.remove('hidden');
    const statusEl = document.getElementById(`choice-image-status-${choiceNumber}`);
    if (statusEl) { statusEl.textContent = ''; statusEl.className = 'mt-1 text-xs'; }
  };

  // Load existing choice images on page load
  function loadExistingChoiceImages() {
    document.querySelectorAll('input[id*="choice-image-url-"]').forEach(hiddenInput => {
      if (hiddenInput.value) {
        const choiceNumber = hiddenInput.id.split('-').pop();
        const preview = document.getElementById(`choice-image-preview-${choiceNumber}`);
        const uploadArea = document.getElementById(`choice-upload-area-${choiceNumber}`);
        
        if (preview) {
          const img = preview.querySelector('img');
          if (img) {
            img.src = hiddenInput.value;
          }
          preview.classList.remove('hidden');
        }
        if (uploadArea) {
          uploadArea.classList.add('hidden');
        }
      }
    });
  }

  // Call on page load
  loadExistingChoiceImages();

  // Correct answer visual feedback (simplified)
  function handleCorrectAnswerChange(checkbox) {
    const choiceItem = checkbox.closest('.choice-item');
    if (!choiceItem) return;
    if (checkbox.checked) choiceItem.classList.add('correct-answer'); else choiceItem.classList.remove('correct-answer');
  }
  document.querySelectorAll('input[name$="-is_correct"]').forEach(cb => {
    cb.addEventListener('change', function(){ handleCorrectAnswerChange(this); });
    if (cb.checked) handleCorrectAnswerChange(cb);
  });
});
</script>

<!-- Image Modal -->
<div id="imageModal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
  <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
    <div class="fixed inset-0 bg-black bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closeImageModal()"></div>
    <div class="relative inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full modal-panel">
      <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white" id="modal-title">Image Preview</h3>
          <button type="button" onclick="closeImageModal()" class="bg-white dark:bg-gray-800 rounded-md text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
            <span class="sr-only">Close</span>
            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
          </button>
        </div>
        <div class="mt-2 flex justify-center">
          <img id="modalImage" src="" alt="Preview" class="max-w-full max-h-96 h-auto rounded-lg border border-gray-200 dark:border-gray-600 shadow-lg">
        </div>
      </div>
      <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
        <button type="button" onclick="closeImageModal()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-primary-600 text-base font-medium text-white hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 sm:ml-3 sm:w-auto sm:text-sm">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
function openImageModal(imageSrc, imageTitle) {
  const modal = document.getElementById('imageModal');
  const modalImage = document.getElementById('modalImage');
  const modalTitle = document.getElementById('modal-title');
  if (imageSrc && modal && modalImage) {
    modalImage.src = imageSrc;
    if (modalTitle) modalTitle.textContent = imageTitle || 'Image Preview';
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
  }
}
function closeImageModal() {
  const modal = document.getElementById('imageModal');
  if (modal) {
    modal.classList.add('hidden');
    document.body.style.overflow = '';
  }
}
  </script>
{% endblock %}
