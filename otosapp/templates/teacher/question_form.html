{% extends 'base.html' %}

{% block title %}{% if question %}Edit Question{% else %}Create Question{% endif %}{% endblock %}

{% block content %}
<section class="bg-gray-50 dark:bg-gray-900 p-6">
  <div class="mx-auto max-w-3xl">
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
      <h1 class="text-xl font-bold mb-4 text-gray-900 dark:text-white">{% if question %}Edit Question{% else %}Create Question{% endif %}</h1>
  <form method="post" id="questionForm">
        {% csrf_token %}
        <div class="space-y-4">
          {{ form.non_field_errors }}
          <div>
            <label class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300">Question Text</label>
            {{ form.question_text }}
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300">Question Type</label>
              {{ form.question_type }}
            </div>
            <div>
              <label class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300">Score</label>
              {{ form.score }}
            </div>
          </div>

          <div class="mt-4">
            <h3 class="text-sm font-medium text-gray-900 dark:text-white mb-2">Choices</h3>
            <!-- Management form -->
            {{ formset.management_form }}

            <!-- Container for existing forms -->
            <div id="choicesContainer" class="space-y-2">
              {% for f in formset %}
                <div class="choice-form p-2 border rounded bg-gray-50 dark:bg-gray-700 flex items-center gap-4" data-index="{{ forloop.counter0 }}">
                  <div class="flex-1 w-full">
                    {{ f.choice_text }}
                    {% if f.choice_text.errors %}
                      <p class="text-sm text-red-600 mt-1">{{ f.choice_text.errors|striptags }}</p>
                    {% endif %}
                  </div>

                  <div class="flex items-center whitespace-nowrap">
                    <label class="inline-flex items-center">
                      {{ f.is_correct }}
                      <span class="ml-2 text-sm text-gray-900 dark:text-white">Correct Answer</span>
                    </label>
                  </div>

                </div>
              {% endfor %}
            </div>

            <!-- Choices are managed server-side; client-side add button removed -->
          </div>

          <script>
            function getManagementField(nameSuffix) {
              return document.querySelector('input[name$="-' + nameSuffix + '"]');
            }

            function currentTotalForms() {
              const el = getManagementField('TOTAL_FORMS');
              return el ? parseInt(el.value, 10) : 0;
            }

            function setTotalForms(val) {
              const el = getManagementField('TOTAL_FORMS');
              if (el) el.value = String(val);
            }

            // client-side addChoice removed â€” choices should be added server-side via the form

            function removeChoice(buttonEl) {
              // Find the containing form row
              const row = buttonEl.closest('.choice-form');
              if (!row) return;
              // If the row contains a DELETE input, check it and hide row
              const deleteInput = row.querySelector('input[type="checkbox"][name$="-DELETE"]') || row.querySelector('input[name$="-DELETE"]');
              if (deleteInput) {
                deleteInput.checked = true;
                row.style.display = 'none';
              } else {
                // Newly added form: remove node and renumber forms
                row.remove();
                renumberForms();
              }
            }

            function renumberForms() {
              const rows = document.querySelectorAll('#choicesContainer .choice-form');
              const total = rows.length;
              // Update TOTAL_FORMS
              setTotalForms(total);
              // Re-label indices in input names and ids
              rows.forEach((row, index) => {
                row.setAttribute('data-index', index);
                const inputs = row.querySelectorAll('input, select, textarea, label');
                inputs.forEach(el => {
                  // update name
                  if (el.name) {
                    el.name = el.name.replace(/-\d+-/g, '-' + index + '-').replace(/__prefix__/g, index);
                  }
                  // update id
                  if (el.id) {
                    el.id = el.id.replace(/-\d+-/g, '-' + index + '-').replace(/__prefix__/g, index);
                  }
                  // update for attribute on labels
                  if (el.getAttribute && el.getAttribute('for')) {
                    el.setAttribute('for', el.getAttribute('for').replace(/-\d+-/g, '-' + index + '-').replace(/__prefix__/g, index));
                  }
                });
              });
            }
          </script>

          <div class="flex items-center space-x-2 mt-6">
            <button id="questionSaveBtn" type="submit" class="px-4 py-2 bg-primary-600 text-white rounded">Save</button>
            <a href="{% url 'teacher_question_list' category.id %}" class="text-sm text-gray-600">Cancel</a>
          </div>
        </div>
      </form>
    </div>
  </div>
</section>
{% endblock %}

<script>
  // Fallback: if some JS prevented normal submit, force submit on click
  document.addEventListener('DOMContentLoaded', function(){
    var btn = document.getElementById('questionSaveBtn');
    var form = document.getElementById('questionForm');
    if(btn && form){
      btn.addEventListener('click', function(e){
        setTimeout(function(){
          if(!form.dataset.submitted){
            try{ form.submit(); } catch(err){ console.error(err); }
          }
        }, 10);
      });

      // Mark as submitted when native submit occurs
      form.addEventListener('submit', function(){ form.dataset.submitted = '1'; });
    }
  });
</script>
