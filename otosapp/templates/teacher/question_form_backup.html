{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title|default:"Question Form" }}{% endblock %}

{% block extrahead %}
    <!-- Flowbite WYSIWYG Editor -->
    <script src="https://unpkg.com/flowbite@1.7.0/dist/flowbite.min.js"></script>
    
    <!-- MathJax Configuration -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true,
          tags: 'none'
        },
        options: {
          processHtmlClass: 'wysiwyg-editor|latex-formula|math-formula',
          ignoreHtmlClass: 'no-mathjax',
          skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        },
        chtml: {
          displayAlign: 'left',
          displayIndent: '0',
          scale: 1.0,
          minScale: 0.5,
          matchFontHeight: true,
          fontURL: 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/output/chtml/fonts/woff-v2'
        },
        startup: {
          ready: () => {
            MathJax.startup.defaultReady();
            setTimeout(() => {
              if (window.MathJax && window.MathJax.typesetPromise) {
                window.MathJax.typesetPromise().catch((err) => {});
              }
            }, 500);
          }
        }
      };
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.min.js"></script>

    <!-- Include WYSIWYG Styles -->
    {% include 'teacher/includes/wysiwyg_styles.html' %}

    <style>
        /* Page transition animation */
        .section-fade-in { animation: fadeIn 0.25s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Form-specific WYSIWYG overrides */
        .wysiwyg-editor {
            min-height: 200px;
        }
        
        [id^="wysiwyg-choice-text-"] {
            min-height: 100px;
        }

        /* Form inputs styling */
        textarea, input[type="text"], select {
            background: white;
            color: #1f2937;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            transition: all 0.15s ease-in-out;
        }

        .dark textarea, .dark input[type="text"], .dark select {
            background: #1f2937;
            color: #f9fafb;
            border-color: #4b5563;
        }

        /* Choice styling */
        .choice-checkbox:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
        }

        .choice-item.correct-answer {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border: 3px solid #10b981;
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
            transform: scale(1.02);
        }

        .choice-item.correct-answer .choice-header {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .choice-item {
            transition: all 0.2s ease-in-out;
        }
        
        .choice-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .wysiwyg-editor {
                min-height: 150px;
            }
        }

        /* Focus states */
        .wysiwyg-editor:focus {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
        }
        
      /* LaTeX Formula Styling - Inline with text flow */
      .math-formula {
        display: inline !important;
        margin: 0 1px;
        padding: 2px 4px;
        background-color: #eff6ff;
        border: 1px solid #3b82f6;
        border-radius: 4px;
        font-size: 1em;
        vertical-align: baseline;
        cursor: pointer;
        user-select: none;
        white-space: nowrap;
        font-family: 'KaTeX_Main', 'Times New Roman', serif;
        line-height: 1.2;
        max-width: none;
      }
      
      .math-formula:hover {
        background-color: #dbeafe;
        border-color: #2563eb;
      }
      
      /* Dark mode math formula styling */
      .dark .math-formula {
        background-color: #1e3a8a;
        border-color: #3b82f6;
        color: #dbeafe;
      }
      
      .dark .math-formula:hover {
        background-color: #1e40af;
        border-color: #60a5fa;
      }
      
      /* Ensure math formulas don't break text flow */
      .wysiwyg-editor .math-formula {
        line-height: inherit;
        vertical-align: baseline;
      }
      
      /* MathJax output styling override */
      .math-formula .MathJax,
      .math-formula .MathJax_Display {
        display: inline !important;
        margin: 0 !important;
        padding: 0 !important;
        text-align: left !important;
      }
      
      /* Legacy LaTeX formula styling (for backward compatibility) */
        .latex-formula, .math-display {
          display: inline-block;
          margin: 2px 5px;
          padding: 4px 8px;
          background-color: #f0f9ff;
          border: 1px solid #0ea5e9;
          border-radius: 4px;
          min-height: 24px;
          vertical-align: middle;
          cursor: pointer;
          user-select: none; /* Prevent text selection issues */
          position: relative;
          z-index: 1;
        }
        
        .latex-formula:hover, .math-display:hover {
          background-color: #e0f2fe;
          border-color: #0284c7;
        }
        
        /* Dark mode LaTeX styling */
        .dark .latex-formula, .dark .math-display {
          background-color: #1e3a8a;
          border-color: #3b82f6;
          color: #dbeafe;
        }
        
        .dark .latex-formula:hover, .dark .math-display:hover {
          background-color: #1e40af;
          border-color: #60a5fa;
        }
        
        /* Ensure LaTeX doesn't break editor flow */
        .wysiwyg-editor .latex-formula,
        .wysiwyg-editor .math-display {
          white-space: nowrap;
          overflow: hidden;
        }
        
        /* Format toolbar button active states */
        [data-wysiwyg-toggle-format].active {
            background-color: #dbeafe;
            color: #1e40af;
        }
        
        .dark [data-wysiwyg-toggle-format].active {
            background-color: #1e3a8a;
            color: #bfdbfe;
        }

        /* Text inputs and textareas */
        textarea,
        input[type="text"],
        select {
            background: #ffffff;
            color: #1f2937;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 0.75rem;
            font-size: 14px;
            transition: border-color 0.2s ease-in-out;
        }

        .dark textarea,
        .dark input[type="text"],
        .dark select {
            background: #1f2937;
            color: #f9fafb;
            border-color: #4b5563;
        }

        textarea:focus,
        input[type="text"]:focus,
        select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        textarea::placeholder,
        input[type="text"]::placeholder {
            color: #9ca3af;
        }

        .dark textarea::placeholder,
        .dark input[type="text"]::placeholder {
            color: #6b7280;
        }

        /* Choice checkbox styling */
        .choice-checkbox:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
        }

        .dark .choice-checkbox {
            border-color: #4b5563;
            background-color: #374151;
        }

        /* Correct answer visual states */
        .choice-item.correct-answer {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border: 3px solid #10b981;
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
            transform: scale(1.02);
        }

        .choice-item.correct-answer .choice-header {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .choice-item.correct-answer .wysiwyg-editor {
            border: 2px solid #10b981;
            background-color: rgba(255, 255, 255, 0.98);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.15);
        }

        .dark .choice-item.correct-answer .wysiwyg-editor {
            background-color: rgba(31, 41, 55, 0.98);
        }

        /* Dark theme adjustments for correct answer (softer, more readable) */
        .dark .choice-item.correct-answer {
            background: rgba(6, 95, 70, 0.22);
            border-color: #059669;
            box-shadow: 0 8px 18px rgba(5, 150, 105, 0.18);
        }

        .dark .choice-item.correct-answer .choice-header {
            background: linear-gradient(135deg, #065f46 0%, #047857 100%);
            color: #e5fff4;
        }

        .dark .choice-item.correct-answer .choice-status,
        .dark .choice-item.correct-answer h4 {
            color: #e5fff4;
        }

        .dark .choice-item.correct-answer .choice-badge {
            background-color: #059669;
            color: #ecfdf5;
        }

        /* Layout and small animations */
        .choice-item { 
            transition: all 0.2s ease-in-out; 
        }
        
        .choice-item:hover { 
            transform: translateY(-1px); 
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); 
        }

        /* Modal and thumbnail */
        #imageModal { 
            backdrop-filter: blur(4px); 
        }
        
        #modalImage { 
            transition: transform 0.2s ease-in-out; 
            cursor: zoom-in; 
        }
        
        #modalImage:hover { 
            transform: scale(1.02); 
        }
        
        .choice-item img { 
            transition: all 0.2s ease-in-out; 
        }
        
        .choice-item img:hover { 
            transform: scale(1.05); 
            box-shadow: 0 4px 20px rgba(0,0,0,0.15); 
        }

        /* Responsive tweaks */
        @media (max-width: 768px) {
            .wysiwyg-editor { 
                min-height: 180px; 
            }
            .choice-item { 
                padding: 0.5rem; 
            }
        }

        /* Dark mode adjustments for previews */
        .dark #imageModal .modal-panel { 
            background-color: #0f172a; 
        }
        
        .dark .choice-item img { 
            box-shadow: 0 4px 14px rgba(255,255,255,0.03); 
        }
        
        /* Optional choice styling */
        .choice-item.optional {
            opacity: 0.8;
            border-style: dashed !important;
        }
        
        .choice-item.optional .choice-header {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        }
        
        .dark .choice-item.optional .choice-header {
            background: linear-gradient(135deg, #374151 0%, #4b5563 100%);
        }
        
        .choice-item.optional:hover {
            opacity: 1;
        }
    </style>
{% endblock %}

{% block content %}
<!-- Include Question Header Component -->
<section class="bg-gray-50 dark:bg-gray-900 p-3 sm:p-5 antialiased">
    <div class="mx-auto max-w-screen-xl px-4 lg:px-12">
        {% with header_title=page_title|default:"Question Form" header_subtitle=page_subtitle show_back_button=True header_icon='<svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>' %}
            {% include 'teacher/manage_questions/includes/question_header.html' %}
        {% endwith %}

    <div class="bg-white dark:bg-gray-800 relative shadow-md sm:rounded-lg overflow-hidden question-form-card">
        <div class="p-6">
            <div class="max-w-4xl mx-auto">
                <!-- Error Messages -->
                {% if form.errors %}
                    <div class="mb-6 bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg dark:bg-red-900/20 dark:border-red-800 dark:text-red-400">
                                    <div class="flex">
                                        <div class="flex-shrink-0">
                                            <svg class="h-5 w-5 text-red-400" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                                            </svg>
                                        </div>
                                        <div class="ml-3">
                                            <h3 class="text-sm font-medium">Please fix the following errors:</h3>
                                            <div class="mt-2 text-sm">
                                                <ul class="list-disc pl-5 space-y-1">
                                                    {% for field, errors in form.errors.items %}
                                                        {% for error in errors %}
                                                            <li>{{ field|capfirst }}: {{ error }}</li>
                                                        {% endfor %}
                                                    {% endfor %}
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}

                            <!-- Form -->
                            <form method="post" class="space-y-6">
                                {% csrf_token %}
                                
                                <!-- Question Content -->
                                <div class="bg-white dark:bg-gray-800 shadow-sm rounded-lg border border-gray-200 dark:border-gray-700">
                                    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                                        <h3 class="text-lg font-medium text-gray-900 dark:text-white">Question Content</h3>
                                        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                                            {% if question %}Update your question content using the rich text editor{% else %}Enter your question content using the rich text editor{% endif %}
                                        </p>
                                    </div>
                                    <div class="px-6 py-4">
                                        <div class="mb-4 p-4 border border-gray-200 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700">
                                            <label for="id_question_text" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                                Question Text
                                                <span class="text-red-500">*</span>
                                            </label>
                                            
                                            <!-- Flowbite WYSIWYG Editor for Question Text -->
                                            <div class="w-full mb-4 border border-gray-200 rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600">
                                                <div class="flex items-center justify-between px-3 py-2 border-b dark:border-gray-600">
                                                    <div class="flex flex-wrap items-center divide-gray-200 sm:divide-x sm:rtl:divide-x-reverse dark:divide-gray-600">
                                                        <div class="flex items-center space-x-1 rtl:space-x-reverse sm:pe-4">
                                                            <button type="button" data-tooltip-target="tooltip-bold-teacher" data-wysiwyg-toggle-format="bold" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5h4.5a3.5 3.5 0 1 1 0 7H8m0-7v7m0-7H6m2 7h6.5a3.5 3.5 0 1 1 0 7H8m0-7v7m0 0H6"/>
                                                                </svg>
                                                                <span class="sr-only">Bold</span>
                                                            </button>
                                                            <div id="tooltip-bold-teacher" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                Bold
                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                            </div>
                                                            <button type="button" data-tooltip-target="tooltip-italic-teacher" data-wysiwyg-toggle-format="italic" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m8.874 19 6.143-14M6 19h6.33m-.66-14H18"/>
                                                                </svg>
                                                                <span class="sr-only">Italic</span>
                                                            </button>
                                                            <div id="tooltip-italic-teacher" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                Italic
                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                            </div>
                                                            <button type="button" data-tooltip-target="tooltip-underline-teacher" data-wysiwyg-toggle-format="underline" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                                    <path stroke="currentColor" stroke-linecap="round" stroke-width="2" d="M6 19h12M8 5v9a4 4 0 0 0 8 0V5M6 5h4m4 0h4"/>
                                                                </svg>
                                                                <span class="sr-only">Underline</span>
                                                            </button>
                                                            <div id="tooltip-underline-teacher" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                Underline
                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                            </div>
                                                        </div>
                                                        <div class="flex flex-wrap items-center space-x-1 rtl:space-x-reverse sm:ps-4">
                                                            <button type="button" data-tooltip-target="tooltip-list-teacher" data-wysiwyg-toggle-format="unorderedList" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                                    <path stroke="currentColor" stroke-linecap="round" stroke-width="2" d="M9 8h10M9 12h10M9 16h10M4.99 8H5m-.02 4h.01m0 4H5"/>
                                                                </svg>
                                                                <span class="sr-only">Bullet list</span>
                                                            </button>
                                                            <div id="tooltip-list-teacher" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                Bullet list
                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                            </div>
                                                            <button type="button" data-tooltip-target="tooltip-ordered-list-teacher" data-wysiwyg-toggle-format="orderedList" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6h8m-8 6h8m-8 6h8M4 16a2 2 0 1 1 3.321 1.5L4 20h5M4 5l2-1v6m-2 0h4"/>
                                                                </svg>
                                                                <span class="sr-only">Ordered list</span>
                                                            </button>
                                                            <div id="tooltip-ordered-list-teacher" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                Ordered list
                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                            </div>
                                                            <button type="button" data-tooltip-target="tooltip-blockquote-teacher" data-wysiwyg-toggle-format="blockquote" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                                                                    <path fill-rule="evenodd" d="M6 6a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1.5L6 16.5v.5h3l2-3.5V11a2 2 0 0 0-2-2H6Zm7 0a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1.5L13 16.5v.5h3l2-3.5V11a2 2 0 0 0-2-2h-3Z" clip-rule="evenodd"/>
                                                                </svg>
                                                                <span class="sr-only">Blockquote</span>
                                                            </button>
                                                            <div id="tooltip-blockquote-teacher" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                Blockquote
                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                            </div>
                                                            
                                                            <!-- Separator -->
                                                            <div class="w-px h-6 bg-gray-300 dark:bg-gray-600 mx-1"></div>
                                                            
                                                            <!-- Image Upload Button -->
                                                            <button type="button" data-tooltip-target="tooltip-image-teacher" data-wysiwyg-action="image" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                                                                    <path fill-rule="evenodd" d="M13 10a1 1 0 0 1 1-1h.01a1 1 0 1 1 0 2H14a1 1 0 0 1-1-1Z" clip-rule="evenodd"/>
                                                                    <path fill-rule="evenodd" d="M2 6a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v12c0 .556-.227 1.06-.593 1.422A.999.999 0 0 1 20.5 20H4a2.002 2.002 0 0 1-2-2V6Zm6.892 12 3.833-5.356-3.99-4.322a1 1 0 0 0-1.549.097L4 12.879V6h16v9.95l-3.257-3.619a1 1 0 0 0-1.557.088L11.2 18H8.892Z" clip-rule="evenodd"/>
                                                                </svg>
                                                                <span class="sr-only">Upload Image</span>
                                                            </button>
                                                            <div id="tooltip-image-teacher" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                Upload Image
                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                            </div>

                                                            <!-- Math Symbols Button -->
                                                            <button type="button" data-tooltip-target="tooltip-math-teacher" data-wysiwyg-action="math-symbols" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                                                                    <path d="M9 7H7v2H5V7H3V5h2V3h2v2h2v2Zm2 12h10v-2H11v2Zm0-4h10v-2H11v2Zm0-4h10V9H11v2Z"/>
                                                                </svg>
                                                                <span class="sr-only">Math Symbols</span>
                                                            </button>
                                                            <div id="tooltip-math-teacher" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                Insert Math Symbols
                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                            </div>

                                                            <!-- LaTeX Formula Button -->
                                                            <button type="button" data-tooltip-target="tooltip-latex-teacher" data-wysiwyg-action="latex" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                                                                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                                                                </svg>
                                                                <span class="sr-only">LaTeX Formula</span>
                                                            </button>
                                                            <div id="tooltip-latex-teacher" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                Insert LaTeX Formula
                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                            </div>

                                                            <!-- LaTeX Guide Button -->
                                                            <button type="button" data-tooltip-target="tooltip-latex-guide-teacher" data-wysiwyg-action="latex-guide" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
                                                                    <path d="M10 2C5.58 2 2 5.58 2 10s3.58 8 8 8 8-3.58 8-8-3.58-8-8-8zm1 13h-2v-2h2v2zm0-3h-2V7h2v5z"/>
                                                                </svg>
                                                                <span class="sr-only">LaTeX Guide</span>
                                                            </button>
                                                            <div id="tooltip-latex-guide-teacher" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                LaTeX Guide
                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="px-4 py-2 bg-white rounded-b-lg dark:bg-gray-800">
                                                    <div id="wysiwyg-question-text-teacher" data-wysiwyg="true" contenteditable="true" class="prose dark:prose-invert block w-full px-0 text-sm text-gray-800 bg-white border-0 dark:bg-gray-800 focus:ring-0 dark:text-white dark:placeholder-gray-400 wysiwyg-editor" data-placeholder="Type your question here...">{{ form.question_text.value|default:"" }}</div>
                                                </div>
                                            </div>
                                            
                                            <!-- Hidden textarea for form submission -->
                                            <textarea id="id_question_text" name="question_text" class="hidden">{{ form.question_text.value|default:"" }}</textarea>
                                            
                                            {% if form.question_text.errors %}
                                                {% for error in form.question_text.errors %}
                                                    <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ error }}</p>
                                                {% endfor %}
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <!-- Question Type and Category (swapped: Weight config now on the left) -->
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                    <!-- Weight Configuration (moved here) -->
                                    <div class="bg-white dark:bg-gray-800 shadow-sm rounded-lg border border-gray-200 dark:border-gray-700">
                                        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                                            <h3 class="text-lg font-medium text-gray-900 dark:text-white">Weight Configuration</h3>
                                        </div>
                                        <div class="px-6 py-4">
                                            <label for="id_custom_weight" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                                Custom Weight (Optional)
                                            </label>
                                            {{ form.custom_weight }}
                                            {% if form.custom_weight.help_text %}
                                                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">{{ form.custom_weight.help_text }}</p>
                                            {% endif %}
                                            {% if form.custom_weight.errors %}
                                                {% for error in form.custom_weight.errors %}
                                                    <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ error }}</p>
                                                {% endfor %}
                                            {% endif %}
                                        </div>
                                    </div>

                                    <!-- Category -->
                                    <div class="bg-white dark:bg-gray-800 shadow-sm rounded-lg border border-gray-200 dark:border-gray-700">
                                        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                                            <h3 class="text-lg font-medium text-gray-900 dark:text-white">Category</h3>
                                        </div>
                                        <div class="px-6 py-4">
                                            <label for="id_category" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                                Question Category
                                                <span class="text-red-500">*</span>
                                            </label>
                                            {{ form.category }}
                                            <input type="hidden" id="id_category_hidden" name="category">
                                            <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">Category dikunci agar tidak dapat diubah.</p>
                                            <script>
                                            (function() {
                                                var categorySelect = document.getElementById('id_category');
                                                if (categorySelect) {
                                                    categorySelect.setAttribute('disabled', 'disabled');
                                                    if (categorySelect.classList) {
                                                        categorySelect.classList.add('bg-gray-100', 'cursor-not-allowed', 'opacity-60', 'dark:bg-gray-700', 'dark:text-gray-300', 'dark:placeholder-gray-400', 'dark:border-gray-600');
                                                    }
                                                    var hiddenInput = document.getElementById('id_category_hidden');
                                                    if (hiddenInput) {
                                                        hiddenInput.value = categorySelect.value;
                                                    }
                                                }
                                            })();
                                            </script>
                                            {% if form.category.errors %}
                                                {% for error in form.category.errors %}
                                                    <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ error }}</p>
                                                {% endfor %}
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <!-- Question Type (moved here and redesigned as selectable cards) -->
                                <div class="bg-white dark:bg-gray-800 shadow-sm rounded-lg border border-gray-200 dark:border-gray-700">
                                    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                                        <h3 class="text-lg font-medium text-gray-900 dark:text-white">Question Type</h3>
                                    </div>
                                    <div class="px-6 py-4">
                                        <fieldset>
                                            <legend class="sr-only">Question Type</legend>
                                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4" id="questionTypeCards">
                                                {% for choice in form.question_type %}
                                                    <label for="{{ choice.id_for_label }}" class="question-type-card group block border rounded-lg p-4 cursor-pointer transition-all duration-150 border-gray-200 dark:border-gray-700 hover:border-primary-400 dark:hover:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500 dark:focus:ring-primary-400">
                                                        <div class="flex items-start">
                                                            <div class="mt-1">
                                                                {{ choice.tag|safe }}
                                                            </div>
                                                            <div class="ml-3">
                                                                <div class="js-type-title text-sm font-medium text-gray-900 dark:text-white">{{ choice.choice_label }}</div>
                                                                <div class="mt-1 text-xs text-gray-600 dark:text-gray-400 js-type-desc">Pilih tipe pertanyaan yang sesuai.</div>
                                                            </div>
                                                        </div>
                                                    </label>
                                                {% endfor %}
                                            </div>
                                        </fieldset>
                                        <script>
                                            (function() {
                                                var radios = document.querySelectorAll('input[name="question_type"]');
                                                var descMap = {
                                                    'multiple_choice': 'Cocok untuk soal pilihan ganda dengan beberapa opsi jawaban.',
                                                    'essay': 'Jawaban berupa teks esai yang dinilai sesuai kebijakan penilaian.'
                                                };
                                                function refreshCards() {
                                                    radios.forEach(function(radio) {
                                                        var label = document.querySelector('label[for="' + radio.id + '"]');
                                                        if (!label) return;
                                                        var desc = label.querySelector('.js-type-desc');
                                                        var title = label.querySelector('.js-type-title');
                                                        var text = descMap[radio.value] || 'Pilih tipe pertanyaan yang sesuai.';
                                                        if (desc) desc.textContent = text;
                                                        if (radio.checked) {
                                                            label.classList.add('ring-2','ring-primary-500','border-primary-400','bg-primary-100','dark:bg-primary-800/40','dark:border-primary-500','dark:ring-primary-400');
                                                            if (title) {
                                                                title.classList.add('text-gray-900','dark:text-white');
                                                            }
                                                            if (desc) {
                                                                desc.classList.add('text-gray-700','dark:text-gray-300');
                                                                desc.classList.remove('text-gray-600','dark:text-gray-400');
                                                            }
                                                        } else {
                                                            label.classList.remove('ring-2','ring-primary-500','border-primary-400','bg-primary-100','dark:bg-primary-800/40','dark:border-primary-500','dark:ring-primary-400');
                                                            if (desc) {
                                                                desc.classList.remove('text-gray-700','dark:text-gray-300');
                                                                desc.classList.add('text-gray-600','dark:text-gray-400');
                                                            }
                                                        }
                                                    });
                                                }
                                                radios.forEach(function(radio) {
                                                    // Make the native radio visually hidden but accessible via label card
                                                    radio.classList.add('sr-only');
                                                    radio.addEventListener('change', refreshCards);
                                                });
                                                refreshCards();
                                            })();
                                        </script>
                                        {% if form.question_type.help_text %}
                                            <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">{{ form.question_type.help_text }}</p>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- Multiple Choice Options -->
                                <div id="choicesSection" class="bg-white dark:bg-gray-800 shadow-sm rounded-lg border border-gray-200 dark:border-gray-700">
                                    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <h3 class="text-lg font-medium text-gray-900 dark:text-white">Answer Choices</h3>
                                                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                                                    {% if question %}Update multiple choice options for this question{% else %}Add multiple choice options for this question{% endif %}
                                                    <br><span class="text-blue-600 dark:text-blue-400">â€¢ Minimum 2 choices required (A & B must be filled)</span>
                                                    <br><span class="text-gray-400">â€¢ Choices C, D, E are optional</span>
                                                </p>
                                            </div>
                                            <div class="flex items-center space-x-4 text-xs text-gray-500 dark:text-gray-400">
                                                <div class="flex items-center space-x-2">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                    </svg>
                                                    <span>Select at least one correct answer</span>
                                                </div>
                                                <div class="flex items-center space-x-2">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                                                    </svg>
                                                    <span id="choice-counter" class="text-red-500">0/5 choices filled</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="px-6 py-6">
                                        {{ formset.management_form }}
                                        
                                        <div id="choice-forms" class="space-y-4">
                                            {% for form in formset %}
                                                <div class="choice-item relative group border-2 border-gray-200 dark:border-gray-600 rounded-xl overflow-hidden transition-all duration-200 hover:border-primary-300 dark:hover:border-primary-500 {% if form.is_correct.value %}correct-answer{% endif %}{% if forloop.counter > 2 %} optional{% endif %}" data-choice="{{ forloop.counter }}">
                                                    {% for hidden in form.hidden_fields %}{{ hidden }}{% endfor %}
                                                    
                                                    <!-- Choice Header with Letter Badge -->
                                                    <div class="choice-header flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-700/50 border-b border-gray-200 dark:border-gray-600">
                                                        <div class="flex items-center space-x-3">
                                                            <!-- Choice Letter Badge -->
                                                            <div class="choice-badge flex items-center justify-center w-10 h-10 rounded-full font-bold text-lg {% if form.is_correct.value %}bg-green-600 text-white dark:bg-emerald-600 dark:text-emerald-50{% else %}bg-primary-100 text-primary-700 dark:bg-primary-900 dark:text-primary-300{% endif %}">
                                                                {% if forloop.counter == 1 %}A{% elif forloop.counter == 2 %}B{% elif forloop.counter == 3 %}C{% elif forloop.counter == 4 %}D{% elif forloop.counter == 5 %}E{% endif %}
                                                            </div>
                                                            
                                                            <!-- Choice Title -->
                                                            <div>
                                                                <h4 class="text-lg font-semibold {% if form.is_correct.value %}text-white font-bold dark:text-emerald-50{% else %}text-gray-900 dark:text-white{% endif %}">
                                                                    Choice {% if forloop.counter == 1 %}A{% elif forloop.counter == 2 %}B{% elif forloop.counter == 3 %}C{% elif forloop.counter == 4 %}D{% elif forloop.counter == 5 %}E{% endif %}
                                                                </h4>
                                                                <p class="choice-status text-sm {% if form.is_correct.value %}text-white font-medium dark:text-emerald-50{% else %}text-gray-500 dark:text-gray-400{% endif %}">
                                                                    {% if form.is_correct.value %}âœ“ Correct Answer{% else %}Option{% endif %}
                                                                </p>
                                                            </div>
                                                        </div>
                                                        
                                                        <!-- Correct Answer Toggle -->
                                                        <div class="flex items-center space-x-3">
                                                            <!-- Hidden checkbox for form submission -->
                                                            <div class="hidden">{{ form.is_correct }}</div>
                                                            
                                                            <!-- Button to toggle correct answer -->
                                                            <button type="button" 
                                                                    class="correct-answer-btn px-4 py-2 rounded-lg font-medium text-sm transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 {% if form.is_correct.value %}bg-green-600 text-white border-green-600 focus:ring-green-500 hover:bg-green-700{% else %}bg-gray-100 text-gray-700 border-gray-300 hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600 dark:hover:bg-gray-600 focus:ring-gray-500{% endif %}"
                                                                    data-choice-number="{{ forloop.counter }}"
                                                                    onclick="toggleCorrectAnswer(this, {{ forloop.counter }})">
                                                                <div class="flex items-center space-x-2">
                                                                    <svg class="w-4 h-4 {% if form.is_correct.value %}block{% else %}hidden{% endif %} check-icon" fill="currentColor" viewBox="0 0 20 20">
                                                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                                                    </svg>
                                                                    <svg class="w-4 h-4 {% if form.is_correct.value %}hidden{% else %}block{% endif %} plus-icon" fill="currentColor" viewBox="0 0 20 20">
                                                                        <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
                                                                    </svg>
                                                                    <span class="button-text">{% if form.is_correct.value %}Correct Answer{% else %}Mark as Correct{% endif %}</span>
                                                                </div>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Choice Content -->
                                                    <div class="p-4">
                                                        <!-- Choice Text with WYSIWYG Editor -->
                                                        <div>
                                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                                                Choice Text {% if forloop.counter <= 2 %}<span id="choice-text-req-{{ forloop.counter }}" class="text-red-500">*</span>{% else %}<span class="text-gray-400 text-xs">(Optional)</span>{% endif %}
                                                            </label>
                                                            
                                                            <!-- Flowbite WYSIWYG Editor for Choice -->
                                                            <div class="w-full mb-4 border border-gray-200 rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600">
                                                                <div class="flex items-center justify-between px-3 py-2 border-b dark:border-gray-600">
                                                                    <div class="flex flex-wrap items-center divide-gray-200 sm:divide-x sm:rtl:divide-x-reverse dark:divide-gray-600">
                                                                        <div class="flex items-center space-x-1 rtl:space-x-reverse sm:pe-4">
                                                                            <button type="button" data-tooltip-target="tooltip-bold-choice-{{ forloop.counter }}" data-wysiwyg-toggle-format="bold" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                                                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5h4.5a3.5 3.5 0 1 1 0 7H8m0-7v7m0-7H6m2 7h6.5a3.5 3.5 0 1 1 0 7H8m0-7v7m0 0H6"/>
                                                                                </svg>
                                                                                <span class="sr-only">Bold</span>
                                                                            </button>
                                                                            <div id="tooltip-bold-choice-{{ forloop.counter }}" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                                Bold
                                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                                            </div>
                                                                            <button type="button" data-tooltip-target="tooltip-italic-choice-{{ forloop.counter }}" data-wysiwyg-toggle-format="italic" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                                                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m8.874 19 6.143-14M6 19h6.33m-.66-14H18"/>
                                                                                </svg>
                                                                                <span class="sr-only">Italic</span>
                                                                            </button>
                                                                            <div id="tooltip-italic-choice-{{ forloop.counter }}" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                                Italic
                                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                                            </div>
                                                                            <button type="button" data-tooltip-target="tooltip-underline-choice-{{ forloop.counter }}" data-wysiwyg-toggle-format="underline" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                                                    <path stroke="currentColor" stroke-linecap="round" stroke-width="2" d="M6 19h12M8 5v9a4 4 0 0 0 8 0V5M6 5h4m4 0h4"/>
                                                                                </svg>
                                                                                <span class="sr-only">Underline</span>
                                                                            </button>
                                                                            <div id="tooltip-underline-choice-{{ forloop.counter }}" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                                Underline
                                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                                            </div>
                                                                        </div>
                                                                        <div class="flex flex-wrap items-center space-x-1 rtl:space-x-reverse sm:ps-4">
                                                                            <button type="button" data-tooltip-target="tooltip-list-choice-{{ forloop.counter }}" data-wysiwyg-toggle-format="unorderedList" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                                                    <path stroke="currentColor" stroke-linecap="round" stroke-width="2" d="M9 8h10M9 12h10M9 16h10M4.99 8H5m-.02 4h.01m0 4H5"/>
                                                                                </svg>
                                                                                <span class="sr-only">Bullet list</span>
                                                                            </button>
                                                                            <div id="tooltip-list-choice-{{ forloop.counter }}" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                                Bullet list
                                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                                            </div>
                                                                            <button type="button" data-tooltip-target="tooltip-ordered-list-choice-{{ forloop.counter }}" data-wysiwyg-toggle-format="orderedList" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                                                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6h8m-8 6h8m-8 6h8M4 16a2 2 0 1 1 3.321 1.5L4 20h5M4 5l2-1v6m-2 0h4"/>
                                                                                </svg>
                                                                                <span class="sr-only">Ordered list</span>
                                                                            </button>
                                                                            <div id="tooltip-ordered-list-choice-{{ forloop.counter }}" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                                Ordered list
                                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                                            </div>
                                                                            <button type="button" data-tooltip-target="tooltip-blockquote-choice-{{ forloop.counter }}" data-wysiwyg-toggle-format="blockquote" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                                                                                    <path fill-rule="evenodd" d="M6 6a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1.5L6 16.5v.5h3l2-3.5V11a2 2 0 0 0-2-2H6Zm7 0a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1.5L13 16.5v.5h3l2-3.5V11a2 2 0 0 0-2-2h-3Z" clip-rule="evenodd"/>
                                                                                </svg>
                                                                                <span class="sr-only">Blockquote</span>
                                                                            </button>
                                                                            <div id="tooltip-blockquote-choice-{{ forloop.counter }}" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                                Blockquote
                                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                                            </div>
                                                                            
                                                                            <!-- Separator -->
                                                                            <div class="w-px h-6 bg-gray-300 dark:bg-gray-600 mx-1"></div>
                                                                            
                                                                            <!-- Image Upload Button -->
                                                                            <button type="button" data-tooltip-target="tooltip-image-choice-{{ forloop.counter }}" data-wysiwyg-action="image" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                                                                                    <path fill-rule="evenodd" d="M13 10a1 1 0 0 1 1-1h.01a1 1 0 1 1 0 2H14a1 1 0 0 1-1-1Z" clip-rule="evenodd"/>
                                                                                    <path fill-rule="evenodd" d="M2 6a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v12c0 .556-.227 1.06-.593 1.422A.999.999 0 0 1 20.5 20H4a2.002 2.002 0 0 1-2-2V6Zm6.892 12 3.833-5.356-3.99-4.322a1 1 0 0 0-1.549.097L4 12.879V6h16v9.95l-3.257-3.619a1 1 0 0 0-1.557.088L11.2 18H8.892Z" clip-rule="evenodd"/>
                                                                                </svg>
                                                                                <span class="sr-only">Upload Image</span>
                                                                            </button>
                                                                            <div id="tooltip-image-choice-{{ forloop.counter }}" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                                Upload Image
                                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                                            </div>

                                                                            <!-- Math Symbols Button -->
                                                                            <button type="button" data-tooltip-target="tooltip-math-choice-{{ forloop.counter }}" data-wysiwyg-action="math-symbols" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                                                                                    <path d="M9 7H7v2H5V7H3V5h2V3h2v2h2v2Zm2 12h10v-2H11v2Zm0-4h10v-2H11v2Zm0-4h10V9H11v2Z"/>
                                                                                </svg>
                                                                                <span class="sr-only">Math Symbols</span>
                                                                            </button>
                                                                            <div id="tooltip-math-choice-{{ forloop.counter }}" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                                Insert Math Symbols
                                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                                            </div>

                                                                            <!-- LaTeX Formula Button -->
                                                                            <button type="button" data-tooltip-target="tooltip-latex-choice-{{ forloop.counter }}" data-wysiwyg-action="latex" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                                                                                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                                                                                </svg>
                                                                                <span class="sr-only">LaTeX Formula</span>
                                                                            </button>
                                                                            <div id="tooltip-latex-choice-{{ forloop.counter }}" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                                Insert LaTeX Formula
                                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                                            </div>

                                                                            <!-- LaTeX Guide Button -->
                                                                            <button type="button" data-tooltip-target="tooltip-latex-guide-choice-{{ forloop.counter }}" data-wysiwyg-action="latex-guide" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
                                                                                    <path d="M10 2C5.58 2 2 5.58 2 10s3.58 8 8 8 8-3.58 8-8-3.58-8-8-8zm1 13h-2v-2h2v2zm0-3h-2V7h2v5z"/>
                                                                                </svg>
                                                                                <span class="sr-only">LaTeX Guide</span>
                                                                            </button>
                                                                            <div id="tooltip-latex-guide-choice-{{ forloop.counter }}" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                                LaTeX Guide
                                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div class="px-4 py-2 bg-white rounded-b-lg dark:bg-gray-800">
                                                                    <div id="wysiwyg-choice-text-{{ forloop.counter }}" 
                                                                         data-wysiwyg="true" 
                                                                         data-placeholder="Enter choice text..."
                                                                         contenteditable="true" 
                                                                         class="wysiwyg-editor prose max-w-none text-sm text-gray-900 dark:text-white focus:outline-none min-h-[100px] p-2 border-0">
                                                                        {% if form.choice_text.value %}{{ form.choice_text.value|safe }}{% endif %}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            
                                                            <!-- Hidden textarea for form submission -->
                                                            <div class="hidden">{{ form.choice_text }}</div>
                                                            
                                                            <!-- Legacy Image Display -->
                                                            {% if form.instance.choice_image %}
                                                            <div class="mt-3 p-3 bg-yellow-50 border border-yellow-200 rounded-lg dark:bg-yellow-900/20 dark:border-yellow-800">
                                                                <div class="flex items-start space-x-3">
                                                                    <div class="flex-shrink-0">
                                                                        <svg class="w-5 h-5 text-yellow-600 dark:text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                                                                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                                                        </svg>
                                                                    </div>
                                                                    <div class="flex-1">
                                                                        <h4 class="text-sm font-medium text-yellow-800 dark:text-yellow-200">Legacy Image Found</h4>
                                                                        <p class="text-sm text-yellow-700 dark:text-yellow-300 mt-1">This choice contains an image uploaded using the old system. For new images, please use the image upload button in the editor above.</p>
                                                                        <div class="mt-2">
                                                                            <img src="{{ form.instance.choice_image.url }}" 
                                                                                 alt="Legacy choice image" 
                                                                                 class="max-w-xs h-auto rounded-lg border border-yellow-300">
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            {% endif %}
                                                            
                                                            {% if form.choice_text.errors %}
                                                                {% for error in form.choice_text.errors %}
                                                                    <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ error }}</p>
                                                                {% endfor %}
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>

                                <!-- Essay Answer Section -->
                                <div id="essayAnswerSection" class="bg-white dark:bg-gray-800 shadow-sm rounded-lg border border-gray-200 dark:border-gray-700" style="display: none;">
                                    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                                        <h3 class="text-lg font-medium text-gray-900 dark:text-white">Expected Answer</h3>
                                        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Provide the expected answer or key points for this essay question</p>
                                    </div>
                                    <div class="px-6 py-4">
                                        <label for="id_correct_answer_text" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                            Expected Answer
                                        </label>
                                        {{ form.correct_answer_text }}
                                        {% if form.correct_answer_text.help_text %}
                                            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">{{ form.correct_answer_text.help_text }}</p>
                                        {% endif %}
                                        {% if form.correct_answer_text.errors %}
                                            {% for error in form.correct_answer_text.errors %}
                                                <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ error }}</p>
                                            {% endfor %}
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- Explanation / Pembahasan (optional) -->
                                <div class="bg-white dark:bg-gray-800 shadow-sm rounded-lg border border-gray-200 dark:border-gray-700">
                                    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                                        <h3 class="text-lg font-medium text-gray-900 dark:text-white">Pembahasan Jawaban (Opsional)</h3>
                                        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                                            Tambahkan penjelasan mengapa jawabannya seperti itu. Kosongkan jika tidak diperlukan.
                                        </p>
                                    </div>
                                    <div class="px-6 py-4">
                                        <div class="mb-4 p-4 border border-gray-200 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700">
                                            <label for="id_explanation" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                                Pembahasan
                                            </label>
                                            
                                            <!-- Flowbite WYSIWYG Editor for Explanation -->
                                            <div class="w-full mb-4 border border-gray-200 rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600">
                                                <div class="flex items-center justify-between px-3 py-2 border-b dark:border-gray-600">
                                                    <div class="flex flex-wrap items-center divide-gray-200 sm:divide-x sm:rtl:divide-x-reverse dark:divide-gray-600">
                                                        <div class="flex items-center space-x-1 rtl:space-x-reverse sm:pe-4">
                                                            <button type="button" data-tooltip-target="tooltip-bold-exp-teacher" data-wysiwyg-toggle-format="bold" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5h4.5a3.5 3.5 0 1 1 0 7H8m0-7v7m0-7H6m2 7h6.5a3.5 3.5 0 1 1 0 7H8m0-7v7m0 0H6"/>
                                                                </svg>
                                                                <span class="sr-only">Bold</span>
                                                            </button>
                                                            <div id="tooltip-bold-exp-teacher" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                Bold
                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                            </div>
                                                            <button type="button" data-tooltip-target="tooltip-italic-exp-teacher" data-wysiwyg-toggle-format="italic" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m8.874 19 6.143-14M6 19h6.33m-.66-14H18"/>
                                                                </svg>
                                                                <span class="sr-only">Italic</span>
                                                            </button>
                                                            <div id="tooltip-italic-exp-teacher" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                Italic
                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                            </div>
                                                            <button type="button" data-tooltip-target="tooltip-underline-exp-teacher" data-wysiwyg-toggle-format="underline" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                                    <path stroke="currentColor" stroke-linecap="round" stroke-width="2" d="M6 19h12M8 5v9a4 4 0 0 0 8 0V5M6 5h4m4 0h4"/>
                                                                </svg>
                                                                <span class="sr-only">Underline</span>
                                                            </button>
                                                            <div id="tooltip-underline-exp-teacher" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                Underline
                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                            </div>
                                                        </div>
                                                        <div class="flex flex-wrap items-center space-x-1 rtl:space-x-reverse sm:ps-4">
                                                            <button type="button" data-tooltip-target="tooltip-list-exp-teacher" data-wysiwyg-toggle-format="unorderedList" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                                    <path stroke="currentColor" stroke-linecap="round" stroke-width="2" d="M9 8h10M9 12h10M9 16h10M4.99 8H5m-.02 4h.01m0 4H5"/>
                                                                </svg>
                                                                <span class="sr-only">Bullet list</span>
                                                            </button>
                                                            <div id="tooltip-list-exp-teacher" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                Bullet list
                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                            </div>
                                                            <button type="button" data-tooltip-target="tooltip-ordered-list-exp-teacher" data-wysiwyg-toggle-format="orderedList" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6h8m-8 6h8m-8 6h8M4 16a2 2 0 1 1 3.321 1.5L4 20h5M4 5l2-1v6m-2 0h4"/>
                                                                </svg>
                                                                <span class="sr-only">Ordered list</span>
                                                            </button>
                                                            <div id="tooltip-ordered-list-exp-teacher" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                Ordered list
                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                            </div>
                                                            <button type="button" data-tooltip-target="tooltip-blockquote-exp-teacher" data-wysiwyg-toggle-format="blockquote" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                                                                    <path fill-rule="evenodd" d="M6 6a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1.5L6 16.5v.5h3l2-3.5V11a2 2 0 0 0-2-2H6Zm7 0a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1.5L13 16.5v.5h3l2-3.5V11a2 2 0 0 0-2-2h-3Z" clip-rule="evenodd"/>
                                                                </svg>
                                                                <span class="sr-only">Blockquote</span>
                                                            </button>
                                                            <div id="tooltip-blockquote-exp-teacher" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                Blockquote
                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                            </div>
                                                            
                                                            <!-- Separator -->
                                                            <div class="w-px h-6 bg-gray-300 dark:bg-gray-600 mx-1"></div>
                                                            
                                                            <!-- Image Upload Button -->
                                                            <button type="button" data-tooltip-target="tooltip-image-exp-teacher" data-wysiwyg-action="image" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                                                                    <path fill-rule="evenodd" d="M13 10a1 1 0 0 1 1-1h.01a1 1 0 1 1 0 2H14a1 1 0 0 1-1-1Z" clip-rule="evenodd"/>
                                                                    <path fill-rule="evenodd" d="M2 6a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v12c0 .556-.227 1.06-.593 1.422A.999.999 0 0 1 20.5 20H4a2.002 2.002 0 0 1-2-2V6Zm6.892 12 3.833-5.356-3.99-4.322a1 1 0 0 0-1.549.097L4 12.879V6h16v9.95l-3.257-3.619a1 1 0 0 0-1.557.088L11.2 18H8.892Z" clip-rule="evenodd"/>
                                                                </svg>
                                                                <span class="sr-only">Upload Image</span>
                                                            </button>
                                                            <div id="tooltip-image-exp-teacher" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                Upload Image
                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                            </div>

                                                            <!-- Math Symbols Button -->
                                                            <button type="button" data-tooltip-target="tooltip-math-exp-teacher" data-wysiwyg-action="math-symbols" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                                                                    <path d="M9 7H7v2H5V7H3V5h2V3h2v2h2v2Zm2 12h10v-2H11v2Zm0-4h10v-2H11v2Zm0-4h10V9H11v2Z"/>
                                                                </svg>
                                                                <span class="sr-only">Math Symbols</span>
                                                            </button>
                                                            <div id="tooltip-math-exp-teacher" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                Insert Math Symbols
                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                            </div>

                                                            <!-- LaTeX Formula Button -->
                                                            <button type="button" data-tooltip-target="tooltip-latex-exp-teacher" data-wysiwyg-action="latex" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                                                                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                                                                </svg>
                                                                <span class="sr-only">LaTeX Formula</span>
                                                            </button>
                                                            <div id="tooltip-latex-exp-teacher" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                Insert LaTeX Formula
                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                            </div>

                                                            <!-- LaTeX Guide Button -->
                                                            <button type="button" data-tooltip-target="tooltip-latex-guide-exp-teacher" data-wysiwyg-action="latex-guide" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
                                                                    <path d="M10 2C5.58 2 2 5.58 2 10s3.58 8 8 8 8-3.58 8-8-3.58-8-8-8zm1 13h-2v-2h2v2zm0-3h-2V7h2v5z"/>
                                                                </svg>
                                                                <span class="sr-only">LaTeX Guide</span>
                                                            </button>
                                                            <div id="tooltip-latex-guide-exp-teacher" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                LaTeX Guide
                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="px-4 py-2 bg-white rounded-b-lg dark:bg-gray-800">
                                                    <div id="wysiwyg-explanation-teacher" data-wysiwyg="true" contenteditable="true" class="prose dark:prose-invert block w-full px-0 text-sm text-gray-800 bg-white border-0 dark:bg-gray-800 focus:ring-0 dark:text-white dark:placeholder-gray-400 wysiwyg-editor" data-placeholder="Tulis pembahasan (opsional)...">{{ form.explanation.value|default:"" }}</div>
                                                </div>
                                            </div>
                                            
                                            <!-- Hidden textarea for form submission -->
                                            <textarea id="id_explanation" name="explanation" class="hidden">{{ form.explanation.value|default:"" }}</textarea>
                                            
                                            {% if form.explanation.errors %}
                                                {% for error in form.explanation.errors %}
                                                    <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ error }}</p>
                                                {% endfor %}
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <!-- Submit Button -->
                                <div class="flex justify-end space-x-3 pt-6 border-t border-gray-200 dark:border-gray-700">
                                    <a href="{% url 'question_list' %}" class="bg-white dark:bg-gray-800 py-2 px-4 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                                        Cancel
                                    </a>
                                    <button type="submit" class="bg-primary-600 py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors duration-200">
                                        {% if question %}Update Question{% else %}Create Question{% endif %}
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Image Modal -->
<div id="imageModal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
        <!-- Background overlay -->
        <div class="fixed inset-0 bg-black bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closeImageModal()"></div>
        
        <!-- Modal panel -->
        <div class="relative inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full">
            <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <!-- Modal Header -->
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white" id="modal-title">
                        Image Preview
                    </h3>
                    <button type="button" 
                            onclick="closeImageModal()" 
                            class="bg-white dark:bg-gray-800 rounded-md text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                        <span class="sr-only">Close</span>
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                
                <!-- Modal Content -->
                <div class="mt-3 text-center sm:mt-0 sm:text-left">
                    <div class="mt-2 flex justify-center">
                        <img id="modalImage" 
                             src="" 
                             alt="Preview" 
                             class="max-w-full max-h-96 h-auto rounded-lg border border-gray-200 dark:border-gray-600 shadow-lg">
                    </div>
                </div>
            </div>
            
            <!-- Modal Footer -->
            <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" 
                        onclick="closeImageModal()" 
                        class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-primary-600 text-base font-medium text-white hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 sm:ml-3 sm:w-auto sm:text-sm">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Math Symbols Modal -->
<div id="mathSymbolsModal" tabindex="-1" aria-hidden="true" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
  <div class="relative p-4 w-full max-w-4xl max-h-full">
    <!-- Modal content -->
    <div class="relative bg-white rounded-lg shadow dark:bg-gray-700">
      <!-- Modal header -->
      <div class="flex items-center justify-between p-4 md:p-5 border-b rounded-t dark:border-gray-600">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
          Math Symbols
        </h3>
        <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white" onclick="closeMathSymbolsModal()">
          <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
          </svg>
          <span class="sr-only">Close modal</span>
        </button>
      </div>
      <!-- Modal body -->
      <div class="p-4 md:p-5 space-y-4">
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
          
          <!-- Operasi Dasar -->
          <div class="space-y-2">
            <h4 class="font-medium text-gray-900 dark:text-white">Operasi Dasar</h4>
            <div class="grid grid-cols-4 gap-2">
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="+">+</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="âˆ’">âˆ’</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="Ã—">Ã—</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="Ã·">Ã·</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="=">= </button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="â‰ ">â‰ </button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="Â±">Â±</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="âˆ“">âˆ“</button>
            </div>
          </div>

          <!-- Perbandingan -->
          <div class="space-y-2">
            <h4 class="font-medium text-gray-900 dark:text-white">Perbandingan</h4>
            <div class="grid grid-cols-4 gap-2">
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="<"><</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol=">">></button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="â‰¤">â‰¤</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="â‰¥">â‰¥</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="â‰ˆ">â‰ˆ</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="â‰¡">â‰¡</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="âˆ">âˆ</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="âˆž">âˆž</button>
            </div>
          </div>

          <!-- Eksponen & Akar -->
          <div class="space-y-2">
            <h4 class="font-medium text-gray-900 dark:text-white">Eksponen & Akar</h4>
            <div class="grid grid-cols-4 gap-2">
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="Â²">Â²</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="Â³">Â³</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="â¿">â¿</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="âˆš">âˆš</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="âˆ›">âˆ›</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="âˆœ">âˆœ</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="â±">â±</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="áµ">áµ</button>
            </div>
          </div>

          <!-- Pecahan & Desimal -->
          <div class="space-y-2">
            <h4 class="font-medium text-gray-900 dark:text-white">Pecahan</h4>
            <div class="grid grid-cols-4 gap-2">
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="Â½">Â½</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="â…“">â…“</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="â…”">â…”</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="Â¼">Â¼</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="Â¾">Â¾</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="â…•">â…•</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="â…–">â…–</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="â…˜">â…˜</button>
            </div>
          </div>

          <!-- Trigonometri -->
          <div class="space-y-2">
            <h4 class="font-medium text-gray-900 dark:text-white">Trigonometri</h4>
            <div class="grid grid-cols-2 gap-2">
              <button type="button" class="math-symbol-btn p-2 text-sm border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="sin">sin</button>
              <button type="button" class="math-symbol-btn p-2 text-sm border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="cos">cos</button>
              <button type="button" class="math-symbol-btn p-2 text-sm border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="tan">tan</button>
              <button type="button" class="math-symbol-btn p-2 text-sm border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="cot">cot</button>
              <button type="button" class="math-symbol-btn p-2 text-sm border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="sec">sec</button>
              <button type="button" class="math-symbol-btn p-2 text-sm border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="csc">csc</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="Â°">Â°</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="Ï€">Ï€</button>
            </div>
          </div>

          <!-- Logaritma -->
          <div class="space-y-2">
            <h4 class="font-medium text-gray-900 dark:text-white">Logaritma</h4>
            <div class="grid grid-cols-2 gap-2">
              <button type="button" class="math-symbol-btn p-2 text-sm border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="log">log</button>
              <button type="button" class="math-symbol-btn p-2 text-sm border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="ln">ln</button>
              <button type="button" class="math-symbol-btn p-2 text-sm border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="lg">lg</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="e">e</button>
            </div>
          </div>

          <!-- Himpunan -->
          <div class="space-y-2">
            <h4 class="font-medium text-gray-900 dark:text-white">Himpunan</h4>
            <div class="grid grid-cols-4 gap-2">
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="âˆˆ">âˆˆ</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="âˆ‰">âˆ‰</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="âŠ‚">âŠ‚</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="âŠƒ">âŠƒ</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="âˆª">âˆª</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="âˆ©">âˆ©</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="âˆ…">âˆ…</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="â„•">â„•</button>
            </div>
          </div>

          <!-- Lainnya -->
          <div class="space-y-2">
            <h4 class="font-medium text-gray-900 dark:text-white">Lainnya</h4>
            <div class="grid grid-cols-4 gap-2">
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="âˆ‘">âˆ‘</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="âˆ">âˆ</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="âˆ«">âˆ«</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="âˆ‚">âˆ‚</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="âˆ†">âˆ†</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="âˆ‡">âˆ‡</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="Î±">Î±</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="Î²">Î²</button>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>

<!-- Include Math Symbols Modal -->
{% include 'teacher/includes/math_symbols_modal.html' %}

<!-- LaTeX Guide Modal -->
<div id="latexGuideModal" tabindex="-1" aria-hidden="true" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
  <div class="relative p-4 w-full max-w-6xl max-h-full">
    <!-- Modal content -->
    <div class="relative bg-white rounded-lg shadow dark:bg-gray-700">
      <!-- Modal header -->
      <div class="flex items-center justify-between p-4 md:p-5 border-b rounded-t dark:border-gray-600">
        <h3 class="text-xl font-semibold text-gray-900 dark:text-white">
          📖 LaTeX Guide - Panduan Penulisan Formula Matematika
        </h3>
        <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white" id="closeLatexGuideBtnTeacher">
          <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
          </svg>
          <span class="sr-only">Close modal</span>
        </button>
      </div>
      
      <!-- Modal body -->
      <div class="p-4 md:p-5">
        <div class="space-y-6">
          
          <!-- Basic Formulas -->
          <div class="space-y-3">
            <h4 class="text-lg font-medium text-gray-900 dark:text-white">Formula Dasar</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
              <div class="bg-gray-50 dark:bg-gray-800 p-3 rounded">
                <strong>Superscript (Pangkat):</strong><br>
                <code>x^2</code> → x²<br>
                <code>x^{10}</code> → x¹⁰
              </div>
              <div class="bg-gray-50 dark:bg-gray-800 p-3 rounded">
                <strong>Subscript (Indeks):</strong><br>
                <code>x_1</code> → x₁<br>
                <code>x_{ij}</code> → xᵢⱼ
              </div>
              <div class="bg-gray-50 dark:bg-gray-800 p-3 rounded">
                <strong>Pecahan:</strong><br>
                <code>\frac{a}{b}</code> → a/b<br>
                <code>\frac{x+1}{x-1}</code> → (x+1)/(x-1)
              </div>
              <div class="bg-gray-50 dark:bg-gray-800 p-3 rounded">
                <strong>Akar:</strong><br>
                <code>\sqrt{x}</code> → √x<br>
                <code>\sqrt[3]{x}</code> → ³√x
              </div>
            </div>
          </div>

          <!-- Greek Letters -->
          <div class="space-y-3">
            <h4 class="text-lg font-medium text-gray-900 dark:text-white">Huruf Yunani</h4>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm">
              <div class="bg-gray-50 dark:bg-gray-800 p-2 rounded text-center">
                <code>\alpha</code> → α
              </div>
              <div class="bg-gray-50 dark:bg-gray-800 p-2 rounded text-center">
                <code>\beta</code> → β
              </div>
              <div class="bg-gray-50 dark:bg-gray-800 p-2 rounded text-center">
                <code>\gamma</code> → γ
              </div>
              <div class="bg-gray-50 dark:bg-gray-800 p-2 rounded text-center">
                <code>\delta</code> → δ
              </div>
              <div class="bg-gray-50 dark:bg-gray-800 p-2 rounded text-center">
                <code>\epsilon</code> → ε
              </div>
              <div class="bg-gray-50 dark:bg-gray-800 p-2 rounded text-center">
                <code>\theta</code> → θ
              </div>
              <div class="bg-gray-50 dark:bg-gray-800 p-2 rounded text-center">
                <code>\lambda</code> → λ
              </div>
              <div class="bg-gray-50 dark:bg-gray-800 p-2 rounded text-center">
                <code>\pi</code> → π
              </div>
              <div class="bg-gray-50 dark:bg-gray-800 p-2 rounded text-center">
                <code>\sigma</code> → σ
              </div>
              <div class="bg-gray-50 dark:bg-gray-800 p-2 rounded text-center">
                <code>\phi</code> → φ
              </div>
              <div class="bg-gray-50 dark:bg-gray-800 p-2 rounded text-center">
                <code>\omega</code> → ω
              </div>
              <div class="bg-gray-50 dark:bg-gray-800 p-2 rounded text-center">
                <code>\Omega</code> → Ω
              </div>
            </div>
          </div>

          <!-- Mathematical Symbols -->
          <div class="space-y-3">
            <h4 class="text-lg font-medium text-gray-900 dark:text-white">Simbol Matematika</h4>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-2 text-sm">
              <div class="bg-gray-50 dark:bg-gray-800 p-2 rounded text-center">
                <code>\pm</code> → ±
              </div>
              <div class="bg-gray-50 dark:bg-gray-800 p-2 rounded text-center">
                <code>\mp</code> → ∓
              </div>
              <div class="bg-gray-50 dark:bg-gray-800 p-2 rounded text-center">
                <code>\times</code> → ×
              </div>
              <div class="bg-gray-50 dark:bg-gray-800 p-2 rounded text-center">
                <code>\div</code> → ÷
              </div>
              <div class="bg-gray-50 dark:bg-gray-800 p-2 rounded text-center">
                <code>\neq</code> → ≠
              </div>
              <div class="bg-gray-50 dark:bg-gray-800 p-2 rounded text-center">
                <code>\leq</code> → ≤
              </div>
              <div class="bg-gray-50 dark:bg-gray-800 p-2 rounded text-center">
                <code>\geq</code> → ≥
              </div>
              <div class="bg-gray-50 dark:bg-gray-800 p-2 rounded text-center">
                <code>\infty</code> → ∞
              </div>
              <div class="bg-gray-50 dark:bg-gray-800 p-2 rounded text-center">
                <code>\sum</code> → Σ
              </div>
              <div class="bg-gray-50 dark:bg-gray-800 p-2 rounded text-center">
                <code>\prod</code> → Π
              </div>
              <div class="bg-gray-50 dark:bg-gray-800 p-2 rounded text-center">
                <code>\int</code> → ∫
              </div>
              <div class="bg-gray-50 dark:bg-gray-800 p-2 rounded text-center">
                <code>\partial</code> → ∂
              </div>
            </div>
          </div>

          <!-- Advanced Examples -->
          <div class="space-y-3">
            <h4 class="text-lg font-medium text-gray-900 dark:text-white">Contoh Formula Lanjutan</h4>
            <div class="space-y-3 text-sm">
              <div class="bg-gray-50 dark:bg-gray-800 p-3 rounded">
                <strong>Persamaan Kuadrat:</strong><br>
                <code>x = \frac{-b \pm \sqrt{b^2 - 4ac}}{2a}</code>
              </div>
              <div class="bg-gray-50 dark:bg-gray-800 p-3 rounded">
                <strong>Integral:</strong><br>
                <code>\int_{a}^{b} f(x) dx</code>
              </div>
              <div class="bg-gray-50 dark:bg-gray-800 p-3 rounded">
                <strong>Limit:</strong><br>
                <code>\lim_{x \to \infty} f(x) = L</code>
              </div>
              <div class="bg-gray-50 dark:bg-gray-800 p-3 rounded">
                <strong>Matriks:</strong><br>
                <code>\begin{pmatrix} a & b \\ c & d \end{pmatrix}</code>
              </div>
              <div class="bg-gray-50 dark:bg-gray-800 p-3 rounded">
                <strong>Sistem Persamaan:</strong><br>
                <code>\begin{cases} x + y = 1 \\ x - y = 0 \end{cases}</code>
              </div>
            </div>
          </div>

        </div>

        <!-- Tips -->
        <div class="space-y-3 mt-6 p-4 bg-green-50 dark:bg-green-900/20 rounded-lg">
          <h4 class="text-lg font-medium text-green-900 dark:text-green-100">💡 Tips Penting</h4>
          <ul class="text-sm text-green-800 dark:text-green-200 space-y-1 list-disc list-inside">
            <li>Gunakan kurung kurawal <code>{}</code> untuk mengelompokkan elemen yang panjang</li>
            <li>Spasi diabaikan dalam LaTeX, gunakan <code>\,</code> atau <code>\ </code> untuk spasi paksa</li>
            <li>Untuk tanda kurung besar, gunakan <code>\left(</code> dan <code>\right)</code></li>
            <li>Preview formula sebelum menyimpan untuk memastikan tampilan yang benar</li>
          </ul>
        </div>

      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
    <!-- Include WYSIWYG Scripts -->
    {% include 'teacher/includes/wysiwyg_scripts.html' %}

    <!-- Enhanced JavaScript with Modal Management and Full Functionality -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Teacher form JavaScript loaded');
        
        // Initialize modal management system
        window.modalManager = {
            show: function(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                    document.body.style.overflow = 'hidden';
                    console.log('Modal shown:', modalId);
                }
            },
            hide: function(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                    document.body.style.overflow = '';
                    console.log('Modal hidden:', modalId);
                }
            }
        };

        // Question type functionality
        const questionTypeRadios = document.querySelectorAll('input[name="question_type"]');
        const choicesSection = document.getElementById('choicesSection');
        const essayAnswerSection = document.getElementById('essayAnswerSection');
        
        console.log('Found question type radios:', questionTypeRadios.length);
        console.log('Found choices section:', !!choicesSection);
        console.log('Found essay section:', !!essayAnswerSection);
        
        function toggleSections() {
            const selectedType = document.querySelector('input[name="question_type"]:checked');
            console.log('Selected question type:', selectedType ? selectedType.value : 'none');
            
            if (selectedType) {
                document.body.style.cursor = 'wait';
                
                setTimeout(() => {
                    if (selectedType.value === 'multiple_choice') {
                        if (choicesSection) {
                            choicesSection.style.display = 'block';
                            choicesSection.classList.add('section-fade-in');
                            console.log('Showing choices section');
                        }
                        if (essayAnswerSection) {
                            essayAnswerSection.style.display = 'none';
                            console.log('Hiding essay section');
                        }
                    } else if (selectedType.value === 'essay') {
                        if (choicesSection) {
                            choicesSection.style.display = 'none';
                            console.log('Hiding choices section');
                        }
                        if (essayAnswerSection) {
                            essayAnswerSection.style.display = 'block';
                            essayAnswerSection.classList.add('section-fade-in');
                            console.log('Showing essay section');
                        }
                    }
                    document.body.style.cursor = '';
                }, 100);
            } else {
                const multipleChoiceRadio = document.querySelector('input[name="question_type"][value="multiple_choice"]');
                if (multipleChoiceRadio) {
                    multipleChoiceRadio.checked = true;
                    toggleSections();
                }
            }
        }
        
        // Add event listeners to radio buttons first
        questionTypeRadios.forEach(function(radio) {
            radio.addEventListener('change', function() {
                console.log('Question type changed to:', this.value);
                toggleSections();
            });
        });
        
        // Initial toggle based on selected value
        setTimeout(() => {
            toggleSections();
            
            // If no question type is selected, default to multiple choice
            const selectedType = document.querySelector('input[name="question_type"]:checked');
            if (!selectedType) {
                const multipleChoiceRadio = document.querySelector('input[name="question_type"][value="multiple_choice"]');
                if (multipleChoiceRadio) {
                    multipleChoiceRadio.checked = true;
                    toggleSections();
                }
            }
        }, 100);

        // Initialize WYSIWYG editors
        function initializeWysiwygEditor(editor, textarea) {
            if (!editor || !textarea) return null;

            // Set initial content
            if (textarea.value) {
                editor.innerHTML = textarea.value;
            }

            function updatePlaceholder() {
                const isEmpty = editor.innerHTML.trim() === '' || 
                               editor.innerHTML === '<br>' || 
                               editor.innerHTML === '<p><br></p>';
                editor.classList.toggle('is-empty', isEmpty);
            }

            function syncContent() {
                textarea.value = editor.innerHTML;
                updatePlaceholder();
            }

            // Event listeners
            editor.addEventListener('input', syncContent);
            editor.addEventListener('paste', function(e) {
                setTimeout(syncContent, 10);
            });
            editor.addEventListener('focus', updatePlaceholder);
            editor.addEventListener('blur', function() {
                updatePlaceholder();
                if (editor.innerHTML === '<p><br></p>' || editor.innerHTML === '<br>') {
                    editor.innerHTML = '';
                }
                syncContent();
            });
            editor.addEventListener('keyup', function() {
                setTimeout(syncContent, 100);
            });

            updatePlaceholder();
            syncContent();

            return {
                getContent: () => editor.innerHTML,
                setContent: (content) => {
                    editor.innerHTML = content;
                    syncContent();
                }
            };
        }

        // Initialize main editors
        const questionEditor = document.querySelector('#wysiwyg-question-text-teacher');
        const questionTextarea = document.querySelector('#id_question_text');
        if (questionEditor && questionTextarea) {
            initializeWysiwygEditor(questionEditor, questionTextarea);
            console.log('Initialized question editor');
        }

        const explanationEditor = document.querySelector('#wysiwyg-explanation-teacher, #wysiwyg-explanation-text-teacher');
        const explanationTextarea = document.querySelector('#id_explanation');
        if (explanationEditor && explanationTextarea) {
            initializeWysiwygEditor(explanationEditor, explanationTextarea);
            console.log('Initialized explanation editor');
        }

        // Initialize choice editors
        for (let i = 1; i <= 5; i++) {
            const choiceEditor = document.querySelector(`#wysiwyg-choice-text-${i}`);
            const choiceTextarea = document.querySelector(`#id_choices-${i-1}-choice_text`);
            
            if (choiceEditor && choiceTextarea) {
                initializeWysiwygEditor(choiceEditor, choiceTextarea);
                console.log(`Initialized choice ${i} editor`);
            }
        }

        // Toggle correct answer functionality
        window.toggleCorrectAnswer = function(button, choiceNumber) {
            console.log('Toggle correct answer for choice:', choiceNumber);
            const checkboxName = `choices-${choiceNumber - 1}-is_correct`;
            let checkbox = document.querySelector(`input[name="${checkboxName}"]`);
            
            if (!checkbox) {
                const choiceItem = button.closest('.choice-item');
                checkbox = choiceItem.querySelector('input[name$="-is_correct"][type="checkbox"]');
                
                if (!checkbox) {
                    console.warn(`No checkbox found for choice ${choiceNumber}`);
                    return;
                }
            }
            
            // Check if the choice has content before allowing it to be marked as correct
            const choiceEditor = document.querySelector(`#wysiwyg-choice-text-${choiceNumber}`);
            if (choiceEditor) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = choiceEditor.innerHTML.trim();
                const textContent = tempDiv.textContent || tempDiv.innerText || '';
                
                if (!textContent.trim() && !checkbox.checked) {
                    alert(`Please add content to Choice ${String.fromCharCode(64 + choiceNumber)} before marking it as correct`);
                    return;
                }
            }
            
            // Toggle checkbox state
            checkbox.checked = !checkbox.checked;
            
            if (checkbox.checked) {
                checkbox.setAttribute('value', 'on');
            } else {
                checkbox.removeAttribute('value');
            }
            
            // Update button appearance
            updateCorrectAnswerButton(button, checkbox.checked);
            
            // Trigger visual feedback
            handleCorrectAnswerChange(checkbox, choiceNumber);
        };

        function updateCorrectAnswerButton(button, isCorrect) {
            const checkIcon = button.querySelector('.check-icon');
            const plusIcon = button.querySelector('.plus-icon');
            const buttonText = button.querySelector('.button-text');
            
            if (isCorrect) {
                button.className = 'correct-answer-btn px-4 py-2 rounded-lg font-medium text-sm transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 bg-green-600 text-white border-green-600 focus:ring-green-500 hover:bg-green-700';
                if (checkIcon) {
                    checkIcon.classList.remove('hidden');
                    checkIcon.classList.add('block');
                }
                if (plusIcon) {
                    plusIcon.classList.remove('block');
                    plusIcon.classList.add('hidden');
                }
                if (buttonText) {
                    buttonText.textContent = 'Correct Answer';
                }
            } else {
                button.className = 'correct-answer-btn px-4 py-2 rounded-lg font-medium text-sm transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 bg-gray-100 text-gray-700 border-gray-300 hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600 dark:hover:bg-gray-600 focus:ring-gray-500';
                if (checkIcon) {
                    checkIcon.classList.remove('block');
                    checkIcon.classList.add('hidden');
                }
                if (plusIcon) {
                    plusIcon.classList.remove('hidden');
                    plusIcon.classList.add('block');
                }
                if (buttonText) {
                    buttonText.textContent = 'Mark as Correct';
                }
            }
        }

        function handleCorrectAnswerChange(checkbox, choiceNumber) {
            const choiceItem = checkbox.closest('.choice-item');
            
            if (checkbox.checked) {
                choiceItem.classList.add('correct-answer');
                choiceItem.style.border = '3px solid #10b981';
                choiceItem.style.background = 'linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%)';
                choiceItem.style.boxShadow = '0 8px 25px rgba(16, 185, 129, 0.3)';
                choiceItem.style.transform = 'scale(1.02)';
                
                const choiceHeader = choiceItem.querySelector('.choice-header');
                if (choiceHeader) {
                    choiceHeader.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                    choiceHeader.style.color = 'white';
                }
            } else {
                choiceItem.classList.remove('correct-answer');
                choiceItem.style.border = '';
                choiceItem.style.background = '';
                choiceItem.style.boxShadow = '';
                choiceItem.style.transform = '';
                
                const choiceHeader = choiceItem.querySelector('.choice-header');
                if (choiceHeader) {
                    choiceHeader.style.background = '';
                    choiceHeader.style.color = '';
                }
            }
        }

        // Initialize checkboxes
        for (let i = 0; i < 5; i++) {
            const checkbox = document.querySelector(`input[name="choices-${i}-is_correct"][type="checkbox"]`);
            if (checkbox && checkbox.checked) {
                const choiceNumber = i + 1;
                handleCorrectAnswerChange(checkbox, choiceNumber);
                
                const button = document.querySelector(`[onclick*="toggleCorrectAnswer"][onclick*="${choiceNumber}"]`);
                if (button) {
                    updateCorrectAnswerButton(button, true);
                }
            }
        }

        // Image modal functions
        window.openImageModal = function(imageSrc, imageTitle = 'Image Preview') {
            console.log('Opening image modal:', imageSrc);
            if (window.modalManager) {
                window.modalManager.show('imageModal');
                const modalImage = document.getElementById('modalImage');
                const modalTitle = document.getElementById('modal-title');
                
                if (modalImage && imageSrc) {
                    modalImage.src = imageSrc;
                }
                if (modalTitle) {
                    modalTitle.textContent = imageTitle;
                }
            }
        };
        
        window.closeImageModal = function() {
            console.log('Closing image modal');
            if (window.modalManager) {
                window.modalManager.hide('imageModal');
            }
        };

        // LaTeX Guide modal functions
        window.openLatexGuideModal = function() {
            console.log('Opening LaTeX guide modal');
            if (window.modalManager) {
                window.modalManager.show('latexGuideModal');
            }
        };

        window.closeLatexGuideModal = function() {
            console.log('Closing LaTeX guide modal');
            if (window.modalManager) {
                window.modalManager.hide('latexGuideModal');
            }
        };

        // Add event listener to close button
        const closeLatexBtn = document.getElementById('closeLatexGuideBtnTeacher');
        if (closeLatexBtn) {
            closeLatexBtn.addEventListener('click', window.closeLatexGuideModal);
        }

        // Math symbols modal functions
        window.showMathSymbolsModal = function() {
            console.log('Opening math symbols modal');
            if (window.modalManager) {
                window.modalManager.show('mathSymbolsModal');
            }
        };
        
        window.closeMathSymbolsModal = function() {
            console.log('Closing math symbols modal');
            if (window.modalManager) {
                window.modalManager.hide('mathSymbolsModal');
            }
        };

        // Handle math symbol selection
        document.querySelectorAll('.math-symbol-btn').forEach(button => {
            button.addEventListener('click', function() {
                const symbol = this.getAttribute('data-symbol');
                console.log('Math symbol clicked:', symbol);
                
                if (window.currentMathEditor && symbol) {
                    const selection = window.getSelection();
                    if (selection.rangeCount > 0) {
                        const range = selection.getRangeAt(0);
                        range.deleteContents();
                        range.insertNode(document.createTextNode(symbol + ' '));
                        range.setStartAfter(range.endContainer);
                        range.setEndAfter(range.endContainer);
                        selection.removeAllRanges();
                        selection.addRange(range);
                    } else {
                        window.currentMathEditor.innerHTML += symbol + ' ';
                    }
                    
                    // Sync content
                    window.currentMathEditor.dispatchEvent(new Event('input', { bubbles: true }));
                    
                    console.log('Symbol inserted successfully');
                    window.closeMathSymbolsModal();
                } else {
                    console.warn('No active math editor found');
                }
            });
        });

        // Handle toolbar buttons
        document.querySelectorAll('[data-wysiwyg-action]').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const action = this.getAttribute('data-wysiwyg-action');
                console.log('WYSIWYG action clicked:', action);
                
                if (action === 'math-symbols') {
                    // Find the closest editor
                    const toolbar = this.closest('.flex');
                    const container = toolbar ? toolbar.closest('.w-full') : null;
                    const editor = container ? container.querySelector('[data-wysiwyg="true"]') : null;
                    
                    if (editor) {
                        window.currentMathEditor = editor;
                        window.showMathSymbolsModal();
                    }
                } else if (action === 'latex-guide') {
                    window.openLatexGuideModal();
                }
            });
        });

        // Form validation and submission
        const form = document.querySelector('form');
        if (form) {
            form.addEventListener('submit', function(e) {
                console.log('Form submission started');
                
                // Sync all WYSIWYG content before submission
                document.querySelectorAll('[data-wysiwyg="true"]').forEach(editor => {
                    const event = new Event('input', { bubbles: true });
                    editor.dispatchEvent(event);
                });
                
                const category = document.querySelector('#id_category');
                const questionEditor = document.querySelector('#wysiwyg-question-text-teacher');
                const questionTextarea = document.querySelector('#id_question_text');
                
                // Get question content
                let questionContent = '';
                if (questionEditor) {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = questionEditor.innerHTML;
                    const textContent = tempDiv.textContent || tempDiv.innerText || '';
                    questionContent = textContent.trim();
                } else if (questionTextarea) {
                    questionContent = questionTextarea.value.trim();
                }
                
                if (!questionContent || (category && !category.value)) {
                    e.preventDefault();
                    alert('Please fill in all required fields');
                    return false;
                }
                
                // Show loading state
                const submitBtn = form.querySelector('button[type="submit"]');
                if (submitBtn) {
                    const originalText = submitBtn.textContent;
                    submitBtn.textContent = 'Saving...';
                    submitBtn.disabled = true;
                    setTimeout(() => {
                        submitBtn.textContent = originalText;
                        submitBtn.disabled = false;
                    }, 5000);
                }
            });
        }

        console.log('Teacher form JavaScript initialization complete');
    });
    </script>
{% endblock %}

