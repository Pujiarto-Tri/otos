{% extends 'base.html' %}

{% block title %}Student Performance{% endblock %}

{% block content %}
<section class="bg-gray-50 dark:bg-gray-900 p-3 sm:p-5 antialiased">
  <div class="mx-auto max-w-5xl px-4 sm:px-6 lg:px-8">
  <div class="bg-white dark:bg-gray-800 relative shadow-sm sm:rounded-lg overflow-visible mb-6 border border-gray-100 dark:border-gray-700">
      <div class="px-5 py-4 flex items-center justify-between">
        <div>
          <h1 class="text-2xl font-semibold text-gray-900 dark:text-white">Student Performance</h1>
          <p class="text-sm text-gray-500 dark:text-gray-400">See how students performed on your subtests.</p>
        </div>
        <div>
          <a href="{% url 'teacher_category_create' %}" class="inline-flex items-center px-3 py-1.5 text-sm font-medium text-white bg-primary-700 rounded-md hover:bg-primary-800">Tambah Subtest</a>
        </div>
      </div>
      <div class="px-3 py-2 border-t border-gray-100 dark:border-gray-700">
        <form method="get" class="flex flex-col sm:flex-row sm:items-center sm:gap-3">
          <!-- Make search input larger and allow it to grow on small screens -->
          <input id="searchInput" type="search" name="q" placeholder="Search subtest" value="{{ request.GET.q|default_if_none:'' }}" class="w-full sm:flex-1 px-3 py-2 rounded-md border bg-white dark:bg-gray-700 text-base text-gray-700 dark:text-gray-200" />
          <div class="flex items-center gap-2 mt-2 sm:mt-0">
            <button type="submit" class="inline-flex items-center px-3 py-1.5 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">Search</button>
            <a href="{{ request.path }}" class="inline-flex items-center px-3 py-1.5 text-sm font-medium text-gray-700 bg-white border rounded-md hover:bg-gray-50">Clear</a>
          </div>

          <!-- Collapsible filter panel: collapsed by default on all screen sizes; toggled by Filters button -->
          <!-- Flowbite dropdown used for filters -->
          <div class="relative inline-block text-left">
            <button id="filterToggleBtn" data-dropdown-toggle="filterDropdown" type="button" class="inline-flex items-center px-3 py-1.5 text-sm font-medium text-gray-700 bg-white border rounded-md hover:bg-gray-50" aria-expanded="false">Filters
              <svg class="ml-2 -mr-1 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06-.02L10 10.584l3.71-3.396a.75.75 0 011.04 1.08l-4.24 3.885a.75.75 0 01-1.04 0L5.25 8.29a.75.75 0 01-.02-1.08z" clip-rule="evenodd" />
              </svg>
            </button>

            <div id="filterDropdown" class="hidden z-10 w-64 bg-white dark:bg-gray-800 rounded-md shadow-lg ring-1 ring-black ring-opacity-5 mt-2">
              <div class="p-3 space-y-2">
                <label class="block text-xs text-gray-500">Scoring</label>
                <select name="scoring" class="w-full px-2 py-1 rounded-md text-sm bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200">
                  <option value="">All scoring</option>
                  <option value="standard" {% if request.GET.scoring == 'standard' %}selected{% endif %}>Standard</option>
                  <option value="utbk" {% if request.GET.scoring == 'utbk' %}selected{% endif %}>UTBK</option>
                </select>

                <label class="block text-xs text-gray-500">Submission</label>
                <select name="has_submissions" class="w-full px-2 py-1 rounded-md text-sm bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200">
                  <option value="">All</option>
                  <option value="1" {% if request.GET.has_submissions == '1' %}selected{% endif %}>Has submissions</option>
                  <option value="0" {% if request.GET.has_submissions == '0' %}selected{% endif %}>No submissions</option>
                </select>

                <label class="block text-xs text-gray-500">Sort</label>
                <select name="sort" class="w-full px-2 py-1 rounded-md text-sm bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200">
                  <option value="recent" {% if request.GET.sort == 'recent' or not request.GET.sort %}selected{% endif %}>Recent</option>
                  <option value="popular" {% if request.GET.sort == 'popular' %}selected{% endif %}>Most submissions</option>
                  <option value="avg_score" {% if request.GET.sort == 'avg_score' %}selected{% endif %}>Avg score</option>
                </select>

                <div class="flex justify-between pt-2">
                  <a href="{{ request.path }}" class="text-sm text-gray-600 hover:underline">Clear</a>
                  <button type="submit" class="px-3 py-1 text-sm bg-blue-600 text-white rounded-md">Apply</button>
                </div>
              </div>
            </div>
          </div>
          <script>
            document.addEventListener('DOMContentLoaded', function() {
              const filterBtn = document.querySelector('[data-dropdown-toggle="filterDropdown"]');
              const filterDropdown = document.getElementById('filterDropdown');

              if (filterBtn && filterDropdown) {
                filterBtn.addEventListener('click', function(e){
                  e.preventDefault();
                  e.stopPropagation();
                  const isHidden = filterDropdown.classList.contains('hidden');
                  if (isHidden) {
                    filterDropdown.classList.remove('hidden');
                    filterBtn.setAttribute('aria-expanded', 'true');
                  } else {
                    filterDropdown.classList.add('hidden');
                    filterBtn.setAttribute('aria-expanded', 'false');
                  }
                });

                // Close when clicking outside
                document.addEventListener('click', function(e){
                  if (!filterBtn.contains(e.target) && !filterDropdown.contains(e.target)) {
                    filterDropdown.classList.add('hidden');
                    filterBtn.setAttribute('aria-expanded', 'false');
                  }
                });

                // Close on Escape
                document.addEventListener('keydown', function(e){
                  if (e.key === 'Escape') {
                    filterDropdown.classList.add('hidden');
                    filterBtn.setAttribute('aria-expanded', 'false');
                  }
                });
              }
            });
          </script>
        </form>
      </div>

      
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
      {% for cat in categories %}
  <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 hover:shadow-2xl transform transition-transform duration-200 hover:-translate-y-1 group">
        <a href="{% url 'teacher_view_student_scores' cat.id %}" class="block p-6">
          <!-- Header with icon and title -->
          <div class="flex items-center gap-4 mb-4">
            <div class="w-14 h-14 rounded-xl bg-gradient-to-tr from-blue-500 to-indigo-600 text-white flex items-center justify-center shadow-md group-hover:scale-105 transition-transform">
              <!-- Heroicon: academic-cap -->
              <svg xmlns="http://www.w3.org/2000/svg" class="w-7 h-7" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 14l9-5-9-5-9 5 9 5z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 14l6.16-3.422A12.083 12.083 0 0118 20.01L12 18v-4z"></path>
              </svg>
            </div>
            <div class="flex-1 min-w-0">
              <h3 class="text-lg font-semibold text-gray-900 dark:text-white leading-tight">{{ cat.category_name }}</h3>
              <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Subtest</p>
            </div>
          </div>

          <!-- Stats grid -->
          <div class="grid grid-cols-3 gap-4 mb-4">
            <div class="text-center">
              <div class="text-2xl font-bold text-gray-900 dark:text-white">{{ cat.get_question_count }}</div>
              <div class="text-xs text-gray-500 dark:text-gray-400">Soal</div>
            </div>
            <div class="text-center">
              <div class="text-2xl font-bold text-gray-900 dark:text-white">{{ cat.total_students }}</div>
              <div class="text-xs text-gray-500 dark:text-gray-400">Students</div>
            </div>
            <div class="text-center">
              <div class="text-2xl font-bold text-gray-900 dark:text-white">{{ cat.total_tests }}</div>
              <div class="text-xs text-gray-500 dark:text-gray-400">Submitted</div>
            </div>
          </div>

          <!-- Average score and average completion time -->
          <div class="border-t border-gray-100 dark:border-gray-700 pt-4">
            <div class="flex items-center justify-between space-x-4">
              <div class="flex-1">
                <div class="text-sm font-medium text-gray-700 dark:text-gray-300">Avg Score</div>
                <div class="mt-1 inline-flex items-center">
                  <div class="px-3 py-1 rounded-lg bg-gray-100 dark:bg-gray-700">
                    <span class="text-xl font-bold text-gray-900 dark:text-white">{{ cat.avg_score|default_if_none:'-' }}</span>
                  </div>
                  {% if cat.has_avg_score %}
                  <div class="ml-2 w-8 h-8 rounded-full bg-emerald-500 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                  </div>
                  {% endif %}
                </div>
              </div>

              <div class="flex-0 text-right">
                <div class="text-sm font-medium text-gray-700 dark:text-gray-300">Avg Time</div>
                <div class="mt-1">
                  <span class="text-lg font-semibold text-gray-900 dark:text-white">{{ cat.avg_completion_minutes|default_if_none:'-' }}</span>
                  <span class="text-xs text-gray-500 dark:text-gray-400">&nbsp;min</span>
                </div>
              </div>
            </div>
          </div>
        </a>
      </div>
      {% empty %}
      <div class="col-span-full p-6 bg-white dark:bg-gray-800 rounded-lg shadow">
        <p class="text-gray-600 dark:text-gray-300">You have not created any subtests yet. Create one from Manage Subtest.</p>
      </div>
      {% endfor %}
    </div>
  </div>
</section>
{% endblock %}
