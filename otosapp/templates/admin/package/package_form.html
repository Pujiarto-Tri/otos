{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="flex justify-center items-center min-h-screen bg-gray-50 dark:bg-gray-900">
    <div class="w-full max-w-5xl p-6 mt-16">
        
        <!-- Header Card -->
        <div class="bg-white dark:bg-gray-800 shadow rounded-xl p-6 mb-8 flex flex-col md:flex-row justify-between items-center gap-4 border border-gray-200 dark:border-gray-700">
            <div class="text-left w-full">
                <h1 class="text-3xl font-extrabold text-gray-900 dark:text-white tracking-tight mb-1">Buat Paket Tryout Baru</h1>
                <p class="text-base text-gray-500 dark:text-gray-400">Konfigurasi paket tryout dengan komposisi kategori untuk simulasi UTBK</p>
            </div>
            <a href="{% url 'admin_package_list' %}" class="inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 border border-gray-300 rounded-lg shadow-sm hover:bg-gray-200 dark:bg-gray-700 dark:text-white dark:hover:bg-gray-600 transition">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                </svg>
                Kembali
            </a>
        </div>

        {% if package %}
        <!-- Package Status Info -->
        <div class="mb-6 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
            <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-3">Status Paket</h3>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="text-center">
                    <div class="text-2xl font-bold {% if total_questions > 0 %}text-green-600{% else %}text-red-600{% endif %}">{{ total_questions }}</div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">Total Soal</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold {% if is_scoring_complete %}text-green-600{% else %}text-red-600{% endif %}">{{ total_score }}</div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">Total Skor</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-blue-600">{{ package.total_time }}</div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">Menit</div>
                </div>
                <div class="text-center">
                    {% if package.can_be_taken %}
                    <span class="inline-flex px-3 py-1 text-sm font-semibold rounded-full bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300">
                        Siap Digunakan
                    </span>
                    {% else %}
                    <span class="inline-flex px-3 py-1 text-sm font-semibold rounded-full bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300">
                        Perlu Perbaikan
                    </span>
                    {% endif %}
                </div>
            </div>
            {% if not is_scoring_complete %}
            <div class="mt-3 p-3 bg-yellow-100 dark:bg-yellow-900 rounded-lg">
                <div class="flex">
                    <svg class="w-5 h-5 text-yellow-600 dark:text-yellow-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                    </svg>
                    <div class="text-sm text-yellow-800 dark:text-yellow-300">
                        <strong>Peringatan:</strong> Total skor harus 1000 poin untuk simulasi UTBK yang akurat. Saat ini: {{ total_score }} poin.
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}

    <form method="post" class="space-y-6 mt-8">
            {% csrf_token %}
            
            <!-- Basic Package Information -->
            <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Informasi Dasar Paket</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="{{ form.package_name.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            {{ form.package_name.label }}
                        </label>
                        {{ form.package_name }}
                        {% if form.package_name.help_text %}
                        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">{{ form.package_name.help_text }}</p>
                        {% endif %}
                        {% if form.package_name.errors %}
                        <div class="mt-1 text-sm text-red-600 dark:text-red-400">{{ form.package_name.errors.0 }}</div>
                        {% endif %}
                    </div>
                    
                    <div>
                        <label for="{{ form.total_time.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            {{ form.total_time.label }}
                        </label>
                        {{ form.total_time }}
                        {% if form.total_time.help_text %}
                        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">{{ form.total_time.help_text }}</p>
                        {% endif %}
                        {% if form.total_time.errors %}
                        <div class="mt-1 text-sm text-red-600 dark:text-red-400">{{ form.total_time.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="mt-4">
                    <label for="{{ form.description.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        {{ form.description.label }}
                    </label>
                    {{ form.description }}
                    {% if form.description.help_text %}
                    <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">{{ form.description.help_text }}</p>
                    {% endif %}
                    {% if form.description.errors %}
                    <div class="mt-1 text-sm text-red-600 dark:text-red-400">{{ form.description.errors.0 }}</div>
                    {% endif %}
                </div>
                
                <div class="mt-4">
                    <label class="flex items-center">
                        {{ form.is_active }}
                        <span class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">{{ form.is_active.label }}</span>
                    </label>
                    {% if form.is_active.help_text %}
                    <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">{{ form.is_active.help_text }}</p>
                    {% endif %}
                </div>
            </div>

            <!-- Category Configuration -->
            <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white">Konfigurasi Subtest</h3>
                    <div class="flex items-center gap-3">
                        <button type="button" id="add-category" class="inline-flex items-center px-3 py-2 text-sm font-medium text-white bg-green-600 rounded-lg hover:bg-green-700">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                        </svg>
                        Tambah Subtest
                        </button>

                    </div>
                </div>
                
                <div class="mb-4 p-4 bg-blue-50 dark:bg-blue-900 rounded-lg">
                    <h4 class="text-sm font-medium text-blue-800 dark:text-blue-300 mb-2">Petunjuk Konfigurasi:</h4>
                    <ul class="text-sm text-blue-700 dark:text-blue-400 space-y-1">
                        <li>• Total skor dari semua kategori harus = 1000 poin</li>
                        <li>• Pastikan setiap kategori memiliki cukup soal sesuai jumlah yang diminta</li>
                        <li>• Urutan kategori menentukan urutan tampil saat tryout</li>
                    </ul>
                </div>
                <!-- Auto-fill overwrite toggle -->
                <div class="mb-4">
                    <label class="inline-flex items-center text-sm text-gray-700 dark:text-gray-300">
                        <input id="auto-fill-overwrite" type="checkbox" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded-sm focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600" />
                        <span class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">Selalu timpa jumlah soal saat memilih subtest</span>
                    </label>
                </div>

                {{ formset.management_form }}
                <div id="category-forms" class="space-y-4">
                    {% for category_form in formset %}
                    <div class="category-form p-4 border border-gray-200 dark:border-gray-600 rounded-lg">
                        {{ category_form.id }}
                        {% if category_form.DELETE %}
                        <div class="hidden">{{ category_form.DELETE }}</div>
                        {% endif %}
                        
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-md font-medium text-gray-900 dark:text-white">Subtest</h4>
                            {% if not forloop.first %}
                            <button type="button" class="delete-category text-red-600 hover:text-red-800 dark:text-red-400">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                </svg>
                            </button>
                            {% endif %}
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    {{ category_form.category.label }}
                                </label>
                                {{ category_form.category }}
                                {% if category_form.category.errors %}
                                <div class="mt-1 text-sm text-red-600 dark:text-red-400">{{ category_form.category.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    {{ category_form.question_count.label }}
                                </label>
                                {{ category_form.question_count }}
                                <span class="qc-status inline-flex items-center ml-2 text-sm text-gray-500" style="min-width:2.5rem">
                                    <div class="qc-spinner hidden mr-1" role="status" aria-hidden="true">
                                        <svg class="w-4 h-4 text-gray-400 animate-spin dark:text-gray-200" viewBox="0 0 100 101" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M100 50.5908C100 78.2051 77.6142 100.591 50 100.591C22.3858 100.591 0 78.2051 0 50.5908C0 22.9766 22.3858 0.59082 50 0.59082C77.6142 0.59082 100 22.9766 100 50.5908ZM9.0816 50.5908C9.0816 73.1895 27.4013 91.5092 50 91.5092C72.5987 91.5092 90.9184 73.1895 90.9184 50.5908C90.9184 27.9921 72.5987 9.67236 50 9.67236C27.4013 9.67236 9.0816 27.9921 9.0816 50.5908Z" fill="currentColor"/>
                                            <path d="M93.9676 39.0409C96.393 38.4038 97.8624 35.9116 97.0079 33.5539C95.2932 28.8227 92.871 24.3692 89.8167 20.348C85.8452 15.1192 80.8826 10.7232 75.2124 7.41289C69.5422 4.10256 63.2754 1.94025 56.7688 1.05119C51.7666 0.36701 46.6976 0.446843 41.7345 1.27873C39.3151 1.69328 37.861 4.19778 38.4981 6.62326C39.1352 9.04874 41.623 10.4717 44.0503 10.1071C47.8511 9.56066 51.7191 9.52616 55.5402 10.0073C60.8645 10.6587 65.9926 12.6238 70.6331 15.7926C75.2736 18.9614 79.3347 23.2528 82.5849 28.4031C84.9175 31.8856 88.1799 34.3365 91.675 35.5669C93.249 36.1214 94.4222 37.8603 93.9676 39.0409Z" fill="#1e40af"/>
                                        </svg>
                                    </div>
                                    <span class="qc-text"></span>
                                </span>
                                {% if category_form.question_count.errors %}
                                <div class="mt-1 text-sm text-red-600 dark:text-red-400">{{ category_form.question_count.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    {{ category_form.max_score.label }}
                                </label>
                                {{ category_form.max_score }}
                                {% if category_form.max_score.errors %}
                                <div class="mt-1 text-sm text-red-600 dark:text-red-400">{{ category_form.max_score.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    {{ category_form.order.label }}
                                </label>
                                {{ category_form.order }}
                                {% if category_form.order.errors %}
                                <div class="mt-1 text-sm text-red-600 dark:text-red-400">{{ category_form.order.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        {% if category_form.non_field_errors %}
                        <div class="mt-2 text-sm text-red-600 dark:text-red-400">{{ category_form.non_field_errors.0 }}</div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>

                {# Hidden empty form template for client-side adding #}
                <div id="empty-category-form" style="display:none">
                    <div class="category-form p-4 border border-gray-200 dark:border-gray-600 rounded-lg">
                        {{ formset.empty_form.id }}
                        <div class="hidden">{{ formset.empty_form.DELETE }}</div>

                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-md font-medium text-gray-900 dark:text-white">Subtest</h4>
                            <button type="button" class="delete-category text-red-600 hover:text-red-800 dark:text-red-400">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                </svg>
                            </button>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    {{ formset.empty_form.category.label }}
                                </label>
                                {{ formset.empty_form.category }}
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    {{ formset.empty_form.question_count.label }}
                                </label>
                                {{ formset.empty_form.question_count }}
                                <span class="qc-status inline-flex items-center ml-2 text-sm text-gray-500" style="min-width:2.5rem">
                                    <div class="qc-spinner hidden mr-1" role="status" aria-hidden="true">
                                        <svg class="w-4 h-4 text-gray-400 animate-spin dark:text-gray-200" viewBox="0 0 100 101" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M100 50.5908C100 78.2051 77.6142 100.591 50 100.591C22.3858 100.591 0 78.2051 0 50.5908C0 22.9766 22.3858 0.59082 50 0.59082C77.6142 0.59082 100 22.9766 100 50.5908ZM9.0816 50.5908C9.0816 73.1895 27.4013 91.5092 50 91.5092C72.5987 91.5092 90.9184 73.1895 90.9184 50.5908C90.9184 27.9921 72.5987 9.67236 50 9.67236C27.4013 9.67236 9.0816 27.9921 9.0816 50.5908Z" fill="currentColor"/>
                                            <path d="M93.9676 39.0409C96.393 38.4038 97.8624 35.9116 97.0079 33.5539C95.2932 28.8227 92.871 24.3692 89.8167 20.348C85.8452 15.1192 80.8826 10.7232 75.2124 7.41289C69.5422 4.10256 63.2754 1.94025 56.7688 1.05119C51.7666 0.36701 46.6976 0.446843 41.7345 1.27873C39.3151 1.69328 37.861 4.19778 38.4981 6.62326C39.1352 9.04874 41.623 10.4717 44.0503 10.1071C47.8511 9.56066 51.7191 9.52616 55.5402 10.0073C60.8645 10.6587 65.9926 12.6238 70.6331 15.7926C75.2736 18.9614 79.3347 23.2528 82.5849 28.4031C84.9175 31.8856 88.1799 34.3365 91.675 35.5669C93.249 36.1214 94.4222 37.8603 93.9676 39.0409Z" fill="#1e40af"/>
                                        </svg>
                                    </div>
                                    <span class="qc-text"></span>
                                </span>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    {{ formset.empty_form.max_score.label }}
                                </label>
                                {{ formset.empty_form.max_score }}
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    {{ formset.empty_form.order.label }}
                                </label>
                                {{ formset.empty_form.order }}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Score Summary -->
                <div class="mt-4 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Total Skor:</span>
                        <span id="total-score" class="text-lg font-bold text-gray-900 dark:text-white">0</span>
                    </div>
                    <div class="mt-2">
                        <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-600">
                            <div id="score-progress" class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                        <div class="mt-1 text-xs text-gray-500 dark:text-gray-400 text-center">Target: 1000 poin</div>
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="flex justify-end space-x-4">
                <a href="{% url 'admin_package_list' %}" class="px-6 py-2 text-sm font-medium text-gray-700 bg-gray-200 border border-transparent rounded-lg hover:bg-gray-300 dark:bg-gray-600 dark:text-white dark:hover:bg-gray-500">
                    Batal
                </a>
                <button type="submit" class="px-6 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-lg hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 dark:bg-blue-600 dark:hover:bg-blue-700">
                    {% if package %}Perbarui Paket{% else %}Buat Paket{% endif %}
                </button>
            </div>
        </form>

    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Persist overwrite preference in localStorage
    try {
        const overwriteCheckbox = document.getElementById('auto-fill-overwrite');
        if(overwriteCheckbox){
            const saved = localStorage.getItem('admin_package_auto_fill_overwrite');
            if(saved === '1') overwriteCheckbox.checked = true;
            overwriteCheckbox.addEventListener('change', function(){
                try{ localStorage.setItem('admin_package_auto_fill_overwrite', this.checked ? '1' : '0'); } catch(e){}
            });
        }
    } catch(e) { console.warn('localStorage init failed', e); }
    window.updateScoreTotal = function() {
        let total = 0;
        document.querySelectorAll('input[name$="-max_score"]').forEach(function(input) {
            const value = parseFloat(input.value) || 0;
            total += value;
        });
        
        const totalElement = document.getElementById('total-score');
        const progressElement = document.getElementById('score-progress');
        
        totalElement.textContent = total;
        
        // Update progress bar
        const percentage = Math.min((total / 1000) * 100, 100);
        progressElement.style.width = percentage + '%';
        
        // Color coding
        if (Math.abs(total - 1000) < 0.01) {
            totalElement.className = 'text-lg font-bold text-green-600 dark:text-green-400';
            progressElement.className = 'bg-green-600 h-2.5 rounded-full transition-all duration-300';
        } else if (total > 1000) {
            totalElement.className = 'text-lg font-bold text-red-600 dark:text-red-400';
            progressElement.className = 'bg-red-600 h-2.5 rounded-full transition-all duration-300';
        } else {
            totalElement.className = 'text-lg font-bold text-yellow-600 dark:text-yellow-400';
            progressElement.className = 'bg-yellow-600 h-2.5 rounded-full transition-all duration-300';
        }
    }
    
    // Update score on input change
    document.addEventListener('input', function(e) {
        if (e.target.name && e.target.name.endsWith('-max_score')) {
            updateScoreTotal();
        }
    });
    
    // Delete category functionality
    document.addEventListener('click', function(e) {
        if (e.target.closest('.delete-category')) {
            const categoryForm = e.target.closest('.category-form');
            const deleteCheckbox = categoryForm.querySelector('input[name$="-DELETE"]');
            if (deleteCheckbox) {
                deleteCheckbox.checked = true;
                categoryForm.style.display = 'none';
                updateScoreTotal();
            }
        }
    });
    
    // Add category button behavior is implemented in the formset script below.
    // The earlier placeholder alert was removed to avoid forcing a page refresh.
    
    // Initial score calculation
    updateScoreTotal();
});
</script>
<script>
// Formset add/remove logic
document.addEventListener('DOMContentLoaded', function(){
    const addBtn = document.getElementById('add-category');
    const container = document.getElementById('category-forms');
    const emptyTemplate = document.getElementById('empty-category-form');
    const totalFormsInput = document.querySelector('input[name$="-TOTAL_FORMS"]');

    function getTotalForms(){
        return parseInt(totalFormsInput ? totalFormsInput.value : '0', 10);
    }

    function setTotalForms(v){
        if(totalFormsInput) totalFormsInput.value = String(v);
    }

    function renumber(container){
        // Keep TOTAL_FORMS equal to total number of form DOM elements (including ones marked for deletion)
        const allForms = Array.from(container.querySelectorAll('.category-form'));

        // Update name/id/for attributes for all forms so Django form indices remain consistent
        allForms.forEach((form, index) => {
            form.querySelectorAll('input, select, textarea, label').forEach(el => {
                if (el.name) el.name = el.name.replace(/-\d+-/g, '-' + index + '-').replace(/__prefix__/g, index);
                if (el.id) el.id = el.id.replace(/-\d+-/g, '-' + index + '-').replace(/__prefix__/g, index);
                if (el.getAttribute && el.getAttribute('for')) el.setAttribute('for', el.getAttribute('for').replace(/-\d+-/g, '-' + index + '-').replace(/__prefix__/g, index));
            });
        });

        // For user-visible labeling, use a static 'Subtest' label; if a form is marked for deletion, show it as deleted
    let visibleIndex = 0;
    allForms.forEach((form) => {
            const deleteInput = form.querySelector('input[name$="-DELETE"]');
            const isDeleted = deleteInput && deleteInput.checked;
            const heading = form.querySelector('h4');
                if (!isDeleted) {
                    visibleIndex += 1;
                    if (heading) heading.textContent = 'Subtest';
                } else {
                    if (heading) heading.textContent = 'Subtest (dihapus)';
                }
            });

            setTotalForms(allForms.length);
    }

        // Delegate change on category select to auto-fill question_count via AJAX
        // Works for existing and dynamically added rows because it's delegated on the container
        function handleCategoryChangeEvent(e){
            const target = e.target;
            if(!target || target.tagName.toLowerCase() !== 'select') return;
            if(!target.name || !target.name.endsWith('-category')) return;

            const value = target.value;
            const formDiv = target.closest('.category-form');
            if(!formDiv) return;

        const questionInput = formDiv.querySelector('input[name$="-question_count"]');
        const statusSpan = formDiv.querySelector('.qc-status');
            if(!questionInput) return;

            // Only auto-fill if the input is empty or zero
        const currentVal = questionInput.value && questionInput.value.trim() !== '' ? parseInt(questionInput.value, 10) : 0;
        // Read global overwrite setting; if checked, always overwrite
        const overwrite = !!document.getElementById('auto-fill-overwrite') && document.getElementById('auto-fill-overwrite').checked;
        if(currentVal > 0 && !overwrite) return; // don't override an explicitly set value unless overwrite is enabled

            if(!value){
                // no category selected -> clear
                questionInput.value = '';
                return;
            }

            // Fetch question count from API and show status
            const url = '/api/category/' + encodeURIComponent(value) + '/question-count/';
            if(statusSpan){
                const spinner = statusSpan.querySelector('.qc-spinner');
                const textElm = statusSpan.querySelector('.qc-text');
                if(spinner) spinner.classList.remove('hidden');
                if(textElm){ textElm.textContent = ''; textElm.className = 'qc-text'; }
                fetch(url, { method: 'GET', credentials: 'same-origin' })
                    .then(response => {
                        if(!response.ok) throw new Error('Network response was not ok');
                        return response.json();
                    })
                    .then(data => {
                        if(spinner) spinner.classList.add('hidden');
                        if(data && typeof data.count !== 'undefined'){
                            questionInput.value = String(data.count);
                            if(textElm){ textElm.textContent = ''; }
                        } else {
                            if(textElm){ textElm.textContent = '—'; textElm.classList.add('text-yellow-600'); }
                        }
                    })
                    .catch(err => {
                        if(spinner) spinner.classList.add('hidden');
                        if(textElm){ textElm.textContent = '×'; textElm.classList.add('text-red-600'); }
                        console.warn('Failed to fetch question count:', err);
                    });
                return; // fetch handled
            }

            // If no statusSpan (shouldn't happen), fallback to plain fetch
            fetch(url, { method: 'GET', credentials: 'same-origin' })
                .then(response => {
                    if(!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(data => {
                    if(data && typeof data.count !== 'undefined'){
                        questionInput.value = String(data.count);
                    }
                })
                .catch(err => {
                    console.warn('Failed to fetch question count:', err);
                });
        }

    if(addBtn && emptyTemplate && container && totalFormsInput){
        addBtn.addEventListener('click', function(){
            const idx = getTotalForms();
            const clone = emptyTemplate.firstElementChild.cloneNode(true);
            // replace __prefix__ markers in cloned HTML
            clone.innerHTML = clone.innerHTML.replace(/__prefix__/g, idx);
            // Append
            container.appendChild(clone);
            renumber(container);
            updateScoreTotal();
        });

        // Delegated listener for category select changes to auto-fill question_count
        container.addEventListener('change', function(e){
            handleCategoryChangeEvent(e);
        });

        // delegate delete
        container.addEventListener('click', function(e){
            const btn = e.target.closest('.delete-category');
            if(!btn) return;
            const formDiv = btn.closest('.category-form');
            if(!formDiv) return;
            // If this form has a DELETE checkbox, check it and hide
            const deleteInput = formDiv.querySelector('input[name$="-DELETE"]');
            if(deleteInput){
                deleteInput.checked = true;
                formDiv.style.display = 'none';
            } else {
                formDiv.remove();
                renumber(container);
            }
            updateScoreTotal();
        });
    }
});
</script>
{% endblock %}
