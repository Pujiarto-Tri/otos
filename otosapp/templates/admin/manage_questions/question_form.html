{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title|default:"Question Form" }}{% endblock %}

{% block extrahead %}
    <!-- Quill.js Rich Text Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    
    {% block extra_js %}
        {% include 'includes/_quill_init.html' %}
    {% endblock %}
                const formData = new FormData();
                formData.append('upload', file);
                formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
                
                const statusElement = document.getElementById(`choice-image-status-${choiceNumber}`);
                statusElement.textContent = 'Uploading...';
                statusElement.className = 'text-sm text-blue-600 dark:text-blue-400';
                
                fetch('/admin/image-upload/', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.url) {
                        // Update hidden input with image URL
                        document.getElementById(`choice-image-url-${choiceNumber}`).value = data.url;
                        
                        // Show preview
                        const previewContainer = document.getElementById(`choice-image-preview-${choiceNumber}`);
                        const previewImage = previewContainer.querySelector('img');
                        previewImage.src = data.url;
                        // responsive and interactive preview styles
                        previewImage.classList.add('max-w-full','h-auto','rounded-lg','cursor-zoom-in');
                        previewImage.onclick = function() {
                            const choiceLabel = String.fromCharCode(64 + choiceNumber); // Convert 1->A, 2->B, etc.
                            openImageModal(data.url, `Choice ${choiceLabel} Image`);
                        };
                        previewContainer.classList.remove('hidden');
                        
                        // Update status
                        statusElement.textContent = 'Image uploaded successfully';
                        statusElement.className = 'text-sm text-green-600 dark:text-green-400';
                        
                        // Update requirement state: if image exists, choice text is not required
                        if (typeof updateChoiceRequirements === 'function') updateChoiceRequirements();

                        showNotification('Choice image uploaded successfully!', 'success');
                    } else {
                        statusElement.textContent = 'Failed to upload image';
                        statusElement.className = 'text-sm text-red-600 dark:text-red-400';
                        showNotification('Failed to upload choice image', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    statusElement.textContent = 'Failed to upload image';
                    statusElement.className = 'text-sm text-red-600 dark:text-red-400';
                    showNotification('Failed to upload choice image', 'error');
                });
                
                // Clear the file input
                input.value = '';
            };

            // Remove Choice Image Function
            window.removeChoiceImage = function(choiceNumber) {
                try {
                    // Clear hidden input
                    const hiddenInput = document.getElementById(`choice-image-url-${choiceNumber}`);
                    if (hiddenInput) {
                        hiddenInput.value = '';
                    }
                    
                    // Clear file input
                    const fileInput = document.getElementById(`choice-image-${choiceNumber}`);
                    if (fileInput) {
                        fileInput.value = '';
                    }
                    
                    // Hide preview
                    const previewContainer = document.getElementById(`choice-image-preview-${choiceNumber}`);
                    if (previewContainer) {
                        previewContainer.classList.add('hidden');
                    }
                    
                    // Show upload area
                    const uploadArea = document.getElementById(`choice-upload-area-${choiceNumber}`);
                    if (uploadArea) {
                        uploadArea.classList.remove('hidden');
                    }
                    
                    // Clear status
                    const statusElement = document.getElementById(`choice-image-status-${choiceNumber}`);
                    if (statusElement) {
                        statusElement.textContent = '';
                        statusElement.className = 'mt-1 text-xs';
                    }
                    
                    showNotification('Choice image removed', 'success');
                    // Update requirement state after removing image
                    if (typeof updateChoiceRequirements === 'function') updateChoiceRequirements();
                } catch (error) {
                    console.error('Error removing choice image:', error);
                    showNotification('Error removing image', 'error');
                }

                    // For multiple choice, ensure each visible choice has text or image
                    const selectedType = document.querySelector('input[name="question_type"]:checked');
                    if (selectedType && selectedType.value === 'multiple_choice') {
                        const choiceItems = document.querySelectorAll('.choice-item');
                        for (let idx = 0; idx < choiceItems.length; idx++) {
                            const i = idx + 1;
                            const textField = document.querySelector(`#id_choices-${idx}-choice_text`);
                            const hiddenImageInput = document.getElementById(`choice-image-url-${i}`);
                            const textVal = textField ? textField.value.trim() : '';
                            const hasImage = hiddenImageInput && hiddenImageInput.value && hiddenImageInput.value.trim() !== '';
                            if (!textVal && !hasImage) {
                                e.preventDefault();
                                showNotification('Each choice must have text or an image', 'error');
                                if (textField) textField.focus();
                                return;
                            }
                        }
                    }
            };

            // Handle correct answer checkbox changes for visual feedback
            function handleCorrectAnswerChange(checkbox, choiceNumber) {
                const choiceItem = checkbox.closest('.choice-item');
                
                if (checkbox.checked) {
                    // Add comprehensive green styling for correct answer
                    choiceItem.classList.add('correct-answer');
                    
                    // Force remove default classes that might conflict
                    choiceItem.classList.remove('border-gray-200', 'dark:border-gray-600', 'bg-white', 'dark:bg-gray-800');
                    
                    // Add styling
                    choiceItem.style.border = '3px solid #10b981';
                    choiceItem.style.background = 'linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%)';
                    choiceItem.style.boxShadow = '0 8px 25px rgba(16, 185, 129, 0.3)';
                    choiceItem.style.transform = 'scale(1.02)';
                    
                    // Update header background
                    const choiceHeader = choiceItem.querySelector('.choice-header');
                    if (choiceHeader) {
                        choiceHeader.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                        choiceHeader.style.color = 'white';
                    }
                    
                    // Update badge
                    const badge = choiceItem.querySelector('.choice-badge');
                    if (badge) {
                        badge.style.background = 'rgba(255, 255, 255, 0.95)';
                        badge.style.color = '#059669';
                        badge.style.border = '2px solid white';
                        badge.style.fontWeight = 'bold';
                    }
                    
                    // Update status text
                    const statusText = choiceItem.querySelector('.choice-status');
                    if (statusText) {
                        statusText.textContent = 'âœ“ Correct Answer';
                        statusText.style.color = 'white';
                        statusText.style.fontWeight = '600';
                    }
                    
                    // Update header title color
                    const choiceTitle = choiceItem.querySelector('h4');
                    if (choiceTitle) {
                        choiceTitle.style.color = 'white';
                        choiceTitle.style.fontWeight = '700';
                    }
                    
                    // Update checkbox label color
                    const checkboxLabel = choiceItem.querySelector('label span');
                    if (checkboxLabel) {
                        checkboxLabel.style.color = 'white';
                        checkboxLabel.style.fontWeight = '500';
                    }
                    
                    // Update textarea
                    const textarea = choiceItem.querySelector('textarea');
                    if (textarea) {
                        textarea.style.border = '2px solid #10b981';
                        textarea.style.boxShadow = '0 0 0 3px rgba(16, 185, 129, 0.15)';
                    }
                } else {
                    // Remove correct answer styling
                    choiceItem.classList.remove('correct-answer');
                    
                    // Reset inline styles
                    choiceItem.style.border = '';
                    choiceItem.style.background = '';
                    choiceItem.style.boxShadow = '';
                    choiceItem.style.transform = '';
                    
                    // Reset header
                    const choiceHeader = choiceItem.querySelector('.choice-header');
                    if (choiceHeader) {
                        choiceHeader.style.background = '';
                        choiceHeader.style.color = '';
                    }
                    
                    // Reset badge
                    const badge = choiceItem.querySelector('.choice-badge');
                    if (badge) {
                        badge.style.background = '';
                        badge.style.color = '';
                        badge.style.border = '';
                        badge.style.fontWeight = '';
                    }
                    
                    // Reset status text
                    const statusText = choiceItem.querySelector('.choice-status');
                    if (statusText) {
                        statusText.textContent = 'Option';
                        statusText.style.color = '';
                        statusText.style.fontWeight = '';
                    }
                    
                    // Reset header title
                    const choiceTitle = choiceItem.querySelector('h4');
                    if (choiceTitle) {
                        choiceTitle.style.color = '';
                        choiceTitle.style.fontWeight = '';
                    }
                    
                    // Reset checkbox label
                    const checkboxLabel = choiceItem.querySelector('label span');
                    if (checkboxLabel) {
                        checkboxLabel.style.color = '';
                        checkboxLabel.style.fontWeight = '';
                    }
                    
                    // Reset textarea
                    const textarea = choiceItem.querySelector('textarea');
                    if (textarea) {
                        textarea.style.border = '';
                        textarea.style.boxShadow = '';
                    }
                }
            }

            // Initialize choice checkboxes function
            function initializeChoiceCheckboxes() {
                // Add event listeners to all correct answer checkboxes - try multiple selectors
                let checkboxes = document.querySelectorAll('input[name$="-is_correct"]'); // Formset pattern
                if (checkboxes.length === 0) {
                    checkboxes = document.querySelectorAll('input[name$="_is_correct"]'); // Alternative pattern
                }
                if (checkboxes.length === 0) {
                    checkboxes = document.querySelectorAll('.choice-checkbox'); // Class-based selector
                }
                if (checkboxes.length === 0) {
                    checkboxes = document.querySelectorAll('input[type="checkbox"]'); // All checkboxes
                }
                
                checkboxes.forEach((checkbox, index) => {
                    // Remove existing listeners to avoid duplicates
                    if (checkbox._choiceHandler) {
                        checkbox.removeEventListener('change', checkbox._choiceHandler);
                    }
                    
                    // Create new handler
                    checkbox._choiceHandler = function() {
                        handleCorrectAnswerChange(this, index + 1);
                    };
                    
                    checkbox.addEventListener('change', checkbox._choiceHandler);
                    
                    // Initialize state on page load
                    if (checkbox.checked) {
                        handleCorrectAnswerChange(checkbox, index + 1);
                    }
                });
            }

            // Initialize correct answer checkboxes on DOM ready
            document.addEventListener('DOMContentLoaded', function() {
                initializeChoiceCheckboxes();
                if (typeof updateChoiceRequirements === 'function') updateChoiceRequirements();
            });
            
            // Image Modal Functions
            window.openImageModal = function(imageSrc, imageTitle = 'Image Preview') {
                const modal = document.getElementById('imageModal');
                const modalImage = document.getElementById('modalImage');
                const modalTitle = document.getElementById('modal-title');
                
                if (imageSrc && imageSrc !== '') {
                    modalImage.src = imageSrc;
                    modalTitle.textContent = imageTitle;
                    modal.classList.remove('hidden');
                    document.body.style.overflow = 'hidden'; // Prevent background scrolling
                } else {
                    showNotification('No image to display', 'warning');
                }
            };
            
            window.closeImageModal = function() {
                const modal = document.getElementById('imageModal');
                modal.classList.add('hidden');
                document.body.style.overflow = ''; // Restore scrolling
            };
            
            // Close modal when clicking outside or pressing Escape
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    closeImageModal();
                }
            });
            
            // Prevent modal from closing when clicking on the image
            document.getElementById('modalImage').addEventListener('click', function(event) {
                event.stopPropagation();
            });
            
            // Notification system
            function showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `fixed top-4 right-4 z-50 px-4 py-3 rounded-lg shadow-lg max-w-sm ${getNotificationClasses(type)}`;
                notification.innerHTML = `
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            ${getNotificationIcon(type)}
                        </div>
                        <div class="ml-3">
                            <p class="text-sm font-medium">${message}</p>
                        </div>
                        <div class="ml-auto pl-3">
                            <button onclick="this.parentElement.parentElement.parentElement.remove()" class="inline-flex text-gray-400 hover:text-gray-600">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 5000);
            }
            
            function getNotificationClasses(type) {
                switch (type) {
                    case 'success':
                        return 'bg-green-50 border border-green-200 text-green-800 dark:bg-green-900/20 dark:border-green-800 dark:text-green-400';
                    case 'error':
                        return 'bg-red-50 border border-red-200 text-red-800 dark:bg-red-900/20 dark:border-red-800 dark:text-red-400';
                    case 'warning':
                        return 'bg-yellow-50 border border-yellow-200 text-yellow-800 dark:bg-yellow-900/20 dark:border-yellow-800 dark:text-yellow-400';
                    default:
                        return 'bg-blue-50 border border-blue-200 text-blue-800 dark:bg-blue-900/20 dark:border-blue-800 dark:text-blue-400';
                }
            }
            
            function getNotificationIcon(type) {
                switch (type) {
                    case 'success':
                        return '<svg class="w-5 h-5 text-green-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>';
                    case 'error':
                        return '<svg class="w-5 h-5 text-red-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>';
                    case 'warning':
                        return '<svg class="w-5 h-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>';
                    default:
                        return '<svg class="w-5 h-5 text-blue-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>';
                }
            }
            
            // Mobile-friendly enhancements
            if (window.innerWidth <= 768) {
                document.querySelectorAll('input, textarea, select').forEach(input => {
                    input.addEventListener('focus', function() {
                        setTimeout(() => {
                            this.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }, 300);
                    });
                });
            }
        });
    </script>
{% endblock %}
