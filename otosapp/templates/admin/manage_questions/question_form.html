{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title|default:"Question Form" }}{% endblock %}

{% block extrahead %}
    <!-- Flowbite WYSIWYG Editor -->
    <!-- Flowbite: UI components (relies on Tailwind) -->
    <script src="https://unpkg.com/flowbite@1.7.0/dist/flowbite.min.js"></script>
    <!-- MathJax Configuration (must be before MathJax script) -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true,
          tags: 'none'
        },
        options: {
          processHtmlClass: 'wysiwyg-editor|latex-formula|math-formula',
          ignoreHtmlClass: 'no-mathjax',
          skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        },
        chtml: {
          displayAlign: 'left',
          displayIndent: '0',
          scale: 1.0,
          minScale: 0.5,
          matchFontHeight: true,
          fontURL: 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/output/chtml/fonts/woff-v2'
        },
        startup: {
          ready: () => {
            MathJax.startup.defaultReady();
            // Re-render all math after page load
            setTimeout(() => {
              if (window.MathJax && window.MathJax.typesetPromise) {
                window.MathJax.typesetPromise().catch((err) => {});
              }
            }, 500);
          }
        }
      };
    </script>
    <!-- MathJax Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.min.js"></script>
    <style>
        .section-fade-in { animation: fadeIn 0.25s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }
        
        /* WYSIWYG Editor custom styles */
        .wysiwyg-editor {
            min-height: 200px;
        }
        
        /* Choice WYSIWYG editors have smaller min-height */
        [id^="wysiwyg-choice-text-"] {
            min-height: 100px;
        }
        
        .prose {
            max-width: none;
        }
        
        .prose p {
            margin-bottom: 1em;
        }
        
        .prose ul, .prose ol {
            margin: 1em 0;
            padding-left: 2em;
        }
        
        .prose blockquote {
            border-left: 4px solid #e5e7eb;
            padding-left: 1em;
            margin: 1em 0;
            font-style: italic;
        }
        
        .dark .prose blockquote {
            border-left-color: #6b7280;
        }
        
        /* Placeholder styling for empty WYSIWYG editors */
        [data-wysiwyg="true"].is-empty:before {
            content: attr(data-placeholder);
            color: #9ca3af;
            font-style: italic;
            pointer-events: none;
            position: absolute;
        }
        
        .dark [data-wysiwyg="true"].is-empty:before {
            color: #6b7280;
        }
        
        /* Ensure proper focus outline for accessibility */
        [data-wysiwyg="true"]:focus {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
        }
        
      /* LaTeX Formula Styling - Inline with text flow */
      .math-formula {
        display: inline !important;
        margin: 0 1px;
        padding: 2px 4px;
        background-color: #eff6ff;
        border: 1px solid #3b82f6;
        border-radius: 4px;
        font-size: 1em;
        vertical-align: baseline;
        cursor: pointer;
        user-select: none;
        white-space: nowrap;
        font-family: 'KaTeX_Main', 'Times New Roman', serif;
        line-height: 1.2;
        max-width: none;
      }
      
      .math-formula:hover {
        background-color: #dbeafe;
        border-color: #2563eb;
      }
      
      /* Dark mode math formula styling */
      .dark .math-formula {
        background-color: #1e3a8a;
        border-color: #3b82f6;
        color: #dbeafe;
      }
      
      .dark .math-formula:hover {
        background-color: #1e40af;
        border-color: #60a5fa;
      }
      
      /* Ensure math formulas don't break text flow */
      .wysiwyg-editor .math-formula {
        line-height: inherit;
        vertical-align: baseline;
      }
      
      /* MathJax output styling override */
      .math-formula .MathJax,
      .math-formula .MathJax_Display {
        display: inline !important;
        margin: 0 !important;
        padding: 0 !important;
        text-align: left !important;
      }        /* Legacy LaTeX formula styling (for backward compatibility) */
        .latex-formula, .math-display {
          display: inline-block;
          margin: 2px 5px;
          padding: 4px 8px;
          background-color: #f0f9ff;
          border: 1px solid #0ea5e9;
          border-radius: 4px;
          min-height: 24px;
          vertical-align: middle;
          cursor: pointer;
          user-select: none; /* Prevent text selection issues */
          position: relative;
          z-index: 1;
        }
        
        .latex-formula:hover, .math-display:hover {
          background-color: #e0f2fe;
          border-color: #0284c7;
        }
        
        /* Dark mode LaTeX styling */
        .dark .latex-formula, .dark .math-display {
          background-color: #1e3a8a;
          border-color: #3b82f6;
          color: #dbeafe;
        }
        
        .dark .latex-formula:hover, .dark .math-display:hover {
          background-color: #1e40af;
          border-color: #60a5fa;
        }
        
        /* Ensure LaTeX doesn't break editor flow */
        .wysiwyg-editor .latex-formula,
        .wysiwyg-editor .math-display {
          white-space: nowrap;
          overflow: hidden;
        }
        
        /* Format toolbar button active states */
        [data-wysiwyg-toggle-format].active {
            background-color: #dbeafe;
            color: #1e40af;
        }
        
        .dark [data-wysiwyg-toggle-format].active {
            background-color: #1e3a8a;
            color: #bfdbfe;
        }

        /* Image resizing and dragging styles */
        .image-resizer {
            position: relative;
            display: inline-block;
            border: 2px dashed transparent;
            transition: border-color 0.2s ease;
        }
        
        .image-resizer:hover {
            border-color: #3b82f6;
        }
        
        .image-resizer.selected {
            border-color: #1d4ed8;
            background-color: rgba(59, 130, 246, 0.1);
        }
        
        .resize-handle {
            position: absolute;
            background: #3b82f6;
            border: 2px solid white;
            border-radius: 50%;
            width: 12px;
            height: 12px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s ease;
            z-index: 10;
        }
        
        .image-resizer.selected .resize-handle {
            opacity: 1;
        }
        
        .resize-handle.nw {
            top: -6px;
            left: -6px;
            cursor: nw-resize;
        }
        
        .resize-handle.ne {
            top: -6px;
            right: -6px;
            cursor: ne-resize;
        }
        
        .resize-handle.sw {
            bottom: -6px;
            left: -6px;
            cursor: sw-resize;
        }
        
        .resize-handle.se {
            bottom: -6px;
            right: -6px;
            cursor: se-resize;
        }
        
        .resize-handle.n {
            top: -6px;
            left: 50%;
            transform: translateX(-50%);
            cursor: n-resize;
        }
        
        .resize-handle.s {
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
            cursor: s-resize;
        }
        
        .resize-handle.e {
            right: -6px;
            top: 50%;
            transform: translateY(-50%);
            cursor: e-resize;
        }
        
        .resize-handle.w {
            left: -6px;
            top: 50%;
            transform: translateY(-50%);
            cursor: w-resize;
        }
        
        .crop-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            pointer-events: none;
            z-index: 5;
        }
        
        .crop-area {
            position: absolute;
            border: 2px dashed #fff;
            background: transparent;
            min-width: 20px;
            min-height: 20px;
            cursor: move;
            pointer-events: all;
            z-index: 6;
        }
        
        .crop-handle {
            position: absolute;
            background: #fff;
            border: 2px solid #3b82f6;
            width: 10px;
            height: 10px;
            z-index: 7;
        }
        
        .crop-handle.nw { top: -5px; left: -5px; cursor: nw-resize; }
        .crop-handle.ne { top: -5px; right: -5px; cursor: ne-resize; }
        .crop-handle.sw { bottom: -5px; left: -5px; cursor: sw-resize; }
        .crop-handle.se { bottom: -5px; right: -5px; cursor: se-resize; }
        
        .image-edit-toolbar {
            position: absolute;
            top: -40px;
            left: 0;
            background: rgba(0, 0, 0, 0.8);
            padding: 5px 10px;
            border-radius: 5px;
            opacity: 0;
            transition: opacity 0.2s ease;
            z-index: 15;
        }
        
        .image-resizer.selected .image-edit-toolbar {
            opacity: 1;
        }
        
        /* Enhanced styling for selected image wrapper */
        .image-resizer.selected {
            border-color: #3B82F6 !important;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        
        /* Ensure toolbar is properly positioned and visible */
        .image-edit-toolbar {
            pointer-events: auto;
            user-select: none;
        }
        
        .image-edit-toolbar button {
            pointer-events: auto;
        }
        
        .toolbar-btn {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 3px 6px;
            margin: 0 2px;
            border-radius: 3px;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .toolbar-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
        }

        /* Text inputs and textareas */
        textarea,
        input[type="text"],
        select {
            background: #ffffff;
            color: #1f2937;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 0.75rem;
            font-size: 14px;
            transition: border-color 0.2s ease-in-out;
        }

        .dark textarea,
        .dark input[type="text"],
        .dark select {
            background: #1f2937;
            color: #f9fafb;
            border-color: #4b5563;
        }

        textarea:focus,
        input[type="text"]:focus,
        select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        textarea::placeholder,
        input[type="text"]::placeholder {
            color: #9ca3af;
        }

        .dark textarea::placeholder,
        .dark input[type="text"]::placeholder {
            color: #6b7280;
        }

        /* Choice checkbox styling */
        .choice-checkbox:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
        }

        .dark .choice-checkbox {
            border-color: #4b5563;
            background-color: #374151;
        }

        /* Correct answer visual states */
        .choice-item.correct-answer {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border: 3px solid #10b981;
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
            transform: scale(1.02);
        }

        .choice-item.correct-answer .choice-header {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .choice-item.correct-answer .wysiwyg-editor {
            border: 2px solid #10b981;
            background-color: rgba(255, 255, 255, 0.98);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.15);
        }

        .dark .choice-item.correct-answer .wysiwyg-editor {
            background-color: rgba(31, 41, 55, 0.98);
        }

        /* Dark theme adjustments for correct answer (softer, more readable) */
        .dark .choice-item.correct-answer {
            background: rgba(6, 95, 70, 0.22);
            border-color: #059669;
            box-shadow: 0 8px 18px rgba(5, 150, 105, 0.18);
        }

        .dark .choice-item.correct-answer .choice-header {
            background: linear-gradient(135deg, #065f46 0%, #047857 100%);
            color: #e5fff4;
        }

        .dark .choice-item.correct-answer .choice-status,
        .dark .choice-item.correct-answer h4 {
            color: #e5fff4;
        }

        .dark .choice-item.correct-answer .choice-badge {
            background-color: #059669;
            color: #ecfdf5;
        }

        /* Layout and small animations */
        .choice-item { 
            transition: all 0.2s ease-in-out; 
        }
        
        .choice-item:hover { 
            transform: translateY(-1px); 
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); 
        }

        /* Modal and thumbnail */
        #imageModal { 
            backdrop-filter: blur(4px); 
        }
        
        #modalImage { 
            transition: transform 0.2s ease-in-out; 
            cursor: zoom-in; 
        }
        
        #modalImage:hover { 
            transform: scale(1.02); 
        }
        
        .choice-item img { 
            transition: all 0.2s ease-in-out; 
        }
        
        .choice-item img:hover { 
            transform: scale(1.05); 
            box-shadow: 0 4px 20px rgba(0,0,0,0.15); 
        }

        /* Responsive tweaks */
        @media (max-width: 768px) {
            .wysiwyg-editor { 
                min-height: 180px; 
            }
            .choice-item { 
                padding: 0.5rem; 
            }
        }

        /* Dark mode adjustments for previews */
        .dark #imageModal .modal-panel { 
            background-color: #0f172a; 
        }
        
        .dark .choice-item img { 
            box-shadow: 0 4px 14px rgba(255,255,255,0.03); 
        }
        
        /* Optional choice styling */
        .choice-item.optional {
            opacity: 0.8;
            border-style: dashed !important;
        }
        
        .choice-item.optional .choice-header {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        }
        
        .dark .choice-item.optional .choice-header {
            background: linear-gradient(135deg, #374151 0%, #4b5563 100%);
        }
        
        .choice-item.optional:hover {
            opacity: 1;
        }
    </style>
{% endblock %}

{% block content %}
<!-- Include Question Header Component -->
<section class="bg-gray-50 dark:bg-gray-900 p-3 sm:p-5 antialiased">
    <div class="mx-auto max-w-screen-xl px-4 lg:px-12">
        {% with header_title=page_title|default:"Question Form" header_subtitle=page_subtitle show_back_button=True header_icon='<svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>' %}
            {% include 'admin/manage_questions/includes/question_header.html' %}
        {% endwith %}

    <div class="bg-white dark:bg-gray-800 relative shadow-md sm:rounded-lg overflow-hidden question-form-card">
        <div class="p-6">
            <div class="max-w-4xl mx-auto">
                <!-- Error Messages -->
                {% if form.errors %}
                    <div class="mb-6 bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg dark:bg-red-900/20 dark:border-red-800 dark:text-red-400">
                                    <div class="flex">
                                        <div class="flex-shrink-0">
                                            <svg class="h-5 w-5 text-red-400" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                                            </svg>
                                        </div>
                                        <div class="ml-3">
                                            <h3 class="text-sm font-medium">Please fix the following errors:</h3>
                                            <div class="mt-2 text-sm">
                                                <ul class="list-disc pl-5 space-y-1">
                                                    {% for field, errors in form.errors.items %}
                                                        {% for error in errors %}
                                                            <li>{{ field|capfirst }}: {{ error }}</li>
                                                        {% endfor %}
                                                    {% endfor %}
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}

                            <!-- Form -->
                            <form method="post" class="space-y-6">
                                {% csrf_token %}
                                
                                <!-- Question Content -->
                                <div class="bg-white dark:bg-gray-800 shadow-sm rounded-lg border border-gray-200 dark:border-gray-700">
                                    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                                        <h3 class="text-lg font-medium text-gray-900 dark:text-white">Question Content</h3>
                                        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                                            {% if question %}Update your question content using the rich text editor{% else %}Enter your question content using the rich text editor{% endif %}
                                        </p>
                                    </div>
                                    <div class="px-6 py-4">
                                        <div class="mb-4 p-4 border border-gray-200 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700">
                                            <label for="id_question_text" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                                Question Text
                                                <span class="text-red-500">*</span>
                                            </label>
                                            
                                            <!-- Flowbite WYSIWYG Editor for Question Text -->
                                            <div class="w-full mb-4 border border-gray-200 rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600">
                                                <div class="flex items-center justify-between px-3 py-2 border-b dark:border-gray-600">
                                                    <div class="flex flex-wrap items-center divide-gray-200 sm:divide-x sm:rtl:divide-x-reverse dark:divide-gray-600">
                                                        <div class="flex items-center space-x-1 rtl:space-x-reverse sm:pe-4">
                                                            <button type="button" data-tooltip-target="tooltip-bold-admin" data-wysiwyg-toggle-format="bold" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5h4.5a3.5 3.5 0 1 1 0 7H8m0-7v7m0-7H6m2 7h6.5a3.5 3.5 0 1 1 0 7H8m0-7v7m0 0H6"/>
                                                                </svg>
                                                                <span class="sr-only">Bold</span>
                                                            </button>
                                                            <div id="tooltip-bold-admin" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                Bold
                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                            </div>
                                                            <button type="button" data-tooltip-target="tooltip-italic-admin" data-wysiwyg-toggle-format="italic" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m8.874 19 6.143-14M6 19h6.33m-.66-14H18"/>
                                                                </svg>
                                                                <span class="sr-only">Italic</span>
                                                            </button>
                                                            <div id="tooltip-italic-admin" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                Italic
                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                            </div>
                                                            <button type="button" data-tooltip-target="tooltip-underline-admin" data-wysiwyg-toggle-format="underline" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                                    <path stroke="currentColor" stroke-linecap="round" stroke-width="2" d="M6 19h12M8 5v9a4 4 0 0 0 8 0V5M6 5h4m4 0h4"/>
                                                                </svg>
                                                                <span class="sr-only">Underline</span>
                                                            </button>
                                                            <div id="tooltip-underline-admin" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                Underline
                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                            </div>
                                                        </div>
                                                        <div class="flex flex-wrap items-center space-x-1 rtl:space-x-reverse sm:ps-4">
                                                            <button type="button" data-tooltip-target="tooltip-list-admin" data-wysiwyg-toggle-format="unorderedList" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                                    <path stroke="currentColor" stroke-linecap="round" stroke-width="2" d="M9 8h10M9 12h10M9 16h10M4.99 8H5m-.02 4h.01m0 4H5"/>
                                                                </svg>
                                                                <span class="sr-only">Bullet list</span>
                                                            </button>
                                                            <div id="tooltip-list-admin" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                Bullet list
                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                            </div>
                                                            <button type="button" data-tooltip-target="tooltip-ordered-list-admin" data-wysiwyg-toggle-format="orderedList" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6h8m-8 6h8m-8 6h8M4 16a2 2 0 1 1 3.321 1.5L4 20h5M4 5l2-1v6m-2 0h4"/>
                                                                </svg>
                                                                <span class="sr-only">Ordered list</span>
                                                            </button>
                                                            <div id="tooltip-ordered-list-admin" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                Ordered list
                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                            </div>
                                                            <button type="button" data-tooltip-target="tooltip-blockquote-admin" data-wysiwyg-toggle-format="blockquote" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                                                                    <path fill-rule="evenodd" d="M6 6a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1.5L6 16.5v.5h3l2-3.5V11a2 2 0 0 0-2-2H6Zm7 0a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1.5L13 16.5v.5h3l2-3.5V11a2 2 0 0 0-2-2h-3Z" clip-rule="evenodd"/>
                                                                </svg>
                                                                <span class="sr-only">Blockquote</span>
                                                            </button>
                                                            <div id="tooltip-blockquote-admin" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                Blockquote
                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                            </div>
                                                            
                                                            <!-- Separator -->
                                                            <div class="w-px h-6 bg-gray-300 dark:bg-gray-600 mx-1"></div>
                                                            
                                                            <!-- Image Upload Button -->
                                                            <button type="button" data-tooltip-target="tooltip-image-admin" data-wysiwyg-action="image" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                                                                    <path fill-rule="evenodd" d="M13 10a1 1 0 0 1 1-1h.01a1 1 0 1 1 0 2H14a1 1 0 0 1-1-1Z" clip-rule="evenodd"/>
                                                                    <path fill-rule="evenodd" d="M2 6a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v12c0 .556-.227 1.06-.593 1.422A.999.999 0 0 1 20.5 20H4a2.002 2.002 0 0 1-2-2V6Zm6.892 12 3.833-5.356-3.99-4.322a1 1 0 0 0-1.549.097L4 12.879V6h16v9.95l-3.257-3.619a1 1 0 0 0-1.557.088L11.2 18H8.892Z" clip-rule="evenodd"/>
                                                                </svg>
                                                                <span class="sr-only">Upload Image</span>
                                                            </button>
                                                            <div id="tooltip-image-admin" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                Upload Image
                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                            </div>

                                                            <!-- Math Symbols Button -->
                                                            <button type="button" data-tooltip-target="tooltip-math-admin" data-wysiwyg-action="math-symbols" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                                                                    <path d="M9 7H7v2H5V7H3V5h2V3h2v2h2v2Zm2 12h10v-2H11v2Zm0-4h10v-2H11v2Zm0-4h10V9H11v2Z"/>
                                                                </svg>
                                                                <span class="sr-only">Math Symbols</span>
                                                            </button>
                                                            <div id="tooltip-math-admin" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                Insert Math Symbols
                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                            </div>

                                                            <!-- LaTeX Formula Button -->
                                                            <button type="button" data-tooltip-target="tooltip-latex-admin" data-wysiwyg-action="latex" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                                                                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                                                                </svg>
                                                                <span class="sr-only">LaTeX Formula</span>
                                                            </button>
                                                            <div id="tooltip-latex-admin" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                Insert LaTeX Formula
                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                            </div>

                                                            <!-- LaTeX Guide Button -->
                                                            <button type="button" data-tooltip-target="tooltip-latex-guide-admin" data-wysiwyg-action="latex-guide" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
                                                                    <path d="M10 2C5.58 2 2 5.58 2 10s3.58 8 8 8 8-3.58 8-8-3.58-8-8-8zm1 13h-2v-2h2v2zm0-3h-2V7h2v5z"/>
                                                                </svg>
                                                                <span class="sr-only">LaTeX Guide</span>
                                                            </button>
                                                            <div id="tooltip-latex-guide-admin" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                LaTeX Guide
                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="px-4 py-2 bg-white rounded-b-lg dark:bg-gray-800">
                                                    <div id="wysiwyg-question-text-admin" data-wysiwyg="true" contenteditable="true" class="prose dark:prose-invert block w-full px-0 text-sm text-gray-800 bg-white border-0 dark:bg-gray-800 focus:ring-0 dark:text-white dark:placeholder-gray-400 wysiwyg-editor" data-placeholder="Type your question here...">{{ form.question_text.value|default:"" }}</div>
                                                </div>
                                            </div>
                                            
                                            <!-- Hidden textarea for form submission -->
                                            <textarea id="id_question_text" name="question_text" class="hidden">{{ form.question_text.value|default:"" }}</textarea>
                                            
                                            {% if form.question_text.errors %}
                                                {% for error in form.question_text.errors %}
                                                    <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ error }}</p>
                                                {% endfor %}
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <!-- Question Type and Category (swapped: Weight config now on the left) -->
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                    <!-- Weight Configuration (moved here) -->
                                    <div class="bg-white dark:bg-gray-800 shadow-sm rounded-lg border border-gray-200 dark:border-gray-700">
                                        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                                            <h3 class="text-lg font-medium text-gray-900 dark:text-white">Weight Configuration</h3>
                                        </div>
                                        <div class="px-6 py-4">
                                            <label for="id_custom_weight" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                                Custom Weight (Optional)
                                            </label>
                                            {{ form.custom_weight }}
                                            {% if form.custom_weight.help_text %}
                                                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">{{ form.custom_weight.help_text }}</p>
                                            {% endif %}
                                            {% if form.custom_weight.errors %}
                                                {% for error in form.custom_weight.errors %}
                                                    <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ error }}</p>
                                                {% endfor %}
                                            {% endif %}
                                        </div>
                                    </div>

                                    <!-- Category -->
                                    <div class="bg-white dark:bg-gray-800 shadow-sm rounded-lg border border-gray-200 dark:border-gray-700">
                                        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                                            <h3 class="text-lg font-medium text-gray-900 dark:text-white">Category</h3>
                                        </div>
                                        <div class="px-6 py-4">
                                            <label for="id_category" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                                Question Category
                                                <span class="text-red-500">*</span>
                                            </label>
                                            {{ form.category }}
                                            <input type="hidden" id="id_category_hidden" name="category">
                                            <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">Category dikunci agar tidak dapat diubah.</p>
                                            <script>
                                            (function() {
                                                var categorySelect = document.getElementById('id_category');
                                                if (categorySelect) {
                                                    categorySelect.setAttribute('disabled', 'disabled');
                                                    if (categorySelect.classList) {
                                                        categorySelect.classList.add('bg-gray-100', 'cursor-not-allowed', 'opacity-60', 'dark:bg-gray-700', 'dark:text-gray-300', 'dark:placeholder-gray-400', 'dark:border-gray-600');
                                                    }
                                                    var hiddenInput = document.getElementById('id_category_hidden');
                                                    if (hiddenInput) {
                                                        hiddenInput.value = categorySelect.value;
                                                    }
                                                }
                                            })();
                                            </script>
                                            {% if form.category.errors %}
                                                {% for error in form.category.errors %}
                                                    <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ error }}</p>
                                                {% endfor %}
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <!-- Question Type (moved here and redesigned as selectable cards) -->
                                <div class="bg-white dark:bg-gray-800 shadow-sm rounded-lg border border-gray-200 dark:border-gray-700">
                                    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                                        <h3 class="text-lg font-medium text-gray-900 dark:text-white">Question Type</h3>
                                    </div>
                                    <div class="px-6 py-4">
                                        <fieldset>
                                            <legend class="sr-only">Question Type</legend>
                                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4" id="questionTypeCards">
                                                {% for choice in form.question_type %}
                                                    <label for="{{ choice.id_for_label }}" class="question-type-card group block border rounded-lg p-4 cursor-pointer transition-all duration-150 border-gray-200 dark:border-gray-700 hover:border-primary-400 dark:hover:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500 dark:focus:ring-primary-400">
                                                        <div class="flex items-start">
                                                            <div class="mt-1">
                                                                {{ choice.tag|safe }}
                                                            </div>
                                                            <div class="ml-3">
                                                                <div class="js-type-title text-sm font-medium text-gray-900 dark:text-white">{{ choice.choice_label }}</div>
                                                                <div class="mt-1 text-xs text-gray-600 dark:text-gray-400 js-type-desc">Pilih tipe pertanyaan yang sesuai.</div>
                                                            </div>
                                                        </div>
                                                    </label>
                                                {% endfor %}
                                            </div>
                                        </fieldset>
                                        <script>
                                            (function() {
                                                var radios = document.querySelectorAll('input[name="question_type"]');
                                                var descMap = {
                                                    'multiple_choice': 'Cocok untuk soal pilihan ganda dengan beberapa opsi jawaban.',
                                                    'essay': 'Jawaban berupa teks esai yang dinilai sesuai kebijakan penilaian.'
                                                };
                                                function refreshCards() {
                                                    radios.forEach(function(radio) {
                                                        var label = document.querySelector('label[for="' + radio.id + '"]');
                                                        if (!label) return;
                                                        var desc = label.querySelector('.js-type-desc');
                                                        var title = label.querySelector('.js-type-title');
                                                        var text = descMap[radio.value] || 'Pilih tipe pertanyaan yang sesuai.';
                                                        if (desc) desc.textContent = text;
                                                        if (radio.checked) {
                                                            label.classList.add('ring-2','ring-primary-500','border-primary-400','bg-primary-100','dark:bg-primary-800/40','dark:border-primary-500','dark:ring-primary-400');
                                                            if (title) {
                                                                title.classList.add('text-gray-900','dark:text-white');
                                                            }
                                                            if (desc) {
                                                                desc.classList.add('text-gray-700','dark:text-gray-300');
                                                                desc.classList.remove('text-gray-600','dark:text-gray-400');
                                                            }
                                                        } else {
                                                            label.classList.remove('ring-2','ring-primary-500','border-primary-400','bg-primary-100','dark:bg-primary-800/40','dark:border-primary-500','dark:ring-primary-400');
                                                            if (desc) {
                                                                desc.classList.remove('text-gray-700','dark:text-gray-300');
                                                                desc.classList.add('text-gray-600','dark:text-gray-400');
                                                            }
                                                        }
                                                    });
                                                }
                                                radios.forEach(function(radio) {
                                                    // Make the native radio visually hidden but accessible via label card
                                                    radio.classList.add('sr-only');
                                                    radio.addEventListener('change', refreshCards);
                                                });
                                                refreshCards();
                                            })();
                                        </script>
                                        {% if form.question_type.help_text %}
                                            <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">{{ form.question_type.help_text }}</p>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- Multiple Choice Options -->
                                <div id="choicesSection" class="bg-white dark:bg-gray-800 shadow-sm rounded-lg border border-gray-200 dark:border-gray-700" style="display: none;">
                                    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <h3 class="text-lg font-medium text-gray-900 dark:text-white">Answer Choices</h3>
                                                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                                                    {% if question %}Update multiple choice options for this question{% else %}Add multiple choice options for this question{% endif %}
                                                    <br><span class="text-blue-600 dark:text-blue-400">• Minimum 2 choices required (A & B must be filled)</span>
                                                    <br><span class="text-gray-400">• Choices C, D, E are optional</span>
                                                </p>
                                            </div>
                                            <div class="flex items-center space-x-4 text-xs text-gray-500 dark:text-gray-400">
                                                <div class="flex items-center space-x-2">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                    </svg>
                                                    <span>Select at least one correct answer</span>
                                                </div>
                                                <div class="flex items-center space-x-2">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                                                    </svg>
                                                    <span id="choice-counter" class="text-red-500">0/5 choices filled</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="px-6 py-6">
                                        {{ formset.management_form }}
                                        
                                        <div id="choice-forms" class="space-y-4">
                                            {% for form in formset %}
                                                <div class="choice-item relative group border-2 border-gray-200 dark:border-gray-600 rounded-xl overflow-hidden transition-all duration-200 hover:border-primary-300 dark:hover:border-primary-500 {% if form.is_correct.value %}correct-answer{% endif %}{% if forloop.counter > 2 %} optional{% endif %}" data-choice="{{ forloop.counter }}">
                                                    {% for hidden in form.hidden_fields %}{{ hidden }}{% endfor %}
                                                    
                                                    <!-- Choice Header with Letter Badge -->
                                                    <div class="choice-header flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-700/50 border-b border-gray-200 dark:border-gray-600">
                                                        <div class="flex items-center space-x-3">
                                                            <!-- Choice Letter Badge -->
                                                            <div class="choice-badge flex items-center justify-center w-10 h-10 rounded-full font-bold text-lg {% if form.is_correct.value %}bg-green-600 text-white dark:bg-emerald-600 dark:text-emerald-50{% else %}bg-primary-100 text-primary-700 dark:bg-primary-900 dark:text-primary-300{% endif %}">
                                                                {% if forloop.counter == 1 %}A{% elif forloop.counter == 2 %}B{% elif forloop.counter == 3 %}C{% elif forloop.counter == 4 %}D{% elif forloop.counter == 5 %}E{% endif %}
                                                            </div>
                                                            
                                                            <!-- Choice Title -->
                                                            <div>
                                                                <h4 class="text-lg font-semibold {% if form.is_correct.value %}text-white font-bold dark:text-emerald-50{% else %}text-gray-900 dark:text-white{% endif %}">
                                                                    Choice {% if forloop.counter == 1 %}A{% elif forloop.counter == 2 %}B{% elif forloop.counter == 3 %}C{% elif forloop.counter == 4 %}D{% elif forloop.counter == 5 %}E{% endif %}
                                                                </h4>
                                                                <p class="choice-status text-sm {% if form.is_correct.value %}text-white font-medium dark:text-emerald-50{% else %}text-gray-500 dark:text-gray-400{% endif %}">
                                                                    {% if form.is_correct.value %}✓ Correct Answer{% else %}Option{% endif %}
                                                                </p>
                                                            </div>
                                                        </div>
                                                        
                                                        <!-- Correct Answer Toggle -->
                                                        <div class="flex items-center space-x-3">
                                                            <!-- Hidden checkbox for form submission -->
                                                            <div class="hidden">{{ form.is_correct }}</div>
                                                            
                                                            <!-- Button to toggle correct answer -->
                                                            <button type="button" 
                                                                    class="correct-answer-btn px-4 py-2 rounded-lg font-medium text-sm transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 {% if form.is_correct.value %}bg-green-600 text-white border-green-600 focus:ring-green-500 hover:bg-green-700{% else %}bg-gray-100 text-gray-700 border-gray-300 hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600 dark:hover:bg-gray-600 focus:ring-gray-500{% endif %}"
                                                                    data-choice-number="{{ forloop.counter }}"
                                                                    onclick="toggleCorrectAnswer(this, {{ forloop.counter }})">
                                                                <div class="flex items-center space-x-2">
                                                                    <svg class="w-4 h-4 {% if form.is_correct.value %}block{% else %}hidden{% endif %} check-icon" fill="currentColor" viewBox="0 0 20 20">
                                                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                                                    </svg>
                                                                    <svg class="w-4 h-4 {% if form.is_correct.value %}hidden{% else %}block{% endif %} plus-icon" fill="currentColor" viewBox="0 0 20 20">
                                                                        <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
                                                                    </svg>
                                                                    <span class="button-text">{% if form.is_correct.value %}Correct Answer{% else %}Mark as Correct{% endif %}</span>
                                                                </div>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Choice Content -->
                                                    <div class="p-4">
                                                        <!-- Choice Text with WYSIWYG Editor -->
                                                        <div>
                                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                                                Choice Text {% if forloop.counter <= 2 %}<span id="choice-text-req-{{ forloop.counter }}" class="text-red-500">*</span>{% else %}<span class="text-gray-400 text-xs">(Optional)</span>{% endif %}
                                                            </label>
                                                            
                                                            <!-- Flowbite WYSIWYG Editor for Choice -->
                                                            <div class="w-full mb-4 border border-gray-200 rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600">
                                                                <div class="flex items-center justify-between px-3 py-2 border-b dark:border-gray-600">
                                                                    <div class="flex flex-wrap items-center divide-gray-200 sm:divide-x sm:rtl:divide-x-reverse dark:divide-gray-600">
                                                                        <div class="flex items-center space-x-1 rtl:space-x-reverse sm:pe-4">
                                                                            <button type="button" data-tooltip-target="tooltip-bold-choice-{{ forloop.counter }}" data-wysiwyg-toggle-format="bold" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                                                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5h4.5a3.5 3.5 0 1 1 0 7H8m0-7v7m0-7H6m2 7h6.5a3.5 3.5 0 1 1 0 7H8m0-7v7m0 0H6"/>
                                                                                </svg>
                                                                                <span class="sr-only">Bold</span>
                                                                            </button>
                                                                            <div id="tooltip-bold-choice-{{ forloop.counter }}" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                                Bold
                                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                                            </div>
                                                                            <button type="button" data-tooltip-target="tooltip-italic-choice-{{ forloop.counter }}" data-wysiwyg-toggle-format="italic" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                                                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m8.874 19 6.143-14M6 19h6.33m-.66-14H18"/>
                                                                                </svg>
                                                                                <span class="sr-only">Italic</span>
                                                                            </button>
                                                                            <div id="tooltip-italic-choice-{{ forloop.counter }}" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                                Italic
                                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                                            </div>
                                                                            <button type="button" data-tooltip-target="tooltip-underline-choice-{{ forloop.counter }}" data-wysiwyg-toggle-format="underline" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                                                    <path stroke="currentColor" stroke-linecap="round" stroke-width="2" d="M6 19h12M8 5v9a4 4 0 0 0 8 0V5M6 5h4m4 0h4"/>
                                                                                </svg>
                                                                                <span class="sr-only">Underline</span>
                                                                            </button>
                                                                            <div id="tooltip-underline-choice-{{ forloop.counter }}" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                                Underline
                                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                                            </div>
                                                                        </div>
                                                                        <div class="flex flex-wrap items-center space-x-1 rtl:space-x-reverse sm:ps-4">
                                                                            <button type="button" data-tooltip-target="tooltip-list-choice-{{ forloop.counter }}" data-wysiwyg-toggle-format="unorderedList" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                                                    <path stroke="currentColor" stroke-linecap="round" stroke-width="2" d="M9 8h10M9 12h10M9 16h10M4.99 8H5m-.02 4h.01m0 4H5"/>
                                                                                </svg>
                                                                                <span class="sr-only">Bullet list</span>
                                                                            </button>
                                                                            <div id="tooltip-list-choice-{{ forloop.counter }}" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                                Bullet list
                                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                                            </div>
                                                                            <button type="button" data-tooltip-target="tooltip-ordered-list-choice-{{ forloop.counter }}" data-wysiwyg-toggle-format="orderedList" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                                                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6h8m-8 6h8m-8 6h8M4 16a2 2 0 1 1 3.321 1.5L4 20h5M4 5l2-1v6m-2 0h4"/>
                                                                                </svg>
                                                                                <span class="sr-only">Ordered list</span>
                                                                            </button>
                                                                            <div id="tooltip-ordered-list-choice-{{ forloop.counter }}" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                                Ordered list
                                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                                            </div>
                                                                            <button type="button" data-tooltip-target="tooltip-blockquote-choice-{{ forloop.counter }}" data-wysiwyg-toggle-format="blockquote" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                                                                                    <path fill-rule="evenodd" d="M6 6a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1.5L6 16.5v.5h3l2-3.5V11a2 2 0 0 0-2-2H6Zm7 0a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1.5L13 16.5v.5h3l2-3.5V11a2 2 0 0 0-2-2h-3Z" clip-rule="evenodd"/>
                                                                                </svg>
                                                                                <span class="sr-only">Blockquote</span>
                                                                            </button>
                                                                            <div id="tooltip-blockquote-choice-{{ forloop.counter }}" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                                Blockquote
                                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                                            </div>
                                                                            
                                                                            <!-- Separator -->
                                                                            <div class="w-px h-6 bg-gray-300 dark:bg-gray-600 mx-1"></div>
                                                                            
                                                                            <!-- Image Upload Button -->
                                                                            <button type="button" data-tooltip-target="tooltip-image-choice-{{ forloop.counter }}" data-wysiwyg-action="image" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                                                                                    <path fill-rule="evenodd" d="M13 10a1 1 0 0 1 1-1h.01a1 1 0 1 1 0 2H14a1 1 0 0 1-1-1Z" clip-rule="evenodd"/>
                                                                                    <path fill-rule="evenodd" d="M2 6a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v12c0 .556-.227 1.06-.593 1.422A.999.999 0 0 1 20.5 20H4a2.002 2.002 0 0 1-2-2V6Zm6.892 12 3.833-5.356-3.99-4.322a1 1 0 0 0-1.549.097L4 12.879V6h16v9.95l-3.257-3.619a1 1 0 0 0-1.557.088L11.2 18H8.892Z" clip-rule="evenodd"/>
                                                                                </svg>
                                                                                <span class="sr-only">Upload Image</span>
                                                                            </button>
                                                                            <div id="tooltip-image-choice-{{ forloop.counter }}" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                                Upload Image
                                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                                            </div>

                                                                            <!-- Math Symbols Button -->
                                                                            <button type="button" data-tooltip-target="tooltip-math-choice-{{ forloop.counter }}" data-wysiwyg-action="math-symbols" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                                                                                    <path d="M9 7H7v2H5V7H3V5h2V3h2v2h2v2Zm2 12h10v-2H11v2Zm0-4h10v-2H11v2Zm0-4h10V9H11v2Z"/>
                                                                                </svg>
                                                                                <span class="sr-only">Math Symbols</span>
                                                                            </button>
                                                                            <div id="tooltip-math-choice-{{ forloop.counter }}" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                                Insert Math Symbols
                                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                                            </div>

                                                                            <!-- LaTeX Formula Button -->
                                                                            <button type="button" data-tooltip-target="tooltip-latex-choice-{{ forloop.counter }}" data-wysiwyg-action="latex" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                                                                                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                                                                                </svg>
                                                                                <span class="sr-only">LaTeX Formula</span>
                                                                            </button>
                                                                            <div id="tooltip-latex-choice-{{ forloop.counter }}" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                                Insert LaTeX Formula
                                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                                            </div>

                                                                            <!-- LaTeX Guide Button -->
                                                                            <button type="button" data-tooltip-target="tooltip-latex-guide-choice-{{ forloop.counter }}" data-wysiwyg-action="latex-guide" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
                                                                                    <path d="M10 2C5.58 2 2 5.58 2 10s3.58 8 8 8 8-3.58 8-8-3.58-8-8-8zm1 13h-2v-2h2v2zm0-3h-2V7h2v5z"/>
                                                                                </svg>
                                                                                <span class="sr-only">LaTeX Guide</span>
                                                                            </button>
                                                                            <div id="tooltip-latex-guide-choice-{{ forloop.counter }}" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                                LaTeX Guide
                                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div class="px-4 py-2 bg-white rounded-b-lg dark:bg-gray-800">
                                                                    <div id="wysiwyg-choice-text-{{ forloop.counter }}" 
                                                                         data-wysiwyg="true" 
                                                                         data-placeholder="Enter choice text..."
                                                                         contenteditable="true" 
                                                                         class="wysiwyg-editor prose max-w-none text-sm text-gray-900 dark:text-white focus:outline-none min-h-[100px] p-2 border-0">
                                                                        {% if form.choice_text.value %}{{ form.choice_text.value|safe }}{% endif %}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            
                                                            <!-- Hidden textarea for form submission -->
                                                            <div class="hidden">{{ form.choice_text }}</div>
                                                            
                                                            <!-- Legacy Image Display -->
                                                            {% if form.instance.choice_image %}
                                                            <div class="mt-3 p-3 bg-yellow-50 border border-yellow-200 rounded-lg dark:bg-yellow-900/20 dark:border-yellow-800">
                                                                <div class="flex items-start space-x-3">
                                                                    <div class="flex-shrink-0">
                                                                        <svg class="w-5 h-5 text-yellow-600 dark:text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                                                                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                                                        </svg>
                                                                    </div>
                                                                    <div class="flex-1">
                                                                        <h4 class="text-sm font-medium text-yellow-800 dark:text-yellow-200">Legacy Image Found</h4>
                                                                        <p class="text-sm text-yellow-700 dark:text-yellow-300 mt-1">This choice contains an image uploaded using the old system. For new images, please use the image upload button in the editor above.</p>
                                                                        <div class="mt-2">
                                                                            <img src="{{ form.instance.choice_image.url }}" 
                                                                                 alt="Legacy choice image" 
                                                                                 class="max-w-xs h-auto rounded-lg border border-yellow-300 cursor-pointer hover:border-blue-400 transition-all duration-200 legacy-image"
                                                                                 data-original-url="{{ form.instance.choice_image.url }}"
                                                                                 onclick="showLegacyImageOptions(this)">
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            {% endif %}
                                                            
                                                            {% if form.choice_text.errors %}
                                                                {% for error in form.choice_text.errors %}
                                                                    <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ error }}</p>
                                                                {% endfor %}
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>

                                <!-- Essay Answer Section -->
                                <div id="essayAnswerSection" class="bg-white dark:bg-gray-800 shadow-sm rounded-lg border border-gray-200 dark:border-gray-700" style="display: none;">
                                    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                                        <h3 class="text-lg font-medium text-gray-900 dark:text-white">Expected Answer</h3>
                                        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Provide the expected answer or key points for this essay question</p>
                                    </div>
                                    <div class="px-6 py-4">
                                        <label for="id_correct_answer_text" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                            Expected Answer
                                        </label>
                                        {{ form.correct_answer_text }}
                                        {% if form.correct_answer_text.help_text %}
                                            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">{{ form.correct_answer_text.help_text }}</p>
                                        {% endif %}
                                        {% if form.correct_answer_text.errors %}
                                            {% for error in form.correct_answer_text.errors %}
                                                <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ error }}</p>
                                            {% endfor %}
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- Explanation / Pembahasan (optional) -->
                                <div class="bg-white dark:bg-gray-800 shadow-sm rounded-lg border border-gray-200 dark:border-gray-700">
                                    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                                        <h3 class="text-lg font-medium text-gray-900 dark:text-white">Pembahasan Jawaban (Opsional)</h3>
                                        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                                            Tambahkan penjelasan mengapa jawabannya seperti itu. Kosongkan jika tidak diperlukan.
                                        </p>
                                    </div>
                                    <div class="px-6 py-4">
                                        <div class="mb-4 p-4 border border-gray-200 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700">
                                            <label for="id_explanation" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                                Pembahasan
                                            </label>
                                            
                                            <!-- Flowbite WYSIWYG Editor for Explanation -->
                                            <div class="w-full mb-4 border border-gray-200 rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600">
                                                <div class="flex items-center justify-between px-3 py-2 border-b dark:border-gray-600">
                                                    <div class="flex flex-wrap items-center divide-gray-200 sm:divide-x sm:rtl:divide-x-reverse dark:divide-gray-600">
                                                        <div class="flex items-center space-x-1 rtl:space-x-reverse sm:pe-4">
                                                            <button type="button" data-tooltip-target="tooltip-bold-exp-admin" data-wysiwyg-toggle-format="bold" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5h4.5a3.5 3.5 0 1 1 0 7H8m0-7v7m0-7H6m2 7h6.5a3.5 3.5 0 1 1 0 7H8m0-7v7m0 0H6"/>
                                                                </svg>
                                                                <span class="sr-only">Bold</span>
                                                            </button>
                                                            <div id="tooltip-bold-exp-admin" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                Bold
                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                            </div>
                                                            <button type="button" data-tooltip-target="tooltip-italic-exp-admin" data-wysiwyg-toggle-format="italic" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m8.874 19 6.143-14M6 19h6.33m-.66-14H18"/>
                                                                </svg>
                                                                <span class="sr-only">Italic</span>
                                                            </button>
                                                            <div id="tooltip-italic-exp-admin" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                Italic
                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                            </div>
                                                            <button type="button" data-tooltip-target="tooltip-underline-exp-admin" data-wysiwyg-toggle-format="underline" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                                    <path stroke="currentColor" stroke-linecap="round" stroke-width="2" d="M6 19h12M8 5v9a4 4 0 0 0 8 0V5M6 5h4m4 0h4"/>
                                                                </svg>
                                                                <span class="sr-only">Underline</span>
                                                            </button>
                                                            <div id="tooltip-underline-exp-admin" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                Underline
                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                            </div>
                                                        </div>
                                                        <div class="flex flex-wrap items-center space-x-1 rtl:space-x-reverse sm:ps-4">
                                                            <button type="button" data-tooltip-target="tooltip-list-exp-admin" data-wysiwyg-toggle-format="unorderedList" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                                    <path stroke="currentColor" stroke-linecap="round" stroke-width="2" d="M9 8h10M9 12h10M9 16h10M4.99 8H5m-.02 4h.01m0 4H5"/>
                                                                </svg>
                                                                <span class="sr-only">Bullet list</span>
                                                            </button>
                                                            <div id="tooltip-list-exp-admin" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                Bullet list
                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                            </div>
                                                            <button type="button" data-tooltip-target="tooltip-ordered-list-exp-admin" data-wysiwyg-toggle-format="orderedList" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6h8m-8 6h8m-8 6h8M4 16a2 2 0 1 1 3.321 1.5L4 20h5M4 5l2-1v6m-2 0h4"/>
                                                                </svg>
                                                                <span class="sr-only">Ordered list</span>
                                                            </button>
                                                            <div id="tooltip-ordered-list-exp-admin" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                Ordered list
                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                            </div>
                                                            <button type="button" data-tooltip-target="tooltip-blockquote-exp-admin" data-wysiwyg-toggle-format="blockquote" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                                                                    <path fill-rule="evenodd" d="M6 6a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1.5L6 16.5v.5h3l2-3.5V11a2 2 0 0 0-2-2H6Zm7 0a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1.5L13 16.5v.5h3l2-3.5V11a2 2 0 0 0-2-2h-3Z" clip-rule="evenodd"/>
                                                                </svg>
                                                                <span class="sr-only">Blockquote</span>
                                                            </button>
                                                            <div id="tooltip-blockquote-exp-admin" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                Blockquote
                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                            </div>
                                                            
                                                            <!-- Separator -->
                                                            <div class="w-px h-6 bg-gray-300 dark:bg-gray-600 mx-1"></div>
                                                            
                                                            <!-- Image Upload Button -->
                                                            <button type="button" data-tooltip-target="tooltip-image-exp-admin" data-wysiwyg-action="image" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                                                                    <path fill-rule="evenodd" d="M13 10a1 1 0 0 1 1-1h.01a1 1 0 1 1 0 2H14a1 1 0 0 1-1-1Z" clip-rule="evenodd"/>
                                                                    <path fill-rule="evenodd" d="M2 6a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v12c0 .556-.227 1.06-.593 1.422A.999.999 0 0 1 20.5 20H4a2.002 2.002 0 0 1-2-2V6Zm6.892 12 3.833-5.356-3.99-4.322a1 1 0 0 0-1.549.097L4 12.879V6h16v9.95l-3.257-3.619a1 1 0 0 0-1.557.088L11.2 18H8.892Z" clip-rule="evenodd"/>
                                                                </svg>
                                                                <span class="sr-only">Upload Image</span>
                                                            </button>
                                                            <div id="tooltip-image-exp-admin" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                Upload Image
                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                            </div>

                                                            <!-- Math Symbols Button -->
                                                            <button type="button" data-tooltip-target="tooltip-math-exp-admin" data-wysiwyg-action="math-symbols" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                                                                    <path d="M9 7H7v2H5V7H3V5h2V3h2v2h2v2Zm2 12h10v-2H11v2Zm0-4h10v-2H11v2Zm0-4h10V9H11v2Z"/>
                                                                </svg>
                                                                <span class="sr-only">Math Symbols</span>
                                                            </button>
                                                            <div id="tooltip-math-exp-admin" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                Insert Math Symbols
                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                            </div>

                                                            <!-- LaTeX Formula Button -->
                                                            <button type="button" data-tooltip-target="tooltip-latex-exp-admin" data-wysiwyg-action="latex" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                                                                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                                                                </svg>
                                                                <span class="sr-only">LaTeX Formula</span>
                                                            </button>
                                                            <div id="tooltip-latex-exp-admin" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                Insert LaTeX Formula
                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                            </div>

                                                            <!-- LaTeX Guide Button -->
                                                            <button type="button" data-tooltip-target="tooltip-latex-guide-exp-admin" data-wysiwyg-action="latex-guide" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
                                                                    <path d="M10 2C5.58 2 2 5.58 2 10s3.58 8 8 8 8-3.58 8-8-3.58-8-8-8zm1 13h-2v-2h2v2zm0-3h-2V7h2v5z"/>
                                                                </svg>
                                                                <span class="sr-only">LaTeX Guide</span>
                                                            </button>
                                                            <div id="tooltip-latex-guide-exp-admin" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                LaTeX Guide
                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="px-4 py-2 bg-white rounded-b-lg dark:bg-gray-800">
                                                    <div id="wysiwyg-explanation-admin" data-wysiwyg="true" contenteditable="true" class="prose dark:prose-invert block w-full px-0 text-sm text-gray-800 bg-white border-0 dark:bg-gray-800 focus:ring-0 dark:text-white dark:placeholder-gray-400 wysiwyg-editor" data-placeholder="Tulis pembahasan (opsional)...">{{ form.explanation.value|default:"" }}</div>
                                                </div>
                                            </div>
                                            
                                            <!-- Hidden textarea for form submission -->
                                            <textarea id="id_explanation" name="explanation" class="hidden">{{ form.explanation.value|default:"" }}</textarea>
                                            
                                            {% if form.explanation.errors %}
                                                {% for error in form.explanation.errors %}
                                                    <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ error }}</p>
                                                {% endfor %}
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <!-- Submit Button -->
                                <div class="flex justify-end space-x-3 pt-6 border-t border-gray-200 dark:border-gray-700">
                                    <a href="{% url 'question_list' %}" class="bg-white dark:bg-gray-800 py-2 px-4 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                                        Cancel
                                    </a>
                                    <button type="submit" class="bg-primary-600 py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors duration-200">
                                        {% if question %}Update Question{% else %}Create Question{% endif %}
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Image Modal -->
<div id="imageModal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
        <!-- Background overlay -->
        <div class="fixed inset-0 bg-black bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closeImageModal()"></div>
        
        <!-- Modal panel -->
        <div class="relative inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full">
            <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <!-- Modal Header -->
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white" id="modal-title">
                        Image Preview
                    </h3>
                    <button type="button" 
                            onclick="closeImageModal()" 
                            class="bg-white dark:bg-gray-800 rounded-md text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                        <span class="sr-only">Close</span>
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                
                <!-- Modal Content -->
                <div class="mt-3 text-center sm:mt-0 sm:text-left">
                    <div class="mt-2 flex justify-center">
                        <img id="modalImage" 
                             src="" 
                             alt="Preview" 
                             class="max-w-full max-h-96 h-auto rounded-lg border border-gray-200 dark:border-gray-600 shadow-lg">
                    </div>
                </div>
            </div>
            
            <!-- Modal Footer -->
            <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" 
                        onclick="closeImageModal()" 
                        class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-primary-600 text-base font-medium text-white hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 sm:ml-3 sm:w-auto sm:text-sm">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Math Symbols Modal -->
<div id="mathSymbolsModal" tabindex="-1" aria-hidden="true" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
  <div class="relative p-4 w-full max-w-4xl max-h-full">
    <!-- Modal content -->
    <div class="relative bg-white rounded-lg shadow dark:bg-gray-700">
      <!-- Modal header -->
      <div class="flex items-center justify-between p-4 md:p-5 border-b rounded-t dark:border-gray-600">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
          Math Symbols
        </h3>
        <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white" onclick="closeMathSymbolsModal()">
          <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
          </svg>
          <span class="sr-only">Close modal</span>
        </button>
      </div>
      <!-- Modal body -->
      <div class="p-4 md:p-5 space-y-4">
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
          
          <!-- Operasi Dasar -->
          <div class="space-y-2">
            <h4 class="font-medium text-gray-900 dark:text-white">Operasi Dasar</h4>
            <div class="grid grid-cols-4 gap-2">
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="+">+</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="−">−</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="×">×</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="÷">÷</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="=">= </button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="≠">≠</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="±">±</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="∓">∓</button>
            </div>
          </div>

          <!-- Perbandingan -->
          <div class="space-y-2">
            <h4 class="font-medium text-gray-900 dark:text-white">Perbandingan</h4>
            <div class="grid grid-cols-4 gap-2">
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="<"><</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol=">">></button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="≤">≤</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="≥">≥</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="≈">≈</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="≡">≡</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="∝">∝</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="∞">∞</button>
            </div>
          </div>

          <!-- Eksponen & Akar -->
          <div class="space-y-2">
            <h4 class="font-medium text-gray-900 dark:text-white">Eksponen & Akar</h4>
            <div class="grid grid-cols-4 gap-2">
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="²">²</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="³">³</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="ⁿ">ⁿ</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="√">√</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="∛">∛</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="∜">∜</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="ⁱ">ⁱ</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="ᵏ">ᵏ</button>
            </div>
          </div>

          <!-- Pecahan & Desimal -->
          <div class="space-y-2">
            <h4 class="font-medium text-gray-900 dark:text-white">Pecahan</h4>
            <div class="grid grid-cols-4 gap-2">
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="½">½</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="⅓">⅓</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="⅔">⅔</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="¼">¼</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="¾">¾</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="⅕">⅕</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="⅖">⅖</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="⅘">⅘</button>
            </div>
          </div>

          <!-- Trigonometri -->
          <div class="space-y-2">
            <h4 class="font-medium text-gray-900 dark:text-white">Trigonometri</h4>
            <div class="grid grid-cols-2 gap-2">
              <button type="button" class="math-symbol-btn p-2 text-sm border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="sin">sin</button>
              <button type="button" class="math-symbol-btn p-2 text-sm border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="cos">cos</button>
              <button type="button" class="math-symbol-btn p-2 text-sm border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="tan">tan</button>
              <button type="button" class="math-symbol-btn p-2 text-sm border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="cot">cot</button>
              <button type="button" class="math-symbol-btn p-2 text-sm border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="sec">sec</button>
              <button type="button" class="math-symbol-btn p-2 text-sm border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="csc">csc</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="°">°</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="π">π</button>
            </div>
          </div>

          <!-- Logaritma -->
          <div class="space-y-2">
            <h4 class="font-medium text-gray-900 dark:text-white">Logaritma</h4>
            <div class="grid grid-cols-2 gap-2">
              <button type="button" class="math-symbol-btn p-2 text-sm border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="log">log</button>
              <button type="button" class="math-symbol-btn p-2 text-sm border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="ln">ln</button>
              <button type="button" class="math-symbol-btn p-2 text-sm border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="lg">lg</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="e">e</button>
            </div>
          </div>

          <!-- Himpunan -->
          <div class="space-y-2">
            <h4 class="font-medium text-gray-900 dark:text-white">Himpunan</h4>
            <div class="grid grid-cols-4 gap-2">
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="∈">∈</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="∉">∉</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="⊂">⊂</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="⊃">⊃</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="∪">∪</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="∩">∩</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="∅">∅</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="ℕ">ℕ</button>
            </div>
          </div>

          <!-- Lainnya -->
          <div class="space-y-2">
            <h4 class="font-medium text-gray-900 dark:text-white">Lainnya</h4>
            <div class="grid grid-cols-4 gap-2">
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="∑">∑</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="∏">∏</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="∫">∫</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="∂">∂</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="∆">∆</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="∇">∇</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="α">α</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="β">β</button>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Fix checkbox duplication issue and ensure proper naming
  console.log('[DEBUG] Fixing checkbox duplication...');
  for (let i = 0; i < 5; i++) {
    const checkboxes = document.querySelectorAll(`input[name="choices-${i}-is_correct"]`);
    console.log(`Found ${checkboxes.length} checkboxes for choices-${i}-is_correct`);
    
    if (checkboxes.length > 1) {
      // Keep the Django-generated one (usually has proper ID) and remove others
      let djangoCheckbox = null;
      let toRemove = [];
      
      checkboxes.forEach(cb => {
        if (cb.id && cb.id.includes('id_choices')) {
          djangoCheckbox = cb;
        } else {
          toRemove.push(cb);
        }
      });
      
      // Remove duplicates
      toRemove.forEach(cb => cb.remove());
      
      // If no Django checkbox found, keep the first one
      if (!djangoCheckbox && checkboxes.length > 0) {
        djangoCheckbox = checkboxes[0];
        for (let j = 1; j < checkboxes.length; j++) {
          checkboxes[j].remove();
        }
      }
      
      console.log(`Kept checkbox for choices-${i}-is_correct:`, djangoCheckbox ? djangoCheckbox.id : 'NONE');
    }
  }
  
  // Verify final state
  console.log('[DEBUG] Final checkbox verification:');
  for (let i = 0; i < 5; i++) {
    const checkbox = document.querySelector(`input[name="choices-${i}-is_correct"]`);
    console.log(`Choice ${i+1}: ${checkbox ? 'HAS CHECKBOX' : 'NO CHECKBOX'} - ${checkbox ? checkbox.name : 'N/A'}`);
  }

  // Initialize Flowbite WYSIWYG editors
  const questionEditor = document.querySelector('#wysiwyg-question-text-admin');
  const explanationEditor = document.querySelector('#wysiwyg-explanation-admin');
  const questionTextarea = document.querySelector('#id_question_text');
  const explanationTextarea = document.querySelector('#id_explanation');

  // Flowbite WYSIWYG Editor initialization
  function initializeWysiwygEditor(editor, textarea) {
    if (!editor || !textarea) return;

    // Set initial content
    if (textarea.value) {
      editor.innerHTML = textarea.value;
    }

    // Handle placeholder display
    function updatePlaceholder() {
      const isEmpty = editor.innerHTML.trim() === '' || editor.innerHTML === '<br>' || editor.innerHTML === '<p><br></p>';
      if (isEmpty) {
        editor.classList.add('is-empty');
      } else {
        editor.classList.remove('is-empty');
      }
    }

    // Sync content to hidden textarea
    function syncContent() {
      textarea.value = editor.innerHTML;
      updatePlaceholder();
    }

    // Event listeners
    editor.addEventListener('input', syncContent);
    editor.addEventListener('paste', function(e) {
      setTimeout(syncContent, 10); // Allow paste to complete
    });
    editor.addEventListener('focus', updatePlaceholder);
    editor.addEventListener('blur', function() {
      updatePlaceholder();
      // Clean up empty paragraphs
      if (editor.innerHTML === '<p><br></p>' || editor.innerHTML === '<br>') {
        editor.innerHTML = '';
      }
      syncContent();
    });
    
    // Additional sync on keyup for better reliability
    editor.addEventListener('keyup', function() {
      setTimeout(syncContent, 100);
    });

    // Initial placeholder check
    updatePlaceholder();
    
    // Initial sync to ensure content is properly set
    syncContent();

    return {
      getContent: () => editor.innerHTML,
      setContent: (content) => {
        editor.innerHTML = content;
        syncContent();
      }
    };
  }

  // Initialize both editors
  const questionWysiwyg = initializeWysiwygEditor(questionEditor, questionTextarea);
  const explanationWysiwyg = initializeWysiwygEditor(explanationEditor, explanationTextarea);

  // Initialize choice editors
  const choiceEditors = {};
  for (let i = 1; i <= 5; i++) {
    const choiceEditor = document.querySelector(`#wysiwyg-choice-text-${i}`);
    const choiceTextarea = document.querySelector(`#id_choices-${i-1}-choice_text`);
    
    if (choiceEditor && choiceTextarea) {
      choiceEditors[i] = initializeWysiwygEditor(choiceEditor, choiceTextarea);
      
      // Add real-time validation for choices
      choiceEditor.addEventListener('input', function() {
        validateChoiceRequirements(i);
      });
      choiceEditor.addEventListener('blur', function() {
        validateChoiceRequirements(i);
      });
    }
  }
  
            // Global function to sync all WYSIWYG content to textareas
            window.syncAllWysiwygContent = function() {
                // Sync question content
                const questionEditor = document.querySelector('#wysiwyg-question-text-admin');
                const questionTextarea = document.querySelector('#id_question_text');
                if (questionEditor && questionTextarea) {
                    questionTextarea.value = cleanContentForSaving(questionEditor.innerHTML);
                }
                
                // Sync explanation content
                const explanationEditor = document.querySelector('#wysiwyg-explanation-text-admin');
                const explanationTextarea = document.querySelector('#id_explanation');
                if (explanationEditor && explanationTextarea) {
                    explanationTextarea.value = cleanContentForSaving(explanationEditor.innerHTML);
                }
                
                // Sync all choice editors
                for (let i = 1; i <= 5; i++) {
                    const choiceEditor = document.querySelector(`#wysiwyg-choice-text-${i}`);
                    const choiceTextarea = document.querySelector(`#id_choices-${i-1}-choice_text`);
                    
                    if (choiceEditor && choiceTextarea) {
                        let htmlContent = cleanContentForSaving(choiceEditor.innerHTML);
                        
                        // Get text content to check if it's truly empty
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = htmlContent;
                        const textContent = tempDiv.textContent || tempDiv.innerText || '';
                        
                        // Clean up empty WYSIWYG content (just empty tags)
                        if (!textContent.trim()) {
                            htmlContent = '';
                        }
                        
                        choiceTextarea.value = htmlContent;
                    }
                }
            };
            
            // Function to clean content before saving (removes toolbar elements)
            function cleanContentForSaving(htmlContent) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = htmlContent;
                
                // Remove all toolbar elements by class
                tempDiv.querySelectorAll('.image-edit-toolbar').forEach(toolbar => toolbar.remove());
                
                // Remove all image resizer wrappers but keep the images
                tempDiv.querySelectorAll('.image-resizer').forEach(resizer => {
                    const img = resizer.querySelector('img');
                    if (img) {
                        // Move image out of resizer wrapper
                        resizer.parentNode.insertBefore(img, resizer);
                    }
                    resizer.remove();
                });
                
                // Remove any toolbar buttons by onclick attributes
                tempDiv.querySelectorAll('button[onclick*="resizeImagePercent"]').forEach(btn => btn.remove());
                tempDiv.querySelectorAll('button[onclick*="removeImageFromResizer"]').forEach(btn => btn.remove());
                
                // Remove any toolbar buttons by class
                tempDiv.querySelectorAll('.toolbar-btn').forEach(btn => btn.remove());
                
                // Remove any remaining button elements that might be toolbar related
                tempDiv.querySelectorAll('button').forEach(btn => {
                    const btnText = btn.textContent.trim();
                    // Remove buttons with resize percentages or × symbol
                    if (btnText.match(/^(25%|50%|75%|100%|×)$/)) {
                        btn.remove();
                    }
                });
                
                // Remove resize handles and related divs
                tempDiv.querySelectorAll('.resize-handle').forEach(handle => handle.remove());
                tempDiv.querySelectorAll('[class*="resize-handle"]').forEach(handle => handle.remove());
                tempDiv.querySelectorAll('.resizable-image').forEach(wrapper => {
                    const img = wrapper.querySelector('img');
                    if (img) {
                        wrapper.parentNode.insertBefore(img, wrapper);
                    }
                    wrapper.remove();
                });
                
                // More aggressive text cleaning - remove text nodes with toolbar patterns
                const walker = document.createTreeWalker(
                    tempDiv,
                    NodeFilter.SHOW_TEXT,
                    null,
                    false
                );
                
                const textNodes = [];
                let node;
                while (node = walker.nextNode()) {
                    textNodes.push(node);
                }
                
                textNodes.forEach(textNode => {
                    let text = textNode.textContent;
                    // Remove various toolbar text patterns
                    text = text.replace(/\b25%\s*50%\s*75%\s*100%\s*×\s*/g, '');
                    text = text.replace(/\b25%\s*50%\s*75%\s*100%\s*/g, '');
                    text = text.replace(/\b25%\s*/g, '');
                    text = text.replace(/\b50%\s*/g, '');
                    text = text.replace(/\b75%\s*/g, '');
                    text = text.replace(/\b100%\s*/g, '');
                    text = text.replace(/\s*×\s*/g, '');
                    text = text.replace(/^\s*25%\s*50%\s*75%\s*100%\s*×.*$/, '');
                    
                    // Clean up extra whitespace
                    text = text.replace(/\s+/g, ' ').trim();
                    
                    if (text !== textNode.textContent) {
                        if (text === '') {
                            textNode.remove();
                        } else {
                            textNode.textContent = text;
                        }
                    }
                });
                
                // Final cleanup of HTML content as string
                let cleanedHTML = tempDiv.innerHTML;
                
                // Remove any remaining toolbar text patterns in HTML
                cleanedHTML = cleanedHTML.replace(/25%\s*50%\s*75%\s*100%\s*×/g, '');
                cleanedHTML = cleanedHTML.replace(/25%\s*50%\s*75%\s*100%/g, '');
                cleanedHTML = cleanedHTML.replace(/\b(25%|50%|75%|100%)\s*/g, '');
                cleanedHTML = cleanedHTML.replace(/\s*×\s*/g, '');
                
                // Clean up empty elements and extra whitespace
                cleanedHTML = cleanedHTML.replace(/<(\w+)[^>]*>\s*<\/\1>/g, '');
                cleanedHTML = cleanedHTML.replace(/>\s+</g, '><');
                cleanedHTML = cleanedHTML.trim();
                
                return cleanedHTML;
            }  // Real-time choice validation function
  function validateChoiceRequirements(choiceNumber) {
    const choiceEditor = document.querySelector(`#wysiwyg-choice-text-${choiceNumber}`);
    const choiceItem = choiceEditor?.closest('.choice-item');
    const requiredSpan = document.querySelector(`#choice-text-req-${choiceNumber}`);
    
    if (!choiceEditor || !choiceItem) return;
    
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = choiceEditor.innerHTML.trim();
    const textContent = tempDiv.textContent || tempDiv.innerText || '';
    const hasContent = textContent.trim() !== '';
    
    // Check if this choice is marked as correct but has no content
    const correctCheckbox = choiceItem.querySelector('input[name$="-is_correct"]');
    if (correctCheckbox && correctCheckbox.checked && !hasContent) {
      // Automatically uncheck the correct answer if content is removed
      correctCheckbox.checked = false;
      
      // Update button appearance
      const correctButton = choiceItem.querySelector('.correct-answer-btn');
      if (correctButton) {
        updateCorrectAnswerButton(correctButton, false);
      }
      
      // Remove correct answer styling
      handleCorrectAnswerChange(correctCheckbox, choiceNumber);
      
      // Show notification
      showNotification(`Choice ${String.fromCharCode(64 + choiceNumber)} is no longer marked as correct since it has no content`, 'info');
    }
    
    // Update visual feedback for required choices (A & B)
    if (choiceNumber <= 2) {
      if (hasContent) {
        choiceItem.classList.remove('border-red-300', 'dark:border-red-600');
        choiceItem.classList.add('border-green-300', 'dark:border-green-600');
        if (requiredSpan) {
          requiredSpan.classList.remove('text-red-500');
          requiredSpan.classList.add('text-green-500');
        }
      } else {
        choiceItem.classList.remove('border-green-300', 'dark:border-green-600');
        choiceItem.classList.add('border-red-300', 'dark:border-red-600');
        if (requiredSpan) {
          requiredSpan.classList.remove('text-green-500');
          requiredSpan.classList.add('text-red-500');
        }
      }
    }
    
    // Update choice counter display
    updateChoiceCounter();
  }
  
  // Function to update choice counter
  function updateChoiceCounter() {
    let filledChoices = 0;
    for (let i = 1; i <= 5; i++) {
      const choiceEditor = document.querySelector(`#wysiwyg-choice-text-${i}`);
      if (choiceEditor) {
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = choiceEditor.innerHTML.trim();
        const textContent = tempDiv.textContent || tempDiv.innerText || '';
        if (textContent.trim()) {
          filledChoices++;
        }
      }
    }
    
    // Find and update counter display (if exists)
    const counterDisplay = document.querySelector('#choice-counter');
    if (counterDisplay) {
      counterDisplay.textContent = `${filledChoices}/5 choices filled`;
      if (filledChoices >= 2) {
        counterDisplay.classList.remove('text-red-500');
        counterDisplay.classList.add('text-green-500');
      } else {
        counterDisplay.classList.remove('text-green-500');
        counterDisplay.classList.add('text-red-500');
      }
    }
  }

  // Flowbite WYSIWYG Toolbar functionality
  function initializeToolbar() {
    const formatButtons = document.querySelectorAll('[data-wysiwyg-toggle-format]');
    
    formatButtons.forEach((button, index) => {
      
      button.addEventListener('click', function(e) {
        e.preventDefault();
        const format = this.getAttribute('data-wysiwyg-toggle-format');
        
        // Find the associated editor - look for the parent container with border class
        const toolbar = this.closest('[class*="border"]');
        const editorContainer = toolbar ? toolbar.closest('.bg-white, .dark\\:bg-gray-800') : null;
        const editor = editorContainer ? editorContainer.querySelector('[data-wysiwyg="true"]') : null;
        
        
        if (!editor) {
          return;
        }

        // Focus the editor
        editor.focus();
        
        // Apply formatting based on Flowbite WYSIWYG commands
        let success = false;
        
        try {
          switch(format) {
            case 'bold':
              success = document.execCommand('bold', false, null);
              break;
            case 'italic':
              success = document.execCommand('italic', false, null);
              break;
            case 'underline':
              success = document.execCommand('underline', false, null);
              break;
            case 'unorderedList':
              success = document.execCommand('insertUnorderedList', false, null);
              break;
            case 'orderedList':
              success = document.execCommand('insertOrderedList', false, null);
              break;
            case 'blockquote':
              success = document.execCommand('formatBlock', false, 'blockquote');
              break;
            case 'h1':
              success = document.execCommand('formatBlock', false, 'h1');
              break;
            case 'h2':
              success = document.execCommand('formatBlock', false, 'h2');
              break;
            case 'h3':
              success = document.execCommand('formatBlock', false, 'h3');
              break;
            case 'paragraph':
              success = document.execCommand('formatBlock', false, 'p');
              break;
          }
        } catch (error) {
          // Silent error handling
        }
        
        // Update visual state of button with more visible colors for light theme
        if (success) {
          
          // Toggle button state based on current format state
          const isCurrentlyActive = this.classList.contains('text-white') && this.classList.contains('bg-blue-600');
          
          if (!isCurrentlyActive) {
            // Remove existing states and add active state
            this.classList.remove('text-blue-700', 'bg-gray-100');
            this.classList.add('text-white', 'bg-blue-600');
            this.style.boxShadow = '0 2px 4px rgba(59, 130, 246, 0.3)';
          } else {
            // Remove active state if already active (toggle behavior)
            this.classList.remove('text-white', 'bg-blue-600');
            this.style.boxShadow = '';
          }
        }
        
        // Sync content to textarea
        let textarea = null;
        if (editor.id === 'wysiwyg-question-text-admin') {
          textarea = questionTextarea;
        } else if (editor.id === 'wysiwyg-explanation-text-admin') {
          textarea = explanationTextarea;
        } else if (editor.id.startsWith('wysiwyg-choice-text-')) {
          // Handle choice editors
          const choiceNumber = editor.id.split('-').pop();
          const choiceIndex = parseInt(choiceNumber) - 1;
          textarea = document.querySelector(`#id_choices-${choiceIndex}-choice_text`);
        }
        
        if (textarea) {
          textarea.value = editor.innerHTML;
        }
        
        // Trigger input event for any additional listeners
        editor.dispatchEvent(new Event('input', { bubbles: true }));
      });
    });

    // Initialize text formatting buttons (for active state)
    document.querySelectorAll('[data-wysiwyg-toggle-format]').forEach(button => {
      const format = button.getAttribute('data-wysiwyg-toggle-format');
      
      // Add Flowbite button styling if not already present
      if (!button.classList.contains('p-2')) {
        button.classList.add('p-2', 'text-gray-500', 'rounded', 'cursor-pointer', 'hover:text-gray-900', 'hover:bg-gray-100', 'dark:text-gray-400', 'dark:hover:text-white', 'dark:hover:bg-gray-600');
      }
    });
  }

  // Initialize toolbar
  initializeToolbar();

  // Additional toolbar functionality for image upload and math
  function initializeSpecialActions() {
    // Handle image upload buttons
    document.querySelectorAll('[data-wysiwyg-action="image"]').forEach(button => {
      button.addEventListener('click', function(e) {
        e.preventDefault();
        
        // Find the associated editor - look for the parent container
        const toolbar = this.closest('[class*="border"]');
        const editorContainer = toolbar ? toolbar.closest('.bg-white, .dark\\:bg-gray-800') : null;
        const editor = editorContainer ? editorContainer.querySelector('[data-wysiwyg="true"]') : null;
        
        if (!editor) {
          return;
        }
        
        // Create file input
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.style.display = 'none';
        
        input.onchange = function() {
          const file = input.files[0];
          if (!file) return;
          
          // Show loading indicator
          const loadingText = document.createElement('span');
          loadingText.textContent = 'Uploading image...';
          loadingText.style.color = '#6b7280';
          loadingText.style.fontStyle = 'italic';
          
          // Insert loading text at cursor position
          const selection = window.getSelection();
          if (selection.rangeCount > 0) {
            const range = selection.getRangeAt(0);
            range.insertNode(loadingText);
            range.collapse(false);
          }
          
          // Upload file
          const formData = new FormData();
          formData.append('upload', file);
          formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
          
          fetch('/admin/image-upload/', {
            method: 'POST',
            body: formData,
            headers: {
              'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
          })
          .then(response => response.json())
          .then(data => {
            // Remove loading text
            if (loadingText.parentNode) {
              loadingText.parentNode.removeChild(loadingText);
            }
            
            if (data.url) {
              // Create image resizer container
              const resizer = document.createElement('div');
              resizer.className = 'image-resizer';
              resizer.style.display = 'inline-block';
              resizer.style.position = 'relative';
              resizer.style.margin = '10px 0';
              
              // Create image element
              const img = document.createElement('img');
              img.src = data.url;
              img.style.maxWidth = '100%';
              img.style.height = 'auto';
              img.style.display = 'block';
              img.style.borderRadius = '8px';
              img.classList.add('editable-image');
              img.setAttribute('data-original-url', data.url);
              
              // Create resize handles
              const handles = ['nw', 'ne', 'sw', 'se', 'n', 's', 'e', 'w'];
              handles.forEach(handle => {
                const handleEl = document.createElement('div');
                handleEl.className = `resize-handle ${handle}`;
                handleEl.setAttribute('data-handle', handle);
                resizer.appendChild(handleEl);
              });
              
              // Create toolbar
              const toolbar = document.createElement('div');
              toolbar.className = 'image-edit-toolbar';
              toolbar.innerHTML = `
                <button type="button" class="toolbar-btn" onclick="resizeImageToPercent(this, 25)" title="25%">25%</button>
                <button type="button" class="toolbar-btn" onclick="resizeImageToPercent(this, 50)" title="50%">50%</button>
                <button type="button" class="toolbar-btn" onclick="resizeImageToPercent(this, 75)" title="75%">75%</button>
                <button type="button" class="toolbar-btn" onclick="resizeImageToPercent(this, 100)" title="100%">100%</button>
                <button type="button" class="toolbar-btn" onclick="startCropMode(this)" title="Crop">✂️</button>
                <button type="button" class="toolbar-btn" onclick="resetImageSize(this)" title="Reset">↻</button>
                <button type="button" class="toolbar-btn" onclick="removeImageFromResizer(this)" title="Remove">🗑️</button>
                <button type="button" class="toolbar-btn" onclick="previewImageFromResizer(this)" title="Preview">👁️</button>
              `;
              resizer.appendChild(toolbar);
              
              // Add image to resizer
              resizer.appendChild(img);
              
              // Initialize drag and resize functionality
              initializeImageResizer(resizer, editor);
              
              // Insert resizer at cursor position
              const selection = window.getSelection();
              if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                range.insertNode(resizer);
                range.collapse(false);
              } else {
                editor.appendChild(resizer);
              }
              
              // Update textarea
              let textarea = null;
              if (editor.id === 'wysiwyg-question-text-admin') {
                textarea = questionTextarea;
              } else if (editor.id === 'wysiwyg-explanation-text-admin') {
                textarea = explanationTextarea;
              } else if (editor.id.startsWith('wysiwyg-choice-text-')) {
                // Handle choice editors
                const choiceNumber = editor.id.split('-').pop();
                const choiceIndex = parseInt(choiceNumber) - 1;
                textarea = document.querySelector(`#id_choices-${choiceIndex}-choice_text`);
              }
              
              if (textarea) {
                textarea.value = editor.innerHTML;
              }
              
              // Trigger input event
              editor.dispatchEvent(new Event('input', { bubbles: true }));
              
              // Show success message
              showNotification('Image uploaded successfully! Click and drag to resize, or use toolbar for more options.', 'success');
            } else {
              showNotification('Failed to upload image: ' + (data.error || 'Unknown error'), 'error');
            }
          })
          .catch(error => {
            // Remove loading text
            if (loadingText.parentNode) {
              loadingText.parentNode.removeChild(loadingText);
            }
            showNotification('Image upload failed. Please try again.', 'error');
          });
        };
        
        // Trigger file selection
        document.body.appendChild(input);
        input.click();
        document.body.removeChild(input);
      });
    });

    // Handle math symbols buttons
    document.querySelectorAll('[data-wysiwyg-action="math-symbols"]').forEach(button => {
      button.addEventListener('click', function(e) {
        e.preventDefault();
        
        // Find the associated editor
        const toolbar = this.closest('[class*="border"]');
        const editorContainer = toolbar ? toolbar.closest('.bg-white, .dark\\:bg-gray-800') : null;
        const editor = editorContainer ? editorContainer.querySelector('[data-wysiwyg="true"]') : null;
        
        if (!editor) {
          return;
        }
        
        // Store the current editor for symbol insertion
        window.currentMathEditor = editor;
        
        // Show math symbols modal
        showMathSymbolsModal();
      });
    });
    
    // Math symbols modal functions
    window.showMathSymbolsModal = function() {
      const modal = document.getElementById('mathSymbolsModal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    };
    
    window.closeMathSymbolsModal = function() {
      const modal = document.getElementById('mathSymbolsModal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    };
    
    // Handle math symbol selection
    document.querySelectorAll('.math-symbol-btn').forEach(button => {
      button.addEventListener('click', function() {
        const symbol = this.getAttribute('data-symbol');
        
        if (window.currentMathEditor && symbol) {
          // Focus the editor
          window.currentMathEditor.focus();
          
          // Insert symbol at cursor position
          document.execCommand('insertText', false, symbol);
          
          // Sync content to textarea
          const questionTextarea = document.getElementById('id_question_text');
          const explanationTextarea = document.getElementById('id_explanation');
          
          if (window.currentMathEditor.id === 'wysiwyg-question-text-admin') {
            questionTextarea.value = window.currentMathEditor.innerHTML;
          } else if (window.currentMathEditor.id === 'wysiwyg-explanation-text-admin') {
            explanationTextarea.value = window.currentMathEditor.innerHTML;
          } else if (window.currentMathEditor.id.startsWith('wysiwyg-choice-text-')) {
            // Handle choice editors
            const choiceNumber = window.currentMathEditor.id.split('-').pop();
            const choiceIndex = parseInt(choiceNumber) - 1;
            const choiceTextarea = document.querySelector(`#id_choices-${choiceIndex}-choice_text`);
            if (choiceTextarea) {
              choiceTextarea.value = window.currentMathEditor.innerHTML;
            }
          }
          
          // Close modal
          closeMathSymbolsModal();
          
          // Show notification
          showNotification('Math symbol inserted!', 'success');
        }
      });
    });
    
    // Close modal when clicking outside
    document.getElementById('mathSymbolsModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeMathSymbolsModal();
      }
    });

    // Handle LaTeX formula buttons
    document.querySelectorAll('[data-wysiwyg-action="latex"]').forEach(button => {
      button.addEventListener('click', function(e) {
        e.preventDefault();
        
        // Find the associated editor
        const toolbar = this.closest('[class*="border"]');
        const editorContainer = toolbar ? toolbar.closest('.bg-white, .dark\\:bg-gray-800') : null;
        const editor = editorContainer ? editorContainer.querySelector('[data-wysiwyg="true"]') : null;
        
        if (!editor) {
          return;
        }

        // Prompt for LaTeX formula
        const latex = prompt('Enter LaTeX formula (e.g., x^2 + y^2 = z^2, \\frac{a}{b}, \\sqrt{x}):');
        if (!latex) return;
        
        // Use document.execCommand for better WYSIWYG compatibility
        editor.focus();
        
        // Create a simple span that won't interfere with text flow
        const mathSpan = document.createElement('span');
        mathSpan.className = 'math-formula';
        mathSpan.contentEditable = 'false'; // Prevent editing inside formula
        mathSpan.style.display = 'inline';
        mathSpan.style.backgroundColor = '#eff6ff';
        mathSpan.style.border = '1px solid #3b82f6';
        mathSpan.style.borderRadius = '4px';
        mathSpan.style.padding = '2px 4px';
        mathSpan.style.margin = '0 1px';
        mathSpan.style.fontSize = '1em';
        mathSpan.style.verticalAlign = 'baseline';
        mathSpan.style.cursor = 'pointer';
        mathSpan.style.fontFamily = 'KaTeX_Main, "Times New Roman", serif';
        mathSpan.dataset.latex = latex;
        
        // Set initial content for MathJax processing
        mathSpan.textContent = `\\(${latex}\\)`;
        
        // Insert using execCommand for better compatibility
        const selection = window.getSelection();
        if (selection.rangeCount > 0) {
          const range = selection.getRangeAt(0);
          
          // Delete any selected content first
          range.deleteContents();
          
          // Insert the math span
          range.insertNode(mathSpan);
          
          // Move cursor after the math span
          range.setStartAfter(mathSpan);
          range.setEndAfter(mathSpan);
          
          // Clear selection and set new range
          selection.removeAllRanges();
          selection.addRange(range);
          
          // Add a space after for easier typing
          document.execCommand('insertText', false, ' ');
        } else {
          // Fallback: append to editor
          editor.appendChild(mathSpan);
          editor.appendChild(document.createTextNode(' '));
        }
        
        // Update textarea
        const questionTextarea = document.getElementById('id_question_text');
        const explanationTextarea = document.getElementById('id_explanation');
        
        if (editor.id === 'wysiwyg-question-text-admin') {
          questionTextarea.value = editor.innerHTML;
        } else if (editor.id === 'wysiwyg-explanation-text-admin') {
          explanationTextarea.value = editor.innerHTML;
        } else if (editor.id.startsWith('wysiwyg-choice-text-')) {
          // Handle choice editors
          const choiceNumber = editor.id.split('-').pop();
          const choiceIndex = parseInt(choiceNumber) - 1;
          const choiceTextarea = document.querySelector(`#id_choices-${choiceIndex}-choice_text`);
          if (choiceTextarea) {
            choiceTextarea.value = editor.innerHTML;
          }
        }
        
        // Trigger input event
        editor.dispatchEvent(new Event('input', { bubbles: true }));
        
        // Re-render MathJax for the new LaTeX
        setTimeout(() => {
          if (window.MathJax && window.MathJax.typesetPromise) {
            window.MathJax.typesetPromise([mathSpan]).then(() => {
              
              // Add click handler for editing
              mathSpan.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const currentLatex = this.dataset.latex;
                const newLatex = prompt('Edit LaTeX formula:', currentLatex);
                if (newLatex && newLatex !== currentLatex) {
                  this.dataset.latex = newLatex;
                  this.textContent = `\\(${newLatex}\\)`;
                  
                  // Re-render with MathJax
                  window.MathJax.typesetPromise([this]).then(() => {
                    // Update textarea
                    if (editor.id === 'wysiwyg-question-text-admin') {
                      questionTextarea.value = editor.innerHTML;
                    } else if (editor.id === 'wysiwyg-explanation-text-admin') {
                      explanationTextarea.value = editor.innerHTML;
                    } else if (editor.id.startsWith('wysiwyg-choice-text-')) {
                      // Handle choice editors
                      const choiceNumber = editor.id.split('-').pop();
                      const choiceIndex = parseInt(choiceNumber) - 1;
                      const choiceTextarea = document.querySelector(`#id_choices-${choiceIndex}-choice_text`);
                      if (choiceTextarea) {
                        choiceTextarea.value = editor.innerHTML;
                      }
                    }
                    editor.focus();
                  }).catch((err) => {
                    this.style.backgroundColor = '#fef2f2';
                    this.style.borderColor = '#ef4444';
                    this.style.color = '#dc2626';
                    this.textContent = `Error: ${newLatex}`;
                  });
                }
              });
            }).catch((err) => {
              mathSpan.style.backgroundColor = '#fef2f2';
              mathSpan.style.borderColor = '#ef4444';
              mathSpan.style.color = '#dc2626';
              mathSpan.textContent = `Error: ${latex}`;
            });
          }
        }, 100);
        
        showNotification('LaTeX formula inserted!', 'success');
      });
    });

    // LaTeX Guide buttons
    document.querySelectorAll('[data-wysiwyg-action="latex-guide"]').forEach(button => {
      button.addEventListener('click', function(e) {
        e.preventDefault();
        window.openLatexGuideModal();
      });
    });
  }

  // LaTeX Guide Modal functions (Global scope)
  window.openLatexGuideModal = function() {
    const modal = document.getElementById('latexGuideModal');
    if (modal) {
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      document.body.style.overflow = 'hidden';
    }
  }

  window.closeLatexGuideModal = function() {
    const modal = document.getElementById('latexGuideModal');
    if (modal) {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      document.body.style.overflow = 'auto';
    }
  }

  // Add event listener for close button
  document.getElementById('closeLatexGuideBtnAdmin')?.addEventListener('click', function() {
    window.closeLatexGuideModal();
  });

  // Close modal when clicking outside
  document.getElementById('latexGuideModal')?.addEventListener('click', function(e) {
    if (e.target === this) {
      window.closeLatexGuideModal();
    }
  });

  // Close modal with Escape key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      const modal = document.getElementById('latexGuideModal');
      if (modal && !modal.classList.contains('hidden')) {
        window.closeLatexGuideModal();
      }
    }
  });

  // Initialize special actions
  initializeSpecialActions();
  
  // Initialize choice counter on page load
  updateChoiceCounter();
  
  // Make existing images in editors clickable for editing
  document.querySelectorAll('[data-wysiwyg="true"] img').forEach(img => {
    if (!img.closest('.image-resizer')) {
      wrapImageInResizer(img);
    }
  });

  // Function to wrap existing images in resizer containers
  function wrapImageInResizer(img) {
    const editor = img.closest('[data-wysiwyg="true"]');
    if (!editor) return;
    
    // Create resizer container
    const resizer = document.createElement('div');
    resizer.className = 'image-resizer';
    resizer.style.display = 'inline-block';
    resizer.style.position = 'relative';
    resizer.style.margin = '10px 0';
    
    // Store original URL if not already set
    if (!img.getAttribute('data-original-url')) {
      img.setAttribute('data-original-url', img.src);
    }
    
    // Add editable-image class
    img.classList.add('editable-image');
    
    // Create resize handles
    const handles = ['nw', 'ne', 'sw', 'se', 'n', 's', 'e', 'w'];
    handles.forEach(handle => {
      const handleEl = document.createElement('div');
      handleEl.className = `resize-handle ${handle}`;
      handleEl.setAttribute('data-handle', handle);
      resizer.appendChild(handleEl);
    });
    
    // Create toolbar
    const toolbar = document.createElement('div');
    toolbar.className = 'image-edit-toolbar';
    toolbar.innerHTML = `
      <button type="button" class="toolbar-btn" onclick="resizeImageToPercent(this, 25)" title="25%">25%</button>
      <button type="button" class="toolbar-btn" onclick="resizeImageToPercent(this, 50)" title="50%">50%</button>
      <button type="button" class="toolbar-btn" onclick="resizeImageToPercent(this, 75)" title="75%">75%</button>
      <button type="button" class="toolbar-btn" onclick="resizeImageToPercent(this, 100)" title="100%">100%</button>
      <button type="button" class="toolbar-btn" onclick="startCropMode(this)" title="Crop">✂️</button>
      <button type="button" class="toolbar-btn" onclick="resetImageSize(this)" title="Reset">↻</button>
      <button type="button" class="toolbar-btn" onclick="removeImageFromResizer(this)" title="Remove">🗑️</button>
      <button type="button" class="toolbar-btn" onclick="previewImageFromResizer(this)" title="Preview">👁️</button>
    `;
    resizer.appendChild(toolbar);
    
    // Move image into resizer
    img.parentNode.insertBefore(resizer, img);
    resizer.appendChild(img);
    
    // Initialize drag and resize functionality
    initializeImageResizer(resizer, editor);
  }
  
  // Render existing LaTeX formulas on page load
  setTimeout(() => {
    const existingMath = document.querySelectorAll('.latex-formula, .math-display, .math-formula');
    if (existingMath.length > 0 && window.MathJax && window.MathJax.typesetPromise) {
      window.MathJax.typesetPromise(Array.from(existingMath)).catch((err) => {});
    }
  }, 1000);
            
  // Question type functionality
            const questionTypeRadios = document.querySelectorAll('input[name="question_type"]');
            const choicesSection = document.getElementById('choicesSection');
            const essayAnswerSection = document.getElementById('essayAnswerSection');
            
            console.log('[DEBUG] Question type initialization:', {
                radios: questionTypeRadios.length,
                choicesSection: !!choicesSection,
                essayAnswerSection: !!essayAnswerSection
            });
            
            function toggleSections() {
                const selectedType = document.querySelector('input[name="question_type"]:checked');
                console.log('[DEBUG] toggleSections called, selectedType:', selectedType ? selectedType.value : 'NONE');
                
                if (selectedType) {
                    document.body.style.cursor = 'wait';
                    
                    setTimeout(() => {
                        if (selectedType.value === 'multiple_choice') {
                            if (choicesSection) choicesSection.style.display = 'block';
                            if (essayAnswerSection) essayAnswerSection.style.display = 'none';
                            if (choicesSection) choicesSection.classList.add('section-fade-in');
                            
                            console.log('[DEBUG] Showing multiple choice section');
                            
                            // Initialize choice checkboxes after section becomes visible
                            setTimeout(() => {
                                initializeChoiceCheckboxes();
                            }, 100);
                        } else if (selectedType.value === 'essay') {
                            if (choicesSection) choicesSection.style.display = 'none';
                            if (essayAnswerSection) essayAnswerSection.style.display = 'block';
                            if (essayAnswerSection) essayAnswerSection.classList.add('section-fade-in');
                            
                            console.log('[DEBUG] Showing essay section');
                        }
                        
                        document.body.style.cursor = '';
                    }, 100);
                } else {
                    console.log('[DEBUG] No question type selected, ensuring multiple_choice is selected by default');
                    // If no type is selected, select multiple_choice by default
                    const multipleChoiceRadio = document.querySelector('input[name="question_type"][value="multiple_choice"]');
                    if (multipleChoiceRadio) {
                        multipleChoiceRadio.checked = true;
                        setTimeout(toggleSections, 50);
                    }
                }
            }
            
            // Initial toggle based on selected value
            setTimeout(() => {
                toggleSections();
            }, 100);
            
            // Add event listeners to radio buttons
            questionTypeRadios.forEach(function(radio) {
                radio.addEventListener('change', toggleSections);
            });
            
            // Form validation with enhanced UX
            const form = document.querySelector('form');
            if (form) {
                form.addEventListener('submit', function(e) {
                    const category = document.querySelector('#id_category');
                    
                    // Use the comprehensive sync function that includes cleaning
                    window.syncAllWysiwygContent();
                    
                    // Debug: Log all checkbox states before submission and ensure they're all present
                    console.log('=== CHECKBOX DEBUG BEFORE SUBMIT ===');
                    
                    // Check existing checkboxes first
                    for (let i = 0; i < 5; i++) {
                        const checkbox = document.querySelector(`input[name="choices-${i}-is_correct"]`);
                        console.log(`Choice ${i+1} checkbox:`, {
                            exists: !!checkbox,
                            name: checkbox ? checkbox.name : 'N/A',
                            checked: checkbox ? checkbox.checked : 'N/A',
                            value: checkbox ? checkbox.value : 'N/A',
                            id: checkbox ? checkbox.id : 'N/A'
                        });
                        
                        // CRITICAL FIX: Ensure checked checkboxes are properly submitted
                        // Instead of adding hidden inputs, ensure checked checkboxes have correct attributes
                        if (checkbox) {
                            if (checkbox.checked) {
                                console.log(`Checkbox ${i+1} is CHECKED - ensuring proper submission`);
                                // Make sure checked checkbox has the right value and attributes
                                checkbox.value = 'on';
                                checkbox.setAttribute('checked', 'checked');
                            } else {
                                console.log(`Checkbox ${i+1} is UNCHECKED`);
                                // Remove checked attribute for unchecked boxes
                                checkbox.removeAttribute('checked');
                            }
                        }
                    }
                    
                    // Log final FormData to see what will be submitted
                    console.log('=== FORM DATA BEFORE SUBMIT ===');
                    const formData = new FormData(form);
                    for (let [key, value] of formData.entries()) {
                        if (key.includes('is_correct') || key.includes('choice_text')) {
                            console.log(`FormData: ${key} = ${value}`);
                        }
                    }
                    
                    console.log('========================================');
                    
                    // Get content from Flowbite WYSIWYG editors for validation
                    let questionContent = '';
                    if (questionEditor) {
                        questionContent = questionEditor.innerHTML.trim();
                        // Check for empty content (just HTML tags with no text)
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = questionContent;
                        const textContent = tempDiv.textContent || tempDiv.innerText || '';
                        if (!textContent.trim()) questionContent = '';
                    } else if (questionTextarea) {
                        questionContent = questionTextarea.value.trim();
                    }
                    
                    if (!questionContent || (category && !category.value)) {
                        e.preventDefault();
                        showNotification('Please fill in all required fields', 'error');
                        
                        const firstError = document.querySelector('.text-red-500');
                        if (firstError) {
                            firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                        return;
                    }
                    
                    // Check multiple choice validation - minimum 2 choices required
                    const multipleChoiceRadio = document.querySelector('input[value="multiple_choice"]:checked');
                    if (multipleChoiceRadio) {
                        let validChoicesCount = 0;
                        let correctAnswerExists = false;
                        let validChoicesWithContent = []; // Track which choices have content
                        
                        // Check all choices (A, B, C, D, E) and track which ones have content
                        for (let i = 1; i <= 5; i++) {
                            const choiceEditor = document.querySelector(`#wysiwyg-choice-text-${i}`);
                            if (choiceEditor) {
                                const tempDiv = document.createElement('div');
                                tempDiv.innerHTML = choiceEditor.innerHTML.trim();
                                const textContent = tempDiv.textContent || tempDiv.innerText || '';
                                if (textContent.trim()) {
                                    validChoicesCount++;
                                    validChoicesWithContent.push(i); // Track this choice as having content
                                }
                            }
                        }
                        
                        // Check if at least one correct answer is selected AND has content
                        const correctAnswerCheckboxes = document.querySelectorAll('input[name$="-is_correct"]:checked');
                        let validCorrectAnswers = 0;
                        
                        correctAnswerCheckboxes.forEach(checkbox => {
                            // Extract choice number from checkbox name (e.g., "choices-0-is_correct" -> choice 1)
                            const nameMatch = checkbox.name.match(/choices-(\d+)-is_correct/);
                            if (nameMatch) {
                                const choiceIndex = parseInt(nameMatch[1]); // 0-based index
                                const choiceNumber = choiceIndex + 1; // Convert to 1-based
                                
                                // Check if this choice has content
                                if (validChoicesWithContent.includes(choiceNumber)) {
                                    validCorrectAnswers++;
                                }
                            }
                        });
                        
                        correctAnswerExists = validCorrectAnswers > 0;
                        
                        // Validation: minimum 2 choices required, and at least one must be marked as correct
                        if (validChoicesCount < 2) {
                            e.preventDefault();
                            showNotification('Please fill in at least 2 choices (A & B are required)', 'error');
                            const choicesSection = document.getElementById('choicesSection');
                            if (choicesSection) {
                                choicesSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            }
                            return;
                        }
                        
                        // Check if first 2 choices (A & B) are filled since they are required
                        if (!validChoicesWithContent.includes(1) || !validChoicesWithContent.includes(2)) {
                            e.preventDefault();
                            showNotification('Choices A and B are required. Please fill them in.', 'error');
                            const choicesSection = document.getElementById('choicesSection');
                            if (choicesSection) {
                                choicesSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            }
                            return;
                        }
                        
                        if (!correctAnswerExists) {
                            e.preventDefault();
                            showNotification('Please select at least one correct answer from the choices that have content', 'error');
                            const choicesSection = document.getElementById('choicesSection');
                            if (choicesSection) {
                                choicesSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            }
                            return;
                        }
                    }
                    
                    // Check if essay type and answer is provided
                    const essayRadio = document.querySelector('input[value="essay"]:checked');
                    if (essayRadio) {
                        const essayAnswer = document.getElementById('id_correct_answer_text');
                        if (essayAnswer && !essayAnswer.value.trim()) {
                            e.preventDefault();
                            showNotification('Please provide an expected answer for the essay question', 'error');
                            essayAnswer.focus();
                            return;
                        }
                    }
                    
                    // Show loading state
                    const submitBtn = form.querySelector('button[type="submit"]');
                    if (submitBtn) {
                        submitBtn.disabled = true;
                        const isUpdate = submitBtn.textContent.includes('Update');
                        submitBtn.innerHTML = `
                            <svg class="animate-spin -ml-1 mr-3 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            ${isUpdate ? 'Updating' : 'Creating'} Question...
                        `;
                    }
                });
            }
            
            // Toggle correct answer button functionality (Global function)
            window.toggleCorrectAnswer = function(button, choiceNumber) {
                // Find the hidden checkbox - use the exact name pattern that Django generates
                const checkboxName = `choices-${choiceNumber - 1}-is_correct`;
                let checkbox = document.querySelector(`input[name="${checkboxName}"]`);
                
                console.log(`[DEBUG] Looking for checkbox with name: ${checkboxName}`);
                console.log(`[DEBUG] Found checkbox:`, checkbox);
                
                if (!checkbox) {
                    console.warn(`No checkbox found for choice ${choiceNumber} with name ${checkboxName}`);
                    // Try alternative selector
                    const choiceItem = button.closest('.choice-item');
                    checkbox = choiceItem.querySelector('input[name$="-is_correct"][type="checkbox"]');
                    console.log(`[DEBUG] Fallback checkbox search:`, checkbox);
                    
                    if (!checkbox) {
                        console.error(`Still no checkbox found for choice ${choiceNumber}`);
                        return;
                    }
                }
                
                // Check if the choice has content before allowing it to be marked as correct
                const choiceEditor = document.querySelector(`#wysiwyg-choice-text-${choiceNumber}`);
                if (choiceEditor) {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = choiceEditor.innerHTML.trim();
                    const textContent = tempDiv.textContent || tempDiv.innerText || '';
                    
                    if (!textContent.trim() && !checkbox.checked) {
                        // Prevent marking empty choice as correct
                        showNotification(`Please add content to Choice ${String.fromCharCode(64 + choiceNumber)} before marking it as correct`, 'warning');
                        return;
                    }
                }
                
                // Toggle checkbox state
                checkbox.checked = !checkbox.checked;
                
                // CRITICAL: Also set the value attribute to ensure form submission works
                if (checkbox.checked) {
                    checkbox.setAttribute('value', 'on');
                } else {
                    checkbox.removeAttribute('value');
                }
                
                console.log(`[DEBUG] Choice ${choiceNumber} (${checkboxName}) marked as: ${checkbox.checked ? 'CORRECT' : 'INCORRECT'}`);
                console.log(`[DEBUG] Checkbox value attribute:`, checkbox.getAttribute('value'));
                
                // Update button appearance
                updateCorrectAnswerButton(button, checkbox.checked);
                
                // Trigger existing visual feedback
                handleCorrectAnswerChange(checkbox, choiceNumber);
            };
            

            
            // Update button appearance based on state
            function updateCorrectAnswerButton(button, isCorrect) {
                const checkIcon = button.querySelector('.check-icon');
                const plusIcon = button.querySelector('.plus-icon');
                const buttonText = button.querySelector('.button-text');
                
                if (isCorrect) {
                    // Correct state - green button
                    button.className = 'correct-answer-btn px-4 py-2 rounded-lg font-medium text-sm transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 bg-green-600 text-white border-green-600 focus:ring-green-500 hover:bg-green-700';
                    checkIcon.classList.remove('hidden');
                    checkIcon.classList.add('block');
                    plusIcon.classList.remove('block');
                    plusIcon.classList.add('hidden');
                    buttonText.textContent = 'Correct Answer';
                } else {
                    // Normal state - gray button
                    button.className = 'correct-answer-btn px-4 py-2 rounded-lg font-medium text-sm transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 bg-gray-100 text-gray-700 border-gray-300 hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600 dark:hover:bg-gray-600 focus:ring-gray-500';
                    checkIcon.classList.remove('block');
                    checkIcon.classList.add('hidden');
                    plusIcon.classList.remove('hidden');
                    plusIcon.classList.add('block');
                    buttonText.textContent = 'Mark as Correct';
                }
            }
            
            // Handle correct answer checkbox changes for visual feedback
            function handleCorrectAnswerChange(checkbox, choiceNumber) {
                const choiceItem = checkbox.closest('.choice-item');
                
                if (checkbox.checked) {
                    // Add comprehensive green styling for correct answer
                    choiceItem.classList.add('correct-answer');
                    
                    // Force remove default classes that might conflict
                    choiceItem.classList.remove('border-gray-200', 'dark:border-gray-600', 'bg-white', 'dark:bg-gray-800');
                    
                    // Add styling
                    choiceItem.style.border = '3px solid #10b981';
                    choiceItem.style.background = 'linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%)';
                    choiceItem.style.boxShadow = '0 8px 25px rgba(16, 185, 129, 0.3)';
                    choiceItem.style.transform = 'scale(1.02)';
                    
                    // Update header background
                    const choiceHeader = choiceItem.querySelector('.choice-header');
                    if (choiceHeader) {
                        choiceHeader.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                        choiceHeader.style.color = 'white';
                    }
                    
                    // Update badge
                    const badge = choiceItem.querySelector('.choice-badge');
                    if (badge) {
                        badge.style.background = 'rgba(255, 255, 255, 0.95)';
                        badge.style.color = '#059669';
                        badge.style.border = '2px solid white';
                        badge.style.fontWeight = 'bold';
                    }
                    
                    // Update status text
                    const statusText = choiceItem.querySelector('.choice-status');
                    if (statusText) {
                        statusText.textContent = '✓ Correct Answer';
                        statusText.style.color = 'white';
                        statusText.style.fontWeight = '600';
                    }
                    
                    // Update header title color
                    const choiceTitle = choiceItem.querySelector('h4');
                    if (choiceTitle) {
                        choiceTitle.style.color = 'white';
                        choiceTitle.style.fontWeight = '700';
                    }
                    
                    // Update checkbox label color
                    const checkboxLabel = choiceItem.querySelector('label span');
                    if (checkboxLabel) {
                        checkboxLabel.style.color = 'white';
                        checkboxLabel.style.fontWeight = '500';
                    }
                    
                    // Update WYSIWYG editor
                    const wysiwygEditor = choiceItem.querySelector('.wysiwyg-editor');
                    if (wysiwygEditor) {
                        wysiwygEditor.style.border = '2px solid #10b981';
                        wysiwygEditor.style.boxShadow = '0 0 0 3px rgba(16, 185, 129, 0.15)';
                    }
                } else {
                    // Remove correct answer styling
                    choiceItem.classList.remove('correct-answer');
                    
                    // Reset inline styles
                    choiceItem.style.border = '';
                    choiceItem.style.background = '';
                    choiceItem.style.boxShadow = '';
                    choiceItem.style.transform = '';
                    
                    // Reset header
                    const choiceHeader = choiceItem.querySelector('.choice-header');
                    if (choiceHeader) {
                        choiceHeader.style.background = '';
                        choiceHeader.style.color = '';
                    }
                    
                    // Reset badge
                    const badge = choiceItem.querySelector('.choice-badge');
                    if (badge) {
                        badge.style.background = '';
                        badge.style.color = '';
                        badge.style.border = '';
                        badge.style.fontWeight = '';
                    }
                    
                    // Reset status text
                    const statusText = choiceItem.querySelector('.choice-status');
                    if (statusText) {
                        statusText.textContent = 'Option';
                        statusText.style.color = '';
                        statusText.style.fontWeight = '';
                    }
                    
                    // Reset header title
                    const choiceTitle = choiceItem.querySelector('h4');
                    if (choiceTitle) {
                        choiceTitle.style.color = '';
                        choiceTitle.style.fontWeight = '';
                    }
                    
                    // Reset checkbox label
                    const checkboxLabel = choiceItem.querySelector('label span');
                    if (checkboxLabel) {
                        checkboxLabel.style.color = '';
                        checkboxLabel.style.fontWeight = '';
                    }
                    
                    // Reset WYSIWYG editor
                    const wysiwygEditor = choiceItem.querySelector('.wysiwyg-editor');
                    if (wysiwygEditor) {
                        wysiwygEditor.style.border = '';
                        wysiwygEditor.style.boxShadow = '';
                    }
                }
            }

            // Initialize choice checkboxes function
            function initializeChoiceCheckboxes() {
                console.log('[DEBUG] Initializing choice checkboxes...');
                
                // Process each choice individually to ensure correct mapping
                for (let i = 0; i < 5; i++) {
                    const checkbox = document.querySelector(`input[name="choices-${i}-is_correct"][type="checkbox"]`);
                    const choiceNumber = i + 1; // Convert to 1-based for display
                    
                    if (checkbox) {
                        console.log(`[DEBUG] Initializing checkbox for choice ${choiceNumber}:`, checkbox.name);
                        
                        // Remove existing listeners to avoid duplicates
                        if (checkbox._choiceHandler) {
                            checkbox.removeEventListener('change', checkbox._choiceHandler);
                        }
                        
                        // Create new handler with validation
                        checkbox._choiceHandler = function(e) {
                            console.log(`[DEBUG] Checkbox change event for choice ${choiceNumber}: checked=${this.checked}`);
                            
                            // If checkbox is being checked, validate that the choice has content
                            if (this.checked) {
                                const choiceEditor = document.querySelector(`#wysiwyg-choice-text-${choiceNumber}`);
                                if (choiceEditor) {
                                    const tempDiv = document.createElement('div');
                                    tempDiv.innerHTML = choiceEditor.innerHTML.trim();
                                    const textContent = tempDiv.textContent || tempDiv.innerText || '';
                                    
                                    if (!textContent.trim()) {
                                        // Prevent checking if no content
                                        e.preventDefault();
                                        this.checked = false;
                                        showNotification(`Please add content to Choice ${String.fromCharCode(64 + choiceNumber)} before marking it as correct`, 'warning');
                                        return;
                                    }
                                }
                            }
                            
                            handleCorrectAnswerChange(this, choiceNumber);
                        };
                        
                        checkbox.addEventListener('change', checkbox._choiceHandler);
                        
                        // Initialize state on page load
                        if (checkbox.checked) {
                            handleCorrectAnswerChange(checkbox, choiceNumber);
                        }
                        
                        // Initialize button state
                        const choiceItem = checkbox.closest('.choice-item');
                        const button = choiceItem?.querySelector('.correct-answer-btn');
                        if (button) {
                            updateCorrectAnswerButton(button, checkbox.checked);
                        }
                    } else {
                        console.warn(`[DEBUG] No checkbox found for choice ${choiceNumber}`);
                    }
                }
            }

            // Initialize correct answer checkboxes on DOM ready
            document.addEventListener('DOMContentLoaded', function() {
                initializeChoiceCheckboxes();
                if (typeof updateChoiceRequirements === 'function') updateChoiceRequirements();
            });
            
            // Image Modal Functions
            window.openImageModal = function(imageSrc, imageTitle = 'Image Preview') {
                const modal = document.getElementById('imageModal');
                const modalImage = document.getElementById('modalImage');
                const modalTitle = document.getElementById('modal-title');
                
                if (imageSrc && imageSrc !== '') {
                    modalImage.src = imageSrc;
                    modalTitle.textContent = imageTitle;
                    modal.classList.remove('hidden');
                    document.body.style.overflow = 'hidden'; // Prevent background scrolling
                } else {
                    showNotification('No image to display', 'warning');
                }
            };
            
            window.closeImageModal = function() {
                const modal = document.getElementById('imageModal');
                modal.classList.add('hidden');
                document.body.style.overflow = ''; // Restore scrolling
            };
            
            // Close modal when clicking outside or pressing Escape
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    closeImageModal();
                }
            });
            
            // Prevent modal from closing when clicking on the image
            document.getElementById('modalImage').addEventListener('click', function(event) {
                event.stopPropagation();
            });
            
            // Notification system
            function showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `fixed top-4 right-4 z-50 px-4 py-3 rounded-lg shadow-lg max-w-sm ${getNotificationClasses(type)}`;
                notification.innerHTML = `
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            ${getNotificationIcon(type)}
                        </div>
                        <div class="ml-3">
                            <p class="text-sm font-medium">${message}</p>
                        </div>
                        <div class="ml-auto pl-3">
                            <button onclick="this.parentElement.parentElement.parentElement.remove()" class="inline-flex text-gray-400 hover:text-gray-600">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 5000);
            }
            
            function getNotificationClasses(type) {
                switch (type) {
                    case 'success':
                        return 'bg-green-50 border border-green-200 text-green-800 dark:bg-green-900/20 dark:border-green-800 dark:text-green-400';
                    case 'error':
                        return 'bg-red-50 border border-red-200 text-red-800 dark:bg-red-900/20 dark:border-red-800 dark:text-red-400';
                    case 'warning':
                        return 'bg-yellow-50 border border-yellow-200 text-yellow-800 dark:bg-yellow-900/20 dark:border-yellow-800 dark:text-yellow-400';
                    default:
                        return 'bg-blue-50 border border-blue-200 text-blue-800 dark:bg-blue-900/20 dark:border-blue-800 dark:text-blue-400';
                }
            }
            
            function getNotificationIcon(type) {
                switch (type) {
                    case 'success':
                        return '<svg class="w-5 h-5 text-green-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>';
                    case 'error':
                        return '<svg class="w-5 h-5 text-red-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>';
                    case 'warning':
                        return '<svg class="w-5 h-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>';
                    default:
                        return '<svg class="w-5 h-5 text-blue-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>';
                }
            }
            
            // Mobile-friendly enhancements
            if (window.innerWidth <= 768) {
                document.querySelectorAll('input, textarea, select').forEach(input => {
                    input.addEventListener('focus', function() {
                        setTimeout(() => {
                            this.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }, 300);
                    });
                });
            }

            // Image editing functionality
            window.showImageEditOptions = function(imgElement, editor) {
                // Remove any existing edit menu
                const existingMenu = document.querySelector('.image-edit-menu');
                if (existingMenu) {
                    existingMenu.remove();
                }

                // Create edit options menu
                const menu = document.createElement('div');
                menu.className = 'image-edit-menu absolute bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-lg shadow-lg p-2 z-50';
                menu.style.minWidth = '200px';

                // Position the menu near the image
                const rect = imgElement.getBoundingClientRect();
                menu.style.position = 'fixed';
                menu.style.top = (rect.top + window.scrollY - 10) + 'px';
                menu.style.left = (rect.right + 10) + 'px';

                // Add menu options
                menu.innerHTML = `
                    <div class="space-y-1">
                        <button class="w-full text-left px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded flex items-center" onclick="resizeImage(this, 'small')">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 13l6 6"></path>
                            </svg>
                            Resize to Small (25%)
                        </button>
                        <button class="w-full text-left px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded flex items-center" onclick="resizeImage(this, 'medium')">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 13l6 6"></path>
                            </svg>
                            Resize to Medium (50%)
                        </button>
                        <button class="w-full text-left px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded flex items-center" onclick="resizeImage(this, 'large')">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 13l6 6"></path>
                            </svg>
                            Resize to Large (75%)
                        </button>
                        <button class="w-full text-left px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded flex items-center" onclick="resizeImage(this, 'full')">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 13l6 6"></path>
                            </svg>
                            Resize to Full (100%)
                        </button>
                        <hr class="my-1 border-gray-200 dark:border-gray-600">
                        <button class="w-full text-left px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded flex items-center" onclick="openImageCropModal(this)">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21L21 7M7 21H3V17M21 7V3H17"></path>
                            </svg>
                            Crop Image
                        </button>
                        <hr class="my-1 border-gray-200 dark:border-gray-600">
                        <button class="w-full text-left px-3 py-2 text-sm text-blue-600 dark:text-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded flex items-center" onclick="previewImage(this)">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            </svg>
                            Preview Full Size
                        </button>
                        <button class="w-full text-left px-3 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 rounded flex items-center" onclick="removeImage(this)">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                            Remove Image
                        </button>
                    </div>
                `;

                // Store references
                menu.imgElement = imgElement;
                menu.editor = editor;

                // Add to document
                document.body.appendChild(menu);

                // Close menu when clicking outside
                setTimeout(() => {
                    const closeHandler = function(e) {
                        if (!menu.contains(e.target) && e.target !== imgElement) {
                            menu.remove();
                            document.removeEventListener('click', closeHandler);
                        }
                    };
                    document.addEventListener('click', closeHandler);
                }, 100);
            };

            // Resize image function
            window.resizeImage = function(button, size) {
                const menu = button.closest('.image-edit-menu');
                const imgElement = menu.imgElement;
                const editor = menu.editor;

                // Define size percentages
                const sizes = {
                    'small': '25%',
                    'medium': '50%', 
                    'large': '75%',
                    'full': '100%'
                };

                // Apply new size
                imgElement.style.maxWidth = sizes[size];
                imgElement.style.width = sizes[size];

                // Update textarea
                syncEditorToTextarea(editor);

                // Show notification
                showNotification(`Image resized to ${size}`, 'success');

                // Close menu
                menu.remove();
            };

            // Preview image function
            window.previewImage = function(button) {
                const menu = button.closest('.image-edit-menu');
                const imgElement = menu.imgElement;
                const originalUrl = imgElement.getAttribute('data-original-url') || imgElement.src;
                
                window.openImageModal(originalUrl, 'Image Preview');
                menu.remove();
            };

            // Remove image function
            window.removeImage = function(button) {
                const menu = button.closest('.image-edit-menu');
                const imgElement = menu.imgElement;
                const editor = menu.editor;

                if (confirm('Are you sure you want to remove this image?')) {
                    imgElement.remove();
                    syncEditorToTextarea(editor);
                    showNotification('Image removed', 'success');
                }
                menu.remove();
            };

            // Helper function to sync editor content to textarea
            function syncEditorToTextarea(editor) {
                let textarea = null;
                if (editor.id === 'wysiwyg-question-text-admin') {
                    textarea = document.querySelector('#id_question_text');
                } else if (editor.id === 'wysiwyg-explanation-text-admin') {
                    textarea = document.querySelector('#id_explanation');
                } else if (editor.id.startsWith('wysiwyg-choice-text-')) {
                    const choiceNumber = editor.id.split('-').pop();
                    const choiceIndex = parseInt(choiceNumber) - 1;
                    textarea = document.querySelector(`#id_choices-${choiceIndex}-choice_text`);
                }

                if (textarea) {
                    textarea.value = editor.innerHTML;
                }

                // Trigger input event
                editor.dispatchEvent(new Event('input', { bubbles: true }));
            }

            // Crop modal function
            window.openImageCropModal = function(button) {
                const menu = button.closest('.image-edit-menu');
                const imgElement = menu.imgElement;
                const editor = menu.editor;
                
                // For now, show a simple crop interface
                // In a full implementation, you might want to integrate a cropping library like Cropper.js
                const cropOptions = [
                    { name: 'Square (1:1)', ratio: '1:1' },
                    { name: 'Wide (16:9)', ratio: '16:9' },
                    { name: 'Portrait (3:4)', ratio: '3:4' },
                    { name: 'Custom', ratio: 'custom' }
                ];

                let optionsHtml = '<div class="space-y-2 p-4">';
                optionsHtml += '<h3 class="text-lg font-medium text-gray-900 dark:text-white mb-3">Crop Options</h3>';
                optionsHtml += '<p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Select an aspect ratio to crop your image:</p>';
                
                cropOptions.forEach((option, index) => {
                    optionsHtml += `
                        <button class="w-full text-left px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded border border-gray-200 dark:border-gray-600" 
                                onclick="applyCrop('${option.ratio}', this)">
                            ${option.name}
                        </button>
                    `;
                });
                
                optionsHtml += '</div>';

                // Create crop modal
                const cropModal = document.createElement('div');
                cropModal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50';
                cropModal.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 rounded-lg max-w-md w-full mx-4">
                        <div class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-600">
                            <h3 class="text-lg font-medium text-gray-900 dark:text-white">Crop Image</h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        ${optionsHtml}
                    </div>
                `;

                // Store references for crop function
                cropModal.imgElement = imgElement;
                cropModal.editor = editor;

                document.body.appendChild(cropModal);
                menu.remove();
            };

            // Apply crop function
            window.applyCrop = function(ratio, button) {
                const modal = button.closest('.fixed');
                const imgElement = modal.imgElement;
                const editor = modal.editor;

                // Apply crop styles based on ratio
                if (ratio === '1:1') {
                    imgElement.style.aspectRatio = '1';
                    imgElement.style.objectFit = 'cover';
                } else if (ratio === '16:9') {
                    imgElement.style.aspectRatio = '16/9';
                    imgElement.style.objectFit = 'cover';
                } else if (ratio === '3:4') {
                    imgElement.style.aspectRatio = '3/4';
                    imgElement.style.objectFit = 'cover';
                } else if (ratio === 'custom') {
                    // For custom, just set object-fit to cover
                    imgElement.style.objectFit = 'cover';
                }

                // Ensure the image has a defined height for aspect ratio to work
                if (ratio !== 'custom') {
                    imgElement.style.height = 'auto';
                    imgElement.style.maxHeight = '300px';
                }

                // Update textarea
                syncEditorToTextarea(editor);

                // Show notification
                showNotification(`Image cropped to ${ratio === 'custom' ? 'custom' : ratio} aspect ratio`, 'success');

                // Close modal
                modal.remove();
            };

            // Handle legacy image options
            window.showLegacyImageOptions = function(imgElement) {
                // Remove any existing edit menu
                const existingMenu = document.querySelector('.image-edit-menu');
                if (existingMenu) {
                    existingMenu.remove();
                }

                // Create edit options menu for legacy images
                const menu = document.createElement('div');
                menu.className = 'image-edit-menu absolute bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-lg shadow-lg p-2 z-50';
                menu.style.minWidth = '200px';

                // Position the menu near the image
                const rect = imgElement.getBoundingClientRect();
                menu.style.position = 'fixed';
                menu.style.top = (rect.top + window.scrollY - 10) + 'px';
                menu.style.left = (rect.right + 10) + 'px';

                // Add menu options for legacy images
                menu.innerHTML = `
                    <div class="space-y-1">
                        <div class="px-3 py-2 text-xs font-medium text-gray-500 dark:text-gray-400 border-b border-gray-200 dark:border-gray-600">
                            Legacy Image Options
                        </div>
                        <button class="w-full text-left px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded flex items-center" onclick="resizeLegacyImage(this, 'small')">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 13l6 6"></path>
                            </svg>
                            Resize to Small
                        </button>
                        <button class="w-full text-left px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded flex items-center" onclick="resizeLegacyImage(this, 'medium')">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 13l6 6"></path>
                            </svg>
                            Resize to Medium
                        </button>
                        <button class="w-full text-left px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded flex items-center" onclick="resizeLegacyImage(this, 'large')">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 13l6 6"></path>
                            </svg>
                            Resize to Large
                        </button>
                        <button class="w-full text-left px-3 py-2 text-sm text-blue-600 dark:text-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded flex items-center" onclick="previewLegacyImage(this)">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            </svg>
                            Preview Full Size
                        </button>
                    </div>
                `;

                // Store reference
                menu.imgElement = imgElement;

                // Add to document
                document.body.appendChild(menu);

                // Close menu when clicking outside
                setTimeout(() => {
                    const closeHandler = function(e) {
                        if (!menu.contains(e.target) && e.target !== imgElement) {
                            menu.remove();
                            document.removeEventListener('click', closeHandler);
                        }
                    };
                    document.addEventListener('click', closeHandler);
                }, 100);
            };

            // Resize legacy image function
            window.resizeLegacyImage = function(button, size) {
                const menu = button.closest('.image-edit-menu');
                const imgElement = menu.imgElement;

                // Define size classes
                const sizes = {
                    'small': 'max-w-32',
                    'medium': 'max-w-48', 
                    'large': 'max-w-64'
                };

                // Remove existing max-width classes
                imgElement.classList.remove('max-w-xs', 'max-w-32', 'max-w-48', 'max-w-64');
                
                // Apply new size class
                imgElement.classList.add(sizes[size]);

                // Show notification
                showNotification(`Legacy image resized to ${size}`, 'success');

                // Close menu
                menu.remove();
            };

            // Preview legacy image function
            window.previewLegacyImage = function(button) {
                const menu = button.closest('.image-edit-menu');
                const imgElement = menu.imgElement;
                const originalUrl = imgElement.getAttribute('data-original-url') || imgElement.src;
                
                window.openImageModal(originalUrl, 'Legacy Image Preview');
                menu.remove();
            };

            // Initialize image resizer functionality
            window.initializeImageResizer = function(resizer, editor) {
                const img = resizer.querySelector('img');
                let isResizing = false;
                let startX, startY, startWidth, startHeight, currentHandle;
                
                // Add click handler to select image
                resizer.addEventListener('click', function(e) {
                    e.stopPropagation();
                    e.preventDefault();
                    
                    // Remove selection from other images
                    document.querySelectorAll('.image-resizer.selected').forEach(r => {
                        if (r !== resizer) r.classList.remove('selected');
                    });
                    resizer.classList.add('selected');
                });
                
                // Add resize handle functionality
                resizer.querySelectorAll('.resize-handle').forEach(handle => {
                    handle.addEventListener('mousedown', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        isResizing = true;
                        currentHandle = this.getAttribute('data-handle');
                        startX = e.clientX;
                        startY = e.clientY;
                        startWidth = img.offsetWidth;
                        startHeight = img.offsetHeight;
                        
                        resizer.classList.add('selected');
                        document.body.style.userSelect = 'none';
                        
                        // Add global mouse events
                        document.addEventListener('mousemove', handleResize);
                        document.addEventListener('mouseup', stopResize);
                    });
                });
                
                function handleResize(e) {
                    if (!isResizing) return;
                    
                    const dx = e.clientX - startX;
                    const dy = e.clientY - startY;
                    
                    let newWidth = startWidth;
                    let newHeight = startHeight;
                    
                    // Calculate new dimensions based on handle direction
                    switch (currentHandle) {
                        case 'se': // Southeast
                            newWidth = startWidth + dx;
                            newHeight = startHeight + dy;
                            break;
                        case 'sw': // Southwest
                            newWidth = startWidth - dx;
                            newHeight = startHeight + dy;
                            break;
                        case 'ne': // Northeast
                            newWidth = startWidth + dx;
                            newHeight = startHeight - dy;
                            break;
                        case 'nw': // Northwest
                            newWidth = startWidth - dx;
                            newHeight = startHeight - dy;
                            break;
                        case 'e': // East
                            newWidth = startWidth + dx;
                            break;
                        case 'w': // West
                            newWidth = startWidth - dx;
                            break;
                        case 's': // South
                            newHeight = startHeight + dy;
                            break;
                        case 'n': // North
                            newHeight = startHeight - dy;
                            break;
                    }
                    
                    // Apply minimum constraints
                    newWidth = Math.max(50, newWidth);
                    newHeight = Math.max(50, newHeight);
                    
                    // Apply new dimensions
                    img.style.width = newWidth + 'px';
                    img.style.height = newHeight + 'px';
                    img.style.maxWidth = 'none';
                    img.style.maxHeight = 'none';
                }
                
                function stopResize() {
                    if (!isResizing) return;
                    
                    isResizing = false;
                    document.body.style.userSelect = '';
                    
                    // Remove global mouse events
                    document.removeEventListener('mousemove', handleResize);
                    document.removeEventListener('mouseup', stopResize);
                    
                    // Sync content to textarea
                    syncEditorToTextarea(editor);
                    
                    showNotification('Image resized successfully!', 'success');
                }
            };

            // Toolbar functions for image resizer
            window.startCropMode = function(button) {
                const resizer = button.closest('.image-resizer');
                const img = resizer.querySelector('img');
                
                // Prevent form submission
                if (button && button.tagName === 'BUTTON') {
                    button.type = 'button';
                }
                
                // Toggle crop mode
                if (resizer.querySelector('.crop-overlay')) {
                    exitCropMode(resizer);
                } else {
                    enterCropMode(resizer);
                }
            };
            
            function enterCropMode(resizer) {
                const img = resizer.querySelector('img');
                
                // Create crop overlay
                const overlay = document.createElement('div');
                overlay.className = 'crop-overlay';
                
                // Create crop area (starts at center)
                const cropArea = document.createElement('div');
                cropArea.className = 'crop-area';
                const imgRect = img.getBoundingClientRect();
                const resizerRect = resizer.getBoundingClientRect();
                
                // Position crop area in center (25% of image size)
                const cropWidth = Math.min(200, img.offsetWidth * 0.5);
                const cropHeight = Math.min(200, img.offsetHeight * 0.5);
                const left = (img.offsetWidth - cropWidth) / 2;
                const top = (img.offsetHeight - cropHeight) / 2;
                
                cropArea.style.left = left + 'px';
                cropArea.style.top = top + 'px';
                cropArea.style.width = cropWidth + 'px';
                cropArea.style.height = cropHeight + 'px';
                
                // Add crop handles
                ['nw', 'ne', 'sw', 'se'].forEach(pos => {
                    const handle = document.createElement('div');
                    handle.className = `crop-handle ${pos}`;
                    cropArea.appendChild(handle);
                });
                
                overlay.appendChild(cropArea);
                resizer.appendChild(overlay);
                
                // Initialize crop functionality
                initializeCropArea(cropArea, img, resizer);
                
                // Update toolbar button
                const button = resizer.querySelector('[onclick*="startCropMode"]');
                button.innerHTML = '✓';
                button.title = 'Apply Crop';
                button.type = 'button';
                button.onclick = function(e) { 
                    e.preventDefault(); 
                    e.stopPropagation(); 
                    applyCropFromResizer(this); 
                };
                
                showNotification('Crop mode active. Drag the crop area or resize it, then click ✓ to apply.', 'info');
            }
            
            function exitCropMode(resizer) {
                const overlay = resizer.querySelector('.crop-overlay');
                if (overlay) {
                    overlay.remove();
                }
                
                // Reset toolbar button
                const button = resizer.querySelector('[onclick*="applyCropFromResizer"]') || 
                              resizer.querySelector('[title="Apply Crop"]');
                if (button) {
                    button.innerHTML = '✂️';
                    button.title = 'Crop';
                    button.type = 'button';
                    button.onclick = function(e) { 
                        e.preventDefault(); 
                        e.stopPropagation(); 
                        startCropMode(this); 
                    };
                }
            }
            
            function initializeCropArea(cropArea, img, resizer) {
                let isDragging = false;
                let isResizingCrop = false;
                let startX, startY, startLeft, startTop, startWidth, startHeight, currentCropHandle;
                
                // Make crop area draggable
                cropArea.addEventListener('mousedown', function(e) {
                    if (e.target.classList.contains('crop-handle')) return;
                    
                    e.preventDefault();
                    isDragging = true;
                    startX = e.clientX;
                    startY = e.clientY;
                    startLeft = parseInt(cropArea.style.left);
                    startTop = parseInt(cropArea.style.top);
                    
                    document.addEventListener('mousemove', dragCropArea);
                    document.addEventListener('mouseup', stopCropDrag);
                });
                
                // Make crop handles resizable
                cropArea.querySelectorAll('.crop-handle').forEach(handle => {
                    handle.addEventListener('mousedown', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        isResizingCrop = true;
                        currentCropHandle = this.classList[1];
                        startX = e.clientX;
                        startY = e.clientY;
                        startLeft = parseInt(cropArea.style.left);
                        startTop = parseInt(cropArea.style.top);
                        startWidth = parseInt(cropArea.style.width);
                        startHeight = parseInt(cropArea.style.height);
                        
                        document.addEventListener('mousemove', resizeCropArea);
                        document.addEventListener('mouseup', stopCropResize);
                    });
                });
                
                function dragCropArea(e) {
                    if (!isDragging) return;
                    
                    const dx = e.clientX - startX;
                    const dy = e.clientY - startY;
                    
                    let newLeft = startLeft + dx;
                    let newTop = startTop + dy;
                    
                    // Constrain to image bounds
                    newLeft = Math.max(0, Math.min(newLeft, img.offsetWidth - parseInt(cropArea.style.width)));
                    newTop = Math.max(0, Math.min(newTop, img.offsetHeight - parseInt(cropArea.style.height)));
                    
                    cropArea.style.left = newLeft + 'px';
                    cropArea.style.top = newTop + 'px';
                }
                
                function resizeCropArea(e) {
                    if (!isResizingCrop) return;
                    
                    const dx = e.clientX - startX;
                    const dy = e.clientY - startY;
                    
                    let newLeft = startLeft;
                    let newTop = startTop;
                    let newWidth = startWidth;
                    let newHeight = startHeight;
                    
                    switch (currentCropHandle) {
                        case 'se':
                            newWidth = startWidth + dx;
                            newHeight = startHeight + dy;
                            break;
                        case 'sw':
                            newLeft = startLeft + dx;
                            newWidth = startWidth - dx;
                            newHeight = startHeight + dy;
                            break;
                        case 'ne':
                            newTop = startTop + dy;
                            newWidth = startWidth + dx;
                            newHeight = startHeight - dy;
                            break;
                        case 'nw':
                            newLeft = startLeft + dx;
                            newTop = startTop + dy;
                            newWidth = startWidth - dx;
                            newHeight = startHeight - dy;
                            break;
                    }
                    
                    // Apply constraints
                    newWidth = Math.max(20, Math.min(newWidth, img.offsetWidth - newLeft));
                    newHeight = Math.max(20, Math.min(newHeight, img.offsetHeight - newTop));
                    newLeft = Math.max(0, Math.min(newLeft, img.offsetWidth - newWidth));
                    newTop = Math.max(0, Math.min(newTop, img.offsetHeight - newHeight));
                    
                    cropArea.style.left = newLeft + 'px';
                    cropArea.style.top = newTop + 'px';
                    cropArea.style.width = newWidth + 'px';
                    cropArea.style.height = newHeight + 'px';
                }
                
                function stopCropDrag() {
                    isDragging = false;
                    document.removeEventListener('mousemove', dragCropArea);
                    document.removeEventListener('mouseup', stopCropDrag);
                }
                
                function stopCropResize() {
                    isResizingCrop = false;
                    document.removeEventListener('mousemove', resizeCropArea);
                    document.removeEventListener('mouseup', stopCropResize);
                }
            }
            
            window.applyCropFromResizer = function(button) {
                const resizer = button.closest('.image-resizer');
                const img = resizer.querySelector('img');
                const cropArea = resizer.querySelector('.crop-area');
                const editor = resizer.closest('[data-wysiwyg="true"]');
                
                // Prevent form submission
                if (button && button.tagName === 'BUTTON') {
                    button.type = 'button';
                }
                
                if (!cropArea) return;
                
                // Get crop dimensions
                const cropLeft = parseInt(cropArea.style.left);
                const cropTop = parseInt(cropArea.style.top);
                const cropWidth = parseInt(cropArea.style.width);
                const cropHeight = parseInt(cropArea.style.height);
                
                // Apply crop using CSS clip-path
                img.style.clipPath = `inset(${cropTop}px ${img.offsetWidth - cropLeft - cropWidth}px ${img.offsetHeight - cropTop - cropHeight}px ${cropLeft}px)`;
                
                // Exit crop mode
                exitCropMode(resizer);
                
                // Sync content
                syncEditorToTextarea(editor);
                
                showNotification('Crop applied successfully!', 'success');
            };
            
            window.resizeImageToPercent = function(button, percentage) {
                const resizer = button.closest('.image-resizer');
                const img = resizer.querySelector('img');
                const editor = resizer.closest('[data-wysiwyg="true"]');
                
                // Prevent form submission
                if (button && button.tagName === 'BUTTON') {
                    button.type = 'button';
                }
                
                // Get the original image dimensions
                const tempImg = new Image();
                tempImg.onload = function() {
                    const originalWidth = this.naturalWidth;
                    const originalHeight = this.naturalHeight;
                    
                    // Calculate new dimensions based on percentage
                    const newWidth = (originalWidth * percentage) / 100;
                    const newHeight = (originalHeight * percentage) / 100;
                    
                    // Apply new size
                    img.style.width = newWidth + 'px';
                    img.style.height = newHeight + 'px';
                    img.style.maxWidth = 'none';
                    
                    // Exit crop mode if active
                    exitCropMode(resizer);
                    
                    // Sync content
                    syncEditorToTextarea(editor);
                    
                    showNotification(`Image resized to ${percentage}%!`, 'success');
                };
                tempImg.src = img.dataset.originalSrc || img.src;
            };
            
            window.resetImageSize = function(button) {
                const resizer = button.closest('.image-resizer');
                const img = resizer.querySelector('img');
                const editor = resizer.closest('[data-wysiwyg="true"]');
                
                // Prevent form submission
                if (button && button.tagName === 'BUTTON') {
                    button.type = 'button';
                }
                
                // Reset all modifications
                img.style.width = '';
                img.style.height = '';
                img.style.maxWidth = '100%';
                img.style.maxHeight = '';
                img.style.clipPath = '';
                img.style.aspectRatio = '';
                img.style.objectFit = '';
                
                // Exit crop mode if active
                exitCropMode(resizer);
                
                // Sync content
                syncEditorToTextarea(editor);
                
                showNotification('Image reset to original size!', 'success');
            };
            
            window.removeImageFromResizer = function(button) {
                const resizer = button.closest('.image-resizer');
                const editor = resizer.closest('[data-wysiwyg="true"]');
                
                // Prevent form submission
                if (button && button.tagName === 'BUTTON') {
                    button.type = 'button';
                }
                
                if (confirm('Are you sure you want to remove this image?')) {
                    resizer.remove();
                    syncEditorToTextarea(editor);
                    showNotification('Image removed successfully!', 'success');
                }
            };
            
            window.previewImageFromResizer = function(button) {
                const resizer = button.closest('.image-resizer');
                const img = resizer.querySelector('img');
                const originalUrl = img.getAttribute('data-original-url') || img.src;
                
                // Prevent form submission
                if (button && button.tagName === 'BUTTON') {
                    button.type = 'button';
                }
                
                window.openImageModal(originalUrl, 'Image Preview');
            };
            
            // Global click handler to deselect images
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.image-resizer')) {
                    document.querySelectorAll('.image-resizer.selected').forEach(r => {
                        r.classList.remove('selected');
                    });
                }
            });

            // Add event delegation for toolbar buttons to prevent form submission
            document.addEventListener('click', function(e) {
                // Only run if we have image resizers on the page
                const hasResizers = document.querySelector('.image-resizer');
                if (!hasResizers) return;
                
                if (e.target.classList.contains('toolbar-btn')) {
                    e.preventDefault();
                    e.stopPropagation();
                    // The onclick handlers will still execute
                }
            });
            
            // Simple Image Resizer Functionality
            function wrapImageInResizer(img) {
                // Check if already wrapped
                const existingWrapper = img.closest('.image-resizer');
                if (existingWrapper) {
                    console.log('Image already wrapped');
                    
                    // Check if wrapper has toolbar
                    let existingToolbar = existingWrapper.querySelector('.image-edit-toolbar');
                    if (existingToolbar) {
                        // Ensure toolbar is visible and functional
                        existingToolbar.style.display = 'block';
                        existingToolbar.style.opacity = '1';
                        existingToolbar.style.visibility = 'visible';
                        // Re-attach click handler
                        addImageClickHandler(img, existingToolbar, existingWrapper);
                        return;
                    }
                    
                    // Add toolbar to existing wrapper
                    const toolbar = createToolbar();
                    existingWrapper.appendChild(toolbar);
                    addImageClickHandler(img, toolbar, existingWrapper);
                    return;
                }
                
                // Create wrapper
                const wrapper = document.createElement('div');
                wrapper.className = 'image-resizer';
                wrapper.style.cssText = `
                    display: inline-block;
                    position: relative;
                    margin: 10px 0;
                    cursor: pointer;
                    border: 2px solid transparent;
                    border-radius: 4px;
                    transition: border-color 0.2s ease;
                `;
                
                // Create and add toolbar
                const toolbar = createToolbar();
                
                // Insert wrapper and move image
                img.parentNode.insertBefore(wrapper, img);
                wrapper.appendChild(img);
                wrapper.appendChild(toolbar);
                
                // Add click handler
                addImageClickHandler(img, toolbar, wrapper);
            }
            
            // Helper function to create toolbar
            function createToolbar() {
                const toolbar = document.createElement('div');
                toolbar.className = 'image-edit-toolbar';
                toolbar.style.cssText = `
                    display: none;
                    position: absolute;
                    top: -45px;
                    right: 0px;
                    background: rgba(31, 41, 55, 0.95);
                    padding: 8px;
                    border-radius: 8px;
                    z-index: 1000;
                    white-space: nowrap;
                    opacity: 0;
                    visibility: hidden;
                    transition: opacity 0.2s ease, visibility 0.2s ease;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
                    border: 1px solid rgba(75, 85, 99, 0.5);
                    min-width: 200px;
                    backdrop-filter: blur(4px);
                `;
                
                toolbar.innerHTML = `
                    <div style="display: flex; gap: 4px; align-items: center;">
                        <button type="button" onclick="resizeImagePercent(this, 25)" style="
                            padding: 6px 10px; 
                            background: #374151; 
                            color: white; 
                            border: 1px solid #4B5563; 
                            border-radius: 4px; 
                            font-size: 11px; 
                            cursor: pointer;
                            transition: background 0.2s ease;
                            min-width: 35px;
                        " onmouseover="this.style.background='#4B5563'" onmouseout="this.style.background='#374151'">25%</button>
                        <button type="button" onclick="resizeImagePercent(this, 50)" style="
                            padding: 6px 10px; 
                            background: #374151; 
                            color: white; 
                            border: 1px solid #4B5563; 
                            border-radius: 4px; 
                            font-size: 11px; 
                            cursor: pointer;
                            transition: background 0.2s ease;
                            min-width: 35px;
                        " onmouseover="this.style.background='#4B5563'" onmouseout="this.style.background='#374151'">50%</button>
                        <button type="button" onclick="resizeImagePercent(this, 75)" style="
                            padding: 6px 10px; 
                            background: #374151; 
                            color: white; 
                            border: 1px solid #4B5563; 
                            border-radius: 4px; 
                            font-size: 11px; 
                            cursor: pointer;
                            transition: background 0.2s ease;
                            min-width: 35px;
                        " onmouseover="this.style.background='#4B5563'" onmouseout="this.style.background='#374151'">75%</button>
                        <button type="button" onclick="resizeImagePercent(this, 100)" style="
                            padding: 6px 10px; 
                            background: #16A34A; 
                            color: white; 
                            border: 1px solid #15803D; 
                            border-radius: 4px; 
                            font-size: 11px; 
                            cursor: pointer;
                            transition: background 0.2s ease;
                            min-width: 40px;
                            font-weight: 500;
                        " onmouseover="this.style.background='#15803D'" onmouseout="this.style.background='#16A34A'">100%</button>
                        <button type="button" onclick="removeImageFromResizer(this)" style="
                            padding: 6px 8px; 
                            background: #DC2626; 
                            color: white; 
                            border: 1px solid #B91C1C; 
                            border-radius: 4px; 
                            font-size: 11px; 
                            cursor: pointer;
                            transition: background 0.2s ease;
                            min-width: 25px;
                        " onmouseover="this.style.background='#B91C1C'" onmouseout="this.style.background='#DC2626'" title="Remove Image">×</button>
                    </div>
                `;
                
                return toolbar;
            }
            
            // Helper function to add click handler
            function addImageClickHandler(img, toolbar, wrapper) {
                // Remove any existing event listeners
                img.onclick = null;
                
                img.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Hide all other toolbars first
                    document.querySelectorAll('.image-edit-toolbar').forEach(t => {
                        if (t !== toolbar) {
                            t.style.display = 'none';
                            t.style.opacity = '0';
                            t.style.visibility = 'hidden';
                        }
                    });
                    document.querySelectorAll('.image-resizer').forEach(r => {
                        r.classList.remove('selected');
                    });
                    
                    // Show this toolbar with multiple fallbacks
                    toolbar.style.display = 'block';
                    toolbar.style.opacity = '1';
                    toolbar.style.visibility = 'visible';
                    
                    // Smart positioning to avoid being cut off
                    const imgRect = img.getBoundingClientRect();
                    const toolbarHeight = 50; // Estimated toolbar height
                    const viewportHeight = window.innerHeight;
                    
                    // Position above image if there's space, otherwise below
                    if (imgRect.top > toolbarHeight + 20) {
                        toolbar.style.top = '-45px';
                        toolbar.style.bottom = 'auto';
                    } else {
                        toolbar.style.top = 'auto';
                        toolbar.style.bottom = '-45px';
                    }
                    
                    // Ensure toolbar doesn't go off-screen horizontally
                    toolbar.style.right = '0px';
                    toolbar.style.left = 'auto';
                    
                    wrapper.classList.add('selected');
                });
            }
            
            // Resize function
            window.resizeImagePercent = function(button, percentage) {
                const wrapper = button.closest('.image-resizer');
                const img = wrapper.querySelector('img');
                const originalWidth = img.naturalWidth;
                const originalHeight = img.naturalHeight;
                
                const newWidth = (originalWidth * percentage) / 100;
                const newHeight = (originalHeight * percentage) / 100;
                
                img.style.width = newWidth + 'px';
                img.style.height = newHeight + 'px';
                img.style.maxWidth = 'none';
                img.style.maxHeight = 'none';
                
                // Sync content to textarea
                const editor = wrapper.closest('[data-wysiwyg="true"]');
                if (editor) {
                    syncEditorToTextarea(editor);
                }
            };
            
            // Remove image function
            window.removeImageFromResizer = function(button) {
                if (confirm('Are you sure you want to remove this image?')) {
                    const wrapper = button.closest('.image-resizer');
                    const editor = wrapper.closest('[data-wysiwyg="true"]');
                    
                    // Remove the entire wrapper
                    wrapper.remove();
                    
                    // Sync content to textarea
                    if (editor) {
                        syncEditorToTextarea(editor);
                    }
                }
            };
            
            // Initialize images
            function initializeImageResizers() {
                // Only run on pages with WYSIWYG editors
                const editors = document.querySelectorAll('[data-wysiwyg="true"]');
                if (editors.length === 0) {
                    return; // Exit if no WYSIWYG editors found
                }
                
                editors.forEach((editor, index) => {
                    const images = editor.querySelectorAll('img');
                    
                    images.forEach((img, imgIndex) => {
                        wrapImageInResizer(img);
                    });
                });
            }
            
            // Hide toolbar when clicking outside
            document.addEventListener('click', function(e) {
                // Only run if we have image resizers on the page
                const hasResizers = document.querySelector('.image-resizer');
                if (!hasResizers) return;
                
                if (!e.target.closest('.image-resizer')) {
                    document.querySelectorAll('.image-edit-toolbar').forEach(toolbar => {
                        toolbar.style.display = 'none';
                    });
                    document.querySelectorAll('.image-resizer').forEach(wrapper => {
                        wrapper.classList.remove('selected');
                    });
                }
            });
            
            // Initialize on load
            setTimeout(() => {
                // Only initialize image resizers on question form pages
                if (document.querySelector('#wysiwyg-question-text-admin') || 
                    document.querySelector('#wysiwyg-explanation-admin') ||
                    document.querySelector('[id^="wysiwyg-choice-text-"]')) {
                    initializeImageResizers();
                }
            }, 500);
        });
    </script>

    <!-- LaTeX Guide Modal -->
    <div id="latexGuideModal" tabindex="-1" aria-hidden="true" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
      <div class="relative p-4 w-full max-w-6xl max-h-full">
        <!-- Modal content -->
        <div class="relative bg-white rounded-lg shadow dark:bg-gray-700">
          <!-- Modal header -->
          <div class="flex items-center justify-between p-4 md:p-5 border-b rounded-t dark:border-gray-600">
            <h3 class="text-xl font-semibold text-gray-900 dark:text-white">
              📖 LaTeX Guide - Panduan Penulisan Formula Matematika
            </h3>
            <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white" id="closeLatexGuideBtnAdmin">
              <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
              </svg>
              <span class="sr-only">Close modal</span>
            </button>
          </div>
          <!-- Modal body -->
          <div class="p-4 md:p-5 space-y-6 max-h-96 overflow-y-auto">
            
            <!-- Dasar-dasar LaTeX -->
            <div class="space-y-3">
              <h4 class="text-lg font-medium text-gray-900 dark:text-white">🎯 Dasar-dasar LaTeX</h4>
              <p class="text-sm text-gray-700 dark:text-gray-300">LaTeX menggunakan tanda $ untuk mengapit formula matematika. Contoh: <code class="bg-gray-100 dark:bg-gray-800 px-2 py-1 rounded">$x^2 + y^2 = z^2$</code></p>
            </div>

            <!-- Grid dengan contoh -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              
              <!-- Eksponen dan Subskrip -->
              <div class="space-y-3">
                <h5 class="font-medium text-gray-900 dark:text-white">⬆️ Eksponen & Subskrip</h5>
                <div class="space-y-2 text-sm">
                  <div class="flex justify-between bg-gray-50 dark:bg-gray-800 p-2 rounded">
                    <code>x^2</code>
                    <span>→ x²</span>
                  </div>
                  <div class="flex justify-between bg-gray-50 dark:bg-gray-800 p-2 rounded">
                    <code>x^{2n+1}</code>
                    <span>→ x^(2n+1)</span>
                  </div>
                  <div class="flex justify-between bg-gray-50 dark:bg-gray-800 p-2 rounded">
                    <code>x_1</code>
                    <span>→ x₁</span>
                  </div>
                  <div class="flex justify-between bg-gray-50 dark:bg-gray-800 p-2 rounded">
                    <code>x_{i,j}</code>
                    <span>→ x_(i,j)</span>
                  </div>
                </div>
              </div>

              <!-- Pecahan -->
              <div class="space-y-3">
                <h5 class="font-medium text-gray-900 dark:text-white">➗ Pecahan</h5>
                <div class="space-y-2 text-sm">
                  <div class="flex justify-between bg-gray-50 dark:bg-gray-800 p-2 rounded">
                    <code>\frac{a}{b}</code>
                    <span>→ a/b</span>
                  </div>
                  <div class="flex justify-between bg-gray-50 dark:bg-gray-800 p-2 rounded">
                    <code>\frac{x+1}{x-1}</code>
                    <span>→ (x+1)/(x-1)</span>
                  </div>
                  <div class="flex justify-between bg-gray-50 dark:bg-gray-800 p-2 rounded">
                    <code>\frac{1}{2}</code>
                    <span>→ ½</span>
                  </div>
                </div>
              </div>

              <!-- Akar -->
              <div class="space-y-3">
                <h5 class="font-medium text-gray-900 dark:text-white">√ Akar</h5>
                <div class="space-y-2 text-sm">
                  <div class="flex justify-between bg-gray-50 dark:bg-gray-800 p-2 rounded">
                    <code>\sqrt{x}</code>
                    <span>→ √x</span>
                  </div>
                  <div class="flex justify-between bg-gray-50 dark:bg-gray-800 p-2 rounded">
                    <code>\sqrt[3]{x}</code>
                    <span>→ ∛x</span>
                  </div>
                  <div class="flex justify-between bg-gray-50 dark:bg-gray-800 p-2 rounded">
                    <code>\sqrt{x^2+y^2}</code>
                    <span>→ √(x²+y²)</span>
                  </div>
                </div>
              </div>

              <!-- Trigonometri -->
              <div class="space-y-3">
                <h5 class="font-medium text-gray-900 dark:text-white">📐 Trigonometri</h5>
                <div class="space-y-2 text-sm">
                  <div class="flex justify-between bg-gray-50 dark:bg-gray-800 p-2 rounded">
                    <code>\sin x</code>
                    <span>→ sin x</span>
                  </div>
                  <div class="flex justify-between bg-gray-50 dark:bg-gray-800 p-2 rounded">
                    <code>\cos \theta</code>
                    <span>→ cos θ</span>
                  </div>
                  <div class="flex justify-between bg-gray-50 dark:bg-gray-800 p-2 rounded">
                    <code>\tan^{-1} x</code>
                    <span>→ tan⁻¹ x</span>
                  </div>
                </div>
              </div>

              <!-- Logaritma -->
              <div class="space-y-3">
                <h5 class="font-medium text-gray-900 dark:text-white">📊 Logaritma</h5>
                <div class="space-y-2 text-sm">
                  <div class="flex justify-between bg-gray-50 dark:bg-gray-800 p-2 rounded">
                    <code>\log x</code>
                    <span>→ log x</span>
                  </div>
                  <div class="flex justify-between bg-gray-50 dark:bg-gray-800 p-2 rounded">
                    <code>\ln x</code>
                    <span>→ ln x</span>
                  </div>
                  <div class="flex justify-between bg-gray-50 dark:bg-gray-800 p-2 rounded">
                    <code>\log_2 x</code>
                    <span>→ log₂ x</span>
                  </div>
                </div>
              </div>

              <!-- Integral dan Turunan -->
              <div class="space-y-3">
                <h5 class="font-medium text-gray-900 dark:text-white">∫ Kalkulus</h5>
                <div class="space-y-2 text-sm">
                  <div class="flex justify-between bg-gray-50 dark:bg-gray-800 p-2 rounded">
                    <code>\int x dx</code>
                    <span>→ ∫ x dx</span>
                  </div>
                  <div class="flex justify-between bg-gray-50 dark:bg-gray-800 p-2 rounded">
                    <code>\int_0^1 x dx</code>
                    <span>→ ∫₀¹ x dx</span>
                  </div>
                  <div class="flex justify-between bg-gray-50 dark:bg-gray-800 p-2 rounded">
                    <code>\frac{dy}{dx}</code>
                    <span>→ dy/dx</span>
                  </div>
                  <div class="flex justify-between bg-gray-50 dark:bg-gray-800 p-2 rounded">
                    <code>\sum_{i=1}^n i</code>
                    <span>→ Σᵢ₌₁ⁿ i</span>
                  </div>
                </div>
              </div>

              <!-- Matriks -->
              <div class="space-y-3">
                <h5 class="font-medium text-gray-900 dark:text-white">🔢 Matriks</h5>
                <div class="space-y-2 text-sm">
                  <div class="bg-gray-50 dark:bg-gray-800 p-2 rounded">
                    <code>\begin{matrix} a & b \\ c & d \end{matrix}</code>
                  </div>
                  <div class="bg-gray-50 dark:bg-gray-800 p-2 rounded">
                    <code>\begin{pmatrix} 1 & 2 \\ 3 & 4 \end{pmatrix}</code>
                  </div>
                </div>
              </div>

              <!-- Simbol Khusus -->
              <div class="space-y-3">
                <h5 class="font-medium text-gray-900 dark:text-white">🔤 Huruf Yunani & Simbol</h5>
                <div class="space-y-2 text-sm">
                  <div class="flex justify-between bg-gray-50 dark:bg-gray-800 p-2 rounded">
                    <code>\alpha, \beta, \gamma</code>
                    <span>→ α, β, γ</span>
                  </div>
                  <div class="flex justify-between bg-gray-50 dark:bg-gray-800 p-2 rounded">
                    <code>\pi, \theta, \phi</code>
                    <span>→ π, θ, φ</span>
                  </div>
                  <div class="flex justify-between bg-gray-50 dark:bg-gray-800 p-2 rounded">
                    <code>\infty, \pm, \neq</code>
                    <span>→ ∞, ±, ≠</span>
                  </div>
                  <div class="flex justify-between bg-gray-50 dark:bg-gray-800 p-2 rounded">
                    <code>\leq, \geq, \approx</code>
                    <span>→ ≤, ≥, ≈</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Contoh Lengkap -->
            <div class="space-y-3 mt-6 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
              <h4 class="text-lg font-medium text-blue-900 dark:text-blue-100">💡 Contoh Formula Lengkap</h4>
              <div class="space-y-3 text-sm">
                <div>
                  <strong>Rumus Kuadrat:</strong><br>
                  <code class="bg-white dark:bg-gray-800 px-2 py-1 rounded">x = \frac{-b \pm \sqrt{b^2 - 4ac}}{2a}</code>
                </div>
                <div>
                  <strong>Teorema Pythagoras:</strong><br>
                  <code class="bg-white dark:bg-gray-800 px-2 py-1 rounded">a^2 + b^2 = c^2</code>
                </div>
                <div>
                  <strong>Integral Tentu:</strong><br>
                  <code class="bg-white dark:bg-gray-800 px-2 py-1 rounded">\int_0^{\pi} \sin x \, dx = 2</code>
                </div>
                <div>
                  <strong>Limit:</strong><br>
                  <code class="bg-white dark:bg-gray-800 px-2 py-1 rounded">\lim_{x \to 0} \frac{\sin x}{x} = 1</code>
                </div>
              </div>
            </div>

            <!-- Tips -->
            <div class="space-y-3 mt-6 p-4 bg-green-50 dark:bg-green-900/20 rounded-lg">
              <h4 class="text-lg font-medium text-green-900 dark:text-green-100">💡 Tips Penting</h4>
              <ul class="text-sm text-green-800 dark:text-green-200 space-y-1 list-disc list-inside">
                <li>Gunakan kurung kurawal <code>{}</code> untuk mengelompokkan elemen yang panjang</li>
                <li>Spasi diabaikan dalam LaTeX, gunakan <code>\,</code> atau <code>\ </code> untuk spasi paksa</li>
                <li>Untuk tanda kurung besar, gunakan <code>\left(</code> dan <code>\right)</code></li>
                <li>Preview formula sebelum menyimpan untuk memastikan tampilan yang benar</li>
              </ul>
            </div>

          </div>
        </div>
      </div>
    </div>
{% endblock %}
