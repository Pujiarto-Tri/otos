{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title|default:"Question Form" }}{% endblock %}

{% block extrahead %}
    <!-- Quill.js Rich Text Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS_HTML"></script>
    <!-- Flowbite: UI components (relies on Tailwind) -->
    <script src="https://unpkg.com/flowbite@1.7.0/dist/flowbite.min.js"></script>
    <style>
        /* CSS Variables for consistent theming */
        :root {
            /* Light theme colors */
            --qf-bg-primary: #ffffff;
            --qf-bg-secondary: #f8fafc;
            --qf-text-primary: #1f2937;
            --qf-text-secondary: #6b7280;
            --qf-border: #e5e7eb;
            --qf-border-focus: #3b82f6;
            --qf-placeholder: rgba(107, 114, 128, 0.7);
        }

        .dark {
            /* Dark theme colors */
            --qf-bg-primary: #1f2937;
            --qf-bg-secondary: #374151;
            --qf-text-primary: #f9fafb;
            --qf-text-secondary: #d1d5db;
            --qf-border: #4b5563;
            --qf-border-focus: #60a5fa;
            --qf-placeholder: rgba(209, 213, 219, 0.7);
            --qf-toolbar-icon: #e5e7eb; /* Specific color for toolbar icons */
        }

        /* Quill Rich Text Editor Styling */
        #quill-editor .ql-toolbar.ql-snow {
            background: var(--qf-bg-secondary) !important;
            border: 1px solid var(--qf-border) !important;
            border-radius: 0.5rem 0.5rem 0 0 !important;
            border-bottom: none !important;
        }

        /* Dark mode toolbar with better contrast */
        .dark #quill-editor .ql-toolbar.ql-snow,
        html.dark #quill-editor .ql-toolbar.ql-snow,
        [data-theme="dark"] #quill-editor .ql-toolbar.ql-snow {
            background: #374151 !important; /* Lighter than secondary bg for better contrast */
            border-color: #6b7280 !important;
        }

    /* Do not use filter invert; rely on stroke/fill rules to keep icons outlined and colored */

        #quill-editor .ql-container.ql-snow {
            background: var(--qf-bg-primary) !important;
            border: 1px solid var(--qf-border) !important;
            border-radius: 0 0 0.5rem 0.5rem !important;
            border-top: none !important;
        }

        #quill-editor .ql-editor {
            min-height: 280px !important;
            background: var(--qf-bg-primary) !important;
            color: var(--qf-text-primary) !important;
            font-family: system-ui, -apple-system, sans-serif !important;
            font-size: 15px !important;
            line-height: 1.6 !important;
            padding: 16px !important;
        }

        /* Toolbar buttons and icons */
        #quill-editor .ql-toolbar button,
        #quill-editor .ql-toolbar .ql-picker-label {
            color: var(--qf-text-primary) !important;
        }

        #quill-editor .ql-toolbar button:hover,
        #quill-editor .ql-toolbar .ql-picker-label:hover {
            background: rgba(59, 130, 246, 0.1) !important;
            color: var(--qf-border-focus) !important;
        }

        #quill-editor .ql-toolbar .ql-active {
            background: rgba(59, 130, 246, 0.15) !important;
            color: var(--qf-border-focus) !important;
        }

        /* Make active toolbar icons visually distinct (outlined + accent stroke) */
        #quill-editor .ql-toolbar .ql-active svg,
        #quill-editor .ql-toolbar .ql-active svg * {
            stroke: var(--qf-border-focus) !important;
            fill: none !important; /* Keep outlined */
            stroke-width: 1.8 !important;
        }

        /* Theme classes applied by JS: allows CSS to drive visual states without inline styles */
        #quill-editor .ql-toolbar.qf-theme-dark button,
        #quill-editor .ql-toolbar.qf-theme-dark .ql-picker-label {
            color: #ffffff !important;
            background: rgba(255,255,255,0.03) !important;
        }

        #quill-editor .ql-toolbar.qf-theme-dark button:hover,
        #quill-editor .ql-toolbar.qf-theme-dark .ql-picker-label:hover {
            color: var(--qf-border-focus) !important;
        }

        #quill-editor .ql-toolbar.qf-theme-light button,
        #quill-editor .ql-toolbar.qf-theme-light .ql-picker-label {
            color: #374151 !important;
            background: transparent !important;
        }

        #quill-editor .ql-toolbar.qf-theme-light button:hover,
        #quill-editor .ql-toolbar.qf-theme-light .ql-picker-label:hover {
            color: var(--qf-border-focus) !important;
        }

        #quill-editor .ql-toolbar svg {
            stroke: currentColor !important;
            fill: currentColor !important;
        }

        /* Dark mode specific toolbar styling for better icon visibility */
        /* High specificity overrides for Flowbite dark mode */
        .dark #quill-editor .ql-toolbar button,
        .dark #quill-editor .ql-toolbar .ql-picker-label,
        html.dark #quill-editor .ql-toolbar button,
        html.dark #quill-editor .ql-toolbar .ql-picker-label,
        [data-theme="dark"] #quill-editor .ql-toolbar button,
        [data-theme="dark"] #quill-editor .ql-toolbar .ql-picker-label {
            color: #ffffff !important; /* Pure white for maximum contrast */
            border: 1px solid transparent !important;
            border-radius: 0.25rem !important;
            background: rgba(255, 255, 255, 0.05) !important; /* Subtle background */
        }

        .dark #quill-editor .ql-toolbar button:hover,
        .dark #quill-editor .ql-toolbar .ql-picker-label:hover,
        html.dark #quill-editor .ql-toolbar button:hover,
        html.dark #quill-editor .ql-toolbar .ql-picker-label:hover,
        [data-theme="dark"] #quill-editor .ql-toolbar button:hover,
        [data-theme="dark"] #quill-editor .ql-toolbar .ql-picker-label:hover {
            background: rgba(96, 165, 250, 0.25) !important; /* More visible hover */
            border-color: rgba(96, 165, 250, 0.5) !important;
            color: #ffffff !important; /* Keep white on hover */
        }

        .dark #quill-editor .ql-toolbar .ql-active,
        html.dark #quill-editor .ql-toolbar .ql-active,
        [data-theme="dark"] #quill-editor .ql-toolbar .ql-active {
            background: rgba(96, 165, 250, 0.3) !important;
            border-color: rgba(96, 165, 250, 0.6) !important;
            color: var(--qf-border-focus) !important; /* Accent for active state */
        }

        /* Active icons in dark mode: accent stroke, no fill */
        .dark #quill-editor .ql-toolbar .ql-active svg,
        html.dark #quill-editor .ql-toolbar .ql-active svg,
        [data-theme="dark"] #quill-editor .ql-toolbar .ql-active svg,
        .dark #quill-editor .ql-toolbar .ql-active svg *,
        html.dark #quill-editor .ql-toolbar .ql-active svg *,
        [data-theme="dark"] #quill-editor .ql-toolbar .ql-active svg * {
            stroke: var(--qf-border-focus) !important;
            fill: none !important;
            stroke-width: 1.8 !important;
        }

        /* Improve default icon visibility in dark mode: slightly brighter and smoother */
        .dark #quill-editor .ql-toolbar button svg,
        html.dark #quill-editor .ql-toolbar button svg,
        [data-theme="dark"] #quill-editor .ql-toolbar button svg,
        .dark #quill-editor .ql-toolbar .ql-picker-label svg,
        html.dark #quill-editor .ql-toolbar .ql-picker-label svg,
        [data-theme="dark"] #quill-editor .ql-toolbar .ql-picker-label svg {
            stroke: rgba(255,255,255,0.88) !important; /* brighter than before */
            opacity: 0.8 !important; /* inactive icons slightly dim */
            transition: stroke 140ms ease, opacity 140ms ease, stroke-width 140ms ease;
            fill: none !important;
        }

        /* Hover and active state should be full-bright and thicker stroke */
        .dark #quill-editor .ql-toolbar button:hover svg,
        .dark #quill-editor .ql-toolbar .ql-active svg,
        html.dark #quill-editor .ql-toolbar button:hover svg,
        html.dark #quill-editor .ql-toolbar .ql-active svg,
        [data-theme="dark"] #quill-editor .ql-toolbar button:hover svg,
        [data-theme="dark"] #quill-editor .ql-toolbar .ql-active svg {
            stroke: var(--qf-border-focus) !important; /* accent color */
            opacity: 1 !important;
            stroke-width: 1.9 !important;
        }

        /* Disabled or unavailable toolbar items should be more muted */
        .dark #quill-editor .ql-toolbar button.ql-disabled svg,
        .dark #quill-editor .ql-toolbar .ql-picker-label.ql-disabled svg {
            opacity: 0.28 !important;
            stroke: rgba(255,255,255,0.5) !important;
        }

        .dark #quill-editor .ql-toolbar svg,
        html.dark #quill-editor .ql-toolbar svg,
        [data-theme="dark"] #quill-editor .ql-toolbar svg {
            stroke: #ffffff !important;
            fill: none !important; /* Keep icons outlined (no fill) */
            opacity: 1 !important; /* Ensure full opacity in dark mode */
            color: #ffffff !important;
        }

        /* Ensure SVG paths inherit the color properly in dark mode */
        .dark #quill-editor .ql-toolbar svg path,
        .dark #quill-editor .ql-toolbar svg line,
        .dark #quill-editor .ql-toolbar svg rect,
        .dark #quill-editor .ql-toolbar svg circle,
        .dark #quill-editor .ql-toolbar svg polygon,
        html.dark #quill-editor .ql-toolbar svg path,
        html.dark #quill-editor .ql-toolbar svg line,
        html.dark #quill-editor .ql-toolbar svg rect,
        html.dark #quill-editor .ql-toolbar svg circle,
        html.dark #quill-editor .ql-toolbar svg polygon,
        [data-theme="dark"] #quill-editor .ql-toolbar svg path,
        [data-theme="dark"] #quill-editor .ql-toolbar svg line,
        [data-theme="dark"] #quill-editor .ql-toolbar svg rect,
        [data-theme="dark"] #quill-editor .ql-toolbar svg circle,
        [data-theme="dark"] #quill-editor .ql-toolbar svg polygon {
            stroke: #ffffff !important;
            fill: none !important; /* Keep paths outlined */
            color: #ffffff !important;
        }

        /* Override any Tailwind/Flowbite styles that might interfere */
        .dark #quill-editor .ql-toolbar button[class*="text-"],
        .dark #quill-editor .ql-toolbar .ql-picker-label[class*="text-"],
        html.dark #quill-editor .ql-toolbar button[class*="text-"],
        html.dark #quill-editor .ql-toolbar .ql-picker-label[class*="text-"],
        [data-theme="dark"] #quill-editor .ql-toolbar button[class*="text-"],
        [data-theme="dark"] #quill-editor .ql-toolbar .ql-picker-label[class*="text-"] {
            color: #ffffff !important;
        }

        /* Light mode reset - ensure icons are dark (outlined) when switching back from dark mode */
        html:not(.dark) #quill-editor .ql-toolbar svg,
        html:not([data-theme="dark"]) #quill-editor .ql-toolbar svg,
        body:not(.dark) #quill-editor .ql-toolbar svg {
            stroke: #374151 !important;
            fill: none !important; /* Keep outlined icons */
            color: #374151 !important;
            filter: none !important; /* Remove any invert filters */
        }

        html:not(.dark) #quill-editor .ql-toolbar svg path,
        html:not(.dark) #quill-editor .ql-toolbar svg line,
        html:not(.dark) #quill-editor .ql-toolbar svg rect,
        html:not(.dark) #quill-editor .ql-toolbar svg circle,
        html:not(.dark) #quill-editor .ql-toolbar svg polygon,
        html:not([data-theme="dark"]) #quill-editor .ql-toolbar svg path,
        html:not([data-theme="dark"]) #quill-editor .ql-toolbar svg line,
        html:not([data-theme="dark"]) #quill-editor .ql-toolbar svg rect,
        html:not([data-theme="dark"]) #quill-editor .ql-toolbar svg circle,
        html:not([data-theme="dark"]) #quill-editor .ql-toolbar svg polygon,
        body:not(.dark) #quill-editor .ql-toolbar svg path,
        body:not(.dark) #quill-editor .ql-toolbar svg line,
        body:not(.dark) #quill-editor .ql-toolbar svg rect,
        body:not(.dark) #quill-editor .ql-toolbar svg circle,
        body:not(.dark) #quill-editor .ql-toolbar svg polygon {
            stroke: #374151 !important;
            fill: none !important; /* Keep outlined icons */
            color: #374151 !important;
        }

        html:not(.dark) #quill-editor .ql-toolbar button,
        html:not(.dark) #quill-editor .ql-toolbar .ql-picker-label,
        html:not([data-theme="dark"]) #quill-editor .ql-toolbar button,
        html:not([data-theme="dark"]) #quill-editor .ql-toolbar .ql-picker-label,
        body:not(.dark) #quill-editor .ql-toolbar button,
        body:not(.dark) #quill-editor .ql-toolbar .ql-picker-label {
            color: #374151 !important;
            background: transparent !important;
        }
        html.dark #quill-editor .ql-toolbar .ql-picker-label[class*="text-"],
        [data-theme="dark"] #quill-editor .ql-toolbar button[class*="text-"],
        [data-theme="dark"] #quill-editor .ql-toolbar .ql-picker-label[class*="text-"] {
            color: #ffffff !important;
        }

        /* Specific targeting for stroke and fill attributes */
        .dark #quill-editor .ql-toolbar .ql-stroke,
        html.dark #quill-editor .ql-toolbar .ql-stroke,
        [data-theme="dark"] #quill-editor .ql-toolbar .ql-stroke {
            stroke: #ffffff !important;
        }

        /* Ensure any elements using .ql-fill are not forced to a solid fill; keep outlines */
        .dark #quill-editor .ql-toolbar .ql-fill,
        html.dark #quill-editor .ql-toolbar .ql-fill,
        [data-theme="dark"] #quill-editor .ql-toolbar .ql-fill {
            fill: none !important;
        }

        /* Force override for any inherited styles - keep fills none */
        .dark #quill-editor .ql-toolbar button *,
        .dark #quill-editor .ql-toolbar .ql-picker-label *,
        html.dark #quill-editor .ql-toolbar button *,
        html.dark #quill-editor .ql-toolbar .ql-picker-label *,
        [data-theme="dark"] #quill-editor .ql-toolbar button *,
        [data-theme="dark"] #quill-editor .ql-toolbar .ql-picker-label * {
            color: #ffffff !important;
            stroke: #ffffff !important;
            fill: none !important; /* Prevent icons from becoming filled */
        }

        /* Dark mode picker options */
        .dark #quill-editor .ql-picker-options {
            background: #374151 !important; /* Darker background for dropdowns */
            border: 1px solid #4b5563 !important;
        }

        .dark #quill-editor .ql-picker-item {
            color: #e5e7eb !important;
        }

        .dark #quill-editor .ql-picker-item:hover {
            background: #4b5563 !important;
            color: #f3f4f6 !important;
        }

        /* Dropdown pickers for Quill toolbar */
        #quill-editor .ql-picker-options {
            background: var(--qf-bg-primary) !important;
            border: 1px solid var(--qf-border) !important;
            border-radius: 0.375rem !important;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05) !important;
        }

        #quill-editor .ql-picker-item {
            color: var(--qf-text-primary) !important;
        }

        #quill-editor .ql-picker-item:hover {
            background: var(--qf-bg-secondary) !important;
        }

        #quill-editor .ql-picker-label {
            color: var(--qf-text-primary) !important;
        }

        /* Placeholder text */
        #quill-editor .ql-editor.ql-blank::before {
            color: var(--qf-placeholder) !important;
            font-style: italic !important;
        }

        /* Text inputs and textareas */
        textarea,
        input[type="text"],
        select,
        .choice-item textarea {
            background: var(--qf-bg-primary) !important;
            color: var(--qf-text-primary) !important;
            border: 1px solid var(--qf-border) !important;
            border-radius: 0.5rem !important;
            padding: 0.75rem !important;
            font-size: 14px !important;
            transition: border-color 0.2s ease-in-out !important;
        }

        textarea:focus,
        input[type="text"]:focus,
        select:focus,
        .choice-item textarea:focus {
            outline: none !important;
            border-color: var(--qf-border-focus) !important;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
        }

        textarea::placeholder,
        input[type="text"]::placeholder,
        .choice-item textarea::placeholder {
            color: var(--qf-placeholder) !important;
        }

        /* Fallback textarea styling */
        .textarea-fallback {
            background: var(--qf-bg-primary) !important;
            color: var(--qf-text-primary) !important;
            border: 1px solid var(--qf-border) !important;
            border-radius: 0.5rem !important;
            padding: 16px !important;
            min-height: 280px !important;
            font-family: system-ui, -apple-system, sans-serif !important;
            font-size: 15px !important;
            line-height: 1.6 !important;
        }

        /* Choice checkbox styling */
        .choice-checkbox:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
        }

        .dark .choice-checkbox {
            border-color: #4b5563;
            background-color: #374151;
        }

        /* Correct answer visual states */
        .choice-item.correct-answer {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%) !important;
            border: 3px solid #10b981 !important;
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3) !important;
            transform: scale(1.02) !important;
        }

        .choice-item.correct-answer .choice-header {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
            color: white !important;
        }

        .choice-item.correct-answer textarea {
            border: 2px solid #10b981 !important;
            background-color: rgba(255, 255, 255, 0.98) !important;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.15) !important;
        }

        .dark .choice-item.correct-answer textarea {
            background-color: rgba(31, 41, 55, 0.98) !important;
        }

        /* Dark theme adjustments for correct answer (softer, more readable) */
        .dark .choice-item.correct-answer {
            background: rgba(6, 95, 70, 0.22) !important; /* emerald-800 with opacity */
            border-color: #059669 !important; /* emerald-600 */
            box-shadow: 0 8px 18px rgba(5, 150, 105, 0.18) !important;
        }

        .dark .choice-item.correct-answer .choice-header {
            background: linear-gradient(135deg, #065f46 0%, #047857 100%) !important; /* emerald-800 → emerald-700 */
            color: #e5fff4 !important; /* soft mint text */
        }

        .dark .choice-item.correct-answer .choice-status,
        .dark .choice-item.correct-answer h4 {
            color: #e5fff4 !important; /* improve contrast on dark */
        }

        .dark .choice-item.correct-answer .choice-badge {
            background-color: #059669 !important; /* emerald-600 */
            color: #ecfdf5 !important; /* emerald-50 */
        }

        /* Layout and small animations */
        .section-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .choice-item { transition: all 0.2s ease-in-out; }
        .choice-item:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }

        /* Modal and thumbnail */
        #imageModal { backdrop-filter: blur(4px); }
        #modalImage { transition: transform 0.2s ease-in-out; cursor: zoom-in; }
        #modalImage:hover { transform: scale(1.02); }
        .choice-item img { transition: all 0.2s ease-in-out; }
        .choice-item img:hover { transform: scale(1.05); box-shadow: 0 4px 20px rgba(0,0,0,0.15); }

        /* Responsive tweaks */
        @media (max-width: 768px) {
            #quill-editor .ql-editor { min-height: 180px !important; }
            .choice-item { padding: 0.5rem !important; }
        }

        /* Dark mode adjustments for previews */
        .dark #imageModal .modal-panel { background-color: #0f172a; }
        .dark .choice-item img { box-shadow: 0 4px 14px rgba(255,255,255,0.03); }
    </style>
{% endblock %}

{% block content %}
<!-- Include Question Header Component -->
<section class="bg-gray-50 dark:bg-gray-900 p-3 sm:p-5 antialiased">
    <div class="mx-auto max-w-screen-xl px-4 lg:px-12">
        {% with header_title=page_title|default:"Question Form" header_subtitle=page_subtitle show_back_button=True header_icon='<svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>' %}
            {% include 'admin/manage_questions/includes/question_header.html' %}
        {% endwith %}

    <div class="bg-white dark:bg-gray-800 relative shadow-md sm:rounded-lg overflow-hidden question-form-card">
        <div class="p-6">
            <div class="max-w-4xl mx-auto">
                <!-- Error Messages -->
                {% if form.errors %}
                    <div class="mb-6 bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg dark:bg-red-900/20 dark:border-red-800 dark:text-red-400">
                                    <div class="flex">
                                        <div class="flex-shrink-0">
                                            <svg class="h-5 w-5 text-red-400" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                                            </svg>
                                        </div>
                                        <div class="ml-3">
                                            <h3 class="text-sm font-medium">Please fix the following errors:</h3>
                                            <div class="mt-2 text-sm">
                                                <ul class="list-disc pl-5 space-y-1">
                                                    {% for field, errors in form.errors.items %}
                                                        {% for error in errors %}
                                                            <li>{{ field|capfirst }}: {{ error }}</li>
                                                        {% endfor %}
                                                    {% endfor %}
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}

                            <!-- Form -->
                            <form method="post" class="space-y-6">
                                {% csrf_token %}
                                
                                <!-- Question Content -->
                                <div class="bg-white dark:bg-gray-800 shadow-sm rounded-lg border border-gray-200 dark:border-gray-700">
                                    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                                        <h3 class="text-lg font-medium text-gray-900 dark:text-white">Question Content</h3>
                                        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                                            {% if question %}Update your question content using the rich text editor{% else %}Enter your question content using the rich text editor{% endif %}
                                        </p>
                                    </div>
                                    <div class="px-6 py-4">
                                        <div class ="mb-4 p-4 border border-gray-200 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700">
                                            <label for="id_question_text" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                                Question Text
                                                <span class="text-red-500">*</span>
                                            </label>
                                            {{ form.question_text }}
                                            {% if form.question_text.errors %}
                                                {% for error in form.question_text.errors %}
                                                    <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ error }}</p>
                                                {% endfor %}
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <!-- Question Type and Category (swapped: Weight config now on the left) -->
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                    <!-- Weight Configuration (moved here) -->
                                    <div class="bg-white dark:bg-gray-800 shadow-sm rounded-lg border border-gray-200 dark:border-gray-700">
                                        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                                            <h3 class="text-lg font-medium text-gray-900 dark:text-white">Weight Configuration</h3>
                                        </div>
                                        <div class="px-6 py-4">
                                            <label for="id_custom_weight" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                                Custom Weight (Optional)
                                            </label>
                                            {{ form.custom_weight }}
                                            {% if form.custom_weight.help_text %}
                                                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">{{ form.custom_weight.help_text }}</p>
                                            {% endif %}
                                            {% if form.custom_weight.errors %}
                                                {% for error in form.custom_weight.errors %}
                                                    <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ error }}</p>
                                                {% endfor %}
                                            {% endif %}
                                        </div>
                                    </div>

                                    <!-- Category -->
                                    <div class="bg-white dark:bg-gray-800 shadow-sm rounded-lg border border-gray-200 dark:border-gray-700">
                                        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                                            <h3 class="text-lg font-medium text-gray-900 dark:text-white">Category</h3>
                                        </div>
                                        <div class="px-6 py-4">
                                            <label for="id_category" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                                Question Category
                                                <span class="text-red-500">*</span>
                                            </label>
                                            {{ form.category }}
                                            <input type="hidden" id="id_category_hidden" name="category">
                                            <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">Category dikunci agar tidak dapat diubah.</p>
                                            <script>
                                            (function() {
                                                var categorySelect = document.getElementById('id_category');
                                                if (categorySelect) {
                                                    categorySelect.setAttribute('disabled', 'disabled');
                                                    if (categorySelect.classList) {
                                                        categorySelect.classList.add('bg-gray-100', 'cursor-not-allowed', 'opacity-60', 'dark:bg-gray-700', 'dark:text-gray-300', 'dark:placeholder-gray-400', 'dark:border-gray-600');
                                                    }
                                                    var hiddenInput = document.getElementById('id_category_hidden');
                                                    if (hiddenInput) {
                                                        hiddenInput.value = categorySelect.value;
                                                    }
                                                }
                                            })();
                                            </script>
                                            {% if form.category.errors %}
                                                {% for error in form.category.errors %}
                                                    <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ error }}</p>
                                                {% endfor %}
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <!-- Question Type (moved here and redesigned as selectable cards) -->
                                <div class="bg-white dark:bg-gray-800 shadow-sm rounded-lg border border-gray-200 dark:border-gray-700">
                                    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                                        <h3 class="text-lg font-medium text-gray-900 dark:text-white">Question Type</h3>
                                    </div>
                                    <div class="px-6 py-4">
                                        <fieldset>
                                            <legend class="sr-only">Question Type</legend>
                                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4" id="questionTypeCards">
                                                {% for choice in form.question_type %}
                                                    <label for="{{ choice.id_for_label }}" class="question-type-card group block border rounded-lg p-4 cursor-pointer transition-all duration-150 border-gray-200 dark:border-gray-700 hover:border-primary-400 dark:hover:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500 dark:focus:ring-primary-400">
                                                        <div class="flex items-start">
                                                            <div class="mt-1">
                                                                {{ choice.tag|safe }}
                                                            </div>
                                                            <div class="ml-3">
                                                                <div class="js-type-title text-sm font-medium text-gray-900 dark:text-white">{{ choice.choice_label }}</div>
                                                                <div class="mt-1 text-xs text-gray-600 dark:text-gray-400 js-type-desc">Pilih tipe pertanyaan yang sesuai.</div>
                                                            </div>
                                                        </div>
                                                    </label>
                                                {% endfor %}
                                            </div>
                                        </fieldset>
                                        <script>
                                            (function() {
                                                var radios = document.querySelectorAll('input[name="question_type"]');
                                                var descMap = {
                                                    'multiple_choice': 'Cocok untuk soal pilihan ganda dengan beberapa opsi jawaban.',
                                                    'essay': 'Jawaban berupa teks esai yang dinilai sesuai kebijakan penilaian.'
                                                };
                                                function refreshCards() {
                                                    radios.forEach(function(radio) {
                                                        var label = document.querySelector('label[for="' + radio.id + '"]');
                                                        if (!label) return;
                                                        var desc = label.querySelector('.js-type-desc');
                                                        var title = label.querySelector('.js-type-title');
                                                        var text = descMap[radio.value] || 'Pilih tipe pertanyaan yang sesuai.';
                                                        if (desc) desc.textContent = text;
                                                        if (radio.checked) {
                                                            label.classList.add('ring-2','ring-primary-500','border-primary-400','bg-primary-100','dark:bg-primary-800/40','dark:border-primary-500','dark:ring-primary-400');
                                                            if (title) {
                                                                title.classList.add('text-gray-900','dark:text-white');
                                                            }
                                                            if (desc) {
                                                                desc.classList.add('text-gray-700','dark:text-gray-300');
                                                                desc.classList.remove('text-gray-600','dark:text-gray-400');
                                                            }
                                                        } else {
                                                            label.classList.remove('ring-2','ring-primary-500','border-primary-400','bg-primary-100','dark:bg-primary-800/40','dark:border-primary-500','dark:ring-primary-400');
                                                            if (desc) {
                                                                desc.classList.remove('text-gray-700','dark:text-gray-300');
                                                                desc.classList.add('text-gray-600','dark:text-gray-400');
                                                            }
                                                        }
                                                    });
                                                }
                                                radios.forEach(function(radio) {
                                                    // Make the native radio visually hidden but accessible via label card
                                                    radio.classList.add('sr-only');
                                                    radio.addEventListener('change', refreshCards);
                                                });
                                                refreshCards();
                                            })();
                                        </script>
                                        {% if form.question_type.help_text %}
                                            <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">{{ form.question_type.help_text }}</p>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- Multiple Choice Options -->
                                <div id="choicesSection" class="bg-white dark:bg-gray-800 shadow-sm rounded-lg border border-gray-200 dark:border-gray-700" style="display: none;">
                                    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <h3 class="text-lg font-medium text-gray-900 dark:text-white">Answer Choices</h3>
                                                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                                                    {% if question %}Update multiple choice options for this question{% else %}Add multiple choice options for this question{% endif %}
                                                </p>
                                            </div>
                                            <div class="flex items-center space-x-2 text-xs text-gray-500 dark:text-gray-400">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                </svg>
                                                <span>Select at least one correct answer</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="px-6 py-6">
                                        {{ formset.management_form }}
                                        
                                        <div id="choice-forms" class="space-y-4">
                                            {% for form in formset %}
                                                <div class="choice-item relative group border-2 border-gray-200 dark:border-gray-600 rounded-xl overflow-hidden transition-all duration-200 hover:border-primary-300 dark:hover:border-primary-500 {% if form.is_correct.value %}correct-answer{% endif %}" data-choice="{{ forloop.counter }}">
                                                    {% for hidden in form.hidden_fields %}{{ hidden }}{% endfor %}
                                                    
                                                    <!-- Choice Header with Letter Badge -->
                                                    <div class="choice-header flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-700/50 border-b border-gray-200 dark:border-gray-600">
                                                        <div class="flex items-center space-x-3">
                                                            <!-- Choice Letter Badge -->
                                                            <div class="choice-badge flex items-center justify-center w-10 h-10 rounded-full font-bold text-lg {% if form.is_correct.value %}bg-green-600 text-white dark:bg-emerald-600 dark:text-emerald-50{% else %}bg-primary-100 text-primary-700 dark:bg-primary-900 dark:text-primary-300{% endif %}">
                                                                {% if forloop.counter == 1 %}A{% elif forloop.counter == 2 %}B{% elif forloop.counter == 3 %}C{% elif forloop.counter == 4 %}D{% elif forloop.counter == 5 %}E{% endif %}
                                                            </div>
                                                            
                                                            <!-- Choice Title -->
                                                            <div>
                                                                <h4 class="text-lg font-semibold {% if form.is_correct.value %}text-white font-bold dark:text-emerald-50{% else %}text-gray-900 dark:text-white{% endif %}">
                                                                    Choice {% if forloop.counter == 1 %}A{% elif forloop.counter == 2 %}B{% elif forloop.counter == 3 %}C{% elif forloop.counter == 4 %}D{% elif forloop.counter == 5 %}E{% endif %}
                                                                </h4>
                                                                <p class="choice-status text-sm {% if form.is_correct.value %}text-white font-medium dark:text-emerald-50{% else %}text-gray-500 dark:text-gray-400{% endif %}">
                                                                    {% if form.is_correct.value %}✓ Correct Answer{% else %}Option{% endif %}
                                                                </p>
                                                            </div>
                                                        </div>
                                                        
                                                        <!-- Correct Answer Toggle -->
                                                        <div class="flex items-center space-x-3">
                                                            <label class="relative inline-flex items-center cursor-pointer">
                                                                {{ form.is_correct }}
                                                                <span class="ml-3 text-sm font-medium {% if form.is_correct.value %}text-white{% else %}text-gray-700 dark:text-gray-300{% endif %}">
                                                                    Mark as correct
                                                                </span>
                                                            </label>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Choice Content -->
                                                    <div class="p-4">
                                                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                                                            <!-- Choice Text (Left 2/3) -->
                                                            <div class="lg:col-span-2">
                                                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                                                    Choice Text <span id="choice-text-req-{{ forloop.counter }}" class="text-red-500">*</span>
                                                                </label>
                                                                {{ form.choice_text }}
                                                                {% if form.choice_text.errors %}
                                                                    {% for error in form.choice_text.errors %}
                                                                        <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ error }}</p>
                                                                    {% endfor %}
                                                                {% endif %}
                                                            </div>
                                                            
                                                            <!-- Choice Image (Right 1/3) -->
                                                            <div class="lg:col-span-1">
                                                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                                                    Choice Image
                                                                </label>
                                                                
                                                                <!-- Image Upload Area -->
                                                                <div class="relative border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-4 text-center hover:border-primary-400 dark:hover:border-primary-500 transition-colors duration-200">
                                                                    <!-- Current Image Preview -->
                                                                    <div id="choice-image-preview-{{ forloop.counter }}" class="{% if not form.instance.choice_image %}hidden{% endif %}">
                                                                        {% if form.instance.choice_image %}
                                                                            <div class="relative inline-block">
                                                                                <img src="{{ form.instance.choice_image.url }}" 
                                                                                     class="w-full h-24 object-cover rounded-lg border border-gray-200 dark:border-gray-600 shadow-sm cursor-pointer hover:opacity-80 transition-opacity" 
                                                                                     alt="Choice image"
                                                                                     onclick="openImageModal('{{ form.instance.choice_image.url }}', 'Choice {% if forloop.counter == 1 %}A{% elif forloop.counter == 2 %}B{% elif forloop.counter == 3 %}C{% elif forloop.counter == 4 %}D{% elif forloop.counter == 5 %}E{% endif %}')">
                                                                                <button type="button" 
                                                                                        onclick="console.log('Remove existing image clicked for choice {{ forloop.counter }}'); removeChoiceImage({{ forloop.counter }}); event.stopPropagation(); return false;" 
                                                                                        class="absolute -top-2 -right-2 bg-red-500 hover:bg-red-600 text-white rounded-full p-2 shadow-lg transition-colors duration-200 z-20 border-2 border-white">
                                                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                                                                    </svg>
                                                                                </button>
                                                                            </div>
                                                                        {% else %}
                                                                            <div class="relative inline-block">
                                                                                <img class="w-full h-24 object-cover rounded-lg border border-gray-200 dark:border-gray-600 shadow-sm cursor-pointer hover:opacity-80 transition-opacity" 
                                                                                     alt="Choice image"
                                                                                     onclick="openImageModal(this.src, 'Choice {% if forloop.counter == 1 %}A{% elif forloop.counter == 2 %}B{% elif forloop.counter == 3 %}C{% elif forloop.counter == 4 %}D{% elif forloop.counter == 5 %}E{% endif %}')">
                                                                                <button type="button" 
                                                                                        onclick="console.log('Remove new image clicked for choice {{ forloop.counter }}'); removeChoiceImage({{ forloop.counter }}); event.stopPropagation(); return false;" 
                                                                                        class="absolute -top-2 -right-2 bg-red-500 hover:bg-red-600 text-white rounded-full p-2 shadow-lg transition-colors duration-200 z-20 border-2 border-white">
                                                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                                                                    </svg>
                                                                                </button>
                                                                            </div>
                                                                        {% endif %}
                                                                    </div>
                                                                    
                                                                    <!-- Upload Area (shown when no image) -->
                                                                    <div id="choice-upload-area-{{ forloop.counter }}" class="{% if form.instance.choice_image %}hidden{% endif %}">
                                                                        <svg class="mx-auto h-8 w-8 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                                                            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                                                                        </svg>
                                                                        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Click to upload</p>
                                                                    </div>
                                                                    
                                                                    <!-- Hidden File Input -->
                                                                    <input type="file" 
                                                                           id="choice-image-{{ forloop.counter }}" 
                                                                           accept="image/*" 
                                                                           class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" 
                                                                           onchange="uploadChoiceImage(this, {{ forloop.counter }})">
                                                                    
                                                                    <!-- Status Text -->
                                                                    <p id="choice-image-status-{{ forloop.counter }}" class="mt-1 text-xs"></p>
                                                                </div>
                                                                
                                                                <!-- Hidden Django Field -->
                                                                <div class="hidden">{{ form.choice_image }}</div>
                                                                <input type="hidden" 
                                                                       id="choice-image-url-{{ forloop.counter }}" 
                                                                       name="choice_image_{{ forloop.counter }}" 
                                                                       value="{% if form.instance.choice_image %}{{ form.instance.choice_image.url }}{% endif %}">
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>

                                <!-- Essay Answer Section -->
                                <div id="essayAnswerSection" class="bg-white dark:bg-gray-800 shadow-sm rounded-lg border border-gray-200 dark:border-gray-700" style="display: none;">
                                    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                                        <h3 class="text-lg font-medium text-gray-900 dark:text-white">Expected Answer</h3>
                                        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Provide the expected answer or key points for this essay question</p>
                                    </div>
                                    <div class="px-6 py-4">
                                        <label for="id_correct_answer_text" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                            Expected Answer
                                        </label>
                                        {{ form.correct_answer_text }}
                                        {% if form.correct_answer_text.help_text %}
                                            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">{{ form.correct_answer_text.help_text }}</p>
                                        {% endif %}
                                        {% if form.correct_answer_text.errors %}
                                            {% for error in form.correct_answer_text.errors %}
                                                <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ error }}</p>
                                            {% endfor %}
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- Explanation / Pembahasan (optional) -->
                                <div class="bg-white dark:bg-gray-800 shadow-sm rounded-lg border border-gray-200 dark:border-gray-700">
                                    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                                        <h3 class="text-lg font-medium text-gray-900 dark:text-white">Pembahasan Jawaban (Opsional)</h3>
                                        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                                            Tambahkan penjelasan mengapa jawabannya seperti itu. Kosongkan jika tidak diperlukan.
                                        </p>
                                    </div>
                                    <div class="px-6 py-4">
                                        <div class ="mb-4 p-4 border border-gray-200 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700">
                                            <label for="id_explanation" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                                Pembahasan
                                            </label>
                                            {{ form.explanation }}
                                            {% if form.explanation.errors %}
                                                {% for error in form.explanation.errors %}
                                                    <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ error }}</p>
                                                {% endfor %}
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <!-- Submit Button -->
                                <div class="flex justify-end space-x-3 pt-6 border-t border-gray-200 dark:border-gray-700">
                                    <a href="{% url 'question_list' %}" class="bg-white dark:bg-gray-800 py-2 px-4 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                                        Cancel
                                    </a>
                                    <button type="submit" class="bg-primary-600 py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors duration-200">
                                        {% if question %}Update Question{% else %}Create Question{% endif %}
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Image Modal -->
<div id="imageModal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
        <!-- Background overlay -->
        <div class="fixed inset-0 bg-black bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closeImageModal()"></div>
        
        <!-- Modal panel -->
        <div class="relative inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full">
            <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <!-- Modal Header -->
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white" id="modal-title">
                        Image Preview
                    </h3>
                    <button type="button" 
                            onclick="closeImageModal()" 
                            class="bg-white dark:bg-gray-800 rounded-md text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                        <span class="sr-only">Close</span>
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                
                <!-- Modal Content -->
                <div class="mt-3 text-center sm:mt-0 sm:text-left">
                    <div class="mt-2 flex justify-center">
                        <img id="modalImage" 
                             src="" 
                             alt="Preview" 
                             class="max-w-full max-h-96 h-auto rounded-lg border border-gray-200 dark:border-gray-600 shadow-lg">
                    </div>
                </div>
            </div>
            
            <!-- Modal Footer -->
            <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" 
                        onclick="closeImageModal()" 
                        class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-primary-600 text-base font-medium text-white hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 sm:ml-3 sm:w-auto sm:text-sm">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
    <!-- Quill.js Rich Text Editor Initialization -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Quill Rich Text Editor
            const questionTextarea = document.querySelector('#id_question_text');
            const explanationTextarea = document.querySelector('#id_explanation');
            let quillEditor = null;
            let quillExplanation = null;
            
            if (questionTextarea) {
                // Create container for Quill editor
                const editorContainer = document.createElement('div');
                editorContainer.id = 'quill-editor';
                editorContainer.className = 'qf-editor-container rounded-lg shadow-sm';
                questionTextarea.parentNode.insertBefore(editorContainer, questionTextarea);
                
                // Initialize Quill
                try {
                    console.log('Initializing Quill editor...');
                    quillEditor = new Quill('#quill-editor', {
                        theme: 'snow',
                        modules: {
                            toolbar: [
                                ['bold', 'italic', 'underline'],
                                ['link', 'blockquote'],
                                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                                [{ 'indent': '-1'}, { 'indent': '+1' }],
                                ['image'],
                                ['clean']
                            ]
                        },
                        placeholder: 'Type your question here...'
                    });
                    
                    console.log('Quill editor created:', quillEditor);
                    console.log('Quill container:', document.querySelector('#quill-editor'));
                    console.log('Quill toolbar:', document.querySelector('#quill-editor .ql-toolbar'));
                    console.log('Quill toolbar buttons:', document.querySelectorAll('#quill-editor .ql-toolbar button'));
                    
                    // Custom Image Upload Handler
                    quillEditor.getModule('toolbar').addHandler('image', function() {
                        const input = document.createElement('input');
                        input.setAttribute('type', 'file');
                        input.setAttribute('accept', 'image/*');
                        input.click();
                        
                        input.onchange = function() {
                            const file = input.files[0];
                            if (file) {
                                // Show upload progress
                                const range = quillEditor.getSelection();
                                quillEditor.insertText(range.index, 'Uploading image...', 'italic', true);
                                
                                const formData = new FormData();
                                formData.append('upload', file);
                                
                                // Add CSRF token
                                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                                
                                fetch('/admin/image-upload/', {
                                    method: 'POST',
                                    headers: {
                                        'X-CSRFToken': csrfToken
                                    },
                                    body: formData
                                })
                                .then(response => response.json())
                                .then(data => {
                                    // Remove progress text
                                    quillEditor.deleteText(range.index, 'Uploading image...'.length);
                                    
                                    if (data.url) {
                                        // Insert image at cursor position
                                        quillEditor.insertEmbed(range.index, 'image', data.url);
                                        quillEditor.setSelection(range.index + 1);
                                    } else {
                                        showNotification('Image upload failed: ' + (data.error || 'Unknown error'), 'error');
                                    }
                                })
                                .catch(error => {
                                    // Remove progress text
                                    quillEditor.deleteText(range.index, 'Uploading image...'.length);
                                    console.error('Upload failed:', error);
                                    showNotification('Image upload failed. Please try again.', 'error');
                                });
                            }
                        };
                    });
                    
                    // Set initial content if textarea has value
                    if (questionTextarea.value) {
                        quillEditor.root.innerHTML = questionTextarea.value;
                    }

                    // Sync editor content with textarea
                    quillEditor.on('text-change', function() {
                        questionTextarea.value = quillEditor.root.innerHTML;
                    });

                    // Hide original textarea (Quill is the visible editor)
                    questionTextarea.style.display = 'none';

                    // Force dark mode icon styling after Quill initialization
                    setTimeout(function() {
                        const isDarkMode = document.documentElement.classList.contains('dark') || 
                                         document.body.classList.contains('dark') ||
                                         document.querySelector('[data-theme="dark"]');
                        
                        if (isDarkMode) {
                            const toolbar = document.querySelector('#quill-editor .ql-toolbar');
                            if (toolbar) {
                                // Force white icons in dark mode
                                const buttons = toolbar.querySelectorAll('button, .ql-picker-label');
                                buttons.forEach(button => {
                                    button.style.color = '#ffffff';
                                    const svgs = button.querySelectorAll('svg, svg *');
                                    svgs.forEach(svg => {
                                        svg.style.stroke = '#ffffff';
                                        svg.style.fill = '#ffffff';
                                        svg.style.color = '#ffffff';
                                        // Add filter as backup
                                        svg.style.filter = 'brightness(0) invert(1)';
                                    });
                                });
                                
                                // Style the toolbar itself
                                toolbar.style.backgroundColor = '#374151';
                                toolbar.style.borderColor = '#6b7280';
                            }
                        }
                    }, 100);

                    console.log('Quill editor initialized successfully');
                    
                    // Observer for theme changes
                    const observer = new MutationObserver(function(mutations) {
                        let shouldRefix = false;
                        
                        mutations.forEach(function(mutation) {
                            if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                                const target = mutation.target;
                                if (target === document.documentElement || target === document.body) {
                                    console.log('Theme change detected on:', target.tagName);
                                    console.log('  Old classes:', mutation.oldValue);
                                    console.log('  New classes:', target.className);
                                    shouldRefix = true;
                                }
                            }
                            
                            // Also watch for DOM changes in toolbar area
                            if (mutation.type === 'childList' && mutation.target.closest('.ql-toolbar')) {
                                console.log('Toolbar DOM change detected');
                                shouldRefix = true;
                            }
                        });
                        
                        if (shouldRefix) {
                            console.log('Theme change or toolbar update detected, re-fixing icons...');
                            setTimeout(() => window.fixQuillIcons(), 100);
                        }
                    });
                    
                    // Start observing theme changes with oldValue tracking
                    observer.observe(document.documentElement, {
                        attributes: true,
                        attributeOldValue: true,
                        attributeFilter: ['class', 'data-theme']
                    });
                    observer.observe(document.body, {
                        attributes: true,
                        attributeOldValue: true,
                        attributeFilter: ['class', 'data-theme']
                    });
                    
                    // Also observe toolbar for DOM changes
                    const toolbar = document.querySelector('.ql-toolbar');
                    if (toolbar) {
                        observer.observe(toolbar, {
                            childList: true,
                            subtree: true
                        });
                    }
                    
                    // Debug function for manual icon fix (can be called from console)
                    window.fixQuillIcons = function() {
                        console.log('=== Debug Quill Icons Fix ===');
                        
                        // Check current theme
                        const isDarkMode = document.documentElement.classList.contains('dark') || 
                                         document.body.classList.contains('dark') ||
                                         document.querySelector('[data-theme="dark"]');
                        
                        console.log('Current theme:', isDarkMode ? 'Dark' : 'Light');
                        
                        // Try multiple selectors
                        const selectors = [
                            '#quill-editor .ql-toolbar',
                            '.ql-toolbar',
                            '[class*="ql-toolbar"]',
                            '.ql-snow .ql-toolbar'
                        ];
                        
                        let toolbar = null;
                        for (let selector of selectors) {
                            toolbar = document.querySelector(selector);
                            console.log(`Trying selector "${selector}":`, toolbar);
                            if (toolbar) break;
                        }
                        
                        if (!toolbar) {
                            console.log('No toolbar found. Available Quill elements:');
                            const quillElements = document.querySelectorAll('[id*="quill"], [class*="ql-"]');
                            quillElements.forEach((el, i) => {
                                console.log(`${i}: ${el.tagName}.${el.className}#${el.id}`, el);
                            });
                            return;
                        }
                        
                        console.log('Found toolbar:', toolbar);
                        
                        // Use CSS classes instead of permanent inline styles so :hover and .ql-active
                        // remain controllable by CSS when theme toggles.
                        // Remove any previously injected inline styles that could block CSS state changes.
                        try {
                            toolbar.classList.toggle('qf-theme-dark', !!isDarkMode);
                            toolbar.classList.toggle('qf-theme-light', !isDarkMode);

                            // Remove inline toolbar colors if present so stylesheet rules take precedence
                            toolbar.style.removeProperty('background-color');
                            toolbar.style.removeProperty('border-color');

                            const buttons = toolbar.querySelectorAll('button, .ql-picker-label');
                            console.log(`Found ${buttons.length} buttons/pickers - cleaning inline styles`);

                            buttons.forEach((button) => {
                                // Remove inline styles previously set by JS so CSS :hover/.ql-active can work
                                button.style.removeProperty('color');
                                button.style.removeProperty('background');
                                button.style.removeProperty('border');
                                button.style.removeProperty('border-radius');

                                // Clean up SVG inline styles to allow CSS-driven stroke/fill
                                const svgElements = button.querySelectorAll('svg, .ql-stroke, .ql-fill');
                                svgElements.forEach((svg) => {
                                    svg.style.removeProperty('stroke');
                                    svg.style.removeProperty('fill');
                                    svg.style.removeProperty('color');
                                    svg.style.removeProperty('filter');
                                    svg.style.removeProperty('stroke-width');

                                    const children = svg.querySelectorAll('*');
                                    children.forEach(child => {
                                        child.style.removeProperty('stroke');
                                        child.style.removeProperty('fill');
                                    });
                                });
                            });

                            // Ensure stylesheet has the right class-based selectors; toggle a reflow class
                            toolbar.classList.add('qf-reflow');
                            setTimeout(() => toolbar.classList.remove('qf-reflow'), 50);
                        } catch (e) {
                            console.warn('Error cleaning inline styles for Quill toolbar:', e);
                        }
                        
                        console.log(`Icons fix completed for ${isDarkMode ? 'dark' : 'light'} mode!`);
                        return toolbar;
                    };
                    
                    // Debug function to find all Quill-related elements
                    window.debugQuillElements = function() {
                        console.log('=== Debug All Quill Elements ===');
                        
                        const allElements = document.querySelectorAll('*');
                        const quillElements = [];
                        
                        allElements.forEach(el => {
                            if (el.id && el.id.includes('quill')) {
                                quillElements.push({type: 'id', selector: '#' + el.id, element: el});
                            }
                            if (el.className && el.className.toString().includes('ql-')) {
                                quillElements.push({type: 'class', selector: '.' + el.className.toString().split(' ').find(c => c.includes('ql-')), element: el});
                            }
                        });
                        
                        console.log('Found Quill elements:', quillElements);
                        
                        // Check if textarea exists
                        const textarea = document.querySelector('#id_question_text');
                        console.log('Question textarea:', textarea);
                        
                        // Check if editor container exists
                        const container = document.querySelector('#quill-editor');
                        console.log('Quill container:', container);
                        
                        if (container) {
                            console.log('Container children:', container.children);
                        }
                        
                        return quillElements;
                    };
                    
                    // Force re-initialize Quill if needed
                    window.forceQuillInit = function() {
                        console.log('=== Force Quill Re-initialization ===');
                        
                        const textarea = document.querySelector('#id_question_text');
                        if (!textarea) {
                            console.log('No textarea found');
                            return;
                        }
                        
                        // Remove existing Quill container if any
                        const existingContainer = document.querySelector('#quill-editor');
                        if (existingContainer) {
                            existingContainer.remove();
                        }
                        
                        // Show textarea temporarily
                        textarea.style.display = 'block';
                        
                        // Create new container
                        const newContainer = document.createElement('div');
                        newContainer.id = 'quill-editor';
                        newContainer.className = 'qf-editor-container rounded-lg shadow-sm';
                        textarea.parentNode.insertBefore(newContainer, textarea);
                        
                        // Re-initialize Quill
                        const newQuill = new Quill('#quill-editor', {
                            theme: 'snow',
                            modules: {
                                toolbar: [
                                    ['bold', 'italic', 'underline'],
                                    ['link', 'blockquote'],
                                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                                    [{ 'indent': '-1'}, { 'indent': '+1' }],
                                    ['image'],
                                    ['clean']
                                ]
                            },
                            placeholder: 'Type your question here...'
                        });
                        
                        if (textarea.value) {
                            newQuill.root.innerHTML = textarea.value;
                        }
                        
                        newQuill.on('text-change', function() {
                            textarea.value = newQuill.root.innerHTML;
                        });
                        
                        textarea.style.display = 'none';
                        
                        // Fix icons immediately
                        setTimeout(() => window.fixQuillIcons(), 100);
                        
                        console.log('Quill re-initialized');
                        return newQuill;
                    };
                    
                    // Persistent icon fix - runs periodically to ensure icons match current theme
                    window.persistentIconFix = function() {
                        const isDarkMode = document.documentElement.classList.contains('dark') || 
                                         document.body.classList.contains('dark') ||
                                         document.querySelector('[data-theme="dark"]');
                        
                        const toolbar = document.querySelector('.ql-toolbar');
                        if (toolbar) {
                            const buttons = toolbar.querySelectorAll('button, .ql-picker-label');
                            let needsFix = false;
                            
                            buttons.forEach(button => {
                                // Remove lingering inline styles so CSS :hover and .ql-active work
                                button.style.removeProperty('color');
                                button.style.removeProperty('background');
                                button.style.removeProperty('border');

                                const svgElements = button.querySelectorAll('svg, .ql-stroke, .ql-fill');
                                svgElements.forEach(svg => {
                                    svg.style.removeProperty('stroke');
                                    svg.style.removeProperty('fill');
                                    svg.style.removeProperty('filter');
                                    svg.style.removeProperty('stroke-width');
                                    const children = svg.querySelectorAll('*');
                                    children.forEach(child => {
                                        child.style.removeProperty('stroke');
                                        child.style.removeProperty('fill');
                                    });
                                });
                            });
                            
                            // Allow CSS to determine if active/hover states are applied; still run a quick check
                            setTimeout(() => window.fixQuillIcons(), 80);
                        }
                    };
                    
                    // Run periodic check every 2 seconds
                    setInterval(window.persistentIconFix, 2000);
                    
                    // Auto-fix on initialization if in dark mode
                    const checkAndFixIcons = () => {
                        const isDarkMode = document.documentElement.classList.contains('dark') || 
                                         document.body.classList.contains('dark') ||
                                         document.querySelector('[data-theme="dark"]');
                        
                        if (isDarkMode) {
                            console.log('Dark mode detected, applying icon fixes...');
                            return window.fixQuillIcons();
                        }
                        return false;
                    };
                    
                    // Multiple retry attempts with better timing
                    const attemptFix = (attempt = 1) => {
                        console.log(`Auto-fix attempt ${attempt}`);
                        const result = checkAndFixIcons();
                        
                        if (!result && attempt < 3) {
                            setTimeout(() => attemptFix(attempt + 1), 500 * attempt);
                        } else if (result) {
                            console.log('Icons successfully fixed on attempt', attempt);
                        }
                    };
                    
                    // Initial fix attempt
                    setTimeout(() => attemptFix(), 100);
                    
                } catch (error) {
                    console.error('Quill initialization failed:', error);
                    // Show textarea as fallback with consistent styling
                    questionTextarea.style.display = 'block';
                    questionTextarea.classList.add('textarea-fallback');
                    if (editorContainer) {
                        editorContainer.style.display = 'none';
                    }
                    showNotification('Rich text editor failed to load. Using fallback editor.', 'warning');
                }
            }

            // Initialize Quill for Explanation (optional)
            if (explanationTextarea) {
                // Create container for Quill editor
                const explanationContainer = document.createElement('div');
                explanationContainer.id = 'quill-explanation';
                explanationContainer.className = 'qf-editor-container rounded-lg shadow-sm';
                explanationTextarea.parentNode.insertBefore(explanationContainer, explanationTextarea);

                try {
                    quillExplanation = new Quill('#quill-explanation', {
                        theme: 'snow',
                        modules: {
                            toolbar: [
                                ['bold', 'italic', 'underline'],
                                ['link', 'blockquote'],
                                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                                [{ 'indent': '-1'}, { 'indent': '+1' }],
                                ['image'],
                                ['clean']
                            ]
                        },
                        placeholder: 'Tulis pembahasan (opsional)...'
                    });

                    if (explanationTextarea.value) {
                        quillExplanation.root.innerHTML = explanationTextarea.value;
                    }

                    quillExplanation.on('text-change', function() {
                        explanationTextarea.value = quillExplanation.root.innerHTML;
                    });

                    explanationTextarea.style.display = 'none';
                } catch (error) {
                    console.error('Quill initialization for explanation failed:', error);
                    explanationTextarea.style.display = 'block';
                    explanationTextarea.classList.add('textarea-fallback');
                    if (explanationContainer) {
                        explanationContainer.style.display = 'none';
                    }
                }
            }
            
            // Question type functionality
            const questionTypeRadios = document.querySelectorAll('input[name="question_type"]');
            const choicesSection = document.getElementById('choicesSection');
            const essayAnswerSection = document.getElementById('essayAnswerSection');
            
            function toggleSections() {
                const selectedType = document.querySelector('input[name="question_type"]:checked');
                if (selectedType) {
                    document.body.style.cursor = 'wait';
                    
                    setTimeout(() => {
                        if (selectedType.value === 'multiple_choice') {
                            choicesSection.style.display = 'block';
                            essayAnswerSection.style.display = 'none';
                            choicesSection.classList.add('section-fade-in');
                            
                            // Initialize choice checkboxes after section becomes visible
                            setTimeout(() => {
                                initializeChoiceCheckboxes();
                            }, 100);
                        } else if (selectedType.value === 'essay') {
                            choicesSection.style.display = 'none';
                            essayAnswerSection.style.display = 'block';
                            essayAnswerSection.classList.add('section-fade-in');
                        }
                        
                        document.body.style.cursor = '';
                        console.log('Question type changed to:', selectedType.value);
                    }, 100);
                }
            }
            
            // Initial toggle based on selected value
            toggleSections();
            
            // Add event listeners to radio buttons
            questionTypeRadios.forEach(function(radio) {
                radio.addEventListener('change', toggleSections);
            });
            
            // Form validation with enhanced UX
            const form = document.querySelector('form');
            if (form) {
                form.addEventListener('submit', function(e) {
                    const category = document.querySelector('#id_category');
                    
                    // Get content from Quill editor or textarea
                    let questionContent = '';
                    if (quillEditor) {
                        questionContent = quillEditor.root.innerHTML.trim();
                        // Also check for empty content (just HTML tags)
                        const textContent = quillEditor.getText().trim();
                        if (!textContent) questionContent = '';
                    } else if (questionTextarea) {
                        questionContent = questionTextarea.value.trim();
                    }

                    // Ensure explanation value is synced (optional field)
                    if (quillExplanation && explanationTextarea) {
                        explanationTextarea.value = quillExplanation.root.innerHTML;
                    }
                    
                    if (!questionContent || (category && !category.value)) {
                        e.preventDefault();
                        showNotification('Please fill in all required fields', 'error');
                        
                        const firstError = document.querySelector('.text-red-500');
                        if (firstError) {
                            firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                        return;
                    }
                    
                    // Check if essay type and answer is provided
                    const essayRadio = document.querySelector('input[value="essay"]:checked');
                    if (essayRadio) {
                        const essayAnswer = document.getElementById('id_correct_answer_text');
                        if (essayAnswer && !essayAnswer.value.trim()) {
                            e.preventDefault();
                            showNotification('Please provide an expected answer for the essay question', 'error');
                            essayAnswer.focus();
                            return;
                        }
                    }
                    
                    // Show loading state
                    const submitBtn = form.querySelector('button[type="submit"]');
                    if (submitBtn) {
                        submitBtn.disabled = true;
                        const isUpdate = submitBtn.textContent.includes('Update');
                        submitBtn.innerHTML = `
                            <svg class="animate-spin -ml-1 mr-3 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            ${isUpdate ? 'Updating' : 'Creating'} Question...
                        `;
                    }
                });
            }
            
            // Choice Image Upload Function
            window.uploadChoiceImage = function(input, choiceNumber) {
                const file = input.files[0];
                if (!file) return;
                
                const formData = new FormData();
                formData.append('upload', file);
                formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
                
                const statusElement = document.getElementById(`choice-image-status-${choiceNumber}`);
                statusElement.textContent = 'Uploading...';
                statusElement.className = 'text-sm text-blue-600 dark:text-blue-400';
                
                fetch('/admin/image-upload/', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.url) {
                        // Update hidden input with image URL
                        document.getElementById(`choice-image-url-${choiceNumber}`).value = data.url;
                        
                        // Show preview
                        const previewContainer = document.getElementById(`choice-image-preview-${choiceNumber}`);
                        const previewImage = previewContainer.querySelector('img');
                        previewImage.src = data.url;
                        // responsive and interactive preview styles
                        previewImage.classList.add('max-w-full','h-auto','rounded-lg','cursor-zoom-in');
                        previewImage.onclick = function() {
                            const choiceLabel = String.fromCharCode(64 + choiceNumber); // Convert 1->A, 2->B, etc.
                            openImageModal(data.url, `Choice ${choiceLabel} Image`);
                        };
                        previewContainer.classList.remove('hidden');
                        
                        // Update status
                        statusElement.textContent = 'Image uploaded successfully';
                        statusElement.className = 'text-sm text-green-600 dark:text-green-400';
                        
                        // Update requirement state: if image exists, choice text is not required
                        if (typeof updateChoiceRequirements === 'function') updateChoiceRequirements();

                        showNotification('Choice image uploaded successfully!', 'success');
                    } else {
                        statusElement.textContent = 'Failed to upload image';
                        statusElement.className = 'text-sm text-red-600 dark:text-red-400';
                        showNotification('Failed to upload choice image', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    statusElement.textContent = 'Failed to upload image';
                    statusElement.className = 'text-sm text-red-600 dark:text-red-400';
                    showNotification('Failed to upload choice image', 'error');
                });
                
                // Clear the file input
                input.value = '';
            };

            // Remove Choice Image Function
            window.removeChoiceImage = function(choiceNumber) {
                try {
                    // Clear hidden input
                    const hiddenInput = document.getElementById(`choice-image-url-${choiceNumber}`);
                    if (hiddenInput) {
                        hiddenInput.value = '';
                    }
                    
                    // Clear file input
                    const fileInput = document.getElementById(`choice-image-${choiceNumber}`);
                    if (fileInput) {
                        fileInput.value = '';
                    }
                    
                    // Hide preview
                    const previewContainer = document.getElementById(`choice-image-preview-${choiceNumber}`);
                    if (previewContainer) {
                        previewContainer.classList.add('hidden');
                    }
                    
                    // Show upload area
                    const uploadArea = document.getElementById(`choice-upload-area-${choiceNumber}`);
                    if (uploadArea) {
                        uploadArea.classList.remove('hidden');
                    }
                    
                    // Clear status
                    const statusElement = document.getElementById(`choice-image-status-${choiceNumber}`);
                    if (statusElement) {
                        statusElement.textContent = '';
                        statusElement.className = 'mt-1 text-xs';
                    }
                    
                    console.log(`Image removed for choice ${choiceNumber}`);
                    showNotification('Choice image removed', 'success');
                    // Update requirement state after removing image
                    if (typeof updateChoiceRequirements === 'function') updateChoiceRequirements();
                } catch (error) {
                    console.error('Error removing choice image:', error);
                    showNotification('Error removing image', 'error');
                }

                    // For multiple choice, ensure each visible choice has text or image
                    const selectedType = document.querySelector('input[name="question_type"]:checked');
                    if (selectedType && selectedType.value === 'multiple_choice') {
                        const choiceItems = document.querySelectorAll('.choice-item');
                        for (let idx = 0; idx < choiceItems.length; idx++) {
                            const i = idx + 1;
                            const textField = document.querySelector(`#id_choices-${idx}-choice_text`);
                            const hiddenImageInput = document.getElementById(`choice-image-url-${i}`);
                            const textVal = textField ? textField.value.trim() : '';
                            const hasImage = hiddenImageInput && hiddenImageInput.value && hiddenImageInput.value.trim() !== '';
                            if (!textVal && !hasImage) {
                                e.preventDefault();
                                showNotification('Each choice must have text or an image', 'error');
                                if (textField) textField.focus();
                                return;
                            }
                        }
                    }
            };

            // Handle correct answer checkbox changes for visual feedback
            function handleCorrectAnswerChange(checkbox, choiceNumber) {
                const choiceItem = checkbox.closest('.choice-item');
                
                if (checkbox.checked) {
                    // Add comprehensive green styling for correct answer
                    choiceItem.classList.add('correct-answer');
                    
                    // Force remove default classes that might conflict
                    choiceItem.classList.remove('border-gray-200', 'dark:border-gray-600', 'bg-white', 'dark:bg-gray-800');
                    
                    // Add styling
                    choiceItem.style.border = '3px solid #10b981';
                    choiceItem.style.background = 'linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%)';
                    choiceItem.style.boxShadow = '0 8px 25px rgba(16, 185, 129, 0.3)';
                    choiceItem.style.transform = 'scale(1.02)';
                    
                    // Update header background
                    const choiceHeader = choiceItem.querySelector('.choice-header');
                    if (choiceHeader) {
                        choiceHeader.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                        choiceHeader.style.color = 'white';
                    }
                    
                    // Update badge
                    const badge = choiceItem.querySelector('.choice-badge');
                    if (badge) {
                        badge.style.background = 'rgba(255, 255, 255, 0.95)';
                        badge.style.color = '#059669';
                        badge.style.border = '2px solid white';
                        badge.style.fontWeight = 'bold';
                    }
                    
                    // Update status text
                    const statusText = choiceItem.querySelector('.choice-status');
                    if (statusText) {
                        statusText.textContent = '✓ Correct Answer';
                        statusText.style.color = 'white';
                        statusText.style.fontWeight = '600';
                    }
                    
                    // Update header title color
                    const choiceTitle = choiceItem.querySelector('h4');
                    if (choiceTitle) {
                        choiceTitle.style.color = 'white';
                        choiceTitle.style.fontWeight = '700';
                    }
                    
                    // Update checkbox label color
                    const checkboxLabel = choiceItem.querySelector('label span');
                    if (checkboxLabel) {
                        checkboxLabel.style.color = 'white';
                        checkboxLabel.style.fontWeight = '500';
                    }
                    
                    // Update textarea
                    const textarea = choiceItem.querySelector('textarea');
                    if (textarea) {
                        textarea.style.border = '2px solid #10b981';
                        textarea.style.boxShadow = '0 0 0 3px rgba(16, 185, 129, 0.15)';
                    }
                } else {
                    // Remove correct answer styling
                    choiceItem.classList.remove('correct-answer');
                    
                    // Reset inline styles
                    choiceItem.style.border = '';
                    choiceItem.style.background = '';
                    choiceItem.style.boxShadow = '';
                    choiceItem.style.transform = '';
                    
                    // Reset header
                    const choiceHeader = choiceItem.querySelector('.choice-header');
                    if (choiceHeader) {
                        choiceHeader.style.background = '';
                        choiceHeader.style.color = '';
                    }
                    
                    // Reset badge
                    const badge = choiceItem.querySelector('.choice-badge');
                    if (badge) {
                        badge.style.background = '';
                        badge.style.color = '';
                        badge.style.border = '';
                        badge.style.fontWeight = '';
                    }
                    
                    // Reset status text
                    const statusText = choiceItem.querySelector('.choice-status');
                    if (statusText) {
                        statusText.textContent = 'Option';
                        statusText.style.color = '';
                        statusText.style.fontWeight = '';
                    }
                    
                    // Reset header title
                    const choiceTitle = choiceItem.querySelector('h4');
                    if (choiceTitle) {
                        choiceTitle.style.color = '';
                        choiceTitle.style.fontWeight = '';
                    }
                    
                    // Reset checkbox label
                    const checkboxLabel = choiceItem.querySelector('label span');
                    if (checkboxLabel) {
                        checkboxLabel.style.color = '';
                        checkboxLabel.style.fontWeight = '';
                    }
                    
                    // Reset textarea
                    const textarea = choiceItem.querySelector('textarea');
                    if (textarea) {
                        textarea.style.border = '';
                        textarea.style.boxShadow = '';
                    }
                }
            }

            // Initialize choice checkboxes function
            function initializeChoiceCheckboxes() {
                // Add event listeners to all correct answer checkboxes - try multiple selectors
                let checkboxes = document.querySelectorAll('input[name$="-is_correct"]'); // Formset pattern
                if (checkboxes.length === 0) {
                    checkboxes = document.querySelectorAll('input[name$="_is_correct"]'); // Alternative pattern
                }
                if (checkboxes.length === 0) {
                    checkboxes = document.querySelectorAll('.choice-checkbox'); // Class-based selector
                }
                if (checkboxes.length === 0) {
                    checkboxes = document.querySelectorAll('input[type="checkbox"]'); // All checkboxes
                }
                
                checkboxes.forEach((checkbox, index) => {
                    // Remove existing listeners to avoid duplicates
                    if (checkbox._choiceHandler) {
                        checkbox.removeEventListener('change', checkbox._choiceHandler);
                    }
                    
                    // Create new handler
                    checkbox._choiceHandler = function() {
                        handleCorrectAnswerChange(this, index + 1);
                    };
                    
                    checkbox.addEventListener('change', checkbox._choiceHandler);
                    
                    // Initialize state on page load
                    if (checkbox.checked) {
                        handleCorrectAnswerChange(checkbox, index + 1);
                    }
                });
            }

            // Initialize correct answer checkboxes on DOM ready
            document.addEventListener('DOMContentLoaded', function() {
                initializeChoiceCheckboxes();
                if (typeof updateChoiceRequirements === 'function') updateChoiceRequirements();
            });
            
            // Image Modal Functions
            window.openImageModal = function(imageSrc, imageTitle = 'Image Preview') {
                const modal = document.getElementById('imageModal');
                const modalImage = document.getElementById('modalImage');
                const modalTitle = document.getElementById('modal-title');
                
                if (imageSrc && imageSrc !== '') {
                    modalImage.src = imageSrc;
                    modalTitle.textContent = imageTitle;
                    modal.classList.remove('hidden');
                    document.body.style.overflow = 'hidden'; // Prevent background scrolling
                } else {
                    showNotification('No image to display', 'warning');
                }
            };
            
            window.closeImageModal = function() {
                const modal = document.getElementById('imageModal');
                modal.classList.add('hidden');
                document.body.style.overflow = ''; // Restore scrolling
            };
            
            // Close modal when clicking outside or pressing Escape
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    closeImageModal();
                }
            });
            
            // Prevent modal from closing when clicking on the image
            document.getElementById('modalImage').addEventListener('click', function(event) {
                event.stopPropagation();
            });
            
            // Notification system
            function showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `fixed top-4 right-4 z-50 px-4 py-3 rounded-lg shadow-lg max-w-sm ${getNotificationClasses(type)}`;
                notification.innerHTML = `
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            ${getNotificationIcon(type)}
                        </div>
                        <div class="ml-3">
                            <p class="text-sm font-medium">${message}</p>
                        </div>
                        <div class="ml-auto pl-3">
                            <button onclick="this.parentElement.parentElement.parentElement.remove()" class="inline-flex text-gray-400 hover:text-gray-600">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 5000);
            }
            
            function getNotificationClasses(type) {
                switch (type) {
                    case 'success':
                        return 'bg-green-50 border border-green-200 text-green-800 dark:bg-green-900/20 dark:border-green-800 dark:text-green-400';
                    case 'error':
                        return 'bg-red-50 border border-red-200 text-red-800 dark:bg-red-900/20 dark:border-red-800 dark:text-red-400';
                    case 'warning':
                        return 'bg-yellow-50 border border-yellow-200 text-yellow-800 dark:bg-yellow-900/20 dark:border-yellow-800 dark:text-yellow-400';
                    default:
                        return 'bg-blue-50 border border-blue-200 text-blue-800 dark:bg-blue-900/20 dark:border-blue-800 dark:text-blue-400';
                }
            }
            
            function getNotificationIcon(type) {
                switch (type) {
                    case 'success':
                        return '<svg class="w-5 h-5 text-green-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>';
                    case 'error':
                        return '<svg class="w-5 h-5 text-red-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>';
                    case 'warning':
                        return '<svg class="w-5 h-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>';
                    default:
                        return '<svg class="w-5 h-5 text-blue-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>';
                }
            }
            
            // Mobile-friendly enhancements
            if (window.innerWidth <= 768) {
                document.querySelectorAll('input, textarea, select').forEach(input => {
                    input.addEventListener('focus', function() {
                        setTimeout(() => {
                            this.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }, 300);
                    });
                });
            }
        });
    </script>
{% endblock %}
