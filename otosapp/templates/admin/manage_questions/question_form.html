{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title|default:"Question Form" }}{% endblock %}

{% block extrahead %}
    <!-- Flowbite WYSIWYG Editor -->
    <!-- Flowbite: UI components (relies on Tailwind) -->
    <script src="https://unpkg.com/flowbite@1.7.0/dist/flowbite.min.js"></script>
    <!-- MathJax for LaTeX rendering -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.min.js"></script>
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']]
        },
        startup: {
          ready: () => {
            MathJax.startup.defaultReady();
            console.log('MathJax loaded and ready for LaTeX rendering');
          }
        }
      };
    </script>
    <style>
        .section-fade-in { animation: fadeIn 0.25s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }
        
        /* WYSIWYG Editor custom styles */
        .wysiwyg-editor {
            min-height: 200px;
        }
        
        .prose {
            max-width: none;
        }
        
        .prose p {
            margin-bottom: 1em;
        }
        
        .prose ul, .prose ol {
            margin: 1em 0;
            padding-left: 2em;
        }
        
        .prose blockquote {
            border-left: 4px solid #e5e7eb;
            padding-left: 1em;
            margin: 1em 0;
            font-style: italic;
        }
        
        .dark .prose blockquote {
            border-left-color: #6b7280;
        }
        
        /* Placeholder styling for empty WYSIWYG editors */
        [data-wysiwyg="true"].is-empty:before {
            content: attr(data-placeholder);
            color: #9ca3af;
            font-style: italic;
            pointer-events: none;
            position: absolute;
        }
        
        .dark [data-wysiwyg="true"].is-empty:before {
            color: #6b7280;
        }
        
        /* Ensure proper focus outline for accessibility */
        [data-wysiwyg="true"]:focus {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
        }
        
        /* Format toolbar button active states */
        [data-wysiwyg-toggle-format].active {
            background-color: #dbeafe;
            color: #1e40af;
        }
        
        .dark [data-wysiwyg-toggle-format].active {
            background-color: #1e3a8a;
            color: #bfdbfe;
        }

        /* Text inputs and textareas */
        textarea,
        input[type="text"],
        select,
        .choice-item textarea {
            background: #ffffff;
            color: #1f2937;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 0.75rem;
            font-size: 14px;
            transition: border-color 0.2s ease-in-out;
        }

        .dark textarea,
        .dark input[type="text"],
        .dark select,
        .dark .choice-item textarea {
            background: #1f2937;
            color: #f9fafb;
            border-color: #4b5563;
        }

        textarea:focus,
        input[type="text"]:focus,
        select:focus,
        .choice-item textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        textarea::placeholder,
        input[type="text"]::placeholder,
        .choice-item textarea::placeholder {
            color: #9ca3af;
        }

        .dark textarea::placeholder,
        .dark input[type="text"]::placeholder,
        .dark .choice-item textarea::placeholder {
            color: #6b7280;
        }

        /* Choice checkbox styling */
        .choice-checkbox:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
        }

        .dark .choice-checkbox {
            border-color: #4b5563;
            background-color: #374151;
        }

        /* Correct answer visual states */
        .choice-item.correct-answer {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border: 3px solid #10b981;
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
            transform: scale(1.02);
        }

        .choice-item.correct-answer .choice-header {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .choice-item.correct-answer textarea {
            border: 2px solid #10b981;
            background-color: rgba(255, 255, 255, 0.98);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.15);
        }

        .dark .choice-item.correct-answer textarea {
            background-color: rgba(31, 41, 55, 0.98);
        }

        /* Dark theme adjustments for correct answer (softer, more readable) */
        .dark .choice-item.correct-answer {
            background: rgba(6, 95, 70, 0.22);
            border-color: #059669;
            box-shadow: 0 8px 18px rgba(5, 150, 105, 0.18);
        }

        .dark .choice-item.correct-answer .choice-header {
            background: linear-gradient(135deg, #065f46 0%, #047857 100%);
            color: #e5fff4;
        }

        .dark .choice-item.correct-answer .choice-status,
        .dark .choice-item.correct-answer h4 {
            color: #e5fff4;
        }

        .dark .choice-item.correct-answer .choice-badge {
            background-color: #059669;
            color: #ecfdf5;
        }

        /* Layout and small animations */
        .choice-item { 
            transition: all 0.2s ease-in-out; 
        }
        
        .choice-item:hover { 
            transform: translateY(-1px); 
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); 
        }

        /* Modal and thumbnail */
        #imageModal { 
            backdrop-filter: blur(4px); 
        }
        
        #modalImage { 
            transition: transform 0.2s ease-in-out; 
            cursor: zoom-in; 
        }
        
        #modalImage:hover { 
            transform: scale(1.02); 
        }
        
        .choice-item img { 
            transition: all 0.2s ease-in-out; 
        }
        
        .choice-item img:hover { 
            transform: scale(1.05); 
            box-shadow: 0 4px 20px rgba(0,0,0,0.15); 
        }

        /* Responsive tweaks */
        @media (max-width: 768px) {
            .wysiwyg-editor { 
                min-height: 180px; 
            }
            .choice-item { 
                padding: 0.5rem; 
            }
        }

        /* Dark mode adjustments for previews */
        .dark #imageModal .modal-panel { 
            background-color: #0f172a; 
        }
        
        .dark .choice-item img { 
            box-shadow: 0 4px 14px rgba(255,255,255,0.03); 
        }
    </style>
{% endblock %}

{% block content %}
<!-- Include Question Header Component -->
<section class="bg-gray-50 dark:bg-gray-900 p-3 sm:p-5 antialiased">
    <div class="mx-auto max-w-screen-xl px-4 lg:px-12">
        {% with header_title=page_title|default:"Question Form" header_subtitle=page_subtitle show_back_button=True header_icon='<svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>' %}
            {% include 'admin/manage_questions/includes/question_header.html' %}
        {% endwith %}

    <div class="bg-white dark:bg-gray-800 relative shadow-md sm:rounded-lg overflow-hidden question-form-card">
        <div class="p-6">
            <div class="max-w-4xl mx-auto">
                <!-- Error Messages -->
                {% if form.errors %}
                    <div class="mb-6 bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg dark:bg-red-900/20 dark:border-red-800 dark:text-red-400">
                                    <div class="flex">
                                        <div class="flex-shrink-0">
                                            <svg class="h-5 w-5 text-red-400" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                                            </svg>
                                        </div>
                                        <div class="ml-3">
                                            <h3 class="text-sm font-medium">Please fix the following errors:</h3>
                                            <div class="mt-2 text-sm">
                                                <ul class="list-disc pl-5 space-y-1">
                                                    {% for field, errors in form.errors.items %}
                                                        {% for error in errors %}
                                                            <li>{{ field|capfirst }}: {{ error }}</li>
                                                        {% endfor %}
                                                    {% endfor %}
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}

                            <!-- Form -->
                            <form method="post" class="space-y-6">
                                {% csrf_token %}
                                
                                <!-- Question Content -->
                                <div class="bg-white dark:bg-gray-800 shadow-sm rounded-lg border border-gray-200 dark:border-gray-700">
                                    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                                        <h3 class="text-lg font-medium text-gray-900 dark:text-white">Question Content</h3>
                                        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                                            {% if question %}Update your question content using the rich text editor{% else %}Enter your question content using the rich text editor{% endif %}
                                        </p>
                                    </div>
                                    <div class="px-6 py-4">
                                        <div class="mb-4 p-4 border border-gray-200 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700">
                                            <label for="id_question_text" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                                Question Text
                                                <span class="text-red-500">*</span>
                                            </label>
                                            
                                            <!-- Flowbite WYSIWYG Editor for Question Text -->
                                            <div class="w-full mb-4 border border-gray-200 rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600">
                                                <div class="flex items-center justify-between px-3 py-2 border-b dark:border-gray-600">
                                                    <div class="flex flex-wrap items-center divide-gray-200 sm:divide-x sm:rtl:divide-x-reverse dark:divide-gray-600">
                                                        <div class="flex items-center space-x-1 rtl:space-x-reverse sm:pe-4">
                                                            <button type="button" data-tooltip-target="tooltip-bold-admin" data-wysiwyg-toggle-format="bold" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5h4.5a3.5 3.5 0 1 1 0 7H8m0-7v7m0-7H6m2 7h6.5a3.5 3.5 0 1 1 0 7H8m0-7v7m0 0H6"/>
                                                                </svg>
                                                                <span class="sr-only">Bold</span>
                                                            </button>
                                                            <div id="tooltip-bold-admin" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                Bold
                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                            </div>
                                                            <button type="button" data-tooltip-target="tooltip-italic-admin" data-wysiwyg-toggle-format="italic" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m8.874 19 6.143-14M6 19h6.33m-.66-14H18"/>
                                                                </svg>
                                                                <span class="sr-only">Italic</span>
                                                            </button>
                                                            <div id="tooltip-italic-admin" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                Italic
                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                            </div>
                                                            <button type="button" data-tooltip-target="tooltip-underline-admin" data-wysiwyg-toggle-format="underline" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                                    <path stroke="currentColor" stroke-linecap="round" stroke-width="2" d="M6 19h12M8 5v9a4 4 0 0 0 8 0V5M6 5h4m4 0h4"/>
                                                                </svg>
                                                                <span class="sr-only">Underline</span>
                                                            </button>
                                                            <div id="tooltip-underline-admin" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                Underline
                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                            </div>
                                                        </div>
                                                        <div class="flex flex-wrap items-center space-x-1 rtl:space-x-reverse sm:ps-4">
                                                            <button type="button" data-tooltip-target="tooltip-list-admin" data-wysiwyg-toggle-format="unorderedList" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                                    <path stroke="currentColor" stroke-linecap="round" stroke-width="2" d="M9 8h10M9 12h10M9 16h10M4.99 8H5m-.02 4h.01m0 4H5"/>
                                                                </svg>
                                                                <span class="sr-only">Bullet list</span>
                                                            </button>
                                                            <div id="tooltip-list-admin" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                Bullet list
                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                            </div>
                                                            <button type="button" data-tooltip-target="tooltip-ordered-list-admin" data-wysiwyg-toggle-format="orderedList" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6h8m-8 6h8m-8 6h8M4 16a2 2 0 1 1 3.321 1.5L4 20h5M4 5l2-1v6m-2 0h4"/>
                                                                </svg>
                                                                <span class="sr-only">Ordered list</span>
                                                            </button>
                                                            <div id="tooltip-ordered-list-admin" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                Ordered list
                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                            </div>
                                                            <button type="button" data-tooltip-target="tooltip-blockquote-admin" data-wysiwyg-toggle-format="blockquote" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                                                                    <path fill-rule="evenodd" d="M6 6a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1.5L6 16.5v.5h3l2-3.5V11a2 2 0 0 0-2-2H6Zm7 0a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1.5L13 16.5v.5h3l2-3.5V11a2 2 0 0 0-2-2h-3Z" clip-rule="evenodd"/>
                                                                </svg>
                                                                <span class="sr-only">Blockquote</span>
                                                            </button>
                                                            <div id="tooltip-blockquote-admin" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                Blockquote
                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                            </div>
                                                            
                                                            <!-- Separator -->
                                                            <div class="w-px h-6 bg-gray-300 dark:bg-gray-600 mx-1"></div>
                                                            
                                                            <!-- Image Upload Button -->
                                                            <button type="button" data-tooltip-target="tooltip-image-admin" data-wysiwyg-action="image" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                                                                    <path fill-rule="evenodd" d="M13 10a1 1 0 0 1 1-1h.01a1 1 0 1 1 0 2H14a1 1 0 0 1-1-1Z" clip-rule="evenodd"/>
                                                                    <path fill-rule="evenodd" d="M2 6a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v12c0 .556-.227 1.06-.593 1.422A.999.999 0 0 1 20.5 20H4a2.002 2.002 0 0 1-2-2V6Zm6.892 12 3.833-5.356-3.99-4.322a1 1 0 0 0-1.549.097L4 12.879V6h16v9.95l-3.257-3.619a1 1 0 0 0-1.557.088L11.2 18H8.892Z" clip-rule="evenodd"/>
                                                                </svg>
                                                                <span class="sr-only">Upload Image</span>
                                                            </button>
                                                            <div id="tooltip-image-admin" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                Upload Image
                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                            </div>

                                                            <!-- Math Symbols Button -->
                                                            <button type="button" data-tooltip-target="tooltip-math-admin" data-wysiwyg-action="math-symbols" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                                                                    <path d="M9 7H7v2H5V7H3V5h2V3h2v2h2v2Zm2 12h10v-2H11v2Zm0-4h10v-2H11v2Zm0-4h10V9H11v2Z"/>
                                                                </svg>
                                                                <span class="sr-only">Math Symbols</span>
                                                            </button>
                                                            <div id="tooltip-math-admin" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                Insert Math Symbols
                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                            </div>

                                                            <!-- LaTeX Formula Button -->
                                                            <button type="button" data-tooltip-target="tooltip-latex-admin" data-wysiwyg-action="latex" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                                                                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                                                                </svg>
                                                                <span class="sr-only">LaTeX Formula</span>
                                                            </button>
                                                            <div id="tooltip-latex-admin" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                Insert LaTeX Formula
                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="px-4 py-2 bg-white rounded-b-lg dark:bg-gray-800">
                                                    <div id="wysiwyg-question-text-admin" data-wysiwyg="true" contenteditable="true" class="prose dark:prose-invert block w-full px-0 text-sm text-gray-800 bg-white border-0 dark:bg-gray-800 focus:ring-0 dark:text-white dark:placeholder-gray-400 wysiwyg-editor" data-placeholder="Type your question here...">{{ form.question_text.value|default:"" }}</div>
                                                </div>
                                            </div>
                                            
                                            <!-- Hidden textarea for form submission -->
                                            <textarea id="id_question_text" name="question_text" class="hidden">{{ form.question_text.value|default:"" }}</textarea>
                                            
                                            {% if form.question_text.errors %}
                                                {% for error in form.question_text.errors %}
                                                    <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ error }}</p>
                                                {% endfor %}
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <!-- Question Type and Category (swapped: Weight config now on the left) -->
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                    <!-- Weight Configuration (moved here) -->
                                    <div class="bg-white dark:bg-gray-800 shadow-sm rounded-lg border border-gray-200 dark:border-gray-700">
                                        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                                            <h3 class="text-lg font-medium text-gray-900 dark:text-white">Weight Configuration</h3>
                                        </div>
                                        <div class="px-6 py-4">
                                            <label for="id_custom_weight" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                                Custom Weight (Optional)
                                            </label>
                                            {{ form.custom_weight }}
                                            {% if form.custom_weight.help_text %}
                                                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">{{ form.custom_weight.help_text }}</p>
                                            {% endif %}
                                            {% if form.custom_weight.errors %}
                                                {% for error in form.custom_weight.errors %}
                                                    <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ error }}</p>
                                                {% endfor %}
                                            {% endif %}
                                        </div>
                                    </div>

                                    <!-- Category -->
                                    <div class="bg-white dark:bg-gray-800 shadow-sm rounded-lg border border-gray-200 dark:border-gray-700">
                                        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                                            <h3 class="text-lg font-medium text-gray-900 dark:text-white">Category</h3>
                                        </div>
                                        <div class="px-6 py-4">
                                            <label for="id_category" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                                Question Category
                                                <span class="text-red-500">*</span>
                                            </label>
                                            {{ form.category }}
                                            <input type="hidden" id="id_category_hidden" name="category">
                                            <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">Category dikunci agar tidak dapat diubah.</p>
                                            <script>
                                            (function() {
                                                var categorySelect = document.getElementById('id_category');
                                                if (categorySelect) {
                                                    categorySelect.setAttribute('disabled', 'disabled');
                                                    if (categorySelect.classList) {
                                                        categorySelect.classList.add('bg-gray-100', 'cursor-not-allowed', 'opacity-60', 'dark:bg-gray-700', 'dark:text-gray-300', 'dark:placeholder-gray-400', 'dark:border-gray-600');
                                                    }
                                                    var hiddenInput = document.getElementById('id_category_hidden');
                                                    if (hiddenInput) {
                                                        hiddenInput.value = categorySelect.value;
                                                    }
                                                }
                                            })();
                                            </script>
                                            {% if form.category.errors %}
                                                {% for error in form.category.errors %}
                                                    <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ error }}</p>
                                                {% endfor %}
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <!-- Question Type (moved here and redesigned as selectable cards) -->
                                <div class="bg-white dark:bg-gray-800 shadow-sm rounded-lg border border-gray-200 dark:border-gray-700">
                                    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                                        <h3 class="text-lg font-medium text-gray-900 dark:text-white">Question Type</h3>
                                    </div>
                                    <div class="px-6 py-4">
                                        <fieldset>
                                            <legend class="sr-only">Question Type</legend>
                                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4" id="questionTypeCards">
                                                {% for choice in form.question_type %}
                                                    <label for="{{ choice.id_for_label }}" class="question-type-card group block border rounded-lg p-4 cursor-pointer transition-all duration-150 border-gray-200 dark:border-gray-700 hover:border-primary-400 dark:hover:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500 dark:focus:ring-primary-400">
                                                        <div class="flex items-start">
                                                            <div class="mt-1">
                                                                {{ choice.tag|safe }}
                                                            </div>
                                                            <div class="ml-3">
                                                                <div class="js-type-title text-sm font-medium text-gray-900 dark:text-white">{{ choice.choice_label }}</div>
                                                                <div class="mt-1 text-xs text-gray-600 dark:text-gray-400 js-type-desc">Pilih tipe pertanyaan yang sesuai.</div>
                                                            </div>
                                                        </div>
                                                    </label>
                                                {% endfor %}
                                            </div>
                                        </fieldset>
                                        <script>
                                            (function() {
                                                var radios = document.querySelectorAll('input[name="question_type"]');
                                                var descMap = {
                                                    'multiple_choice': 'Cocok untuk soal pilihan ganda dengan beberapa opsi jawaban.',
                                                    'essay': 'Jawaban berupa teks esai yang dinilai sesuai kebijakan penilaian.'
                                                };
                                                function refreshCards() {
                                                    radios.forEach(function(radio) {
                                                        var label = document.querySelector('label[for="' + radio.id + '"]');
                                                        if (!label) return;
                                                        var desc = label.querySelector('.js-type-desc');
                                                        var title = label.querySelector('.js-type-title');
                                                        var text = descMap[radio.value] || 'Pilih tipe pertanyaan yang sesuai.';
                                                        if (desc) desc.textContent = text;
                                                        if (radio.checked) {
                                                            label.classList.add('ring-2','ring-primary-500','border-primary-400','bg-primary-100','dark:bg-primary-800/40','dark:border-primary-500','dark:ring-primary-400');
                                                            if (title) {
                                                                title.classList.add('text-gray-900','dark:text-white');
                                                            }
                                                            if (desc) {
                                                                desc.classList.add('text-gray-700','dark:text-gray-300');
                                                                desc.classList.remove('text-gray-600','dark:text-gray-400');
                                                            }
                                                        } else {
                                                            label.classList.remove('ring-2','ring-primary-500','border-primary-400','bg-primary-100','dark:bg-primary-800/40','dark:border-primary-500','dark:ring-primary-400');
                                                            if (desc) {
                                                                desc.classList.remove('text-gray-700','dark:text-gray-300');
                                                                desc.classList.add('text-gray-600','dark:text-gray-400');
                                                            }
                                                        }
                                                    });
                                                }
                                                radios.forEach(function(radio) {
                                                    // Make the native radio visually hidden but accessible via label card
                                                    radio.classList.add('sr-only');
                                                    radio.addEventListener('change', refreshCards);
                                                });
                                                refreshCards();
                                            })();
                                        </script>
                                        {% if form.question_type.help_text %}
                                            <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">{{ form.question_type.help_text }}</p>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- Multiple Choice Options -->
                                <div id="choicesSection" class="bg-white dark:bg-gray-800 shadow-sm rounded-lg border border-gray-200 dark:border-gray-700" style="display: none;">
                                    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <h3 class="text-lg font-medium text-gray-900 dark:text-white">Answer Choices</h3>
                                                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                                                    {% if question %}Update multiple choice options for this question{% else %}Add multiple choice options for this question{% endif %}
                                                </p>
                                            </div>
                                            <div class="flex items-center space-x-2 text-xs text-gray-500 dark:text-gray-400">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                </svg>
                                                <span>Select at least one correct answer</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="px-6 py-6">
                                        {{ formset.management_form }}
                                        
                                        <div id="choice-forms" class="space-y-4">
                                            {% for form in formset %}
                                                <div class="choice-item relative group border-2 border-gray-200 dark:border-gray-600 rounded-xl overflow-hidden transition-all duration-200 hover:border-primary-300 dark:hover:border-primary-500 {% if form.is_correct.value %}correct-answer{% endif %}" data-choice="{{ forloop.counter }}">
                                                    {% for hidden in form.hidden_fields %}{{ hidden }}{% endfor %}
                                                    
                                                    <!-- Choice Header with Letter Badge -->
                                                    <div class="choice-header flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-700/50 border-b border-gray-200 dark:border-gray-600">
                                                        <div class="flex items-center space-x-3">
                                                            <!-- Choice Letter Badge -->
                                                            <div class="choice-badge flex items-center justify-center w-10 h-10 rounded-full font-bold text-lg {% if form.is_correct.value %}bg-green-600 text-white dark:bg-emerald-600 dark:text-emerald-50{% else %}bg-primary-100 text-primary-700 dark:bg-primary-900 dark:text-primary-300{% endif %}">
                                                                {% if forloop.counter == 1 %}A{% elif forloop.counter == 2 %}B{% elif forloop.counter == 3 %}C{% elif forloop.counter == 4 %}D{% elif forloop.counter == 5 %}E{% endif %}
                                                            </div>
                                                            
                                                            <!-- Choice Title -->
                                                            <div>
                                                                <h4 class="text-lg font-semibold {% if form.is_correct.value %}text-white font-bold dark:text-emerald-50{% else %}text-gray-900 dark:text-white{% endif %}">
                                                                    Choice {% if forloop.counter == 1 %}A{% elif forloop.counter == 2 %}B{% elif forloop.counter == 3 %}C{% elif forloop.counter == 4 %}D{% elif forloop.counter == 5 %}E{% endif %}
                                                                </h4>
                                                                <p class="choice-status text-sm {% if form.is_correct.value %}text-white font-medium dark:text-emerald-50{% else %}text-gray-500 dark:text-gray-400{% endif %}">
                                                                    {% if form.is_correct.value %}âœ“ Correct Answer{% else %}Option{% endif %}
                                                                </p>
                                                            </div>
                                                        </div>
                                                        
                                                        <!-- Correct Answer Toggle -->
                                                        <div class="flex items-center space-x-3">
                                                            <label class="relative inline-flex items-center cursor-pointer">
                                                                {{ form.is_correct }}
                                                                <span class="ml-3 text-sm font-medium {% if form.is_correct.value %}text-white{% else %}text-gray-700 dark:text-gray-300{% endif %}">
                                                                    Mark as correct
                                                                </span>
                                                            </label>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Choice Content -->
                                                    <div class="p-4">
                                                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                                                            <!-- Choice Text (Left 2/3) -->
                                                            <div class="lg:col-span-2">
                                                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                                                    Choice Text <span id="choice-text-req-{{ forloop.counter }}" class="text-red-500">*</span>
                                                                </label>
                                                                {{ form.choice_text }}
                                                                {% if form.choice_text.errors %}
                                                                    {% for error in form.choice_text.errors %}
                                                                        <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ error }}</p>
                                                                    {% endfor %}
                                                                {% endif %}
                                                            </div>
                                                            
                                                            <!-- Choice Image (Right 1/3) -->
                                                            <div class="lg:col-span-1">
                                                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                                                    Choice Image
                                                                </label>
                                                                
                                                                <!-- Image Upload Area -->
                                                                <div class="relative border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-4 text-center hover:border-primary-400 dark:hover:border-primary-500 transition-colors duration-200">
                                                                    <!-- Current Image Preview -->
                                                                    <div id="choice-image-preview-{{ forloop.counter }}" class="{% if not form.instance.choice_image %}hidden{% endif %}">
                                                                        {% if form.instance.choice_image %}
                                                                            <div class="relative inline-block">
                                                                                <img src="{{ form.instance.choice_image.url }}" 
                                                                                     class="w-full h-24 object-cover rounded-lg border border-gray-200 dark:border-gray-600 shadow-sm cursor-pointer hover:opacity-80 transition-opacity" 
                                                                                     alt="Choice image"
                                                                                     onclick="openImageModal('{{ form.instance.choice_image.url }}', 'Choice {% if forloop.counter == 1 %}A{% elif forloop.counter == 2 %}B{% elif forloop.counter == 3 %}C{% elif forloop.counter == 4 %}D{% elif forloop.counter == 5 %}E{% endif %}')">
                                                                                <button type="button" 
                                                                                        onclick="console.log('Remove existing image clicked for choice {{ forloop.counter }}'); removeChoiceImage({{ forloop.counter }}); event.stopPropagation(); return false;" 
                                                                                        class="absolute -top-2 -right-2 bg-red-500 hover:bg-red-600 text-white rounded-full p-2 shadow-lg transition-colors duration-200 z-20 border-2 border-white">
                                                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                                                                    </svg>
                                                                                </button>
                                                                            </div>
                                                                        {% else %}
                                                                            <div class="relative inline-block">
                                                                                <img class="w-full h-24 object-cover rounded-lg border border-gray-200 dark:border-gray-600 shadow-sm cursor-pointer hover:opacity-80 transition-opacity" 
                                                                                     alt="Choice image"
                                                                                     onclick="openImageModal(this.src, 'Choice {% if forloop.counter == 1 %}A{% elif forloop.counter == 2 %}B{% elif forloop.counter == 3 %}C{% elif forloop.counter == 4 %}D{% elif forloop.counter == 5 %}E{% endif %}')">
                                                                                <button type="button" 
                                                                                        onclick="console.log('Remove new image clicked for choice {{ forloop.counter }}'); removeChoiceImage({{ forloop.counter }}); event.stopPropagation(); return false;" 
                                                                                        class="absolute -top-2 -right-2 bg-red-500 hover:bg-red-600 text-white rounded-full p-2 shadow-lg transition-colors duration-200 z-20 border-2 border-white">
                                                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                                                                    </svg>
                                                                                </button>
                                                                            </div>
                                                                        {% endif %}
                                                                    </div>
                                                                    
                                                                    <!-- Upload Area (shown when no image) -->
                                                                    <div id="choice-upload-area-{{ forloop.counter }}" class="{% if form.instance.choice_image %}hidden{% endif %}">
                                                                        <svg class="mx-auto h-8 w-8 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                                                            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                                                                        </svg>
                                                                        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Click to upload</p>
                                                                    </div>
                                                                    
                                                                    <!-- Hidden File Input -->
                                                                    <input type="file" 
                                                                           id="choice-image-{{ forloop.counter }}" 
                                                                           accept="image/*" 
                                                                           class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" 
                                                                           onchange="uploadChoiceImage(this, {{ forloop.counter }})">
                                                                    
                                                                    <!-- Status Text -->
                                                                    <p id="choice-image-status-{{ forloop.counter }}" class="mt-1 text-xs"></p>
                                                                </div>
                                                                
                                                                <!-- Hidden Django Field -->
                                                                <div class="hidden">{{ form.choice_image }}</div>
                                                                <input type="hidden" 
                                                                       id="choice-image-url-{{ forloop.counter }}" 
                                                                       name="choice_image_{{ forloop.counter }}" 
                                                                       value="{% if form.instance.choice_image %}{{ form.instance.choice_image.url }}{% endif %}">
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>

                                <!-- Essay Answer Section -->
                                <div id="essayAnswerSection" class="bg-white dark:bg-gray-800 shadow-sm rounded-lg border border-gray-200 dark:border-gray-700" style="display: none;">
                                    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                                        <h3 class="text-lg font-medium text-gray-900 dark:text-white">Expected Answer</h3>
                                        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Provide the expected answer or key points for this essay question</p>
                                    </div>
                                    <div class="px-6 py-4">
                                        <label for="id_correct_answer_text" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                            Expected Answer
                                        </label>
                                        {{ form.correct_answer_text }}
                                        {% if form.correct_answer_text.help_text %}
                                            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">{{ form.correct_answer_text.help_text }}</p>
                                        {% endif %}
                                        {% if form.correct_answer_text.errors %}
                                            {% for error in form.correct_answer_text.errors %}
                                                <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ error }}</p>
                                            {% endfor %}
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- Explanation / Pembahasan (optional) -->
                                <div class="bg-white dark:bg-gray-800 shadow-sm rounded-lg border border-gray-200 dark:border-gray-700">
                                    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                                        <h3 class="text-lg font-medium text-gray-900 dark:text-white">Pembahasan Jawaban (Opsional)</h3>
                                        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                                            Tambahkan penjelasan mengapa jawabannya seperti itu. Kosongkan jika tidak diperlukan.
                                        </p>
                                    </div>
                                    <div class="px-6 py-4">
                                        <div class="mb-4 p-4 border border-gray-200 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700">
                                            <label for="id_explanation" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                                Pembahasan
                                            </label>
                                            
                                            <!-- Flowbite WYSIWYG Editor for Explanation -->
                                            <div class="w-full mb-4 border border-gray-200 rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600">
                                                <div class="flex items-center justify-between px-3 py-2 border-b dark:border-gray-600">
                                                    <div class="flex flex-wrap items-center divide-gray-200 sm:divide-x sm:rtl:divide-x-reverse dark:divide-gray-600">
                                                        <div class="flex items-center space-x-1 rtl:space-x-reverse sm:pe-4">
                                                            <button type="button" data-tooltip-target="tooltip-bold-exp-admin" data-wysiwyg-toggle-format="bold" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5h4.5a3.5 3.5 0 1 1 0 7H8m0-7v7m0-7H6m2 7h6.5a3.5 3.5 0 1 1 0 7H8m0-7v7m0 0H6"/>
                                                                </svg>
                                                                <span class="sr-only">Bold</span>
                                                            </button>
                                                            <div id="tooltip-bold-exp-admin" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                Bold
                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                            </div>
                                                            <button type="button" data-tooltip-target="tooltip-italic-exp-admin" data-wysiwyg-toggle-format="italic" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m8.874 19 6.143-14M6 19h6.33m-.66-14H18"/>
                                                                </svg>
                                                                <span class="sr-only">Italic</span>
                                                            </button>
                                                            <div id="tooltip-italic-exp-admin" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                Italic
                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                            </div>
                                                            <button type="button" data-tooltip-target="tooltip-underline-exp-admin" data-wysiwyg-toggle-format="underline" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                                    <path stroke="currentColor" stroke-linecap="round" stroke-width="2" d="M6 19h12M8 5v9a4 4 0 0 0 8 0V5M6 5h4m4 0h4"/>
                                                                </svg>
                                                                <span class="sr-only">Underline</span>
                                                            </button>
                                                            <div id="tooltip-underline-exp-admin" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                Underline
                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                            </div>
                                                        </div>
                                                        <div class="flex flex-wrap items-center space-x-1 rtl:space-x-reverse sm:ps-4">
                                                            <button type="button" data-tooltip-target="tooltip-list-exp-admin" data-wysiwyg-toggle-format="unorderedList" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                                    <path stroke="currentColor" stroke-linecap="round" stroke-width="2" d="M9 8h10M9 12h10M9 16h10M4.99 8H5m-.02 4h.01m0 4H5"/>
                                                                </svg>
                                                                <span class="sr-only">Bullet list</span>
                                                            </button>
                                                            <div id="tooltip-list-exp-admin" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                Bullet list
                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                            </div>
                                                            <button type="button" data-tooltip-target="tooltip-ordered-list-exp-admin" data-wysiwyg-toggle-format="orderedList" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6h8m-8 6h8m-8 6h8M4 16a2 2 0 1 1 3.321 1.5L4 20h5M4 5l2-1v6m-2 0h4"/>
                                                                </svg>
                                                                <span class="sr-only">Ordered list</span>
                                                            </button>
                                                            <div id="tooltip-ordered-list-exp-admin" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                Ordered list
                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                            </div>
                                                            <button type="button" data-tooltip-target="tooltip-blockquote-exp-admin" data-wysiwyg-toggle-format="blockquote" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                                                                    <path fill-rule="evenodd" d="M6 6a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1.5L6 16.5v.5h3l2-3.5V11a2 2 0 0 0-2-2H6Zm7 0a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1.5L13 16.5v.5h3l2-3.5V11a2 2 0 0 0-2-2h-3Z" clip-rule="evenodd"/>
                                                                </svg>
                                                                <span class="sr-only">Blockquote</span>
                                                            </button>
                                                            <div id="tooltip-blockquote-exp-admin" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                Blockquote
                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                            </div>
                                                            
                                                            <!-- Separator -->
                                                            <div class="w-px h-6 bg-gray-300 dark:bg-gray-600 mx-1"></div>
                                                            
                                                            <!-- Image Upload Button -->
                                                            <button type="button" data-tooltip-target="tooltip-image-exp-admin" data-wysiwyg-action="image" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                                                                    <path fill-rule="evenodd" d="M13 10a1 1 0 0 1 1-1h.01a1 1 0 1 1 0 2H14a1 1 0 0 1-1-1Z" clip-rule="evenodd"/>
                                                                    <path fill-rule="evenodd" d="M2 6a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v12c0 .556-.227 1.06-.593 1.422A.999.999 0 0 1 20.5 20H4a2.002 2.002 0 0 1-2-2V6Zm6.892 12 3.833-5.356-3.99-4.322a1 1 0 0 0-1.549.097L4 12.879V6h16v9.95l-3.257-3.619a1 1 0 0 0-1.557.088L11.2 18H8.892Z" clip-rule="evenodd"/>
                                                                </svg>
                                                                <span class="sr-only">Upload Image</span>
                                                            </button>
                                                            <div id="tooltip-image-exp-admin" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                Upload Image
                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                            </div>

                                                            <!-- Math Symbols Button -->
                                                            <button type="button" data-tooltip-target="tooltip-math-exp-admin" data-wysiwyg-action="math-symbols" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                                                                    <path d="M9 7H7v2H5V7H3V5h2V3h2v2h2v2Zm2 12h10v-2H11v2Zm0-4h10v-2H11v2Zm0-4h10V9H11v2Z"/>
                                                                </svg>
                                                                <span class="sr-only">Math Symbols</span>
                                                            </button>
                                                            <div id="tooltip-math-exp-admin" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                Insert Math Symbols
                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                            </div>

                                                            <!-- LaTeX Formula Button -->
                                                            <button type="button" data-tooltip-target="tooltip-latex-exp-admin" data-wysiwyg-action="latex" class="p-2 text-gray-500 rounded cursor-pointer hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-600">
                                                                <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                                                                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                                                                </svg>
                                                                <span class="sr-only">LaTeX Formula</span>
                                                            </button>
                                                            <div id="tooltip-latex-exp-admin" role="tooltip" class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
                                                                Insert LaTeX Formula
                                                                <div class="tooltip-arrow" data-popper-arrow></div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="px-4 py-2 bg-white rounded-b-lg dark:bg-gray-800">
                                                    <div id="wysiwyg-explanation-admin" data-wysiwyg="true" contenteditable="true" class="prose dark:prose-invert block w-full px-0 text-sm text-gray-800 bg-white border-0 dark:bg-gray-800 focus:ring-0 dark:text-white dark:placeholder-gray-400 wysiwyg-editor" data-placeholder="Tulis pembahasan (opsional)...">{{ form.explanation.value|default:"" }}</div>
                                                </div>
                                            </div>
                                            
                                            <!-- Hidden textarea for form submission -->
                                            <textarea id="id_explanation" name="explanation" class="hidden">{{ form.explanation.value|default:"" }}</textarea>
                                            
                                            {% if form.explanation.errors %}
                                                {% for error in form.explanation.errors %}
                                                    <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ error }}</p>
                                                {% endfor %}
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <!-- Submit Button -->
                                <div class="flex justify-end space-x-3 pt-6 border-t border-gray-200 dark:border-gray-700">
                                    <a href="{% url 'question_list' %}" class="bg-white dark:bg-gray-800 py-2 px-4 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                                        Cancel
                                    </a>
                                    <button type="submit" class="bg-primary-600 py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors duration-200">
                                        {% if question %}Update Question{% else %}Create Question{% endif %}
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Image Modal -->
<div id="imageModal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
        <!-- Background overlay -->
        <div class="fixed inset-0 bg-black bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closeImageModal()"></div>
        
        <!-- Modal panel -->
        <div class="relative inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full">
            <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <!-- Modal Header -->
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white" id="modal-title">
                        Image Preview
                    </h3>
                    <button type="button" 
                            onclick="closeImageModal()" 
                            class="bg-white dark:bg-gray-800 rounded-md text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                        <span class="sr-only">Close</span>
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                
                <!-- Modal Content -->
                <div class="mt-3 text-center sm:mt-0 sm:text-left">
                    <div class="mt-2 flex justify-center">
                        <img id="modalImage" 
                             src="" 
                             alt="Preview" 
                             class="max-w-full max-h-96 h-auto rounded-lg border border-gray-200 dark:border-gray-600 shadow-lg">
                    </div>
                </div>
            </div>
            
            <!-- Modal Footer -->
            <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" 
                        onclick="closeImageModal()" 
                        class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-primary-600 text-base font-medium text-white hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 sm:ml-3 sm:w-auto sm:text-sm">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Math Symbols Modal -->
<div id="mathSymbolsModal" tabindex="-1" aria-hidden="true" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
  <div class="relative p-4 w-full max-w-4xl max-h-full">
    <!-- Modal content -->
    <div class="relative bg-white rounded-lg shadow dark:bg-gray-700">
      <!-- Modal header -->
      <div class="flex items-center justify-between p-4 md:p-5 border-b rounded-t dark:border-gray-600">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
          Math Symbols
        </h3>
        <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white" onclick="closeMathSymbolsModal()">
          <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
          </svg>
          <span class="sr-only">Close modal</span>
        </button>
      </div>
      <!-- Modal body -->
      <div class="p-4 md:p-5 space-y-4">
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
          
          <!-- Operasi Dasar -->
          <div class="space-y-2">
            <h4 class="font-medium text-gray-900 dark:text-white">Operasi Dasar</h4>
            <div class="grid grid-cols-4 gap-2">
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="+">+</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="âˆ’">âˆ’</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="Ã—">Ã—</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="Ã·">Ã·</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="=">= </button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="â‰ ">â‰ </button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="Â±">Â±</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="âˆ“">âˆ“</button>
            </div>
          </div>

          <!-- Perbandingan -->
          <div class="space-y-2">
            <h4 class="font-medium text-gray-900 dark:text-white">Perbandingan</h4>
            <div class="grid grid-cols-4 gap-2">
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="<"><</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol=">">></button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="â‰¤">â‰¤</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="â‰¥">â‰¥</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="â‰ˆ">â‰ˆ</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="â‰¡">â‰¡</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="âˆ">âˆ</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="âˆž">âˆž</button>
            </div>
          </div>

          <!-- Eksponen & Akar -->
          <div class="space-y-2">
            <h4 class="font-medium text-gray-900 dark:text-white">Eksponen & Akar</h4>
            <div class="grid grid-cols-4 gap-2">
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="Â²">Â²</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="Â³">Â³</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="â¿">â¿</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="âˆš">âˆš</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="âˆ›">âˆ›</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="âˆœ">âˆœ</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="â±">â±</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="áµ">áµ</button>
            </div>
          </div>

          <!-- Pecahan & Desimal -->
          <div class="space-y-2">
            <h4 class="font-medium text-gray-900 dark:text-white">Pecahan</h4>
            <div class="grid grid-cols-4 gap-2">
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="Â½">Â½</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="â…“">â…“</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="â…”">â…”</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="Â¼">Â¼</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="Â¾">Â¾</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="â…•">â…•</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="â…–">â…–</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="â…˜">â…˜</button>
            </div>
          </div>

          <!-- Trigonometri -->
          <div class="space-y-2">
            <h4 class="font-medium text-gray-900 dark:text-white">Trigonometri</h4>
            <div class="grid grid-cols-2 gap-2">
              <button type="button" class="math-symbol-btn p-2 text-sm border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="sin">sin</button>
              <button type="button" class="math-symbol-btn p-2 text-sm border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="cos">cos</button>
              <button type="button" class="math-symbol-btn p-2 text-sm border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="tan">tan</button>
              <button type="button" class="math-symbol-btn p-2 text-sm border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="cot">cot</button>
              <button type="button" class="math-symbol-btn p-2 text-sm border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="sec">sec</button>
              <button type="button" class="math-symbol-btn p-2 text-sm border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="csc">csc</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="Â°">Â°</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="Ï€">Ï€</button>
            </div>
          </div>

          <!-- Logaritma -->
          <div class="space-y-2">
            <h4 class="font-medium text-gray-900 dark:text-white">Logaritma</h4>
            <div class="grid grid-cols-2 gap-2">
              <button type="button" class="math-symbol-btn p-2 text-sm border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="log">log</button>
              <button type="button" class="math-symbol-btn p-2 text-sm border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="ln">ln</button>
              <button type="button" class="math-symbol-btn p-2 text-sm border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="lg">lg</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="e">e</button>
            </div>
          </div>

          <!-- Himpunan -->
          <div class="space-y-2">
            <h4 class="font-medium text-gray-900 dark:text-white">Himpunan</h4>
            <div class="grid grid-cols-4 gap-2">
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="âˆˆ">âˆˆ</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="âˆ‰">âˆ‰</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="âŠ‚">âŠ‚</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="âŠƒ">âŠƒ</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="âˆª">âˆª</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="âˆ©">âˆ©</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="âˆ…">âˆ…</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="â„•">â„•</button>
            </div>
          </div>

          <!-- Lainnya -->
          <div class="space-y-2">
            <h4 class="font-medium text-gray-900 dark:text-white">Lainnya</h4>
            <div class="grid grid-cols-4 gap-2">
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="âˆ‘">âˆ‘</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="âˆ">âˆ</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="âˆ«">âˆ«</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="âˆ‚">âˆ‚</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="âˆ†">âˆ†</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="âˆ‡">âˆ‡</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="Î±">Î±</button>
              <button type="button" class="math-symbol-btn p-2 text-lg border rounded hover:bg-gray-100 dark:hover:bg-gray-600" data-symbol="Î²">Î²</button>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  console.log('ðŸš€ ADMIN WYSIWYG Editor Initialization Started');
  
  // Initialize Flowbite WYSIWYG editors
  const questionEditor = document.querySelector('#wysiwyg-question-text-admin');
  const explanationEditor = document.querySelector('#wysiwyg-explanation-admin');
  const questionTextarea = document.querySelector('#id_question_text');
  const explanationTextarea = document.querySelector('#id_explanation');

  console.log('ðŸ“ ADMIN Editor Elements Found:', {
    questionEditor: !!questionEditor,
    explanationEditor: !!explanationEditor,
    questionTextarea: !!questionTextarea,
    explanationTextarea: !!explanationTextarea
  });

  // Flowbite WYSIWYG Editor initialization
  function initializeWysiwygEditor(editor, textarea) {
    if (!editor || !textarea) return;

    // Set initial content
    if (textarea.value) {
      editor.innerHTML = textarea.value;
    }

    // Handle placeholder display
    function updatePlaceholder() {
      const isEmpty = editor.innerHTML.trim() === '' || editor.innerHTML === '<br>' || editor.innerHTML === '<p><br></p>';
      if (isEmpty) {
        editor.classList.add('is-empty');
      } else {
        editor.classList.remove('is-empty');
      }
    }

    // Sync content to hidden textarea
    function syncContent() {
      textarea.value = editor.innerHTML;
      updatePlaceholder();
    }

    // Event listeners
    editor.addEventListener('input', syncContent);
    editor.addEventListener('paste', function(e) {
      setTimeout(syncContent, 10); // Allow paste to complete
    });
    editor.addEventListener('focus', updatePlaceholder);
    editor.addEventListener('blur', function() {
      updatePlaceholder();
      // Clean up empty paragraphs
      if (editor.innerHTML === '<p><br></p>' || editor.innerHTML === '<br>') {
        editor.innerHTML = '';
      }
      syncContent();
    });

    // Initial placeholder check
    updatePlaceholder();

    return {
      getContent: () => editor.innerHTML,
      setContent: (content) => {
        editor.innerHTML = content;
        syncContent();
      }
    };
  }

  // Initialize both editors
  const questionWysiwyg = initializeWysiwygEditor(questionEditor, questionTextarea);
  const explanationWysiwyg = initializeWysiwygEditor(explanationEditor, explanationTextarea);

  // Flowbite WYSIWYG Toolbar functionality
  function initializeToolbar() {
    console.log('ðŸŽ›ï¸ ADMIN Initializing toolbar functionality...');
    
    const formatButtons = document.querySelectorAll('[data-wysiwyg-toggle-format]');
    console.log('ðŸ”˜ ADMIN Format buttons found:', formatButtons.length);
    
    formatButtons.forEach((button, index) => {
      console.log(`ðŸ”˜ ADMIN Button ${index + 1}:`, button.getAttribute('data-wysiwyg-toggle-format'));
      
      button.addEventListener('click', function(e) {
        console.log('ðŸ–±ï¸ ADMIN Button clicked:', this.getAttribute('data-wysiwyg-toggle-format'));
        
        e.preventDefault();
        const format = this.getAttribute('data-wysiwyg-toggle-format');
        
        // Find the associated editor - look for the parent container with border class
        const toolbar = this.closest('[class*="border"]');
        const editorContainer = toolbar ? toolbar.closest('.bg-white, .dark\\:bg-gray-800') : null;
        const editor = editorContainer ? editorContainer.querySelector('[data-wysiwyg="true"]') : null;
        
        console.log('ðŸ” ADMIN Editor lookup:', {
          toolbar: toolbar ? 'found' : 'not found',
          editorContainer: editorContainer ? 'found' : 'not found',
          editor: editor ? editor.id : 'not found'
        });
        
        if (!editor) {
          console.warn('âŒ ADMIN Editor not found for button:', this);
          return;
        }

        // Focus the editor
        editor.focus();
        
        // Apply formatting based on Flowbite WYSIWYG commands
        let success = false;
        
        try {
          switch(format) {
            case 'bold':
              success = document.execCommand('bold', false, null);
              break;
            case 'italic':
              success = document.execCommand('italic', false, null);
              break;
            case 'underline':
              success = document.execCommand('underline', false, null);
              break;
            case 'unorderedList':
              success = document.execCommand('insertUnorderedList', false, null);
              break;
            case 'orderedList':
              success = document.execCommand('insertOrderedList', false, null);
              break;
            case 'blockquote':
              success = document.execCommand('formatBlock', false, 'blockquote');
              break;
            case 'h1':
              success = document.execCommand('formatBlock', false, 'h1');
              break;
            case 'h2':
              success = document.execCommand('formatBlock', false, 'h2');
              break;
            case 'h3':
              success = document.execCommand('formatBlock', false, 'h3');
              break;
            case 'paragraph':
              success = document.execCommand('formatBlock', false, 'p');
              break;
          }
        } catch (error) {
          console.warn('âŒ ADMIN execCommand failed:', error);
        }
        
        // Update visual state of button with more visible colors for light theme
        if (success) {
          console.log('âœ… ADMIN Format applied successfully:', format);
          
          // Toggle button state based on current format state
          const isCurrentlyActive = this.classList.contains('text-white') && this.classList.contains('bg-blue-600');
          
          if (!isCurrentlyActive) {
            // Remove existing states and add active state
            this.classList.remove('text-blue-700', 'bg-gray-100');
            this.classList.add('text-white', 'bg-blue-600');
            this.style.boxShadow = '0 2px 4px rgba(59, 130, 246, 0.3)';
          } else {
            // Remove active state if already active (toggle behavior)
            this.classList.remove('text-white', 'bg-blue-600');
            this.style.boxShadow = '';
          }
        } else {
          console.log('âŒ ADMIN Format application failed:', format);
        }
        
        // Sync content to textarea
        const textarea = editor.id === 'wysiwyg-question-text-admin' ? questionTextarea : explanationTextarea;
        if (textarea) {
          textarea.value = editor.innerHTML;
        }
        
        // Trigger input event for any additional listeners
        editor.dispatchEvent(new Event('input', { bubbles: true }));
      });
    });

    // Initialize text formatting buttons (for active state)
    document.querySelectorAll('[data-wysiwyg-toggle-format]').forEach(button => {
      const format = button.getAttribute('data-wysiwyg-toggle-format');
      
      // Add Flowbite button styling if not already present
      if (!button.classList.contains('p-2')) {
        button.classList.add('p-2', 'text-gray-500', 'rounded', 'cursor-pointer', 'hover:text-gray-900', 'hover:bg-gray-100', 'dark:text-gray-400', 'dark:hover:text-white', 'dark:hover:bg-gray-600');
      }
    });
  }

  // Initialize toolbar
  initializeToolbar();

  // Additional toolbar functionality for image upload and math
  function initializeSpecialActions() {
    // Handle image upload buttons
    document.querySelectorAll('[data-wysiwyg-action="image"]').forEach(button => {
      button.addEventListener('click', function(e) {
        e.preventDefault();
        
        // Find the associated editor - look for the parent container
        const toolbar = this.closest('[class*="border"]');
        const editorContainer = toolbar ? toolbar.closest('.bg-white, .dark\\:bg-gray-800') : null;
        const editor = editorContainer ? editorContainer.querySelector('[data-wysiwyg="true"]') : null;
        
        if (!editor) {
          console.warn('Editor not found for image button:', this);
          return;
        }
        
        // Create file input
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.style.display = 'none';
        
        input.onchange = function() {
          const file = input.files[0];
          if (!file) return;
          
          // Show loading indicator
          const loadingText = document.createElement('span');
          loadingText.textContent = 'Uploading image...';
          loadingText.style.color = '#6b7280';
          loadingText.style.fontStyle = 'italic';
          
          // Insert loading text at cursor position
          const selection = window.getSelection();
          if (selection.rangeCount > 0) {
            const range = selection.getRangeAt(0);
            range.insertNode(loadingText);
            range.collapse(false);
          }
          
          // Upload file
          const formData = new FormData();
          formData.append('upload', file);
          formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
          
          fetch('/admin/image-upload/', {
            method: 'POST',
            body: formData,
            headers: {
              'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
          })
          .then(response => response.json())
          .then(data => {
            // Remove loading text
            if (loadingText.parentNode) {
              loadingText.parentNode.removeChild(loadingText);
            }
            
            if (data.url) {
              // Create image element
              const img = document.createElement('img');
              img.src = data.url;
              img.style.maxWidth = '100%';
              img.style.height = 'auto';
              img.style.display = 'block';
              img.style.margin = '10px 0';
              img.style.borderRadius = '8px';
              img.style.cursor = 'pointer';
              img.onclick = function() {
                window.openImageModal(data.url, 'Uploaded Image');
              };
              
              // Insert image at cursor position
              const selection = window.getSelection();
              if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                range.insertNode(img);
                range.collapse(false);
              } else {
                editor.appendChild(img);
              }
              
              // Update textarea
              const textarea = editor.id === 'wysiwyg-question-text-admin' ? questionTextarea : explanationTextarea;
              if (textarea) {
                textarea.value = editor.innerHTML;
              }
              
              // Trigger input event
              editor.dispatchEvent(new Event('input', { bubbles: true }));
              
              // Show success message
              showNotification('Image uploaded successfully!', 'success');
            } else {
              showNotification('Failed to upload image: ' + (data.error || 'Unknown error'), 'error');
            }
          })
          .catch(error => {
            // Remove loading text
            if (loadingText.parentNode) {
              loadingText.parentNode.removeChild(loadingText);
            }
            console.error('Upload failed:', error);
            showNotification('Image upload failed. Please try again.', 'error');
          });
        };
        
        // Trigger file selection
        document.body.appendChild(input);
        input.click();
        document.body.removeChild(input);
      });
    });

    // Handle math symbols buttons
    document.querySelectorAll('[data-wysiwyg-action="math-symbols"]').forEach(button => {
      button.addEventListener('click', function(e) {
        e.preventDefault();
        
        // Find the associated editor
        const toolbar = this.closest('[class*="border"]');
        const editorContainer = toolbar ? toolbar.closest('.bg-white, .dark\\:bg-gray-800') : null;
        const editor = editorContainer ? editorContainer.querySelector('[data-wysiwyg="true"]') : null;
        
        if (!editor) {
          console.warn('Editor not found for math symbols button:', this);
          return;
        }
        
        // Store the current editor for symbol insertion
        window.currentMathEditor = editor;
        
        // Show math symbols modal
        showMathSymbolsModal();
      });
    });
    
    // Math symbols modal functions
    window.showMathSymbolsModal = function() {
      const modal = document.getElementById('mathSymbolsModal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    };
    
    window.closeMathSymbolsModal = function() {
      const modal = document.getElementById('mathSymbolsModal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    };
    
    // Handle math symbol selection
    document.querySelectorAll('.math-symbol-btn').forEach(button => {
      button.addEventListener('click', function() {
        const symbol = this.getAttribute('data-symbol');
        
        if (window.currentMathEditor && symbol) {
          // Focus the editor
          window.currentMathEditor.focus();
          
          // Insert symbol at cursor position
          document.execCommand('insertText', false, symbol);
          
          // Sync content to textarea
          const questionTextarea = document.getElementById('id_question_text');
          const explanationTextarea = document.getElementById('id_explanation');
          
          if (window.currentMathEditor.id === 'wysiwyg-question-text-admin') {
            questionTextarea.value = window.currentMathEditor.innerHTML;
          } else if (window.currentMathEditor.id === 'wysiwyg-explanation-text-admin') {
            explanationTextarea.value = window.currentMathEditor.innerHTML;
          }
          
          // Close modal
          closeMathSymbolsModal();
          
          // Show notification
          showNotification('Math symbol inserted!', 'success');
        }
      });
    });
    
    // Close modal when clicking outside
    document.getElementById('mathSymbolsModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeMathSymbolsModal();
      }
    });

    // Handle LaTeX formula buttons
    document.querySelectorAll('[data-wysiwyg-action="latex"]').forEach(button => {
      button.addEventListener('click', function(e) {
        e.preventDefault();
        
        // Find the associated editor
        const toolbar = this.closest('[class*="border"]');
        const editorContainer = toolbar ? toolbar.closest('.bg-white, .dark\\:bg-gray-800') : null;
        const editor = editorContainer ? editorContainer.querySelector('[data-wysiwyg="true"]') : null;
        
        if (!editor) {
          console.warn('Editor not found for LaTeX button:', this);
          return;
        }

        // Prompt for LaTeX formula
        const latex = prompt('Enter LaTeX formula (e.g., x^2 + y^2 = z^2, \\frac{a}{b}, \\sqrt{x}):');
        if (!latex) return;
        
        // Create math container with LaTeX
        const mathContainer = document.createElement('span');
        mathContainer.className = 'latex-formula';
        mathContainer.style.display = 'inline-block';
        mathContainer.style.margin = '2px 5px';
        mathContainer.style.padding = '3px 8px';
        mathContainer.style.backgroundColor = '#f0f9ff';
        mathContainer.style.border = '1px solid #0ea5e9';
        mathContainer.style.borderRadius = '4px';
        mathContainer.style.fontFamily = 'monospace';
        mathContainer.style.fontSize = '14px';
        mathContainer.style.color = '#0369a1';
        
        // Add LaTeX notation with proper delimiters
        mathContainer.textContent = `$${latex}$`;
        
        // Focus the editor and insert at cursor position
        editor.focus();
        
        const selection = window.getSelection();
        if (selection.rangeCount > 0) {
          const range = selection.getRangeAt(0);
          range.insertNode(mathContainer);
          range.collapse(false);
        } else {
          editor.appendChild(mathContainer);
        }
        
        // Update textarea
        const questionTextarea = document.getElementById('id_question_text');
        const explanationTextarea = document.getElementById('id_explanation');
        
        if (editor.id === 'wysiwyg-question-text-admin') {
          questionTextarea.value = editor.innerHTML;
        } else if (editor.id === 'wysiwyg-explanation-text-admin') {
          explanationTextarea.value = editor.innerHTML;
        }
        
        // Trigger input event
        editor.dispatchEvent(new Event('input', { bubbles: true }));
        
        // Re-render MathJax for the new LaTeX
        if (window.MathJax && window.MathJax.typesetPromise) {
          window.MathJax.typesetPromise([mathContainer]).catch((err) => console.log(err.message));
        }
        
        showNotification('LaTeX formula inserted!', 'success');
      });
    });
  }

  // Initialize special actions
  initializeSpecialActions();
  
  // Log initialization status
  console.log('ðŸ”§ ADMIN Toolbar initialized');
  console.log('âœ¨ ADMIN Special actions initialized');

  // Log toolbar buttons found
  const formatButtons = document.querySelectorAll('[data-wysiwyg-toggle-format]');
  const imageButtons = document.querySelectorAll('[data-wysiwyg-action="image"]');
  const mathButtons = document.querySelectorAll('[data-wysiwyg-action="math-symbols"]');
  const latexButtons = document.querySelectorAll('[data-wysiwyg-action="latex"]');
  
  console.log('ðŸŽ›ï¸ ADMIN Toolbar buttons found:', {
    formatButtons: formatButtons.length,
    imageButtons: imageButtons.length,
    mathButtons: mathButtons.length,
    latexButtons: latexButtons.length
  });
  
  // Initialize Python environment info display (legacy code removed)
  // Quill.js code has been replaced with Flowbite WYSIWYG
            
  // Question type functionality
            const questionTypeRadios = document.querySelectorAll('input[name="question_type"]');
            const choicesSection = document.getElementById('choicesSection');
            const essayAnswerSection = document.getElementById('essayAnswerSection');
            
            function toggleSections() {
                const selectedType = document.querySelector('input[name="question_type"]:checked');
                if (selectedType) {
                    document.body.style.cursor = 'wait';
                    
                    setTimeout(() => {
                        if (selectedType.value === 'multiple_choice') {
                            choicesSection.style.display = 'block';
                            essayAnswerSection.style.display = 'none';
                            choicesSection.classList.add('section-fade-in');
                            
                            // Initialize choice checkboxes after section becomes visible
                            setTimeout(() => {
                                initializeChoiceCheckboxes();
                            }, 100);
                        } else if (selectedType.value === 'essay') {
                            choicesSection.style.display = 'none';
                            essayAnswerSection.style.display = 'block';
                            essayAnswerSection.classList.add('section-fade-in');
                        }
                        
                        document.body.style.cursor = '';
                        console.log('Question type changed to:', selectedType.value);
                    }, 100);
                }
            }
            
            // Initial toggle based on selected value
            toggleSections();
            
            // Add event listeners to radio buttons
            questionTypeRadios.forEach(function(radio) {
                radio.addEventListener('change', toggleSections);
            });
            
            // Form validation with enhanced UX
            const form = document.querySelector('form');
            if (form) {
                form.addEventListener('submit', function(e) {
                    const category = document.querySelector('#id_category');
                    
                    // Get content from Flowbite WYSIWYG editors
                    let questionContent = '';
                    const questionEditor = document.querySelector('#wysiwyg-question-text-admin');
                    if (questionEditor) {
                        questionContent = questionEditor.innerHTML.trim();
                        // Check for empty content (just HTML tags with no text)
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = questionContent;
                        const textContent = tempDiv.textContent || tempDiv.innerText || '';
                        if (!textContent.trim()) questionContent = '';
                    } else if (questionTextarea) {
                        questionContent = questionTextarea.value.trim();
                    }

                    // Sync explanation content from Flowbite WYSIWYG to textarea
                    const explanationEditor = document.querySelector('#wysiwyg-explanation-text-admin');
                    if (explanationEditor && explanationTextarea) {
                        explanationTextarea.value = explanationEditor.innerHTML;
                    }
                    
                    if (!questionContent || (category && !category.value)) {
                        e.preventDefault();
                        showNotification('Please fill in all required fields', 'error');
                        
                        const firstError = document.querySelector('.text-red-500');
                        if (firstError) {
                            firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                        return;
                    }
                    
                    // Check if essay type and answer is provided
                    const essayRadio = document.querySelector('input[value="essay"]:checked');
                    if (essayRadio) {
                        const essayAnswer = document.getElementById('id_correct_answer_text');
                        if (essayAnswer && !essayAnswer.value.trim()) {
                            e.preventDefault();
                            showNotification('Please provide an expected answer for the essay question', 'error');
                            essayAnswer.focus();
                            return;
                        }
                    }
                    
                    // Show loading state
                    const submitBtn = form.querySelector('button[type="submit"]');
                    if (submitBtn) {
                        submitBtn.disabled = true;
                        const isUpdate = submitBtn.textContent.includes('Update');
                        submitBtn.innerHTML = `
                            <svg class="animate-spin -ml-1 mr-3 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            ${isUpdate ? 'Updating' : 'Creating'} Question...
                        `;
                    }
                });
            }
            
            // Choice Image Upload Function
            window.uploadChoiceImage = function(input, choiceNumber) {
                const file = input.files[0];
                if (!file) return;
                
                const formData = new FormData();
                formData.append('upload', file);
                formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
                
                const statusElement = document.getElementById(`choice-image-status-${choiceNumber}`);
                statusElement.textContent = 'Uploading...';
                statusElement.className = 'text-sm text-blue-600 dark:text-blue-400';
                
                fetch('/admin/image-upload/', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.url) {
                        // Update hidden input with image URL
                        document.getElementById(`choice-image-url-${choiceNumber}`).value = data.url;
                        
                        // Show preview
                        const previewContainer = document.getElementById(`choice-image-preview-${choiceNumber}`);
                        const previewImage = previewContainer.querySelector('img');
                        previewImage.src = data.url;
                        // responsive and interactive preview styles
                        previewImage.classList.add('max-w-full','h-auto','rounded-lg','cursor-zoom-in');
                        previewImage.onclick = function() {
                            const choiceLabel = String.fromCharCode(64 + choiceNumber); // Convert 1->A, 2->B, etc.
                            openImageModal(data.url, `Choice ${choiceLabel} Image`);
                        };
                        previewContainer.classList.remove('hidden');
                        
                        // Update status
                        statusElement.textContent = 'Image uploaded successfully';
                        statusElement.className = 'text-sm text-green-600 dark:text-green-400';
                        
                        // Update requirement state: if image exists, choice text is not required
                        if (typeof updateChoiceRequirements === 'function') updateChoiceRequirements();

                        showNotification('Choice image uploaded successfully!', 'success');
                    } else {
                        statusElement.textContent = 'Failed to upload image';
                        statusElement.className = 'text-sm text-red-600 dark:text-red-400';
                        showNotification('Failed to upload choice image', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    statusElement.textContent = 'Failed to upload image';
                    statusElement.className = 'text-sm text-red-600 dark:text-red-400';
                    showNotification('Failed to upload choice image', 'error');
                });
                
                // Clear the file input
                input.value = '';
            };

            // Remove Choice Image Function
            window.removeChoiceImage = function(choiceNumber) {
                try {
                    // Clear hidden input
                    const hiddenInput = document.getElementById(`choice-image-url-${choiceNumber}`);
                    if (hiddenInput) {
                        hiddenInput.value = '';
                    }
                    
                    // Clear file input
                    const fileInput = document.getElementById(`choice-image-${choiceNumber}`);
                    if (fileInput) {
                        fileInput.value = '';
                    }
                    
                    // Hide preview
                    const previewContainer = document.getElementById(`choice-image-preview-${choiceNumber}`);
                    if (previewContainer) {
                        previewContainer.classList.add('hidden');
                    }
                    
                    // Show upload area
                    const uploadArea = document.getElementById(`choice-upload-area-${choiceNumber}`);
                    if (uploadArea) {
                        uploadArea.classList.remove('hidden');
                    }
                    
                    // Clear status
                    const statusElement = document.getElementById(`choice-image-status-${choiceNumber}`);
                    if (statusElement) {
                        statusElement.textContent = '';
                        statusElement.className = 'mt-1 text-xs';
                    }
                    
                    console.log(`Image removed for choice ${choiceNumber}`);
                    showNotification('Choice image removed', 'success');
                    // Update requirement state after removing image
                    if (typeof updateChoiceRequirements === 'function') updateChoiceRequirements();
                } catch (error) {
                    console.error('Error removing choice image:', error);
                    showNotification('Error removing image', 'error');
                }
            };

            // Handle correct answer checkbox changes for visual feedback
            function handleCorrectAnswerChange(checkbox, choiceNumber) {
                const choiceItem = checkbox.closest('.choice-item');
                
                if (checkbox.checked) {
                    // Add comprehensive green styling for correct answer
                    choiceItem.classList.add('correct-answer');
                    
                    // Force remove default classes that might conflict
                    choiceItem.classList.remove('border-gray-200', 'dark:border-gray-600', 'bg-white', 'dark:bg-gray-800');
                    
                    // Add styling
                    choiceItem.style.border = '3px solid #10b981';
                    choiceItem.style.background = 'linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%)';
                    choiceItem.style.boxShadow = '0 8px 25px rgba(16, 185, 129, 0.3)';
                    choiceItem.style.transform = 'scale(1.02)';
                    
                    // Update header background
                    const choiceHeader = choiceItem.querySelector('.choice-header');
                    if (choiceHeader) {
                        choiceHeader.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                        choiceHeader.style.color = 'white';
                    }
                    
                    // Update badge
                    const badge = choiceItem.querySelector('.choice-badge');
                    if (badge) {
                        badge.style.background = 'rgba(255, 255, 255, 0.95)';
                        badge.style.color = '#059669';
                        badge.style.border = '2px solid white';
                        badge.style.fontWeight = 'bold';
                    }
                    
                    // Update status text
                    const statusText = choiceItem.querySelector('.choice-status');
                    if (statusText) {
                        statusText.textContent = 'âœ“ Correct Answer';
                        statusText.style.color = 'white';
                        statusText.style.fontWeight = '600';
                    }
                    
                    // Update header title color
                    const choiceTitle = choiceItem.querySelector('h4');
                    if (choiceTitle) {
                        choiceTitle.style.color = 'white';
                        choiceTitle.style.fontWeight = '700';
                    }
                    
                    // Update checkbox label color
                    const checkboxLabel = choiceItem.querySelector('label span');
                    if (checkboxLabel) {
                        checkboxLabel.style.color = 'white';
                        checkboxLabel.style.fontWeight = '500';
                    }
                    
                    // Update textarea
                    const textarea = choiceItem.querySelector('textarea');
                    if (textarea) {
                        textarea.style.border = '2px solid #10b981';
                        textarea.style.boxShadow = '0 0 0 3px rgba(16, 185, 129, 0.15)';
                    }
                } else {
                    // Remove correct answer styling
                    choiceItem.classList.remove('correct-answer');
                    
                    // Reset inline styles
                    choiceItem.style.border = '';
                    choiceItem.style.background = '';
                    choiceItem.style.boxShadow = '';
                    choiceItem.style.transform = '';
                    
                    // Reset header
                    const choiceHeader = choiceItem.querySelector('.choice-header');
                    if (choiceHeader) {
                        choiceHeader.style.background = '';
                        choiceHeader.style.color = '';
                    }
                    
                    // Reset badge
                    const badge = choiceItem.querySelector('.choice-badge');
                    if (badge) {
                        badge.style.background = '';
                        badge.style.color = '';
                        badge.style.border = '';
                        badge.style.fontWeight = '';
                    }
                    
                    // Reset status text
                    const statusText = choiceItem.querySelector('.choice-status');
                    if (statusText) {
                        statusText.textContent = 'Option';
                        statusText.style.color = '';
                        statusText.style.fontWeight = '';
                    }
                    
                    // Reset header title
                    const choiceTitle = choiceItem.querySelector('h4');
                    if (choiceTitle) {
                        choiceTitle.style.color = '';
                        choiceTitle.style.fontWeight = '';
                    }
                    
                    // Reset checkbox label
                    const checkboxLabel = choiceItem.querySelector('label span');
                    if (checkboxLabel) {
                        checkboxLabel.style.color = '';
                        checkboxLabel.style.fontWeight = '';
                    }
                    
                    // Reset textarea
                    const textarea = choiceItem.querySelector('textarea');
                    if (textarea) {
                        textarea.style.border = '';
                        textarea.style.boxShadow = '';
                    }
                }
            }

            // Initialize choice checkboxes function
            function initializeChoiceCheckboxes() {
                // Add event listeners to all correct answer checkboxes - try multiple selectors
                let checkboxes = document.querySelectorAll('input[name$="-is_correct"]'); // Formset pattern
                if (checkboxes.length === 0) {
                    checkboxes = document.querySelectorAll('input[name$="_is_correct"]'); // Alternative pattern
                }
                if (checkboxes.length === 0) {
                    checkboxes = document.querySelectorAll('.choice-checkbox'); // Class-based selector
                }
                if (checkboxes.length === 0) {
                    checkboxes = document.querySelectorAll('input[type="checkbox"]'); // All checkboxes
                }
                
                checkboxes.forEach((checkbox, index) => {
                    // Remove existing listeners to avoid duplicates
                    if (checkbox._choiceHandler) {
                        checkbox.removeEventListener('change', checkbox._choiceHandler);
                    }
                    
                    // Create new handler
                    checkbox._choiceHandler = function() {
                        handleCorrectAnswerChange(this, index + 1);
                    };
                    
                    checkbox.addEventListener('change', checkbox._choiceHandler);
                    
                    // Initialize state on page load
                    if (checkbox.checked) {
                        handleCorrectAnswerChange(checkbox, index + 1);
                    }
                });
            }

            // Initialize correct answer checkboxes on DOM ready
            document.addEventListener('DOMContentLoaded', function() {
                initializeChoiceCheckboxes();
                if (typeof updateChoiceRequirements === 'function') updateChoiceRequirements();
            });
            
            // Image Modal Functions
            window.openImageModal = function(imageSrc, imageTitle = 'Image Preview') {
                const modal = document.getElementById('imageModal');
                const modalImage = document.getElementById('modalImage');
                const modalTitle = document.getElementById('modal-title');
                
                if (imageSrc && imageSrc !== '') {
                    modalImage.src = imageSrc;
                    modalTitle.textContent = imageTitle;
                    modal.classList.remove('hidden');
                    document.body.style.overflow = 'hidden'; // Prevent background scrolling
                } else {
                    showNotification('No image to display', 'warning');
                }
            };
            
            window.closeImageModal = function() {
                const modal = document.getElementById('imageModal');
                modal.classList.add('hidden');
                document.body.style.overflow = ''; // Restore scrolling
            };
            
            // Close modal when clicking outside or pressing Escape
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    closeImageModal();
                }
            });
            
            // Prevent modal from closing when clicking on the image
            document.getElementById('modalImage').addEventListener('click', function(event) {
                event.stopPropagation();
            });
            
            // Notification system
            function showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `fixed top-4 right-4 z-50 px-4 py-3 rounded-lg shadow-lg max-w-sm ${getNotificationClasses(type)}`;
                notification.innerHTML = `
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            ${getNotificationIcon(type)}
                        </div>
                        <div class="ml-3">
                            <p class="text-sm font-medium">${message}</p>
                        </div>
                        <div class="ml-auto pl-3">
                            <button onclick="this.parentElement.parentElement.parentElement.remove()" class="inline-flex text-gray-400 hover:text-gray-600">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 5000);
            }
            
            function getNotificationClasses(type) {
                switch (type) {
                    case 'success':
                        return 'bg-green-50 border border-green-200 text-green-800 dark:bg-green-900/20 dark:border-green-800 dark:text-green-400';
                    case 'error':
                        return 'bg-red-50 border border-red-200 text-red-800 dark:bg-red-900/20 dark:border-red-800 dark:text-red-400';
                    case 'warning':
                        return 'bg-yellow-50 border border-yellow-200 text-yellow-800 dark:bg-yellow-900/20 dark:border-yellow-800 dark:text-yellow-400';
                    default:
                        return 'bg-blue-50 border border-blue-200 text-blue-800 dark:bg-blue-900/20 dark:border-blue-800 dark:text-blue-400';
                }
            }
            
            function getNotificationIcon(type) {
                switch (type) {
                    case 'success':
                        return '<svg class="w-5 h-5 text-green-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>';
                    case 'error':
                        return '<svg class="w-5 h-5 text-red-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>';
                    case 'warning':
                        return '<svg class="w-5 h-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>';
                    default:
                        return '<svg class="w-5 h-5 text-blue-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>';
                }
            }
            
            // Mobile-friendly enhancements
            if (window.innerWidth <= 768) {
                document.querySelectorAll('input, textarea, select').forEach(input => {
                    input.addEventListener('focus', function() {
                        setTimeout(() => {
                            this.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }, 300);
                    });
                });
            }
        });
    </script>
{% endblock %}
