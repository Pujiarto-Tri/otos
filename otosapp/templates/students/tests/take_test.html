{% extends 'base.html' %}

{% block title %}Take Test - {{ category.category_name }}{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto p-6 space-y-6">
    <!-- Header Section -->
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 border border-gray-200 dark:border-gray-700">
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-4">
                <div class="flex items-center justify-center w-14 h-14 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-gray-800 dark:text-white">{{ category.category_name }}</h1>
                    <p class="text-lg text-gray-600 dark:text-gray-300">Soal {{ current_question_index|add:1 }} dari {{ questions|length }}</p>
                </div>
            </div>
            
            <!-- Progress Bar & Timer -->
            <div class="flex items-center gap-6">
                <!-- Timer Display -->
                <div class="flex items-center gap-3 px-4 py-2 bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-700 rounded-lg">
                    <svg class="w-5 h-5 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <div class="text-sm">
                        <div class="font-semibold text-red-600 dark:text-red-400">Sisa Waktu</div>
                        <div id="timer-display" class="font-mono text-lg font-bold text-red-700 dark:text-red-300">00:00:00</div>
                    </div>
                </div>
                
                <!-- Progress Bar -->
                <div class="flex items-center gap-3">
                    <div class="w-32 bg-gray-200 rounded-full h-3 dark:bg-gray-700">
                        <div id="progress-bar" class="bg-gradient-to-r from-indigo-500 to-purple-600 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <span id="progress-percentage" class="text-sm font-medium text-gray-600 dark:text-gray-300">0%</span>
                </div>
            </div>
        </div>
    </div>
    <!-- Question Section -->
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700">
        <form method="post" class="p-8">
            {% csrf_token %}
            
            <!-- Question Content -->
            <div class="mb-8">
                <div class="flex items-start gap-4 mb-6">
                    <div class="flex items-center justify-center w-8 h-8 bg-indigo-100 dark:bg-indigo-900 rounded-full flex-shrink-0 mt-1">
                        <span class="text-indigo-600 dark:text-indigo-400 font-bold text-sm">{{ current_question_index|add:1 }}</span>
                    </div>
                    <div class="flex-1">
                        <div class="text-xl font-semibold text-gray-800 dark:text-white leading-relaxed ckeditor-content">{{ question.question_text|safe }}</div>
                    </div>
                </div>
            </div>

            <!-- Answer Choices -->
            <div class="space-y-4 mb-8">
                {% for choice in question.choices.all %}
                <label for="choice_{{ choice.id }}" class="group flex items-start cursor-pointer p-5 rounded-xl border-2 border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900 hover:bg-indigo-50 dark:hover:bg-indigo-900 hover:border-indigo-300 dark:hover:border-indigo-600 transition-all duration-200">
                    <input type="radio" id="choice_{{ choice.id }}" name="answer" value="{{ choice.id }}" 
                           {% if selected_choice_id == choice.id %}checked{% endif %}
                           class="w-5 h-5 text-indigo-600 border-gray-300 focus:ring-indigo-500 dark:focus:ring-indigo-400 dark:ring-offset-gray-800 dark:bg-gray-700 dark:border-gray-600 mt-1 flex-shrink-0">
                    <div class="ml-4 text-lg font-medium text-gray-700 dark:text-gray-300 group-hover:text-indigo-700 dark:group-hover:text-indigo-300 leading-relaxed ckeditor-content">{{ choice.choice_text|safe }}</div>
                </label>
                {% endfor %}
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-col lg:flex-row justify-between items-center gap-4 pt-6 border-t border-gray-200 dark:border-gray-700">
                <!-- Left: Previous Button -->
                <div class="w-full lg:w-auto">
                    {% if current_question_index > 0 %}
                    <a href="{% url 'take_test' category.id current_question_index|add:'-1' %}" class="w-full lg:w-auto inline-flex items-center justify-center gap-2 px-6 py-3 text-indigo-600 bg-white border-2 border-indigo-200 rounded-xl hover:bg-indigo-50 hover:border-indigo-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-all font-semibold">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M11 17l-5-5m0 0l5-5m-5 5h12"></path></svg>
                        Soal Sebelumnya
                    </a>
                    {% endif %}
                </div>

                <!-- Right: Action Buttons -->
                <div class="flex flex-col sm:flex-row gap-3 w-full lg:w-auto">
                    <!-- Submit Test Button -->
                    <button type="button" onclick="showSubmitConfirmation()" class="w-full sm:w-auto inline-flex items-center justify-center gap-2 px-6 py-3 text-white bg-gradient-to-r from-red-600 to-red-700 rounded-xl hover:from-red-700 hover:to-red-800 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition-all font-semibold shadow-lg">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span>Selesai Ujian</span>
                    </button>
                    
                    <!-- Mark Question Button -->
                    <button type="button" onclick="markAsDoubtful()" id="mark-button" class="w-full sm:w-auto inline-flex items-center justify-center gap-2 px-6 py-3 text-yellow-600 bg-white border-2 border-yellow-200 rounded-xl hover:bg-yellow-50 hover:border-yellow-300 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-offset-2 transition-all font-semibold">
                        <svg id="mark-icon" class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path id="bookmark-icon" stroke-linecap="round" stroke-linejoin="round" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>
                            <path id="check-icon" stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" style="display: none;"></path>
                        </svg>
                        <span id="mark-text">Tandai Soal</span>
                    </button>

                    <!-- Next Button -->
                    <button type="submit" class="w-full sm:w-auto inline-flex items-center justify-center gap-2 px-6 py-3 text-white bg-gradient-to-r from-indigo-600 to-purple-600 rounded-xl hover:from-indigo-700 hover:to-purple-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-all font-semibold shadow-lg">
                        <span>Soal Selanjutnya</span>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M13 17h8m0 0V9a2 2 0 00-2-2h-6a2 2 0 00-2 2v8m0 0H5a2 2 0 01-2-2V9a2 2 0 012-2h6a2 2 0 012 2v8z"></path></svg>
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Navigation Section -->
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700">
        <!-- Navigation Header -->
        <div class="flex justify-between items-center p-6 border-b border-gray-200 dark:border-gray-700">
            <h3 class="text-xl font-bold text-gray-800 dark:text-white flex items-center gap-3">
                <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path></svg>
                </div>
                Navigasi Soal
            </h3>
            <button onclick="toggleNavigation()" class="flex items-center gap-2 px-4 py-2 text-indigo-600 bg-indigo-50 dark:bg-indigo-900 border border-indigo-200 dark:border-indigo-700 rounded-lg hover:bg-indigo-100 dark:hover:bg-indigo-800 transition-all font-medium">
                <svg id="nav-toggle-icon" class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"></path></svg>
                <span id="nav-toggle-text">Sembunyikan</span>
            </button>
        </div>

        <!-- Navigation Panel -->
        <div id="navigation-panel" class="p-6 transition-all duration-300">
            <!-- Status Legend -->
            <div class="mb-6 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600">
                <h4 class="text-sm font-semibold text-gray-800 dark:text-white mb-4 flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Keterangan Status Soal
                </h4>
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <div class="flex items-center gap-2 p-2 bg-white dark:bg-gray-800 rounded border">
                        <div class="w-4 h-4 bg-gray-300 border border-gray-400 rounded"></div>
                        <div>
                            <div class="text-xs font-medium text-gray-700 dark:text-gray-300">Belum dikerjakan</div>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-2 p-2 bg-white dark:bg-gray-800 rounded border">
                        <div class="w-4 h-4 bg-green-500 border border-green-600 rounded"></div>
                        <div>
                            <div class="text-xs font-medium text-gray-700 dark:text-gray-300">Sudah dijawab</div>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-2 p-2 bg-white dark:bg-gray-800 rounded border">
                        <div class="w-4 h-4 bg-yellow-500 border border-yellow-600 rounded"></div>
                        <div>
                            <div class="text-xs font-medium text-gray-700 dark:text-gray-300">Ditandai</div>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-2 p-2 bg-white dark:bg-gray-800 rounded border">
                        <div class="w-4 h-4 bg-blue-500 border border-blue-600 rounded"></div>
                        <div>
                            <div class="text-xs font-medium text-gray-700 dark:text-gray-300">Sedang dikerjakan</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Question Grid -->
            <div class="navigation-grid mb-6">
                {% for q in questions %}
                <a href="{% url 'take_test' category.id forloop.counter0 %}"
                   class="nav-button"
                   data-question-id="{{ q.id }}"
                   data-question-index="{{ forloop.counter0 }}"
                   title="Soal {{ forloop.counter }}">
                    {{ forloop.counter }}
                </a>
                {% endfor %}
            </div>

            <!-- Quick Stats -->
            <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600">
                <h4 class="text-sm font-semibold text-gray-800 dark:text-white mb-4 flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                    Statistik Pengerjaan
                </h4>
                
                <div class="grid grid-cols-3 gap-4">
                    <!-- Soal Dijawab -->
                    <div class="text-center p-3 bg-green-100 dark:bg-green-900/30 rounded-lg border border-green-200 dark:border-green-700">
                        <div class="text-2xl font-bold text-green-600 dark:text-green-400 mb-1" id="answered-count">0</div>
                        <div class="text-xs text-gray-600 dark:text-gray-400">Dijawab</div>
                    </div>
                    
                    <!-- Soal Ditandai -->
                    <div class="text-center p-3 bg-yellow-100 dark:bg-yellow-900/30 rounded-lg border border-yellow-200 dark:border-yellow-700">
                        <div class="text-2xl font-bold text-yellow-600 dark:text-yellow-400 mb-1" id="doubtful-count">0</div>
                        <div class="text-xs text-gray-600 dark:text-gray-400">Ditandai</div>
                    </div>
                    
                    <!-- Soal Tersisa -->
                    <div class="text-center p-3 bg-gray-100 dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-600">
                        <div class="text-2xl font-bold text-gray-600 dark:text-gray-400 mb-1" id="remaining-count">{{ questions|length }}</div>
                        <div class="text-xs text-gray-600 dark:text-gray-400">Tersisa</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Submit Confirmation Modal -->
<div id="submit-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" style="display: none;">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/3 shadow-lg rounded-md bg-white dark:bg-gray-800">
        <div class="mt-3 text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 dark:bg-red-900">
                <svg class="h-6 w-6 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                </svg>
            </div>
            <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white">Selesai Ujian</h3>
            <div class="mt-2 px-7 py-3">
                <p class="text-sm text-gray-500 dark:text-gray-300">
                    Apakah Anda yakin ingin menyelesaikan ujian? Setelah ujian diselesaikan, Anda tidak dapat mengubah jawaban lagi.
                </p>
                <div class="mt-4">
                    <div class="text-sm font-medium text-gray-700 dark:text-gray-300">
                        <span id="answered-summary">0</span> soal telah dijawab dari <span>{{ questions|length }}</span> soal
                    </div>
                </div>
            </div>
            <div class="items-center px-4 py-3">
                <div class="flex justify-center gap-4">
                    <button id="cancel-submit" class="px-4 py-2 bg-gray-300 text-gray-800 text-base font-medium rounded-md w-24 hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-300">
                        Batal
                    </button>
                    <form method="post" action="{% url 'submit_test' test_id %}" class="inline">
                        {% csrf_token %}
                        <button type="submit" class="px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md w-32 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-300">
                            Ya, Selesai
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
@keyframes fade-in {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.animate-fade-in {
  animation: fade-in 0.5s ease;
}

/* Styling untuk konten CKEditor */
.ckeditor-content {
  line-height: 1.6;
}

.ckeditor-content p {
  margin-bottom: 1rem;
}

.ckeditor-content img {
  max-width: 100% !important;
  height: auto !important;
  display: block;
  margin: 1rem auto;
  border-radius: 8px;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  transition: opacity 0.3s ease;
}

.ckeditor-content img[src=""], .ckeditor-content img:not([src]) {
  display: none;
}

.ckeditor-content img.loading {
  opacity: 0.5;
}

.ckeditor-content img.error {
  display: block;
  width: 100%;
  height: 200px;
  background-color: #f3f4f6;
  border: 2px dashed #d1d5db;
  position: relative;
}

.ckeditor-content img.error:after {
  content: "Gambar tidak dapat dimuat";
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: #6b7280;
  font-size: 14px;
}

.ckeditor-content figure {
  margin: 1rem 0;
  text-align: center;
}

.ckeditor-content figure img {
  margin: 0 auto;
}

.ckeditor-content ul, .ckeditor-content ol {
  margin: 1rem 0;
  padding-left: 2rem;
}

.ckeditor-content li {
  margin-bottom: 0.5rem;
}

.ckeditor-content h1, .ckeditor-content h2, .ckeditor-content h3 {
  font-weight: bold;
  margin: 1.5rem 0 1rem 0;
}

.ckeditor-content h1 { font-size: 1.5rem; }
.ckeditor-content h2 { font-size: 1.3rem; }
.ckeditor-content h3 { font-size: 1.1rem; }

.ckeditor-content strong {
  font-weight: bold;
}

.ckeditor-content em {
  font-style: italic;
}

/* Dark mode adjustments untuk konten CKEditor */
.dark .ckeditor-content img {
  box-shadow: 0 4px 6px -1px rgba(255, 255, 255, 0.1), 0 2px 4px -1px rgba(255, 255, 255, 0.06);
}

/* CSS khusus untuk grid navigasi */
.navigation-grid {
  display: grid !important;
  grid-template-columns: repeat(5, 1fr) !important;
  gap: 0.75rem !important;
}

@media (min-width: 640px) {
  .navigation-grid {
    grid-template-columns: repeat(8, 1fr) !important;
  }
}

@media (min-width: 768px) {
  .navigation-grid {
    grid-template-columns: repeat(10, 1fr) !important;
  }
}

@media (min-width: 1024px) {
  .navigation-grid {
    grid-template-columns: repeat(12, 1fr) !important;
  }
}

@media (min-width: 1280px) {
  .navigation-grid {
    grid-template-columns: repeat(15, 1fr) !important;
  }
}

/* Override untuk memastikan warna navigasi konsisten */
.nav-button {
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  min-width: 3rem !important; /* 48px */
  width: 3rem !important; /* 48px */
  height: 3rem !important; /* 48px */
  font-size: 0.875rem !important; /* 14px */
  font-weight: 700 !important;
  border-radius: 0.5rem !important; /* 8px */
  border-width: 2px !important;
  transition: all 0.2s ease !important;
  text-decoration: none !important;
  flex-shrink: 0 !important;
}

.nav-button:hover {
  transform: scale(1.05) !important;
}

/* Status warna untuk navigasi */
.nav-button.current {
  background-color: #3b82f6 !important; /* blue-500 - soal sedang dikerjakan */
  border-color: #2563eb !important; /* blue-600 */
  color: white !important;
}

.nav-button.current:hover {
  background-color: #2563eb !important; /* blue-600 */
}

.nav-button.answered {
  background-color: #22c55e !important; /* green-500 - soal sudah dijawab */
  border-color: #16a34a !important; /* green-600 */
  color: white !important;
}

.nav-button.answered:hover {
  background-color: #16a34a !important; /* green-600 */
}

.nav-button.marked {
  background-color: #eab308 !important; /* yellow-500 - soal ditandai */
  border-color: #ca8a04 !important; /* yellow-600 */
  color: white !important;
}

.nav-button.marked:hover {
  background-color: #ca8a04 !important; /* yellow-600 */
}

.nav-button.unanswered {
  background-color: #e5e7eb !important; /* gray-200 - soal belum dijawab */
  border-color: #d1d5db !important; /* gray-300 */
  color: #374151 !important; /* gray-700 */
}

.nav-button.unanswered:hover {
  background-color: #d1d5db !important; /* gray-300 */
  border-color: #9ca3af !important; /* gray-400 */
}
</style>

<script>
// Menggunakan test_id yang konsisten untuk localStorage
let testId = {{ test_id }};
let markedQuestions = JSON.parse(localStorage.getItem('markedQuestions_' + testId) || '[]');
let currentQuestionId = {{ question.id }};

// Timer variables
let remainingTime = {{ remaining_time }}; // seconds from backend
let timerInterval;

// Konversi answered_questions dari backend ke JavaScript array
let answeredQuestions = [{% for q_id in answered_questions %}{{ q_id }}{% if not forloop.last %},{% endif %}{% endfor %}];

// Initialize timer
function initTimer() {
    timerInterval = setInterval(function() {
        remainingTime--;
        updateTimerDisplay();
        
        // Auto-submit when time is up
        if (remainingTime <= 0) {
            clearInterval(timerInterval);
            autoSubmitTest();
        }
        
        // Warning when 5 minutes left
        if (remainingTime === 300) { // 5 minutes
            showTimeWarning();
        }
    }, 1000);
    
    updateTimerDisplay();
}

function updateTimerDisplay() {
    const hours = Math.floor(remainingTime / 3600);
    const minutes = Math.floor((remainingTime % 3600) / 60);
    const seconds = remainingTime % 60;
    
    const display = 
        String(hours).padStart(2, '0') + ':' + 
        String(minutes).padStart(2, '0') + ':' + 
        String(seconds).padStart(2, '0');
    
    document.getElementById('timer-display').textContent = display;
    
    // Change color when time is running low
    const timerElement = document.getElementById('timer-display');
    if (remainingTime <= 300) { // 5 minutes
        timerElement.classList.add('text-red-600', 'dark:text-red-400');
        timerElement.classList.remove('text-red-700', 'dark:text-red-300');
    }
}

function showTimeWarning() {
    if (confirm('Waktu ujian tinggal 5 menit! Pastikan semua jawaban telah tersimpan.')) {
        // User acknowledged the warning
    }
}

function autoSubmitTest() {
    alert('Waktu ujian telah habis! Ujian akan diselesaikan secara otomatis.');
    
    // Clear localStorage for this test
    localStorage.removeItem('markedQuestions_' + testId);
    
    // Create and submit form
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{% url "submit_test" test_id %}';
    
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = csrfToken;
    form.appendChild(csrfInput);
    
    document.body.appendChild(form);
    form.submit();
}

// Show submit confirmation modal
function showSubmitConfirmation() {
    const modal = document.getElementById('submit-modal');
    const answeredCount = answeredQuestions.length;
    document.getElementById('answered-summary').textContent = answeredCount;
    modal.style.display = 'block';
}

// Hide submit confirmation modal
function hideSubmitConfirmation() {
    const modal = document.getElementById('submit-modal');
    modal.style.display = 'none';
}

// Clear localStorage when test is submitted manually
function clearTestData() {
    localStorage.removeItem('markedQuestions_' + testId);
}

// Prevent accidental page close/refresh
function confirmExit() {
    return 'Ujian sedang berlangsung. Jika Anda meninggalkan halaman, progress ujian akan tetap tersimpan tetapi timer akan terus berjalan. Apakah Anda yakin ingin keluar?';
}

// Fungsi toggle navigasi
function toggleNavigation() {
    const panel = document.getElementById('navigation-panel');
    const icon = document.getElementById('nav-toggle-icon');
    const text = document.getElementById('nav-toggle-text');
    
    if (panel.style.display === 'none') {
        panel.style.display = 'block';
        icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"></path>';
        text.textContent = 'Sembunyikan';
    } else {
        panel.style.display = 'none';
        icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7"></path>';
        text.textContent = 'Tampilkan';
    }
}

// Fungsi menandai soal
function markAsDoubtful() {
    const btn = event.target.closest('button');
    const bookmarkIcon = document.getElementById('bookmark-icon');
    const checkIcon = document.getElementById('check-icon');
    const markText = document.getElementById('mark-text');
    
    if (!markedQuestions.includes(currentQuestionId)) {
        // Tandai soal
        markedQuestions.push(currentQuestionId);
        
        // Update visual - show checkmark
        bookmarkIcon.style.display = 'none';
        checkIcon.style.display = 'block';
        markText.textContent = 'Sudah Ditandai';
        
        // Update button style
        btn.classList.add('bg-yellow-100', 'border-yellow-400');
        btn.classList.remove('bg-white', 'border-yellow-200');
    } else {
        // Hapus tanda
        markedQuestions = markedQuestions.filter(id => id !== currentQuestionId);
        
        // Update visual - show bookmark
        bookmarkIcon.style.display = 'block';
        checkIcon.style.display = 'none';
        markText.textContent = 'Tandai Soal';
        
        // Update button style
        btn.classList.remove('bg-yellow-100', 'border-yellow-400');
        btn.classList.add('bg-white', 'border-yellow-200');
    }
    
    localStorage.setItem('markedQuestions_' + testId, JSON.stringify(markedQuestions));
    updateNavigationColors();
}

// Fungsi update warna navigasi berdasarkan status backend dan localStorage
function updateNavigationColors() {
    const answeredQuestionsSet = new Set(answeredQuestions.map(id => parseInt(id)));
    
    document.querySelectorAll('.nav-button').forEach(button => {
        const questionId = parseInt(button.dataset.questionId);
        const questionIndex = parseInt(button.dataset.questionIndex);
        const currentIndex = {{ current_question_index }};
        
        // Reset semua kelas status
        button.classList.remove('marked', 'answered', 'unanswered', 'current');
        
        // Reset warna default
        button.classList.remove('bg-blue-500', 'border-blue-600', 'text-white',
                                'bg-green-500', 'border-green-600', 
                                'bg-yellow-500', 'border-yellow-600',
                                'bg-gray-200', 'border-gray-300', 'text-gray-700');
        
        // Tentukan status berdasarkan prioritas
        if (questionIndex === currentIndex) {
            // Soal sedang dikerjakan (prioritas tertinggi)
            button.classList.add('current', 'bg-blue-500', 'border-blue-600', 'text-white');
        } else if (markedQuestions.includes(questionId)) {
            // Soal ditandai (prioritas kedua)
            button.classList.add('marked', 'bg-yellow-500', 'border-yellow-600', 'text-white');
        } else if (answeredQuestionsSet.has(questionId)) {
            // Soal sudah dijawab (prioritas ketiga)
            button.classList.add('answered', 'bg-green-500', 'border-green-600', 'text-white');
        } else {
            // Soal belum dijawab (default)
            button.classList.add('unanswered', 'bg-gray-200', 'border-gray-300', 'text-gray-700');
        }
    });
    
    // Update statistik
    updateStats();
}

// Fungsi update statistik
function updateStats() {
    const answeredButtons = document.querySelectorAll('.nav-button.answered');
    const markedButtons = document.querySelectorAll('.nav-button.marked');
    const totalQuestions = {{ questions|length }};
    
    const answeredCount = answeredButtons.length;
    const markedCount = markedButtons.length;
    const remainingCount = totalQuestions - answeredCount;
    
    document.getElementById('answered-count').textContent = answeredCount;
    document.getElementById('doubtful-count').textContent = markedCount;
    document.getElementById('remaining-count').textContent = remainingCount;
    
    // Update progress bar berdasarkan soal yang dijawab
    updateProgressBar(answeredCount, totalQuestions);
}

// Fungsi update progress bar
function updateProgressBar(answeredCount, totalQuestions) {
    const percentage = Math.round((answeredCount / totalQuestions) * 100);
    const progressBar = document.getElementById('progress-bar');
    const progressPercentage = document.getElementById('progress-percentage');
    
    if (progressBar && progressPercentage) {
        progressBar.style.width = percentage + '%';
        progressPercentage.textContent = percentage + '%';
    }
}

// Inisialisasi saat halaman dimuat
document.addEventListener('DOMContentLoaded', function() {
    // Initialize timer
    initTimer();
    
    // Set up page exit confirmation
    window.addEventListener('beforeunload', confirmExit);
    
    updateNavigationColors();
    updateStats();
    
    // Inisialisasi progress bar berdasarkan soal yang sudah dijawab
    const totalQuestions = {{ questions|length }};
    const initialAnsweredCount = answeredQuestions.length;
    updateProgressBar(initialAnsweredCount, totalQuestions);
    
    // Set status tombol tandai soal
    const markBtn = document.querySelector('button[onclick="markAsDoubtful()"]');
    const bookmarkIcon = document.getElementById('bookmark-icon');
    const checkIcon = document.getElementById('check-icon');
    const markText = document.getElementById('mark-text');
    
    if (markedQuestions.includes(currentQuestionId)) {
        // Soal sudah ditandai - show checkmark
        bookmarkIcon.style.display = 'none';
        checkIcon.style.display = 'block';
        markText.textContent = 'Sudah Ditandai';
        markBtn.classList.add('bg-yellow-100', 'border-yellow-400');
        markBtn.classList.remove('bg-white', 'border-yellow-200');
    } else {
        // Soal belum ditandai - show bookmark
        bookmarkIcon.style.display = 'block';
        checkIcon.style.display = 'none';
        markText.textContent = 'Tandai Soal';
        markBtn.classList.remove('bg-yellow-100', 'border-yellow-400');
        markBtn.classList.add('bg-white', 'border-yellow-200');
    }
    
    // Event listener untuk form submit - update navigasi saat soal dijawab
    const form = document.querySelector('form[method="post"]');
    if (form && !form.action.includes('submit')) {
        form.addEventListener('submit', function(e) {
            const selectedAnswer = document.querySelector('input[name="answer"]:checked');
            if (selectedAnswer) {
                // Tambahkan soal ke daftar yang sudah dijawab
                if (!answeredQuestions.includes(currentQuestionId)) {
                    answeredQuestions.push(currentQuestionId);
                }
                
                // Update navigasi sebelum form di-submit
                updateNavigationColors();
            }
            // Form akan di-submit bahkan tanpa jawaban dipilih
        });
    }
    
    // Event listener untuk radio buttons - preview update navigasi
    document.querySelectorAll('input[name="answer"]').forEach(radio => {
        radio.addEventListener('change', function() {
            // Berikan preview bahwa soal akan dijawab
            if (!answeredQuestions.includes(currentQuestionId)) {
                answeredQuestions.push(currentQuestionId);
                updateNavigationColors();
            }
        });
    });
    
    // Modal event listeners
    document.getElementById('cancel-submit').addEventListener('click', hideSubmitConfirmation);
    
    // Add event listener to manual submit form
    const submitForm = document.querySelector('form[action*="submit_test"]');
    if (submitForm) {
        submitForm.addEventListener('submit', function(e) {
            clearTestData();
        });
    }
    
    // Handle image loading in CKEditor content
    function handleImageLoading() {
        const images = document.querySelectorAll('.ckeditor-content img');
        images.forEach(img => {
            img.addEventListener('load', function() {
                this.classList.remove('loading', 'error');
            });
            
            img.addEventListener('error', function() {
                this.classList.add('error');
                this.classList.remove('loading');
                console.warn('Failed to load image:', this.src);
            });
            
            // Add loading class initially
            if (!img.complete) {
                img.classList.add('loading');
            }
        });
    }
    
    // Initialize image loading handlers
    handleImageLoading();
});
</script>
{% endblock %}
