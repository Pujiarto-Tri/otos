{% extends 'base.html' %}

{% block title %}Detail Hasil Test{% endblock %}

{% block content %}
<style>
/* Ensure CKEditor block tags inside choice text don't force line breaks */
.choice-text p, .choice-text div { display: inline; margin: 0; }
.choice-text p + p { margin-left: 0; }
/* Hide CKEditor editor toolbars/resizers in read-only explanation output */
details .cke_image_resizer,
details .cke_widget_drag_handler_container,
details .cke_widget_drag_handler,
details .ck-widget__drag-handler,
details .ck-widget__resizer,
details .ck-widget__toolbar {
	display: none !important;
}
/* Hide custom question-form image toolbar in read-only explanations */
details .image-edit-toolbar {
	display: none !important;
}
</style>
<div class="max-w-6xl mx-auto p-4 sm:p-6">
	{# Provide page_title and page_subtitle to welcome_header via explicit branches (avoid inline expressions) #}
	{% if test.tryout_package %}
		{% with page_title=test.tryout_package.package_name page_subtitle=test.date_taken|date:"d M Y H:i" %}
			{% include 'components/welcome_header.html' with page_title=page_title page_subtitle=page_subtitle hide_profile=True %}
		{% endwith %}
	{% elif category %}
		{% with page_title=category.category_name page_subtitle=test.date_taken|date:"d M Y H:i" %}
			{% include 'components/welcome_header.html' with page_title=page_title page_subtitle=page_subtitle hide_profile=True %}
		{% endwith %}
	{% endif %}
			<script>
			// Map 'packages' -> 'by_category', 'categories' -> 'by_question'
			function showTab(tabName) {
				const mapping = { packages: 'by_category', categories: 'by_question' };
				const targetId = mapping[tabName];
				const tabContents = document.querySelectorAll('.tab-content');
				// hide all with soft transition
				tabContents.forEach(content => {
					content.classList.add('opacity-0', 'scale-98')
					setTimeout(() => content.classList.add('hidden'), 180)
					setTimeout(() => content.classList.remove('opacity-0', 'scale-98'), 300)
				});
				setTimeout(() => {
					const el = document.getElementById(targetId+'');
					if (!el) return;
					// show target
					el.classList.remove('hidden');
					el.classList.add('opacity-0', 'scale-98');
					setTimeout(() => el.classList.remove('opacity-0', 'scale-98'), 20);
				}, 200);

				const tabs = document.querySelectorAll('#packages-tab, #categories-tab');
				tabs.forEach(tab => {
					const active = tab.id === tabName + '-tab';
					tab.classList.toggle('text-white', active);
					tab.classList.toggle('bg-blue-600', active);
					tab.classList.toggle('text-gray-600', !active);
					tab.classList.toggle('dark:text-gray-300', !active);
				});
			}

			// initialize default
			document.addEventListener('DOMContentLoaded', () => showTab('packages'));

			// When a category/subtest card is clicked, show only questions for that category
			function filterQuestionsFromElement(el){
				const cat = el.dataset.cat || '';
				filterQuestions(cat);
				// mark active card
				document.querySelectorAll('.subtest-card').forEach(c => c.classList.remove('ring-2','ring-blue-400'));
				if (el) el.classList.add('ring-2','ring-blue-400');
			}

			function filterQuestions(cat){
				// open Per Soal tab
				showTab('categories');
				const qCards = document.querySelectorAll('.question-card');
				let any=false;
				qCards.forEach(card => {
					const c = card.dataset.cat || '';
					if (!cat || c === cat){
						card.classList.remove('hidden');
						any = true;
					} else {
						card.classList.add('hidden');
					}
				});
				if (any){
					const first = document.querySelector('.question-card:not(.hidden)');
					if (first) first.scrollIntoView({behavior:'smooth', block:'start'});
				}
			}

			// Reset filter and remove active indicator
			function resetQuestionFilter(){
				document.querySelectorAll('.question-card').forEach(card => card.classList.remove('hidden'));
				document.querySelectorAll('.subtest-card').forEach(c => c.classList.remove('ring-2','ring-blue-400'));
				// show all questions in the "Per Soal" tab
				showTab('categories');
			}
			</script>
				<div class="mt-4 flex justify-center mb-8">
					<div class="bg-gray-100 dark:bg-gradient-to-br dark:from-slate-800 dark:to-slate-900 p-1 rounded-lg shadow-sm">
						<button id="packages-tab" class="px-6 py-2 text-sm font-medium rounded-md transition-all duration-200 text-white bg-blue-600 shadow-sm hover:bg-blue-700" onclick="showTab('packages')">Per Subtest</button>
						<button id="categories-tab" class="px-6 py-2 text-sm font-medium rounded-md transition-all duration-200 text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white" onclick="showTab('categories')">Per Soal</button>
						<button class="ml-2 px-4 py-2 text-sm text-gray-600 bg-white rounded-md shadow-sm hover:bg-gray-50" onclick="resetQuestionFilter()">Tampilkan Semua</button>
					</div>
				</div>
			<!-- Single Results container: summary + placeholders for other sections -->
			<div class="space-y-6 mb-6">
				<!-- category pills moved into each stat card for clearer association -->
			</div>


			<!-- Recent tests placed below summary to use full width -->
			<div class="mt-6">
				{% include 'components/recent_tests.html' %}
			</div>

			<!-- Per Subtest section -->
			<div id="by_category" role="tabpanel" aria-labelledby="tab-by_category" class="tab-content space-y-4 hidden transition-all duration-200 ease-out transform">
				<div class="mt-2 bg-white dark:bg-transparent rounded-lg p-4">
					<h3 class="text-lg font-semibold mb-2 text-gray-900 dark:text-gray-100">Per Subtest</h3>
					<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
						{% for stat in stats_by_category %}
						{# subtest card: store category/name in data-cat and make clickable to filter questions #}
						<div class="bg-white dark:bg-gray-800 rounded-2xl shadow-md p-6 border border-gray-100 dark:border-gray-700 transform hover:scale-[1.01] transition cursor-pointer subtest-card" onclick="filterQuestionsFromElement(this)"
							data-cat="{% if stat.category_name %}{{ stat.category_name }}{% elif stat.name %}{{ stat.name }}{% else %}{% endif %}">
							{% if stat.category_name %}
							<div class="mb-3">
								<span class="inline-flex items-center px-3 py-1 text-xs font-medium rounded-full bg-slate-100 text-slate-800 dark:bg-slate-700/60 dark:text-slate-100">{{ stat.category_name }}</span>
							</div>
							{% elif stat.name %}
							<div class="mb-3">
								<span class="inline-flex items-center px-3 py-1 text-xs font-medium rounded-full bg-slate-100 text-slate-800 dark:bg-slate-700/60 dark:text-slate-100">{{ stat.name }}</span>
							</div>
							{% endif %}
							<div class="flex items-center gap-2">
								<span class="inline-flex items-center px-2 py-1 text-xs font-semibold rounded-full bg-green-50 text-green-800 dark:bg-green-900/50 dark:text-green-200">
									<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" class="w-3 h-3 mr-1 text-green-600 dark:text-green-300" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 00-1.414 0L8 12.586 4.707 9.293a1 1 0 10-1.414 1.414l4 4a1 1 0 001.414 0l8-8a1 1 0 000-1.414z" clip-rule="evenodd"/></svg>
									Benar {{ stat.correct }}
								</span>
								<span class="inline-flex items-center px-2 py-1 text-xs font-semibold rounded-full bg-red-50 text-red-800 dark:bg-red-900/50 dark:text-red-200">
									<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" class="w-3 h-3 mr-1 text-red-600 dark:text-red-300" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 00-2 0v4a1 1 0 002 0V7zm-1 8a1.5 1.5 0 110-3 1.5 1.5 0 010 3z" clip-rule="evenodd"/></svg>
									Salah {{ stat.incorrect }}
								</span>
								<span class="inline-flex items-center px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800 dark:bg-gray-700/60 dark:text-gray-100">
									<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" class="w-3 h-3 mr-1 text-gray-600 dark:text-gray-300" fill="currentColor"><path d="M10 5a1 1 0 011 1v6a1 1 0 11-2 0V6a1 1 0 011-1z"/></svg>
									Kosong {{ stat.blank }}
								</span>
							</div>
							<div class="mt-4 flex items-baseline justify-between">
								<div>
									<div class="text-3xl font-bold text-gray-900 dark:text-white">{{ stat.score }}</div>
								</div>
								<div class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider">Skor</div>
							</div>
						</div>
						{% endfor %}
					</div>
				</div>
			</div>

		<div id="by_question" role="tabpanel" aria-labelledby="tab-by_question" class="tab-content space-y-4 hidden transition-all duration-200 ease-out transform">
			<div class="mt-2 bg-white dark:bg-transparent rounded-lg p-4">
				<h3 class="text-lg font-semibold mb-2 text-gray-900 dark:text-gray-100">Per Soal</h3>
				<div class="space-y-4">
					{% for q in questions %}
					{# compute a category label for client-side filtering using explicit branches to avoid template tag mismatch #}
					{% if q.category_name %}
						<div class="bg-white dark:bg-gray-800 rounded-2xl shadow-md p-6 border border-gray-100 dark:border-gray-700 question-card" data-cat="{{ q.category_name }}">
					{% elif q.question_obj and q.question_obj.category %}
						<div class="bg-white dark:bg-gray-800 rounded-2xl shadow-md p-6 border border-gray-100 dark:border-gray-700 question-card" data-cat="{{ q.question_obj.category.category_name }}">
					{% elif q.question and q.question.category %}
						<div class="bg-white dark:bg-gray-800 rounded-2xl shadow-md p-6 border border-gray-100 dark:border-gray-700 question-card" data-cat="{{ q.question.category.category_name }}">
					{% else %}
						<div class="bg-white dark:bg-gray-800 rounded-2xl shadow-md p-6 border border-gray-100 dark:border-gray-700 question-card" data-cat="">
					{% endif %}
						<div class="flex items-start gap-4">
							<div class="w-10 flex-shrink-0">
								<div class="text-xs text-gray-500 dark:text-gray-400">No</div>
								<div class="text-sm font-bold text-gray-900 dark:text-gray-100">{{ forloop.counter }}</div>
							</div>
							<div class="flex-1">
								<div class="text-sm text-gray-700 dark:text-gray-200">{{ q.question_text|safe }}</div>
								<div class="text-xs text-gray-500 dark:text-gray-400 mt-1">Jawaban Anda: <span class="font-semibold text-gray-900 dark:text-gray-100">{{ q.your_answer|default:"-"|safe }}</span></div>
									{% if not q.is_correct and q.correct_answer %}
									<div class="text-xs text-green-700 dark:text-green-300 mt-1">Jawaban Benar: <span class="font-semibold">{{ q.correct_answer|safe }}</span></div>
									{% endif %}

								{% if q.all_choices %}
								<ul class="mt-3 space-y-2 text-sm">
									{% for ch in q.all_choices %}
									<li class="p-3 rounded-md {% if ch.label == q.correct_choice_label %}border-2 border-green-400 bg-green-50/40 dark:bg-green-900/30 dark:border-green-600{% elif ch.label == q.your_choice_label and ch.label != q.correct_choice_label %}border-2 border-red-400 bg-red-50/40 dark:bg-red-900/30 dark:border-red-600{% elif ch.label == q.your_choice_label %}border-2 border-indigo-300 bg-indigo-50/40 dark:bg-indigo-900/30 dark:border-indigo-600{% else %}border border-transparent bg-transparent{% endif %}">
										<span class="font-semibold mr-2 {% if ch.label == q.correct_choice_label %}text-green-800 dark:text-green-200{% elif ch.label == q.your_choice_label and ch.label != q.correct_choice_label %}text-red-800 dark:text-red-200{% else %}text-gray-800 dark:text-gray-100{% endif %}">{{ ch.label }}.</span>
										<span class="choice-text {% if ch.label == q.correct_choice_label %}text-green-700 dark:text-green-200{% elif ch.label == q.your_choice_label and ch.label != q.correct_choice_label %}text-red-700 dark:text-red-200{% else %}text-gray-700 dark:text-gray-200{% endif %}">{{ ch.text|safe }}</span>
									</li>
									{% endfor %}
								</ul>
								{% endif %}

								{# Show question explanation/pembahasan if available. q may be a plain question or an Answer proxy; try multiple sources. #}
								{# Robustly resolve explanation: prefer q.explanation, then q.question_obj.explanation, then q.question.explanation. Use 'in' to avoid missing-key lookups. #}
								{% if q.explanation %}
								<details class="mt-3 bg-gray-50 dark:bg-gray-900/30 p-3 rounded-md border border-gray-100 dark:border-gray-700">
									<summary class="cursor-pointer outline-none text-sm font-semibold text-blue-600 dark:text-blue-400">Lihat Pembahasan</summary>
									<div class="mt-2 text-sm text-gray-700 dark:text-gray-200 leading-relaxed">
										{{ q.explanation|safe }}
									</div>
								</details>
								{% elif 'question_obj' in q and q.question_obj.explanation %}
								<details class="mt-3 bg-gray-50 dark:bg-gray-900/30 p-3 rounded-md border border-gray-100 dark:border-gray-700">
									<summary class="cursor-pointer outline-none text-sm font-semibold text-blue-600 dark:text-blue-400">Lihat Pembahasan</summary>
									<div class="mt-2 text-sm text-gray-700 dark:text-gray-200 leading-relaxed">
										{{ q.question_obj.explanation|safe }}
									</div>
								</details>
								{% elif 'question' in q and q.question.explanation %}
								<details class="mt-3 bg-gray-50 dark:bg-gray-900/30 p-3 rounded-md border border-gray-100 dark:border-gray-700">
									<summary class="cursor-pointer outline-none text-sm font-semibold text-blue-600 dark:text-blue-400">Lihat Pembahasan</summary>
									<div class="mt-2 text-sm text-gray-700 dark:text-gray-200 leading-relaxed">
										{{ q.question.explanation|safe }}
									</div>
								</details>
								{% else %}
								<div class="mt-3 text-sm text-gray-500 dark:text-gray-400 italic">Pembahasan belum tersedia.</div>
								{% endif %}
							</div>
							<div class="w-28 text-right">
								{% if q.is_correct %}
									<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-green-800/10 text-green-800 dark:bg-green-700/60 dark:text-green-100">Benar</span>
								{% elif q.your_answer == None or q.your_answer == '' %}
									<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-gray-100 text-gray-800 dark:bg-gray-700/60 dark:text-gray-100">Kosong</span>
								{% else %}
									<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-red-800/10 text-red-800 dark:bg-red-700/60 dark:text-red-100">Salah</span>
								{% endif %}
							</div>
						</div>
					</div>
					{% endfor %}
				</div>
			</div>
		</div>

		{# bottom duplicated links removed; action buttons live near tabs #}
	</div>
</div>
{% endblock %}

{% block extra_js %}
<!-- page-specific JS already initialized above; reserved for future scripts -->
{% endblock %}
