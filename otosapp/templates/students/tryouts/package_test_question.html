{% extends 'base.html' %}
{% load custom_filters %}
{% load media_helpers %}

{% block title %}{% if is_package %}{{ package.package_name }}{% else %}{{ category.category_name }}{% endif %} - Soal {{ current_question_number }}{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto p-6 space-y-6">
    <!-- Header Section -->
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 border border-gray-200 dark:border-gray-700">
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-4">
                <div class="flex items-center justify-center w-14 h-14 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-gray-800 dark:text-white">{% if is_package %}{{ package.package_name }}{% else %}{{ category.category_name }}{% endif %}</h1>
                    <p class="text-lg text-gray-600 dark:text-gray-300">Soal {{ current_question_number }} dari {{ total_questions }}</p>
                </div>
            </div>
            
            <!-- Progress Bar & Timer -->
            <div class="flex items-center gap-6 min-w-0">
                <!-- Timer Display -->
                {% if time_remaining %}
                <div class="flex items-center gap-3 px-4 py-2 bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-700 rounded-lg">
                    <svg class="w-5 h-5 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <div class="text-sm">
                        <div class="font-semibold text-red-600 dark:text-red-400">Sisa Waktu</div>
                        <div id="timer-display" class="font-mono text-lg font-bold text-red-700 dark:text-red-300">00:00:00</div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Question Section -->
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700">
    <form method="post" class="p-4 sm:p-8" id="answer-form">
            {% csrf_token %}
            
            <!-- Question Content -->
            <div class="mb-8">
                <div class="flex items-start gap-4 mb-6">
                    <div class="flex items-center justify-center w-8 h-8 bg-indigo-100 dark:bg-indigo-900 rounded-full flex-shrink-0 mt-1">
                        <span class="text-indigo-600 dark:text-indigo-400 font-bold text-sm">{{ current_question_number }}</span>
                    </div>
                    <div class="flex-1">
                        <div class="text-xl font-semibold text-gray-900 dark:text-white leading-relaxed ckeditor-content question-text">{{ question.question_text|safe }}</div>
                        {% if question.question_image %}
                        <div class="mt-4">
                            <img src="{{ question.question_image|safe_image_url }}" alt="Question Image" class="max-w-full w-full h-auto rounded-lg shadow-sm object-contain max-h-40 sm:max-h-60 md:max-h-80 lg:max-h-96">
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Answer Section -->
            <div class="space-y-4 mb-8">
                {% if question.question_type == 'multiple_choice' %}
                    <!-- Multiple Choice Answers -->
                    {% for choice in choices %}
                    <label for="choice_{{ choice.id }}" class="group flex items-start cursor-pointer p-3 sm:p-5 rounded-xl border-2 border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900 hover:bg-indigo-50 dark:hover:bg-indigo-900 hover:border-indigo-300 dark:hover:border-indigo-600 transition-all duration-200">
                        <input type="radio" id="choice_{{ choice.id }}" name="choice" value="{{ choice.id }}" 
                               {% if previous_answer and previous_answer.selected_choice and previous_answer.selected_choice.id == choice.id %}checked{% endif %}
                               class="w-4 h-4 sm:w-5 sm:h-5 text-indigo-600 border-gray-300 focus:ring-indigo-500 dark:focus:ring-indigo-400 dark:ring-offset-gray-800 dark:bg-gray-700 dark:border-gray-600 mt-1 flex-shrink-0"
                               onchange="saveAnswer()">
                        <div class="ml-4 text-base sm:text-lg font-medium text-gray-800 dark:text-gray-200 group-hover:text-indigo-800 dark:group-hover:text-indigo-200 leading-relaxed ckeditor-content choice-text">
                            {{ choice.choice_text|safe }}
                            {% if choice.choice_image %}
                            <div class="mt-3">
                                <img src="{{ choice.choice_image|safe_image_url }}" alt="Choice Image" class="max-w-full sm:max-w-sm h-auto rounded-lg border border-gray-200 dark:border-gray-600 object-contain">
                            </div>
                            {% endif %}
                        </div>
                    </label>
                    {% endfor %}
                {% elif question.question_type == 'essay' %}
                    <!-- Essay Answer -->
                    <div class="p-4 sm:p-6 bg-gray-50 dark:bg-gray-900 rounded-xl border-2 border-gray-200 dark:border-gray-700">
                        <label for="text_answer" class="block text-lg font-semibold text-gray-800 dark:text-white mb-4">
                            <svg class="inline w-5 h-5 mr-2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                            Tulis jawaban Anda:
                        </label>
                        <textarea 
                            id="text_answer" 
                            name="text_answer" 
                            rows="4" 
                            class="w-full px-3 sm:px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white bg-white dark:bg-gray-800 focus:ring-2 focus:ring-indigo-500 focus:border-transparent resize-y min-h-[120px] sm:min-h-[160px]"
                            placeholder="Ketik jawaban Anda di sini..."
                            onchange="saveEssayAnswer()"
                            onblur="saveEssayAnswer()">{{ previous_text_answer }}</textarea>
                        <div class="mt-2 text-sm text-gray-500 dark:text-gray-400">
                            <svg class="inline w-4 h-4 mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            Jawaban akan tersimpan otomatis
                        </div>
                    </div>
                {% endif %}
                
                <!-- Saving indicator (flyout, fixed so it doesn't shift layout) -->
                <div id="saving-indicator" class="hidden fixed top-20 right-4 z-50 flex items-center gap-2 text-sm text-indigo-600 dark:text-indigo-400 px-4 py-3 bg-indigo-50 dark:bg-indigo-900/30 rounded-lg border border-indigo-200 dark:border-indigo-700 shadow-lg transform translate-x-full opacity-0 transition-all duration-200">
                    <svg class="animate-spin w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    <span>Menyimpan jawaban...</span>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-col lg:flex-row justify-between items-center gap-4 pt-6 border-t border-gray-200 dark:border-gray-700">
                <!-- Left: Previous Button -->
                <div class="w-full lg:w-auto">
                    {% if can_go_previous %}
                    {% if is_package %}
                    <a href="{% url 'take_package_test_question' package.id current_question_number|add:'-1' %}" class="w-full lg:w-auto inline-flex items-center justify-center gap-2 px-6 py-3 text-indigo-600 bg-white border-2 border-indigo-200 rounded-xl hover:bg-indigo-50 hover:border-indigo-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-all font-semibold">
                    {% else %}
                    <a href="{% url 'take_test' category.id current_question_number|add:'-1' %}" class="w-full lg:w-auto inline-flex items-center justify-center gap-2 px-6 py-3 text-indigo-600 bg-white border-2 border-indigo-200 rounded-xl hover:bg-indigo-50 hover:border-indigo-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-all font-semibold">
                    {% endif %}
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M11 17l-5-5m0 0l5-5m-5 5h12"></path></svg>
                        Soal Sebelumnya
                    </a>
                    {% endif %}
                </div>

                <!-- Right: Action Buttons -->
                <div class="flex flex-col sm:flex-row gap-3 w-full lg:w-auto">
                    {% if can_go_next %}
                        <!-- Submit Test Button (Secondary position when not last question) -->
                        <button type="button" onclick="showSubmitConfirmation()" id="submit-test-btn" class="w-full sm:w-auto inline-flex items-center justify-center gap-2 px-6 py-3 transition-all font-semibold rounded-xl focus:outline-none focus:ring-2 focus:ring-offset-2 {% if answered_questions == total_questions %}text-white bg-green-600 hover:bg-green-700 focus:ring-green-500{% else %}text-white bg-red-600 hover:bg-red-700 focus:ring-red-500{% endif %}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span>Selesai Ujian</span>
                        </button>
                        
                        <!-- Mark Question Button -->
                        <button type="button" onclick="markAsDoubtful()" id="mark-button" class="w-full sm:w-auto inline-flex items-center justify-center gap-2 px-6 py-3 text-yellow-600 bg-white border-2 border-yellow-200 rounded-xl hover:bg-yellow-50 hover:border-yellow-300 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-offset-2 transition-all font-semibold">
                            <svg id="mark-icon" class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path id="bookmark-icon" stroke-linecap="round" stroke-linejoin="round" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>
                                <path id="check-icon" stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" style="display: none;"></path>
                            </svg>
                            <span id="mark-text">Tandai Soal</span>
                        </button>

                        <!-- Next Button -->
                        <button type="submit" name="action" value="next" class="w-full sm:w-auto inline-flex items-center justify-center gap-2 px-6 py-3 text-white bg-gradient-to-r from-blue-600 to-blue-700 rounded-xl hover:from-blue-700 hover:to-blue-800 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all font-semibold shadow-lg">
                            <span>Soal Selanjutnya</span>
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                            </svg>
                        </button>
                    {% else %}
                        <!-- Last Question: Submit and Mark buttons -->
                        <!-- Mark Question Button -->
                        <button type="button" onclick="markAsDoubtful()" id="mark-button" class="w-full sm:w-auto inline-flex items-center justify-center gap-2 px-6 py-3 text-yellow-600 bg-white border-2 border-yellow-200 rounded-xl hover:bg-yellow-50 hover:border-yellow-300 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-offset-2 transition-all font-semibold">
                            <svg id="mark-icon" class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path id="bookmark-icon" stroke-linecap="round" stroke-linejoin="round" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>
                                <path id="check-icon" stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" style="display: none;"></path>
                            </svg>
                            <span id="mark-text">Tandai Soal</span>
                        </button>
                        
                        <!-- Submit Test Button (Primary position on last question) -->
                        <button type="button" onclick="showSubmitConfirmation()" id="submit-test-btn" class="w-full sm:w-auto inline-flex items-center justify-center gap-2 px-8 py-4 transition-all font-bold rounded-xl focus:outline-none focus:ring-2 focus:ring-offset-2 text-lg shadow-lg {% if answered_questions == total_questions %}text-white bg-green-600 hover:bg-green-700 focus:ring-green-500{% else %}text-white bg-red-600 hover:bg-red-700 focus:ring-red-500{% endif %}">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span>Selesai Ujian</span>
                        </button>
                    {% endif %}
                </div>
            </div>
        </form>
    </div>

    <!-- Navigation Section -->
    <!-- Progress Bar Card -->
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 mb-4">
        <div class="flex items-center gap-3 min-w-0 px-6 py-4">
            <span class="text-sm font-semibold text-purple-600 dark:text-purple-400 w-16">Progress</span>
            <div class="flex-1">
                <div class="w-full bg-gray-200 rounded-full h-3 dark:bg-gray-700">
                    <div id="progress-bar" class="bg-gradient-to-r from-indigo-500 to-purple-600 h-3 rounded-full transition-all duration-300" style="width: {{ progress }}%"></div>
                </div>
            </div>
            <span id="progress-percentage" class="text-sm font-medium text-gray-600 dark:text-gray-300 ml-3">{{ progress }}%</span>
        </div>
    </div>

    <!-- Navigation Section -->
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700">
        <!-- Subtest selector (for package tests) -->
        {% if is_package and package_subtests %}
        <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
            <div>
                <label for="subtest-select" class="text-sm font-semibold text-gray-700 dark:text-gray-200 mr-2">Pilih Subtest:</label>
                <select id="subtest-select" class="inline-block px-3 py-2 border rounded bg-white dark:bg-gray-800 text-sm">
                    <option value="all">Semua Subtest</option>
                    {% for s in package_subtests %}
                    <option value="{{ s.start }}-{{ s.start|add:s.count|add:'-1' }}" {% if current_question_number >= s.start and current_question_number < s.start|add:s.count %}selected{% endif %}>{{ s.category_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="text-sm text-gray-500">Navigasi menampilkan hanya soal subtest yang dipilih</div>
        </div>
        {% endif %}
        <!-- Navigation Header -->
        <div class="flex justify-between items-center p-6 border-b border-gray-200 dark:border-gray-700">
            <h3 class="text-xl font-bold text-gray-800 dark:text-white flex items-center gap-3">
                <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path></svg>
                </div>
                Navigasi Soal
            </h3>
            <button onclick="toggleNavigation()" class="flex items-center gap-2 px-4 py-2 text-indigo-600 bg-indigo-50 dark:bg-indigo-900 border border-indigo-200 dark:border-indigo-700 rounded-lg hover:bg-indigo-100 dark:hover:bg-indigo-800 transition-all font-medium">
                <svg id="nav-toggle-icon" class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"></path></svg>
                <span id="nav-toggle-text">Sembunyikan</span>
            </button>
        </div>

        <!-- Navigation Panel -->
        <div id="navigation-panel" class="p-6 transition-all duration-300">
            <!-- Status Legend -->
            <div class="mb-6 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600">
                <h4 class="text-sm font-semibold text-gray-800 dark:text-white mb-4 flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Keterangan Status Soal
                </h4>
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <div class="flex items-center gap-2 p-2 bg-white dark:bg-gray-800 rounded border">
                        <div class="w-4 h-4 bg-gray-300 border border-gray-400 rounded"></div>
                        <div>
                            <div class="text-xs font-medium text-gray-700 dark:text-gray-300">Belum dikerjakan</div>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-2 p-2 bg-white dark:bg-gray-800 rounded border">
                        <div class="w-4 h-4 bg-green-500 border border-green-600 rounded"></div>
                        <div>
                            <div class="text-xs font-medium text-gray-700 dark:text-gray-300">Sudah dijawab</div>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-2 p-2 bg-white dark:bg-gray-800 rounded border">
                        <div class="w-4 h-4 bg-yellow-500 border border-yellow-600 rounded"></div>
                        <div>
                            <div class="text-xs font-medium text-gray-700 dark:text-gray-300">Ditandai</div>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-2 p-2 bg-white dark:bg-gray-800 rounded border">
                        <div class="w-4 h-4 bg-blue-500 border border-blue-600 rounded"></div>
                        <div>
                            <div class="text-xs font-medium text-gray-700 dark:text-gray-300">Sedang dikerjakan</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Question Grid -->
            <div class="navigation-grid mb-6">
                {% for i in total_questions|range_filter %}
                {% with question_num=forloop.counter %}
                {% if is_package %}
                <a href="{% url 'take_package_test_question' package.id question_num %}" 
                   class="nav-button"
                   data-question-index="{{ question_num }}"
                   title="Soal {{ question_num }}">
                    {{ question_num }}
                </a>
                {% else %}
                <a href="{% url 'take_test' category.id question_num %}" 
                   class="nav-button"
                   data-question-index="{{ question_num }}"
                   title="Soal {{ question_num }}">
                    {{ question_num }}
                </a>
                {% endif %}
                {% endwith %}
                {% endfor %}
            </div>

            <!-- Quick Stats -->
            <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600">
                <h4 class="text-sm font-semibold text-gray-800 dark:text-white mb-4 flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                    Statistik Pengerjaan
                </h4>
                
                <div class="grid grid-cols-3 gap-4">
                    <!-- Soal Dijawab -->
                    <div class="text-center p-3 bg-green-100 dark:bg-green-900/30 rounded-lg border border-green-200 dark:border-green-700">
                        <div class="text-2xl font-bold text-green-600 dark:text-green-400 mb-1" id="answered-count">{{ answered_questions }}</div>
                        <div class="text-xs text-gray-600 dark:text-gray-400">Dijawab</div>
                    </div>
                    
                    <!-- Soal Ditandai -->
                    <div class="text-center p-3 bg-yellow-100 dark:bg-yellow-900/30 rounded-lg border border-yellow-200 dark:border-yellow-700">
                        <div class="text-2xl font-bold text-yellow-600 dark:text-yellow-400 mb-1" id="doubtful-count">0</div>
                        <div class="text-xs text-gray-600 dark:text-gray-400">Ditandai</div>
                    </div>
                    
                    <!-- Soal Tersisa -->
                    <div class="text-center p-3 bg-gray-100 dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-600">
                        <div class="text-2xl font-bold text-gray-600 dark:text-gray-400 mb-1" id="remaining-count">{{ unanswered_questions }}</div>
                        <div class="text-xs text-gray-600 dark:text-gray-400">Tersisa</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Submit Confirmation Modal -->
<div id="submit-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg max-w-md w-full p-6 shadow-2xl transform transition-all">
            <div class="text-center mb-6">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 dark:bg-red-900 mb-4">
                    <svg class="h-6 w-6 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                    </svg>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white mb-2">
                    Selesai Ujian
                </h3>
                <div class="px-4 py-3">
                    <p id="submit-modal-text" class="text-sm text-gray-500 dark:text-gray-300 mb-4">
                        Apakah Anda yakin ingin menyelesaikan ujian? Setelah ujian diselesaikan, Anda tidak dapat mengubah jawaban lagi.
                    </p>
                    <div class="text-sm font-medium text-gray-700 dark:text-gray-300">
                        <span id="answered-summary">0</span> soal telah dijawab dari <span>{{ total_questions }}</span> soal
                    </div>
                </div>
            </div>
            
            <div class="flex justify-center gap-4">
                <button id="cancel-submit" type="button" class="px-4 py-2 bg-gray-300 dark:bg-gray-600 text-gray-800 dark:text-gray-200 text-base font-medium rounded-md w-24 hover:bg-gray-400 dark:hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-gray-300">
                    Batal
                </button>
                <button onclick="submitTest()" class="px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md w-32 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-300">
                    Ya, Selesai
                </button>
            </div>
        </div>
    </div>
</div>

<style>
@keyframes fade-in {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.animate-fade-in {
  animation: fade-in 0.5s ease;
}

/* Universal font family untuk kompatibilitas lintas platform */
* {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Cantarell", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif !important;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* Reset font weights to normal */
button, .btn {
  font-family: inherit;
  font-weight: 500;
}

/* Styling khusus untuk konten CKEditor dengan typography natural */
.ckeditor-content {
  line-height: 1.6;
  font-family: inherit;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  text-rendering: optimizeLegibility;
  font-weight: 400; /* Normal weight */
}

.ckeditor-content p {
  margin-bottom: 1rem;
  line-height: 1.6;
  font-weight: 400;
}

/* Typography improvements untuk question text - bold yang jelas tapi tidak berlebihan */
.ckeditor-content strong,
.ckeditor-content b {
  font-weight: 700 !important; /* Bold yang jelas namun tidak terlalu tebal */
  color: inherit;
}

.ckeditor-content em,
.ckeditor-content i {
  font-style: italic !important;
  font-weight: inherit; /* Inherit weight, hanya italic */
  color: inherit;
}

.ckeditor-content u {
  text-decoration: underline !important;
  text-decoration-thickness: 1px !important;
}

/* Khusus untuk choice text - pastikan konsistensi formatting */
.choice-text strong,
.choice-text b {
  font-weight: 700 !important;
  color: inherit !important;
  background: none !important;
  border: none !important;
  text-shadow: none !important;
}

.choice-text em,
.choice-text i {
  font-style: italic !important;
  font-weight: inherit !important;
  color: inherit !important;
}

.choice-text u {
  text-decoration: underline !important;
  text-decoration-thickness: 1px !important;
  color: inherit !important;
}

/* Reset any unwanted styling pada choice content */
.choice-text * {
  font-family: inherit !important;
  background: transparent !important;
  border: none !important;
  box-shadow: none !important;
}

/* Reset font weights untuk text elements - menggunakan ukuran standar */
.text-xl.font-semibold,
.text-2xl.font-bold,
.text-3xl.font-bold {
  font-weight: 600; /* Semibold standar */
}

.text-base.font-medium,
.text-lg.font-medium,
.text-lg.font-semibold,
.text-xl.font-semibold {
  font-weight: 500; /* Medium weight */
}

/* Enhanced visibility untuk choice radio buttons */
input[type="radio"] {
  width: 1.125rem;
  height: 1.125rem;
  margin-right: 0.5rem;
}

/* Improved container untuk mencegah overflow */
.ckeditor-content {
  word-wrap: break-word;
  overflow-wrap: break-word;
  hyphens: auto;
  max-width: 100%;
}

.ckeditor-content * {
  max-width: 100%;
  box-sizing: border-box;
}

/* Styling khusus untuk question text */
.question-text {
  font-size: 1.25rem; /* 20px standar */
  line-height: 1.5;
  font-weight: 600; /* Semibold untuk pertanyaan */
}

.choice-text {
  font-size: 1rem; /* 16px standar */
  line-height: 1.5;
  font-weight: 400; /* Normal weight untuk pilihan */
}

/* Pastikan semua choice text memiliki styling yang konsisten */
.choice-text,
.choice-text p,
.choice-text span,
.choice-text div {
  font-size: inherit !important;
  font-weight: 400 !important;
  line-height: inherit !important;
  font-family: inherit !important;
}

/* Override untuk bold dalam choice text agar konsisten */
.choice-text strong,
.choice-text b,
.choice-text .bold {
  font-weight: 700 !important;
  font-size: inherit !important;
  color: inherit !important;
  background: none !important;
  text-shadow: none !important;
}

/* iPad dan tablet specific improvements */
@media screen and (min-width: 768px) and (max-width: 1024px) {
  .question-text {
    font-size: 1.375rem; /* 22px untuk tablet */
    line-height: 1.5;
  }
  
  .choice-text {
    font-size: 1.125rem; /* 18px untuk tablet */
    line-height: 1.5;
  }
  
  .choice-text * {
    font-size: inherit !important;
    line-height: inherit !important;
  }
  
  .ckeditor-content {
    font-size: 1rem;
  }
}

/* Mobile improvements */
@media screen and (max-width: 767px) {
  .question-text {
    font-size: 1.125rem; /* 18px untuk mobile */
    line-height: 1.4;
  }
  
  .choice-text {
    font-size: 0.975rem; /* 15.6px untuk mobile */
    line-height: 1.4;
  }
  
  .choice-text * {
    font-size: inherit !important;
    line-height: inherit !important;
  }
}

/* Container overflow prevention - ukuran standar */
.max-w-6xl {
  padding-left: 1rem;
  padding-right: 1rem;
  overflow-x: hidden;
}

.bg-white.dark\\:bg-gray-800.rounded-2xl {
  padding: 1.5rem;
  margin: 0.5rem 0;
  overflow: hidden;
}

/* Ensure proper text wrapping in all contexts */
.ckeditor-content p,
.ckeditor-content div,
.ckeditor-content span {
  word-break: break-word;
  overflow-wrap: break-word;
  white-space: normal;
}

/* Enhanced contrast untuk bold/italic/underline - tanpa text shadow berlebihan */
.ckeditor-content strong,
.ckeditor-content b {
  font-weight: 700; /* Bold yang jelas */
}

.ckeditor-content em,
.ckeditor-content i {
  font-style: italic;
  font-weight: 500; /* Sedikit lebih tebal untuk italic */
}

.ckeditor-content u {
  text-decoration: underline;
  text-decoration-thickness: 1.5px; /* Underline yang lebih jelas */
}

/* Remove any blue styling from math formulas in question content */
.ckeditor-content .math-formula,
.ckeditor-content .latex-formula,
.ckeditor-content span[data-latex] {
  background: transparent !important;
  border: none !important;
  box-shadow: none !important;
  padding: 0 !important;
  margin: 0 !important;
  color: inherit !important;
  display: inline !important;
}

/* Ensure no blue highlighting on any spans or special elements */
.ckeditor-content span {
  background: transparent !important;
  border: none !important;
  box-shadow: none !important;
}

/* Force consistent styling untuk semua choice elements */
.choice-text span,
.choice-text p,
.choice-text div {
  font-weight: inherit !important;
  font-size: inherit !important;
  background: transparent !important;
  border: none !important;
  color: inherit !important;
  text-shadow: none !important;
}

/* Normalize CKEditor generated content dalam choices */
.choice-text .ckeditor-content * {
  font-weight: 400 !important;
  font-size: inherit !important;
  line-height: inherit !important;
}

.choice-text .ckeditor-content strong,
.choice-text .ckeditor-content b {
  font-weight: 700 !important;
}

.ckeditor-content img {
  max-width: 100% !important;
  height: auto !important;
  display: block;
  margin: 1rem auto;
  border-radius: 8px;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  transition: opacity 0.3s ease;
}

.ckeditor-content img[src=""], .ckeditor-content img:not([src]) {
  display: none;
}

.ckeditor-content img.loading {
  opacity: 0.5;
}

.ckeditor-content img.error {
  display: block;
  width: 100%;
  height: 200px;
  background-color: #f3f4f6;
  border: 2px dashed #d1d5db;
  position: relative;
}

.ckeditor-content img.error:after {
  content: "Gambar tidak dapat dimuat";
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: #6b7280;
  font-size: 14px;
}

/* CSS khusus untuk grid navigasi */
.navigation-grid {
  display: grid !important;
  grid-template-columns: repeat(5, 1fr) !important;
  gap: 0.75rem !important;
}

@media (min-width: 640px) {
  .navigation-grid {
    grid-template-columns: repeat(8, 1fr) !important;
  }
}

@media (min-width: 768px) {
  .navigation-grid {
    grid-template-columns: repeat(10, 1fr) !important;
  }
}

@media (min-width: 1024px) {
  .navigation-grid {
    grid-template-columns: repeat(12, 1fr) !important;
  }
}

/* Navigation button styles */
.nav-button {
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  min-width: 3rem !important;
  width: 3rem !important;
  height: 3rem !important;
  font-size: 0.875rem !important;
  font-weight: 700 !important;
  border-radius: 0.5rem !important;
  border-width: 2px !important;
  transition: all 0.2s ease !important;
  text-decoration: none !important;
  flex-shrink: 0 !important;
}

.nav-button:hover {
  transform: scale(1.05) !important;
}

.nav-button.current {
  background-color: #3b82f6 !important;
  border-color: #2563eb !important;
  color: white !important;
}

.nav-button.current:hover {
  background-color: #2563eb !important;
}

.nav-button.answered {
  background-color: #22c55e !important;
  border-color: #16a34a !important;
  color: white !important;
}

.nav-button.answered:hover {
  background-color: #16a34a !important;
}

.nav-button.unanswered {
  background-color: #e5e7eb !important;
  border-color: #d1d5db !important;
  color: #374151 !important;
}

.nav-button.unanswered:hover {
  background-color: #d1d5db !important;
  border-color: #9ca3af !important;
}

/* Smooth collapse/expand for navigation panel */
#navigation-panel {
    overflow: hidden;
    max-height: 2000px; /* large enough for full content */
    opacity: 1;
    transition: max-height 350ms ease, opacity 300ms ease, padding 300ms ease;
}

#navigation-panel.collapsed {
    max-height: 0 !important;
    opacity: 0 !important;
    padding-top: 0 !important;
    padding-bottom: 0 !important;
}

/* Mobile specific tweaks to improve readability */
@media (max-width: 639px) {
    .navigation-grid {
        grid-template-columns: repeat(4, 1fr) !important;
        gap: 0.5rem !important;
    }

    .nav-button {
        min-width: 2.25rem !important;
        width: 2.25rem !important;
        height: 2.25rem !important;
        font-size: 0.7rem !important;
    }

    /* reduce container horizontal padding for better fit */
    .max-w-6xl.mx-auto.p-6 {
        padding-left: 0.75rem !important;
        padding-right: 0.75rem !important;
    }

    /* make saving indicator smaller on mobile */
    #saving-indicator {
        right: 0.5rem !important;
        top: auto !important;
        bottom: 1rem !important;
    }
    
    .question-text {
        font-size: 1rem; /* 16px untuk mobile */
        line-height: 1.4;
        font-weight: 600;
    }
    
    .choice-text {
        font-size: 0.975rem; /* 15.6px untuk mobile */
        line-height: 1.4;
        font-weight: 400;
    }
    
    /* Pastikan consistency pada mobile juga */
    .choice-text *,
    .choice-text span,
    .choice-text p {
        font-size: inherit !important;
        font-weight: 400 !important;
        line-height: inherit !important;
    }
    
    .choice-text strong,
    .choice-text b {
        font-weight: 700 !important;
        font-size: inherit !important;
    }

    /* Ensure hidden elements stay hidden */
    .hidden {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
    }
    
    /* Ensure saving indicator transitions work properly */
    #saving-indicator.hidden {
        transform: translateX(100%) !important;
        opacity: 0 !important;
        visibility: hidden !important;
    }
    
    /* Ensure no blue boxes appear for math formulas or special elements */
    .MathJax {
        background: transparent !important;
        border: none !important;
        box-shadow: none !important;
    }
    
    .MathJax_Display {
        background: transparent !important;
        border: none !important;
        box-shadow: none !important;
    }
    
    /* Remove any unwanted blue highlighting or boxes */
    .math-formula, .latex-formula {
        background: transparent !important;
        border: none !important;
        box-shadow: none !important;
    }
    
    /* Ensure no unexpected blue boxes on any elements */
    *:not(.nav-button):not(.bg-blue-500):not(.border-blue-600):not([class*="from-blue"]):not([class*="to-blue"]) {
        box-shadow: none !important;
    }
    
    /* Aggressively remove blue styling from content elements */
    .ckeditor-content *:not(.bg-blue-500):not(.border-blue-600) {
        background-color: transparent !important;
        background: transparent !important;
        border-color: transparent !important;
        box-shadow: none !important;
    }
    
    /* Specifically target math formula elements */
    .math-formula, .latex-formula, span[data-latex], span[class*="math"], span[class*="formula"] {
        background-color: transparent !important;
        background: transparent !important;
        border: none !important;
        border-color: transparent !important;
        box-shadow: none !important;
        padding: 0 !important;
        margin: 0 2px !important;
    }
}
</style>

<script>
// Support both package and single-category tests
const isPackage = {% if is_package %}true{% else %}false{% endif %};
const PACKAGE_ID = {% if package %}{{ package.id }}{% else %}null{% endif %};
const CATEGORY_ID = {% if category %}{{ category.id }}{% else %}null{% endif %};
const storageKeyId = isPackage ? `package_${PACKAGE_ID}` : `category_${CATEGORY_ID}`;
let markedQuestions = JSON.parse(localStorage.getItem('markedQuestions_' + storageKeyId) || '[]');
let currentQuestionNumber = {{ current_question_number }}; // Menggunakan question number, bukan ID

// Update tampilan tombol mark berdasarkan status
function updateMarkButtonState() {
    const bookmarkIcon = document.getElementById('bookmark-icon');
    const checkIcon = document.getElementById('check-icon');
    const markText = document.getElementById('mark-text');
    const markButton = document.getElementById('mark-button');
    
    if (markedQuestions.includes(currentQuestionNumber)) {
        // Soal sudah ditandai
        bookmarkIcon.style.display = 'none';
        checkIcon.style.display = 'block';
        markText.textContent = 'Sudah Ditandai';
        markButton.classList.add('bg-yellow-100', 'border-yellow-400');
        markButton.classList.remove('bg-white', 'border-yellow-200');
    } else {
        // Soal belum ditandai
        bookmarkIcon.style.display = 'block';
        checkIcon.style.display = 'none';
        markText.textContent = 'Tandai Soal';
        markButton.classList.remove('bg-yellow-100', 'border-yellow-400');
        markButton.classList.add('bg-white', 'border-yellow-200');
    }
}

// Timer variables
let remainingTime = {{ time_remaining.total_seconds|default:0|floatformat:0 }}; // seconds from backend
let timerInterval;

// Konversi answered_questions dari backend ke JavaScript array
let answeredQuestions = [{% for q_num in answered_question_numbers %}{{ q_num }}{% if not forloop.last %},{% endif %}{% endfor %}];
// Timer handle to avoid race between hide/show of the saving flyout
let savingHideTimer = null;

// Initialize timer
function initTimer() {
    if (remainingTime > 0) {
        timerInterval = setInterval(function() {
            remainingTime--;
            updateTimerDisplay();
            
            // Auto-submit when time is up
            if (remainingTime <= 0) {
                clearInterval(timerInterval);
                autoSubmitTest();
            }
            
            // Warning when 5 minutes left
            if (remainingTime === 300) { // 5 minutes
                showTimeWarning();
            }
        }, 1000);
    }
    
    updateTimerDisplay();
}

function updateTimerDisplay() {
    const hours = Math.floor(remainingTime / 3600);
    const minutes = Math.floor((remainingTime % 3600) / 60);
    const seconds = remainingTime % 60;
    
    const display = 
        String(hours).padStart(2, '0') + ':' + 
        String(minutes).padStart(2, '0') + ':' + 
        String(seconds).padStart(2, '0');
    
    const timerElement = document.getElementById('timer-display');
    if (timerElement) {
        timerElement.textContent = display;
        
        // Change color when time is running low
        if (remainingTime <= 300) { // 5 minutes
            timerElement.classList.add('text-red-200');
        }
    }
}

function showTimeWarning() {
    if (confirm('Waktu ujian tinggal 5 menit! Pastikan semua jawaban telah tersimpan.')) {
        // User acknowledged the warning
    }
}

function autoSubmitTest() {
    alert('Waktu ujian telah habis! Ujian akan diselesaikan secara otomatis.');
    
    // Clear localStorage for this test
    localStorage.removeItem('markedQuestions_' + storageKeyId);
    
    // Create and submit form (choose package or category submit url)
    const form = document.createElement('form');
    form.method = 'POST';
    {% if is_package %}
    form.action = '{% url "submit_package_test" package.id %}';
    {% else %}
    form.action = '{% url "submit_test" test.id %}';
    {% endif %}
    
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = csrfToken;
    form.appendChild(csrfInput);
    
    document.body.appendChild(form);
    form.submit();
}

// Show submit confirmation modal
function showSubmitConfirmation() {
    const selectedAnswer = document.querySelector('input[name="choice"]:checked');
    
    if (selectedAnswer) {
        // Add current question to answered questions if not already there
        if (!answeredQuestions.includes({{ current_question_number }})) {
            answeredQuestions.push({{ current_question_number }});
        }
        
        // Save the answer via AJAX before showing modal
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        formData.append('choice', selectedAnswer.value);
        
        // Save answer via fetch API
        fetch(window.location.href, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        }).then(response => {
            if (response.ok) {
                showModal();
            } else {
                console.error('Failed to save answer');
                showModal();
            }
        }).catch(error => {
            console.error('Error saving answer:', error);
            // Show modal anyway but warn user
            showModal();
        });
    } else {
        // No answer selected, show modal directly
        showModal();
    }
    
    function showModal() {
        const modal = document.getElementById('submit-modal');
        const answeredCount = answeredQuestions.length;
        const totalQuestions = {{ total_questions }};
        
        document.getElementById('answered-summary').textContent = answeredCount;
        
        // Update modal message based on completion status
        const modalText = document.querySelector('#submit-modal-text');
        if (answeredCount === totalQuestions) {
            modalText.innerHTML = 'Selamat! Anda telah menjawab semua soal. Apakah Anda yakin ingin menyelesaikan ujian? Setelah ujian diselesaikan, Anda tidak dapat mengubah jawaban lagi.';
            modalText.classList.remove('text-gray-500', 'dark:text-gray-300');
            modalText.classList.add('text-green-600', 'dark:text-green-400');
        } else {
            modalText.innerHTML = `Anda masih memiliki <strong>${totalQuestions - answeredCount}</strong> soal yang belum dijawab. Apakah Anda yakin ingin menyelesaikan ujian? Setelah ujian diselesaikan, Anda tidak dapat mengubah jawaban lagi.`;
            modalText.classList.remove('text-green-600', 'dark:text-green-400');
            modalText.classList.add('text-gray-500', 'dark:text-gray-300');
        }
        
        modal.style.display = 'block';
    }
}

// Hide submit confirmation modal
function hideSubmitConfirmation() {
    const modal = document.getElementById('submit-modal');
    modal.style.display = 'none';
}

// Submit test function
function submitTest() {
    // Clear localStorage when test is submitted manually
    localStorage.removeItem('markedQuestions_' + storageKeyId);
    
    // Create and submit form (choose package or single test submission)
    const form = document.createElement('form');
    form.method = 'POST';
    {% if is_package %}
    form.action = '{% url "submit_package_test" package.id %}';
    {% else %}
    form.action = '{% url "submit_test" test.id %}';
    {% endif %}
    
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = csrfToken;
    form.appendChild(csrfInput);
    
    const actionInput = document.createElement('input');
    actionInput.type = 'hidden';
    actionInput.name = 'action';
    actionInput.value = 'submit';
    form.appendChild(actionInput);
    
    document.body.appendChild(form);
    form.submit();
}

// Prevent accidental page close/refresh
function confirmExit() {
    return 'Ujian sedang berlangsung. Jika Anda meninggalkan halaman, progress ujian akan tetap tersimpan tetapi timer akan terus berjalan. Apakah Anda yakin ingin keluar?';
}

// Fungsi toggle navigasi
function toggleNavigation() {
    const panel = document.getElementById('navigation-panel');
    const icon = document.getElementById('nav-toggle-icon');
    const text = document.getElementById('nav-toggle-text');

    if (!panel.classList.contains('collapsed')) {
        // collapse
        panel.classList.add('collapsed');
    // after collapsing the panel, show a down-arrow (indicates expandable)
    icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"></path>';
    text.textContent = 'Tampilkan';
    } else {
        // expand
        panel.classList.remove('collapsed');
    // after expanding the panel, show an up-arrow (indicates collapsible)
    icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7"></path>';
    text.textContent = 'Sembunyikan';
    }
}

// Fungsi menandai soal  
function markAsDoubtful() {
    const btn = event.target.closest('button');
    const bookmarkIcon = document.getElementById('bookmark-icon');
    const checkIcon = document.getElementById('check-icon');
    const markText = document.getElementById('mark-text');
    
    if (!markedQuestions.includes(currentQuestionNumber)) {
        // Tandai soal
        markedQuestions.push(currentQuestionNumber);
        
        // Update visual - show checkmark
        bookmarkIcon.style.display = 'none';
        checkIcon.style.display = 'block';
        markText.textContent = 'Sudah Ditandai';
        
        // Update button style
        btn.classList.add('bg-yellow-100', 'border-yellow-400');
        btn.classList.remove('bg-white', 'border-yellow-200');
    } else {
        // Hapus tanda
        markedQuestions = markedQuestions.filter(num => num !== currentQuestionNumber);
        
        // Update visual - show bookmark
        bookmarkIcon.style.display = 'block';
        checkIcon.style.display = 'none';
        markText.textContent = 'Tandai Soal';
        
        // Update button style
        btn.classList.remove('bg-yellow-100', 'border-yellow-400');
        btn.classList.add('bg-white', 'border-yellow-200');
    }
    
    // use unified storage key id
    localStorage.setItem('markedQuestions_' + storageKeyId, JSON.stringify(markedQuestions));
    updateNavigationColors();
}

// Save answer function
function saveAnswer() {
    const selectedAnswer = document.querySelector('input[name="choice"]:checked');
    if (!selectedAnswer) return;

    // Add current question to answeredQuestions if not already there (for real-time UI)
    if (!answeredQuestions.includes({{ current_question_number }})) {
        answeredQuestions.push({{ current_question_number }});
    }
    // Update progress bar & stats immediately for real-time feedback
    updateNavigationColors();
    updateStats();

    // Show saving indicator flyout (no layout shift)
    showSavingIndicator();

    // Send AJAX request to save answer
    const formData = new FormData();
    formData.append('choice', selectedAnswer.value);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

    fetch(window.location.href, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
    // Hide saving indicator flyout
    hideSavingIndicator();

        if (data.status === 'success') {
            showSaveConfirmation();
            // (No need to update UI again here, already done above)
        } else {
            showSaveError();
        }
    })
    .catch(error => {
        console.error('Error:', error);
    // Hide saving indicator flyout
    hideSavingIndicator();
        showSaveError();
    });
}

// Save essay answer function
function saveEssayAnswer() {
    const textAnswer = document.getElementById('text_answer');
    if (!textAnswer) return;

    const answer = textAnswer.value.trim();
    
    // Add current question to answeredQuestions if not already there (for real-time UI)
    if (!answeredQuestions.includes({{ current_question_number }})) {
        answeredQuestions.push({{ current_question_number }});
    }
    // Update progress bar & stats immediately for real-time feedback
    updateNavigationColors();
    updateStats();

    // Show saving indicator flyout (no layout shift)
    showSavingIndicator();

    // Send AJAX request to save essay answer
    const formData = new FormData();
    formData.append('text_answer', answer);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

    fetch(window.location.href, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        // Hide saving indicator flyout
        hideSavingIndicator();

        if (data.status === 'success') {
            showSaveConfirmation();
            // (No need to update UI again here, already done above)
        } else {
            showSaveError();
        }
    })
    .catch(error => {
        console.error('Error saving essay answer:', error);
        // Hide saving indicator flyout
        hideSavingIndicator();
        showSaveError();
    });
}

// Fungsi update warna navigasi berdasarkan status backend dan localStorage
function updateNavigationColors() {
    const answeredQuestionsSet = new Set(answeredQuestions.map(id => parseInt(id)));
    
    document.querySelectorAll('.nav-button').forEach(button => {
        const questionIndex = parseInt(button.dataset.questionIndex);
        const currentIndex = {{ current_question_number }};
        
        // Reset semua kelas status
        button.classList.remove('marked', 'answered', 'unanswered', 'current');
        
        // Reset warna default
        button.classList.remove('bg-blue-500', 'border-blue-600', 'text-white',
                                'bg-green-500', 'border-green-600', 
                                'bg-yellow-500', 'border-yellow-600',
                                'bg-gray-200', 'border-gray-300', 'text-gray-700');
        
        // Tentukan status berdasarkan prioritas
        if (questionIndex === currentIndex) {
            // Soal sedang dikerjakan (prioritas tertinggi)
            button.classList.add('current', 'bg-blue-500', 'border-blue-600', 'text-white');
        } else if (markedQuestions.includes(questionIndex)) {
            // Soal ditandai (prioritas kedua)
            button.classList.add('marked', 'bg-yellow-500', 'border-yellow-600', 'text-white');
        } else if (answeredQuestionsSet.has(questionIndex)) {
            // Soal sudah dijawab (prioritas ketiga)
            button.classList.add('answered', 'bg-green-500', 'border-green-600', 'text-white');
        } else {
            // Soal belum dijawab (default)
            button.classList.add('unanswered', 'bg-gray-200', 'border-gray-300', 'text-gray-700');
        }
    });
    
    // Update statistik
    updateStats();
}

// Fungsi update statistik
function updateStats() {
    const totalQuestions = {{ total_questions }};

    // Use client-side answeredQuestions array as the source of truth for immediate UI updates
    const uniqueAnswered = new Set(answeredQuestions.map(id => Number(id)));
    const answeredCount = uniqueAnswered.size;

    // Count marked buttons from DOM (localStorage-backed)
    const markedButtons = document.querySelectorAll('.nav-button.marked');
    const markedCount = markedButtons.length;

    const remainingCount = Math.max(0, totalQuestions - answeredCount);

    // Update counters in the UI
    const answeredEl = document.getElementById('answered-count');
    const doubtfulEl = document.getElementById('doubtful-count');
    const remainingEl = document.getElementById('remaining-count');

    if (answeredEl) answeredEl.textContent = answeredCount;
    if (doubtfulEl) doubtfulEl.textContent = markedCount;
    if (remainingEl) remainingEl.textContent = remainingCount;

    // Update progress bar berdasarkan soal yang dijawab (client-side)
    updateProgressBar(answeredCount, totalQuestions);

    // Update submit button color based on completion status
    updateSubmitButtonColor(answeredCount, totalQuestions);
}

// Fungsi update warna tombol selesai ujian
function updateSubmitButtonColor(answeredCount, totalQuestions) {
    const submitBtns = document.querySelectorAll('#submit-test-btn, button[name="action"][value="submit"]');
    
    submitBtns.forEach(submitBtn => {
        if (!submitBtn) return;
        
        // Remove all existing color classes
        submitBtn.classList.remove(
            'bg-red-600', 'hover:bg-red-700', 'focus:ring-red-500',
            'bg-green-600', 'hover:bg-green-700', 'focus:ring-green-500',
            'text-white'
        );
        
        if (answeredCount === totalQuestions) {
            // All questions answered - Green button
            submitBtn.classList.add(
                'text-white', 
                'bg-green-600', 
                'hover:bg-green-700', 
                'focus:ring-green-500'
            );
            submitBtn.title = 'Semua soal telah dijawab. Klik untuk menyelesaikan ujian.';
        } else {
            // Not all questions answered - Red button
            submitBtn.classList.add(
                'text-white', 
                'bg-red-600', 
                'hover:bg-red-700', 
                'focus:ring-red-500'
            );
            submitBtn.title = `${totalQuestions - answeredCount} soal belum dijawab. Pastikan semua soal telah dijawab sebelum menyelesaikan ujian.`;
        }
    });
}

// Fungsi untuk menampilkan feedback visual bahwa jawaban tersimpan
function showSaveConfirmation() {
    // Reuse the saving-indicator flyout to show success state (prevents duplicate notifications)
    const el = document.getElementById('saving-indicator');
    if (!el) return;

    // Replace spinner content with success content
    el.innerHTML = `
        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path>
        </svg>
        <span>Jawaban tersimpan</span>
    `;

    // adjust classes to success look
    el.classList.remove('bg-indigo-50', 'dark:bg-indigo-900/30', 'text-indigo-600', 'dark:text-indigo-400', 'border-indigo-200', 'dark:border-indigo-700');
    el.classList.add('bg-green-500', 'text-white', 'border-green-600');

    // Ensure it's visible (slide in)
    if (savingHideTimer) {
        clearTimeout(savingHideTimer);
        savingHideTimer = null;
    }
    el.classList.remove('hidden');
    requestAnimationFrame(() => {
        el.classList.remove('translate-x-full', 'opacity-0');
        el.classList.add('translate-x-0', 'opacity-100');
    });

    // After short delay, hide again and restore original saving markup for next use
    // keep visible longer so user can notice the confirmation
    savingHideTimer = setTimeout(() => {
        el.classList.remove('translate-x-0', 'opacity-100');
        el.classList.add('translate-x-full', 'opacity-0');
        setTimeout(() => {
            // restore original saving content and classes
            el.innerHTML = `
                <svg class="animate-spin w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                <span>Menyimpan jawaban...</span>
            `;
            el.classList.remove('bg-green-500', 'text-white', 'border-green-600');
            el.classList.add('bg-indigo-50', 'dark:bg-indigo-900/30', 'text-indigo-600', 'dark:text-indigo-400', 'border-indigo-200', 'dark:border-indigo-700');
            el.classList.add('hidden');
            savingHideTimer = null;
        }, 220);
    }, 1500);
}

function showSaveError() {
    // Reuse saving-indicator flyout for error state
    const el = document.getElementById('saving-indicator');
    if (!el) return;

    el.innerHTML = `
        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
        <span>Gagal menyimpan jawaban</span>
    `;

    el.classList.remove('bg-indigo-50', 'dark:bg-indigo-900/30', 'text-indigo-600', 'dark:text-indigo-400', 'border-indigo-200', 'dark:border-indigo-700');
    el.classList.add('bg-red-500', 'text-white', 'border-red-600');

    if (savingHideTimer) {
        clearTimeout(savingHideTimer);
        savingHideTimer = null;
    }
    el.classList.remove('hidden');
    requestAnimationFrame(() => {
        el.classList.remove('translate-x-full', 'opacity-0');
        el.classList.add('translate-x-0', 'opacity-100');
    });

    // show error longer so user sees it
    savingHideTimer = setTimeout(() => {
        el.classList.remove('translate-x-0', 'opacity-100');
        el.classList.add('translate-x-full', 'opacity-0');
        setTimeout(() => {
            // restore original saving content and classes
            el.innerHTML = `
                <svg class="animate-spin w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                <span>Menyimpan jawaban...</span>
            `;
            el.classList.remove('bg-red-500', 'text-white', 'border-red-600');
            el.classList.add('bg-indigo-50', 'dark:bg-indigo-900/30', 'text-indigo-600', 'dark:text-indigo-400', 'border-indigo-200', 'dark:border-indigo-700');
            el.classList.add('hidden');
            savingHideTimer = null;
        }, 220);
    }, 1750);
}

// Fungsi update progress bar
function updateProgressBar(answeredCount, totalQuestions) {
    const percentage = Math.round((answeredCount / totalQuestions) * 100);
    const progressBar = document.getElementById('progress-bar');
    const progressPercentage = document.getElementById('progress-percentage');
    
    if (progressBar && progressPercentage) {
        progressBar.style.width = percentage + '%';
        progressPercentage.textContent = percentage + '%';
    }
}

    // Show/hide saving indicator (flyout) without causing layout shifts
    function showSavingIndicator() {
        const el = document.getElementById('saving-indicator');
        if (!el) return;
        el.classList.remove('hidden');
        // trigger transition to slide in
        requestAnimationFrame(() => {
            el.classList.remove('translate-x-full', 'opacity-0');
            el.classList.add('translate-x-0', 'opacity-100');
        });
    }

    function hideSavingIndicator() {
        const el = document.getElementById('saving-indicator');
        if (!el) return;
        // slide out, then hide after transition
        el.classList.remove('translate-x-0', 'opacity-100');
        el.classList.add('translate-x-full', 'opacity-0');
        if (savingHideTimer) {
            clearTimeout(savingHideTimer);
            savingHideTimer = null;
        }
        savingHideTimer = setTimeout(() => {
            el.classList.add('hidden');
            savingHideTimer = null;
        }, 220);
    }

// Comprehensive cleanup function for blue elements
function cleanupBlueElements() {
    // Remove blue styling from all math formula elements
    const mathSelectors = [
        '.math-formula',
        '.latex-formula',
        'span[data-latex]',
        'span[class*="math"]',
        'span[class*="formula"]',
        '.ckeditor-content span'
    ];
    
    mathSelectors.forEach(selector => {
        const elements = document.querySelectorAll(selector);
        elements.forEach(el => {
            // Remove blue classes
            const blueClasses = ['bg-blue-500', 'bg-blue-400', 'bg-blue-300', 'bg-indigo-50', 'border-blue-600', 'border-indigo-200'];
            blueClasses.forEach(cls => el.classList.remove(cls));
            
            // Remove blue inline styles
            if (el.style.backgroundColor && (
                el.style.backgroundColor.includes('blue') || 
                el.style.backgroundColor.includes('rgb(59, 130, 246)') ||
                el.style.backgroundColor.includes('rgb(239, 246, 255)') ||
                el.style.backgroundColor.includes('#eff6ff') ||
                el.style.backgroundColor.includes('#3b82f6')
            )) {
                el.style.backgroundColor = 'transparent';
            }
            
            if (el.style.borderColor && (
                el.style.borderColor.includes('blue') ||
                el.style.borderColor.includes('rgb(59, 130, 246)')
            )) {
                el.style.borderColor = 'transparent';
                el.style.border = 'none';
            }
            
            // Remove other styling that might cause visual issues
            if (!el.classList.contains('nav-button') && 
                !el.classList.contains('bg-blue-500') && 
                !el.closest('button')) {
                el.style.boxShadow = 'none';
                el.style.padding = '0';
                el.style.margin = '0 1px';
            }
        });
    });
    
    console.log(' Blue element cleanup completed');
}

// Inisialisasi saat halaman dimuat
document.addEventListener('DOMContentLoaded', function() {
    // Initialize timer
    initTimer();
    
    // Ensure saving indicator is properly hidden on page load
    const savingIndicator = document.getElementById('saving-indicator');
    if (savingIndicator) {
        savingIndicator.classList.add('hidden', 'translate-x-full', 'opacity-0');
        savingIndicator.classList.remove('translate-x-0', 'opacity-100');
        savingIndicator.style.display = 'none';
        savingIndicator.style.visibility = 'hidden';
    }
    
    // Ensure submit modal is properly hidden
    const submitModal = document.getElementById('submit-modal');
    if (submitModal) {
        submitModal.classList.add('hidden');
        submitModal.style.display = 'none';
    }
    
    // Remove any stray blue boxes or unwanted elements
    setTimeout(() => {
        // Check for any elements that might be causing blue box appearance
        const unwantedElements = document.querySelectorAll('[style*="background-color: blue"], [style*="background: blue"], .bg-blue-400, .bg-blue-300');
        unwantedElements.forEach(el => {
            if (!el.classList.contains('nav-button') && !el.classList.contains('bg-blue-500')) {
                el.style.background = 'transparent';
                el.style.border = 'none';
                el.style.boxShadow = 'none';
            }
        });
        
        // Clean up any math formula elements with blue styling in question content
        const mathElements = document.querySelectorAll('.ckeditor-content .math-formula, .ckeditor-content .latex-formula, .ckeditor-content span[data-latex]');
        mathElements.forEach(el => {
            el.style.background = 'transparent';
            el.style.backgroundColor = 'transparent';
            el.style.border = 'none';
            el.style.borderColor = 'transparent';
            el.style.boxShadow = 'none';
            el.style.padding = '0';
            el.style.margin = '0';
            el.classList.remove('bg-blue-500', 'border-blue-600', 'bg-indigo-50', 'border-indigo-200');
        });
        
        // Remove blue styling from any spans in question content
        const questionSpans = document.querySelectorAll('.ckeditor-content span');
        questionSpans.forEach(span => {
            if (span.style.backgroundColor && (span.style.backgroundColor.includes('blue') || span.style.backgroundColor.includes('rgb(59, 130, 246)'))) {
                span.style.backgroundColor = 'transparent';
                span.style.borderColor = 'transparent';
                span.style.border = 'none';
            }
        });
    }, 100);
    
    // Set up page exit confirmation
    window.addEventListener('beforeunload', confirmExit);
    
    updateNavigationColors();
    updateStats();
    
    // Initialize submit button color
    const totalQuestions = {{ total_questions }};
    const initialAnsweredCount = answeredQuestions.length;
    updateSubmitButtonColor(initialAnsweredCount, totalQuestions);
    
    // Inisialisasi progress bar berdasarkan soal yang sudah dijawab
    updateProgressBar(initialAnsweredCount, totalQuestions);
    
    // Event listener untuk radio buttons - auto-save dan update navigasi
    document.querySelectorAll('input[name="choice"]').forEach(radio => {
        radio.addEventListener('change', function() {
            saveAnswer();
        });
    });
    
    // Modal event listeners
    document.getElementById('cancel-submit').addEventListener('click', hideSubmitConfirmation);
    
    // Add event listener untuk tombol submit yang menggunakan modal
    document.querySelectorAll('button[onclick*="showSubmitConfirmation"]').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            showSubmitConfirmation();
        });
    });
    
    // Handle image loading in CKEditor content
    function handleImageLoading() {
        const images = document.querySelectorAll('.ckeditor-content img');
        images.forEach(img => {
            img.addEventListener('load', function() {
                this.classList.remove('loading', 'error');
            });
            
            img.addEventListener('error', function() {
                console.warn('Failed to load image:', this.src);
            });
            
            // Add loading class initially
            if (!img.complete) {
                img.classList.add('loading');
            }
        });
    }
    
    // Initialize image loading handlers
    handleImageLoading();
    
    // Update mark button state based on localStorage
    updateMarkButtonState();
    
    // Update navigation colors
    updateNavigationColors();
    
    // Additional cleanup for blue elements after everything is loaded
    setTimeout(() => {
        cleanupBlueElements();
        
        // Set up mutation observer to catch any dynamically added blue elements
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                mutation.addedNodes.forEach((node) => {
                    if (node.nodeType === 1) { // Element node
                        // Check if the added node or its children have blue styling
                        const blueElements = node.querySelectorAll ? 
                            node.querySelectorAll('.math-formula, .latex-formula, span[data-latex], span[style*="blue"]') : [];
                        
                        [node, ...blueElements].forEach(el => {
                            if (el && el.style && !el.classList.contains('nav-button')) {
                                if (el.style.backgroundColor && el.style.backgroundColor.includes('blue')) {
                                    el.style.backgroundColor = 'transparent';
                                }
                                if (el.style.borderColor && el.style.borderColor.includes('blue')) {
                                    el.style.borderColor = 'transparent';
                                    el.style.border = 'none';
                                }
                            }
                        });
                    }
                });
            });
        });
        
        // Start observing
        observer.observe(document.body, {
            childList: true,
            subtree: true,
            attributes: true,
            attributeFilter: ['style', 'class']
        });
    }, 500);

    // Subtest filtering: if package_subtests present, wire the select to filter nav
    const subtestSelect = document.getElementById('subtest-select');
    if (subtestSelect) {
        function applySubtestFilter() {
            try {
                const val = subtestSelect.value;
                if (val === 'all') {
                    document.querySelectorAll('.nav-button').forEach(b => { b.style.removeProperty('display'); b.removeAttribute('aria-hidden'); });
                } else {
                    const [startStr, endStr] = val.split('-');
                    const start = parseInt(startStr, 10);
                    const end = parseInt(endStr, 10);
                    document.querySelectorAll('.nav-button').forEach(b => {
                        const idx = parseInt(b.dataset.questionIndex, 10);
                        const match = (idx >= start && idx <= end);
                        if (match) { b.style.removeProperty('display'); b.removeAttribute('aria-hidden'); } else { b.style.setProperty('display','none','important'); b.setAttribute('aria-hidden','true'); }
                    });
                }
            } catch (err) {
                console.error('applySubtestFilter error', err);
            }
        }
        subtestSelect.addEventListener('change', applySubtestFilter);
        // apply initial filter on load
        applySubtestFilter();
    } else {
        // no subtest-select present
    }

    // Intercept Next navigation to warn when crossing subtest boundary
    const answerForm = document.getElementById('answer-form');
    const nextButton = answerForm.querySelector('button[name="action"][value="next"]');
    // Build mapping from question index to subtest range from server-provided package_subtests
    let subtestRanges = [];
    {% if is_package and package_subtests %}
    subtestRanges = [
        {% for s in package_subtests %}{ start: {{ s.start }}, end: {{ s.start|add:s.count|add:'-1' }}, name: '{{ s.category_name|escapejs }}' }{% if not forloop.last %},{% endif %}{% endfor %}
    ];
    {% endif %}

    function findSubtestForIndex(idx){
        for (const r of subtestRanges) if (idx >= r.start && idx <= r.end) return r;
        return null;
    }

    if (nextButton) {
        nextButton.addEventListener('click', function(e){
            // determine target index
            const target = {{ current_question_number }} + 1;
            const currentSub = findSubtestForIndex({{ current_question_number }});
            const targetSub = findSubtestForIndex(target);
            if (currentSub && targetSub && currentSub.name !== targetSub.name) {
                // show modal asking to continue to next subtest
                e.preventDefault();
                showNextSubtestModal(currentSub.name, targetSub.name, function(){
                    // when confirmed, add hidden flags and submit the form programmatically
                    let existingConfirm = answerForm.querySelector('input[name="confirm_next_subtest"]');
                    if (!existingConfirm) {
                        existingConfirm = document.createElement('input');
                        existingConfirm.type = 'hidden'; existingConfirm.name = 'confirm_next_subtest'; existingConfirm.value = '1';
                        answerForm.appendChild(existingConfirm);
                    } else {
                        existingConfirm.value = '1';
                    }

                    // Ensure action='next' is present (programmatic submit doesn't include clicked button value)
                    let actionHidden = answerForm.querySelector('input[name="action"]');
                    if (!actionHidden) {
                        actionHidden = document.createElement('input');
                        actionHidden.type = 'hidden'; actionHidden.name = 'action'; actionHidden.value = 'next';
                        answerForm.appendChild(actionHidden);
                    } else {
                        actionHidden.value = 'next';
                    }

                    answerForm.submit();
                });
            }
            // otherwise allow normal submit
        });
    }

    // Modal for confirming moving to next subtest
    function showNextSubtestModal(fromName, toName, onConfirm){
        // create a simple modal using existing modal styles
        let modal = document.getElementById('next-subtest-modal');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'next-subtest-modal';
            modal.className = 'fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center hidden';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-lg max-w-md w-full p-6 shadow-2xl">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">Lanjut ke Subtest Berikutnya?</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">Anda akan berpindah dari subtest <strong id="modal-from"></strong> ke <strong id="modal-to"></strong>. Lanjutkan?</p>
                    <div class="flex justify-end gap-3">
                        <button id="modal-cancel" class="px-4 py-2 bg-gray-300 dark:bg-gray-600 rounded">Batal</button>
                        <button id="modal-confirm" class="px-4 py-2 bg-blue-600 text-white rounded">Lanjutkan</button>
                    </div>
                </div>`;
            document.body.appendChild(modal);
        }
        modal.querySelector('#modal-from').textContent = fromName;
        modal.querySelector('#modal-to').textContent = toName;
        modal.classList.remove('hidden');
        modal.querySelector('#modal-cancel').onclick = function(){ modal.classList.add('hidden'); };
        modal.querySelector('#modal-confirm').onclick = function(){ modal.classList.add('hidden'); if (onConfirm) onConfirm(); };
    }
});
</script>

{% endblock %}
