{% extends 'base.html' %}
{% load custom_filters %}
{% load media_helpers %}

{% block title %}{% if is_package %}{{ package.package_name }}{% else %}{{ category.category_name }}{% endif %} - Soal {{ current_question_number }}{% endblock %}

{% block content %}
<!-- Immediate CSS to prevent flash of navbar/sidebar -->
<style>
/* Hide navigation elements immediately for exam mode */
#logo-sidebar,
nav.fixed,
header,
.topbar,
.navbar,
#topbar,
.site-header,
button[data-drawer-target="logo-sidebar"],
button[data-drawer-toggle="logo-sidebar"],
button[data-dropdown-toggle="dropdown-user"],
#theme-toggle,
#dropdown-user,
.flex.items-center.ms-3,
nav.fixed .flex.items-center.justify-between,
nav.fixed .px-3.py-3 {
    display: none !important;
}

/* Hide the entire top navigation bar */
nav {
    display: none !important;
}

/* Make main content full screen immediately */
main {
    padding-left: 0 !important;
    padding-top: 0 !important;
    margin: 0 !important;
}

/* Ensure body uses full viewport */
body {
    padding-top: 0 !important;
}

/* Make sure the main container uses full width */
.container {
    max-width: none !important;
    padding-left: 0 !important;
    padding-right: 0 !important;
}

/* Hide the div that contains the navbar padding */
.flex.pt-16 {
    padding-top: 0 !important;
}

/* Ensure main content is properly positioned */
main, .w-full {
    position: relative !important;
    z-index: 10 !important;
    background: inherit !important;
}

/* Protect button styling */
#submit-test-btn-primary,
#submit-test-btn-secondary,
button[onclick*="showSubmitConfirmation"],
button[name="action"][value="next"] {
    position: relative !important;
    z-index: 9999 !important;
}

/* Force button colors to override any conflicts */
#submit-test-btn-primary[style*="background-color"],
#submit-test-btn-secondary[style*="background-color"],
button[onclick*="showSubmitConfirmation"][style*="background-color"] {
    background-color: var(--bg-color, #dc2626) !important;
    color: white !important;
    border-color: var(--border-color, #b91c1c) !important;
}

/* Ensure Next button gradient is preserved */
button[name="action"][value="next"] {
    background: linear-gradient(to right, #2563eb, #1d4ed8) !important;
    color: white !important;
}
</style>

<!-- Desktop/Tablet: Two-column layout, Mobile: Stacked layout -->
<div class="w-full">
    <!-- Mobile: reduced padding, Desktop: normal spacing -->
    <div class="p-2 sm:p-3 lg:p-6 md:grid md:grid-cols-12 md:gap-6 space-y-3 md:space-y-0">
        
        <!-- Left Column: Banner + Question (Desktop: col-span-8, Mobile: full width) -->
        <div class="md:col-span-8 space-y-3 lg:space-y-6">
            <!-- Header Section -->
            <div class="bg-white dark:bg-gray-800 rounded-lg lg:rounded-2xl shadow-lg p-3 sm:p-4 lg:p-6 border border-gray-200 dark:border-gray-700">
                <div class="flex items-center justify-between mb-3 lg:mb-4">
                    <div class="flex items-center gap-3 lg:gap-4">
                        <div class="flex items-center justify-center w-10 h-10 lg:w-14 lg:h-14 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full">
                            <svg class="w-5 h-5 lg:w-8 lg:h-8 text-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        </div>
                        <div>
                            <h1 class="text-lg lg:text-2xl font-bold text-gray-800 dark:text-white">{% if is_package %}{{ package.package_name }}{% else %}{{ category.category_name }}{% endif %}</h1>
                            <p class="text-sm lg:text-lg text-gray-600 dark:text-gray-300">Soal {{ current_question_number }} dari {{ total_questions }}</p>
                        </div>
                    </div>
                    
                    <!-- Timer - visible on mobile, hidden on desktop (moved to right column) -->
                    <div class="lg:hidden">
                        {% if time_remaining %}
                        <div class="flex items-center gap-2 px-2 py-1 bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-700 rounded-md">
                            <svg class="w-4 h-4 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div id="timer-display-mobile" class="font-mono text-sm font-bold text-red-700 dark:text-red-300">00:00:00</div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Question Section -->
            <div class="bg-white dark:bg-gray-800 rounded-lg lg:rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700">
            <form method="post" class="p-3 sm:p-4 lg:p-8" id="answer-form">
            {% csrf_token %}
            
            <!-- Question Content -->
            <div class="mb-8">
                <div class="flex items-start gap-4 mb-6">
                    <div class="flex items-center justify-center w-8 h-8 bg-indigo-100 dark:bg-indigo-900 rounded-full flex-shrink-0 mt-1">
                        <span class="text-indigo-600 dark:text-indigo-400 font-bold text-sm">{{ current_question_number }}</span>
                    </div>
                    <div class="flex-1">
                        <div class="text-xl font-semibold text-gray-900 dark:text-white leading-relaxed ckeditor-content question-text">{{ question.question_text|safe }}</div>
                        {% if question.question_image %}
                        <div class="mt-4">
                            <img src="{{ question.question_image|safe_image_url }}" alt="Question Image" class="max-w-full w-full h-auto rounded-lg shadow-sm object-contain max-h-40 sm:max-h-60 md:max-h-80 lg:max-h-96">
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Answer Section -->
            <div class="space-y-4 mb-8">
                {% if question.question_type == 'multiple_choice' %}
                    <!-- Multiple Choice Answers -->
                    {% for choice in choices %}
                    <label for="choice_{{ choice.id }}" class="group flex items-center cursor-pointer p-3 sm:p-5 rounded-xl border-2 border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900 hover:bg-indigo-50 dark:hover:bg-indigo-900 hover:border-indigo-300 dark:hover:border-indigo-600 transition-all duration-200">
                        <!-- Choice Letter Label -->
                        <div class="choice-letter mr-3">
                            {% if forloop.counter == 1 %}A{% elif forloop.counter == 2 %}B{% elif forloop.counter == 3 %}C{% elif forloop.counter == 4 %}D{% elif forloop.counter == 5 %}E{% endif %}
                        </div>
                        <input type="radio" id="choice_{{ choice.id }}" name="choice" value="{{ choice.id }}" 
                               {% if previous_answer and previous_answer.selected_choice and previous_answer.selected_choice.id == choice.id %}checked{% endif %}
                               class="w-4 h-4 sm:w-5 sm:h-5 text-indigo-600 border-gray-300 focus:ring-indigo-500 dark:focus:ring-indigo-400 dark:ring-offset-gray-800 dark:bg-gray-700 dark:border-gray-600 flex-shrink-0 mr-3"
                               onchange="saveAnswer()">
                        <div class="flex-1 text-base sm:text-lg font-medium text-gray-800 dark:text-gray-200 group-hover:text-indigo-800 dark:group-hover:text-indigo-200 leading-relaxed ckeditor-content choice-text">
                            {{ choice.choice_text|safe }}
                            {% if choice.choice_image %}
                            <div class="mt-3">
                                <img src="{{ choice.choice_image|safe_image_url }}" alt="Choice Image" class="max-w-full sm:max-w-sm h-auto rounded-lg border border-gray-200 dark:border-gray-600 object-contain">
                            </div>
                            {% endif %}
                        </div>
                    </label>
                    {% endfor %}
                {% elif question.question_type == 'essay' %}
                    <!-- Essay Answer -->
                    <div class="p-4 sm:p-6 bg-gray-50 dark:bg-gray-900 rounded-xl border-2 border-gray-200 dark:border-gray-700">
                        <label for="text_answer" class="block text-lg font-semibold text-gray-800 dark:text-white mb-4">
                            <svg class="inline w-5 h-5 mr-2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                            Tulis jawaban Anda:
                        </label>
                        <textarea 
                            id="text_answer" 
                            name="text_answer" 
                            rows="4" 
                            class="w-full px-3 sm:px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white bg-white dark:bg-gray-800 focus:ring-2 focus:ring-indigo-500 focus:border-transparent resize-y min-h-[120px] sm:min-h-[160px]"
                            placeholder="Ketik jawaban Anda di sini..."
                            onchange="saveEssayAnswer()"
                            onblur="saveEssayAnswer()">{{ previous_text_answer }}</textarea>
                        <div class="mt-2 text-sm text-gray-500 dark:text-gray-400">
                            <svg class="inline w-4 h-4 mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            Jawaban akan tersimpan otomatis
                        </div>
                    </div>
                {% endif %}
                
                <!-- Saving indicator (flyout, fixed so it doesn't shift layout) -->
                <div id="saving-indicator" class="hidden fixed top-20 right-4 z-50 flex items-center gap-2 text-sm text-indigo-600 dark:text-indigo-400 px-4 py-3 bg-indigo-50 dark:bg-indigo-900/30 rounded-lg border border-indigo-200 dark:border-indigo-700 shadow-lg transform translate-x-full opacity-0 transition-all duration-200">
                    <svg class="animate-spin w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    <span>Menyimpan jawaban...</span>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-col lg:flex-row justify-between items-center gap-4 pt-6 border-t border-gray-200 dark:border-gray-700">
                <!-- Left: Previous Button -->
                <div class="w-full lg:w-auto">
                    {% if can_go_previous %}
                    {% if is_package %}
                    <a href="{% url 'take_package_test_question' package.id current_question_number|add:'-1' %}" class="w-full lg:w-auto inline-flex items-center justify-center gap-2 px-6 py-3 text-indigo-600 bg-white border-2 border-indigo-200 rounded-xl hover:bg-indigo-50 hover:border-indigo-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-all font-semibold">
                    {% else %}
                    <a href="{% url 'take_test' category.id current_question_number|add:'-1' %}" class="w-full lg:w-auto inline-flex items-center justify-center gap-2 px-6 py-3 text-indigo-600 bg-white border-2 border-indigo-200 rounded-xl hover:bg-indigo-50 hover:border-indigo-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-all font-semibold">
                    {% endif %}
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M11 17l-5-5m0 0l5-5m-5 5h12"></path></svg>
                        Soal Sebelumnya
                    </a>
                    {% endif %}
                </div>

                <!-- Right: Action Buttons -->
                <div class="flex flex-col sm:flex-row gap-3 w-full lg:w-auto">
                    {% if can_go_next %}
                        <!-- Submit Test Button (Secondary position when not last question) -->
                        <button type="button" onclick="showSubmitConfirmation()" id="submit-test-btn-secondary" class="w-full sm:w-auto inline-flex items-center justify-center gap-2 px-6 py-3 transition-all font-semibold rounded-xl focus:outline-none focus:ring-2 focus:ring-offset-2 text-white bg-red-600 hover:bg-red-700 focus:ring-red-500">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span>Selesai Ujian</span>
                        </button>
                        
                        <!-- Mark Question Button -->
                        <button type="button" onclick="markAsDoubtful()" id="mark-button" class="w-full sm:w-auto inline-flex items-center justify-center gap-2 px-6 py-3 text-yellow-600 bg-white border-2 border-yellow-200 rounded-xl hover:bg-yellow-50 hover:border-yellow-300 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-offset-2 transition-all font-semibold">
                            <svg id="mark-icon" class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path id="bookmark-icon" stroke-linecap="round" stroke-linejoin="round" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>
                                <path id="check-icon" stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" style="display: none;"></path>
                            </svg>
                            <span id="mark-text">Tandai Soal</span>
                        </button>

                        <!-- Next Button -->
                        <button type="submit" name="action" value="next" class="w-full sm:w-auto inline-flex items-center justify-center gap-2 px-6 py-3 text-white bg-gradient-to-r from-blue-600 to-blue-700 rounded-xl hover:from-blue-700 hover:to-blue-800 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all font-semibold shadow-lg">
                            <span>Soal Selanjutnya</span>
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                            </svg>
                        </button>
                    {% else %}
                        <!-- Last Question: Submit and Mark buttons -->
                        <!-- Mark Question Button -->
                        <button type="button" onclick="markAsDoubtful()" id="mark-button" class="w-full sm:w-auto inline-flex items-center justify-center gap-2 px-6 py-3 text-yellow-600 bg-white border-2 border-yellow-200 rounded-xl hover:bg-yellow-50 hover:border-yellow-300 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-offset-2 transition-all font-semibold">
                            <svg id="mark-icon" class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path id="bookmark-icon" stroke-linecap="round" stroke-linejoin="round" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>
                                <path id="check-icon" stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" style="display: none;"></path>
                            </svg>
                            <span id="mark-text">Tandai Soal</span>
                        </button>
                        
                        <!-- Submit Test Button (Primary position on last question) -->
                        <button type="button" onclick="showSubmitConfirmation()" id="submit-test-btn-primary" class="w-full sm:w-auto inline-flex items-center justify-center gap-2 px-8 py-4 transition-all font-bold rounded-xl focus:outline-none focus:ring-2 focus:ring-offset-2 text-lg shadow-lg text-white bg-red-600 hover:bg-red-700 focus:ring-red-500">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span>Selesai Ujian</span>
                        </button>
                    {% endif %}
                </div>
            </div>
        </form>
    </div>
        </div>

        <!-- Right Column: Progress Bar + Timer + Navigation (Desktop: col-span-4, Mobile: full width) -->
        <div class="md:col-span-4 space-y-3 lg:space-y-6">
            
            <!-- Desktop Timer Display (hidden on mobile) -->
            <div class="hidden lg:block bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 border border-gray-200 dark:border-gray-700">
                {% if time_remaining %}
                <div class="text-center">
                    <div class="flex items-center justify-center w-16 h-16 bg-red-100 dark:bg-red-900/30 rounded-full mx-auto mb-4">
                        <svg class="w-8 h-8 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="text-sm font-semibold text-red-600 dark:text-red-400 mb-1">Sisa Waktu</div>
                    <div id="timer-display" class="font-mono text-2xl font-bold text-red-700 dark:text-red-300">00:00:00</div>
                </div>
                {% endif %}
            </div>
            
            <!-- Progress Bar Card -->
            <div class="bg-white dark:bg-gray-800 rounded-lg lg:rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700">
                <div class="flex items-center gap-2 lg:gap-3 px-3 py-2 lg:px-6 lg:py-4">
                    <span class="text-xs lg:text-sm font-semibold text-purple-600 dark:text-purple-400 w-12 lg:w-16">Progress</span>
                    <div class="flex-1">
                        <div class="w-full bg-gray-200 rounded-full h-2 lg:h-3 dark:bg-gray-700">
                            <div id="progress-bar" class="bg-gradient-to-r from-indigo-500 to-purple-600 h-2 lg:h-3 rounded-full transition-all duration-300" style="width: {{ progress }}%"></div>
                        </div>
                    </div>
                    <span id="progress-percentage" class="text-xs lg:text-sm font-medium text-gray-600 dark:text-gray-300 ml-2 lg:ml-3">{{ progress }}%</span>
                </div>
            </div>

            <!-- Navigation Section -->
            <div class="bg-white dark:bg-gray-800 rounded-lg lg:rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700">
                <!-- Subtest selector (for package tests) -->
                {% if is_package and package_subtests %}
                <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                    <div>
                        <label for="subtest-select" class="text-sm font-semibold text-gray-700 dark:text-gray-200 mr-2">Pilih Subtest:</label>
                        <select id="subtest-select" class="inline-block px-3 py-2 border rounded bg-white dark:bg-gray-800 text-sm">
                            <option value="all">Semua Subtest</option>
                            {% for s in package_subtests %}
                            <option value="{{ s.start }}-{{ s.start|add:s.count|add:'-1' }}" {% if current_question_number >= s.start and current_question_number < s.start|add:s.count %}selected{% endif %}>{{ s.category_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="text-sm text-gray-500">Navigasi menampilkan hanya soal subtest yang dipilih</div>
                </div>
                {% endif %}
                <!-- Navigation Header -->
                <div class="flex justify-between items-center p-3 lg:p-6 border-b border-gray-200 dark:border-gray-700">
                    <h3 class="text-lg lg:text-xl font-bold text-gray-800 dark:text-white flex items-center gap-2 lg:gap-3">
                        <div class="w-8 h-8 lg:w-10 lg:h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center">
                            <svg class="w-4 h-4 lg:w-5 lg:h-5 text-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path></svg>
                        </div>
                        <span class="hidden sm:inline">Navigasi Soal</span>
                        <span class="sm:hidden">Navigasi</span>
                    </h3>
                    <button onclick="toggleNavigation()" class="flex items-center gap-1 lg:gap-2 px-2 py-1 lg:px-4 lg:py-2 text-indigo-600 bg-indigo-50 dark:bg-indigo-900 border border-indigo-200 dark:border-indigo-700 rounded-md lg:rounded-lg hover:bg-indigo-100 dark:hover:bg-indigo-800 transition-all font-medium text-sm lg:text-base">
                        <svg id="nav-toggle-icon" class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"></path></svg>
                        <span id="nav-toggle-text" class="hidden sm:inline">Sembunyikan</span>
                    </button>
                </div>

                <!-- Navigation Panel -->
                <div id="navigation-panel" class="p-3 lg:p-6 transition-all duration-300">
                    <!-- Status Legend -->
                    <div class="mb-3 lg:mb-6 p-2 lg:p-4 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600">
                        <h4 class="text-xs lg:text-sm font-semibold text-gray-800 dark:text-white mb-2 lg:mb-4 flex items-center gap-1 lg:gap-2">
                            <svg class="w-3 h-3 lg:w-4 lg:h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            <span class="hidden sm:inline">Keterangan Status Soal</span>
                            <span class="sm:hidden">Status</span>
                        </h4>
                        
                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-2 lg:gap-3">
                            <div class="flex items-center gap-1 lg:gap-2 p-1 lg:p-2 bg-white dark:bg-gray-800 rounded border">
                                <div class="w-3 h-3 lg:w-4 lg:h-4 bg-gray-300 border border-gray-400 rounded flex-shrink-0"></div>
                                <div>
                                    <div class="text-xs font-medium text-gray-700 dark:text-gray-300">
                                        <span class="hidden sm:inline">Belum dikerjakan</span>
                                        <span class="sm:hidden">Belum</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex items-center gap-1 lg:gap-2 p-1 lg:p-2 bg-white dark:bg-gray-800 rounded border">
                                <div class="w-3 h-3 lg:w-4 lg:h-4 bg-green-500 border border-green-600 rounded flex-shrink-0"></div>
                                <div>
                                    <div class="text-xs font-medium text-gray-700 dark:text-gray-300">
                                        <span class="hidden sm:inline">Sudah dijawab</span>
                                        <span class="sm:hidden">Sudah</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex items-center gap-1 lg:gap-2 p-1 lg:p-2 bg-white dark:bg-gray-800 rounded border">
                                <div class="w-3 h-3 lg:w-4 lg:h-4 bg-yellow-500 border border-yellow-600 rounded flex-shrink-0"></div>
                                <div>
                                    <div class="text-xs font-medium text-gray-700 dark:text-gray-300">Ditandai</div>
                                </div>
                            </div>
                            
                            <div class="flex items-center gap-2 p-2 bg-white dark:bg-gray-800 rounded border">
                                <div class="w-4 h-4 bg-blue-500 border border-blue-600 rounded"></div>
                                <div>
                                    <div class="text-xs font-medium text-gray-700 dark:text-gray-300">Sedang dikerjakan</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Question Grid -->
                    <div class="navigation-grid mb-6">
                        {% for i in total_questions|range_filter %}
                        {% with question_num=forloop.counter %}
                        {% if is_package %}
                        <a href="{% url 'take_package_test_question' package.id question_num %}" 
                           class="nav-button"
                           data-question-index="{{ question_num }}"
                           title="Soal {{ question_num }}">
                            {{ question_num }}
                        </a>
                        {% else %}
                        <a href="{% url 'take_test' category.id question_num %}" 
                           class="nav-button"
                           data-question-index="{{ question_num }}"
                           title="Soal {{ question_num }}">
                            {{ question_num }}
                        </a>
                        {% endif %}
                        {% endwith %}
                        {% endfor %}
                    </div>

                    <!-- Quick Stats -->
                    <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600">
                        <h4 class="text-sm font-semibold text-gray-800 dark:text-white mb-4 flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                            Statistik Pengerjaan
                        </h4>
                        
                        <div class="grid grid-cols-3 gap-4">
                            <!-- Soal Dijawab -->
                            <div class="text-center p-3 bg-green-100 dark:bg-green-900/30 rounded-lg border border-green-200 dark:border-green-700">
                                <div class="text-2xl font-bold text-green-600 dark:text-green-400 mb-1" id="answered-count">{{ answered_questions }}</div>
                                <div class="text-xs text-gray-600 dark:text-gray-400">Dijawab</div>
                            </div>
                            
                            <!-- Soal Ditandai -->
                            <div class="text-center p-3 bg-yellow-100 dark:bg-yellow-900/30 rounded-lg border border-yellow-200 dark:border-yellow-700">
                                <div class="text-2xl font-bold text-yellow-600 dark:text-yellow-400 mb-1" id="doubtful-count">0</div>
                                <div class="text-xs text-gray-600 dark:text-gray-400">Ditandai</div>
                            </div>
                            
                            <!-- Soal Tersisa -->
                            <div class="text-center p-3 bg-gray-100 dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-600">
                                <div class="text-2xl font-bold text-gray-600 dark:text-gray-400 mb-1" id="remaining-count">{{ unanswered_questions }}</div>
                                <div class="text-xs text-gray-600 dark:text-gray-400">Tersisa</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Submit Confirmation Modal - Flowbite Style -->
<div id="submit-modal" tabindex="-1" aria-hidden="true" class="fixed top-0 left-0 right-0 z-50 hidden w-full p-4 overflow-x-hidden overflow-y-auto md:inset-0 h-[calc(100%-1rem)] max-h-full">
    <div class="relative w-full max-w-2xl max-h-full">
        <!-- Modal content -->
        <div class="relative bg-white rounded-lg shadow dark:bg-gray-700">
            <!-- Modal header -->
            <div class="flex items-start justify-between p-4 border-b rounded-t dark:border-gray-600">
                <h3 class="text-xl font-semibold text-gray-900 dark:text-white">
                    Selesai Ujian
                </h3>
                <button type="button" id="close-modal-btn" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ml-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white">
                    <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
                    </svg>
                    <span class="sr-only">Close modal</span>
                </button>
            </div>
            <!-- Modal body -->
            <div class="p-6 space-y-6">
                <div class="text-center">
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 dark:bg-red-900/50 mb-4">
                        <svg class="h-6 w-6 text-red-600 dark:text-red-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
                        </svg>
                    </div>
                    <div id="submit-modal-text" class="text-base leading-relaxed text-gray-500 dark:text-gray-400 mb-4">
                        Anda telah menjawab <span id="answered-summary" class="font-semibold text-gray-900 dark:text-white">0</span> dari {{ total_questions }} soal.
                    </div>
                    <p class="text-sm text-gray-600 dark:text-gray-300">
                        Setelah ujian diselesaikan, Anda tidak dapat mengubah jawaban lagi.
                    </p>
                </div>
            </div>
            <!-- Modal footer -->
            <div class="flex items-center p-6 space-x-2 border-t border-gray-200 rounded-b dark:border-gray-600">
                <button id="cancel-submit" type="button" class="text-gray-500 bg-white hover:bg-gray-100 focus:ring-4 focus:outline-none focus:ring-blue-300 rounded-lg border border-gray-200 text-sm font-medium px-5 py-2.5 hover:text-gray-900 focus:z-10 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-500 dark:hover:text-white dark:hover:bg-gray-600 dark:focus:ring-gray-600">
                    Batal
                </button>
                <button onclick="submitTest()" type="button" class="text-white bg-red-600 hover:bg-red-800 focus:ring-4 focus:outline-none focus:ring-red-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-red-600 dark:hover:bg-red-700 dark:focus:ring-red-800">
                    Ya, Selesai
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Next Subtest Confirmation Modal (Flowbite structure) -->
<div id="next-subtest-modal" tabindex="-1" aria-hidden="true" class="fixed inset-0 z-[9999] hidden items-center justify-center overflow-y-auto overflow-x-hidden p-4 sm:p-6">
    <div class="fixed inset-0 bg-slate-900/70 backdrop-blur-sm" data-backdrop></div>
    <div class="relative w-full max-w-md">
        <div class="relative rounded-2xl bg-white shadow-lg ring-1 ring-slate-900/10 transition-all dark:bg-slate-900 dark:ring-white/10">
            <div class="flex items-start justify-between gap-4 border-b border-slate-200 px-6 py-4 dark:border-slate-700">
                <h3 class="text-lg font-semibold text-slate-900 dark:text-white">
                    Lanjut ke Subtest Berikutnya?
                </h3>
                <button type="button" class="inline-flex h-8 w-8 items-center justify-center rounded-full bg-slate-200/70 text-slate-600 transition hover:bg-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-400 dark:bg-slate-700/80 dark:text-slate-200 dark:hover:bg-slate-600" data-modal-dismiss>
                    <svg class="h-4 w-4" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 6l8 8m0-8l-8 8"></path>
                    </svg>
                    <span class="sr-only">Tutup modal</span>
                </button>
            </div>
            <div class="px-6 py-5">
                <p class="text-sm leading-6 text-slate-600 dark:text-slate-300">
                    Anda akan berpindah dari subtest <strong id="next-subtest-from" class="text-slate-900 dark:text-slate-100"></strong>
                    ke <strong id="next-subtest-to" class="text-slate-900 dark:text-slate-100"></strong>.
                    Pastikan semua jawaban telah tersimpan sebelum melanjutkan.
                </p>
            </div>
            <div class="flex flex-col-reverse gap-3 border-t border-slate-200 px-6 py-4 sm:flex-row sm:justify-end dark:border-slate-700">
                <button type="button" class="inline-flex items-center justify-center rounded-xl border border-slate-300 bg-white px-4 py-2.5 text-sm font-semibold text-slate-600 shadow-sm transition hover:border-slate-400 hover:text-slate-700 focus:outline-none focus:ring-2 focus:ring-blue-400 dark:border-slate-600 dark:bg-slate-800 dark:text-slate-200 dark:hover:border-slate-500" data-modal-dismiss>
                    Batal
                </button>
                <button type="button" class="inline-flex items-center justify-center rounded-xl bg-blue-600 px-4 py-2.5 text-sm font-semibold text-white shadow-lg shadow-blue-500/30 transition hover:bg-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-300 dark:bg-blue-500 dark:hover:bg-blue-400" data-modal-confirm>
                    Lanjutkan
                </button>
            </div>
        </div>
    </div>
</div>

<style>
@keyframes fade-in {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.animate-fade-in {
  animation: fade-in 0.5s ease;
}

#next-subtest-modal {
    pointer-events: none;
}

#next-subtest-modal.flex {
    pointer-events: auto;
}

/* Universal font family untuk kompatibilitas lintas platform */
* {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Cantarell", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif !important;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* Reset font weights to normal */
button, .btn {
  font-family: inherit;
  font-weight: 500;
}

/* Styling khusus untuk konten CKEditor dengan typography natural */
.ckeditor-content {
  line-height: 1.6;
  font-family: inherit;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  text-rendering: optimizeLegibility;
  font-weight: 400; /* Normal weight */
}

.ckeditor-content p {
  margin-bottom: 1rem;
  line-height: 1.6;
  font-weight: 400;
}

/* Typography improvements untuk question text - bold yang lebih ringan */
.ckeditor-content strong,
.ckeditor-content b {
  font-weight: 600 !important; /* Semi-bold, tidak terlalu tebal */
  color: inherit;
}

.ckeditor-content em,
.ckeditor-content i {
  font-style: italic !important;
  font-weight: inherit; /* Inherit weight, hanya italic */
  color: inherit;
}

.ckeditor-content u {
  text-decoration: underline !important;
  text-decoration-thickness: 1px !important;
}

/* Khusus untuk choice text - pastikan konsistensi formatting */
.choice-text strong,
.choice-text b {
  font-weight: 600 !important; /* Semi-bold, tidak terlalu tebal */
  color: inherit !important;
  background: none !important;
  border: none !important;
  text-shadow: none !important;
}

.choice-text em,
.choice-text i {
  font-style: italic !important;
  font-weight: inherit !important;
  color: inherit !important;
}

.choice-text u {
  text-decoration: underline !important;
  text-decoration-thickness: 1px !important;
  color: inherit !important;
}

/* Reset any unwanted styling pada choice content */
.choice-text * {
  font-family: inherit !important;
  background: transparent !important;
  border: none !important;
  box-shadow: none !important;
}

/* Reset font weights untuk text elements - menggunakan ukuran standar */
.text-xl.font-semibold,
.text-2xl.font-bold,
.text-3xl.font-bold {
  font-weight: 500; /* Medium weight, tidak terlalu tebal */
}

.text-base.font-medium,
.text-lg.font-medium,
.text-lg.font-semibold,
.text-xl.font-semibold {
  font-weight: 450; /* Light medium weight */
}

/* Enhanced visibility untuk choice radio buttons */
input[type="radio"] {
  width: 1.125rem;
  height: 1.125rem;
  margin-right: 0.5rem;
}

/* Choice letter label styling */
.choice-letter {
  width: 1.75rem;
  height: 1.75rem;
  background-color: #e5e7eb;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.8rem;
  font-weight: 600; /* Semi-bold untuk label */
  color: #374151;
  transition: all 0.2s ease;
  flex-shrink: 0;
}

.dark .choice-letter {
  background-color: #4b5563;
  color: #d1d5db;
}

.group:hover .choice-letter {
  background-color: #c7d2fe;
  color: #3730a3;
}

.dark .group:hover .choice-letter {
  background-color: #3730a3;
  color: #c7d2fe;
}

/* Responsive adjustments for choice letters */
@media (max-width: 639px) {
  .choice-letter {
    width: 1.5rem;
    height: 1.5rem;
    font-size: 0.7rem;
  }
}

/* Improved container untuk mencegah overflow */
.ckeditor-content {
  word-wrap: break-word;
  overflow-wrap: break-word;
  hyphens: auto;
  max-width: 100%;
}

.ckeditor-content * {
  max-width: 100%;
  box-sizing: border-box;
}

/* Styling khusus untuk question text */
.question-text {
  font-size: 1.125rem; /* 18px - lebih kecil dari sebelumnya */
  line-height: 1.5;
  font-weight: 500; /* Medium weight, tidak bold */
}

.choice-text {
  font-size: 0.95rem; /* 15px - sedikit lebih kecil */
  line-height: 1.5;
  font-weight: 400; /* Normal weight untuk pilihan */
}

/* Pastikan semua choice text memiliki styling yang konsisten */
.choice-text,
.choice-text p,
.choice-text span,
.choice-text div {
  font-size: inherit !important;
  font-weight: 400 !important;
  line-height: inherit !important;
  font-family: inherit !important;
}

/* Override untuk bold dalam choice text agar konsisten */
.choice-text strong,
.choice-text b,
.choice-text .bold {
  font-weight: 600 !important; /* Semi-bold agar tidak terlalu tebal */
  font-size: inherit !important;
  color: inherit !important;
  background: none !important;
  text-shadow: none !important;
}

/* iPad dan tablet specific improvements */
@media screen and (min-width: 768px) and (max-width: 1024px) {
  .question-text {
    font-size: 1.375rem; /* 22px untuk tablet */
    line-height: 1.5;
  }
  
  .choice-text {
    font-size: 1.125rem; /* 18px untuk tablet */
    line-height: 1.5;
  }
  
  .choice-text * {
    font-size: inherit !important;
    line-height: inherit !important;
  }
  
  .ckeditor-content {
    font-size: 1rem;
  }
}

/* Mobile improvements */
@media screen and (max-width: 767px) {
  .question-text {
    font-size: 1.125rem; /* 18px untuk mobile */
    line-height: 1.4;
  }
  
  .choice-text {
    font-size: 0.975rem; /* 15.6px untuk mobile */
    line-height: 1.4;
  }
  
  .choice-text * {
    font-size: inherit !important;
    line-height: inherit !important;
  }
}

/* Container overflow prevention - ukuran standar */
.max-w-6xl {
  padding-left: 1rem;
  padding-right: 1rem;
  overflow-x: hidden;
}

.bg-white.dark\\:bg-gray-800.rounded-2xl {
  padding: 1.5rem;
  margin: 0.5rem 0;
  overflow: hidden;
}

/* Ensure proper text wrapping in all contexts */
.ckeditor-content p,
.ckeditor-content div,
.ckeditor-content span {
  word-break: break-word;
  overflow-wrap: break-word;
  white-space: normal;
}

/* Enhanced contrast untuk bold/italic/underline - lebih ringan */
.ckeditor-content strong,
.ckeditor-content b {
  font-weight: 600; /* Semi-bold yang lebih ringan */
}

.ckeditor-content em,
.ckeditor-content i {
  font-style: italic;
  font-weight: 450; /* Sedikit lebih ringan untuk italic */
}

.ckeditor-content u {
  text-decoration: underline;
  text-decoration-thickness: 1px; /* Underline yang normal */
}

/* Remove any blue styling from math formulas in question content */
.ckeditor-content .math-formula,
.ckeditor-content .latex-formula,
.ckeditor-content span[data-latex] {
  background: transparent !important;
  border: none !important;
  box-shadow: none !important;
  padding: 0 !important;
  margin: 0 !important;
  color: inherit !important;
  display: inline !important;
}

/* Ensure no blue highlighting on any spans or special elements */
.ckeditor-content span {
  background: transparent !important;
  border: none !important;
  box-shadow: none !important;
}

/* Force consistent styling untuk semua choice elements */
.choice-text span,
.choice-text p,
.choice-text div {
  font-weight: inherit !important;
  font-size: inherit !important;
  background: transparent !important;
  border: none !important;
  color: inherit !important;
  text-shadow: none !important;
}

/* Normalize CKEditor generated content dalam choices */
.choice-text .ckeditor-content * {
  font-weight: 400 !important;
  font-size: inherit !important;
  line-height: inherit !important;
}

.choice-text .ckeditor-content strong,
.choice-text .ckeditor-content b {
  font-weight: 600 !important; /* Semi-bold untuk consistency */
}

.ckeditor-content img {
  max-width: 100% !important;
  height: auto !important;
  display: block;
  margin: 1rem auto;
  border-radius: 8px;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  transition: opacity 0.3s ease;
}

.ckeditor-content img[src=""], .ckeditor-content img:not([src]) {
  display: none;
}

.ckeditor-content img.loading {
  opacity: 0.5;
}

.ckeditor-content img.error {
  display: block;
  width: 100%;
  height: 200px;
  background-color: #f3f4f6;
  border: 2px dashed #d1d5db;
  position: relative;
}

.ckeditor-content img.error:after {
  content: "Gambar tidak dapat dimuat";
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: #6b7280;
  font-size: 14px;
}

/* CSS khusus untuk grid navigasi */
.navigation-grid {
  display: grid !important;
  grid-template-columns: repeat(4, 1fr) !important;
  gap: 0.375rem !important;
  padding: 0.5rem !important;
  width: 100% !important;
  box-sizing: border-box !important;
  overflow: visible !important;
  margin: 0 auto !important;
}

/* Ensure container doesn't cause overflow */
.navigation-grid > * {
  min-width: 0 !important;
  overflow: hidden !important;
}

@media (min-width: 480px) {
  .navigation-grid {
    grid-template-columns: repeat(5, 1fr) !important;
    gap: 0.5rem !important;
    padding: 0.625rem !important;
  }
}

@media (min-width: 640px) {
  .navigation-grid {
    grid-template-columns: repeat(6, 1fr) !important;
    gap: 0.625rem !important;
    padding: 0.75rem !important;
  }
}

@media (min-width: 768px) {
  .navigation-grid {
    grid-template-columns: repeat(7, 1fr) !important;
    gap: 0.75rem !important;
    padding: 0.75rem !important;
  }
}

@media (min-width: 1024px) {
  .navigation-grid {
    grid-template-columns: repeat(8, 1fr) !important;
    gap: 0.75rem !important;
    padding: 1rem !important;
  }
}

/* Navigation button styles */
.nav-button {
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  min-width: 3rem !important;
  width: 100% !important;
  height: 3rem !important;
  font-size: 0.875rem !important;
  font-weight: 700 !important;
  border-radius: 0.5rem !important;
  border-width: 2px !important;
  transition: all 0.2s ease !important;
  text-decoration: none !important;
  flex-shrink: 0 !important;
  box-sizing: border-box !important;
  padding: 0.25rem !important;
  white-space: nowrap !important;
  overflow: hidden !important;
  text-overflow: ellipsis !important;
  line-height: 1 !important;
  margin: 0 !important;
}

.nav-button:hover {
  transform: scale(1.05) !important;
}

.nav-button.current {
  background-color: #3b82f6 !important;
  border-color: #2563eb !important;
  color: white !important;
}

.nav-button.current:hover {
  background-color: #2563eb !important;
}

.nav-button.answered {
  background-color: #22c55e !important;
  border-color: #16a34a !important;
  color: white !important;
}

.nav-button.answered:hover {
  background-color: #16a34a !important;
}

.nav-button.unanswered {
  background-color: #e5e7eb !important;
  border-color: #d1d5db !important;
  color: #374151 !important;
}

.nav-button.unanswered:hover {
  background-color: #d1d5db !important;
  border-color: #9ca3af !important;
}

/* Smooth collapse/expand for navigation panel */
#navigation-panel {
    overflow: hidden;
    max-height: 2000px; /* large enough for full content */
    opacity: 1;
    transition: max-height 350ms ease, opacity 300ms ease, padding 300ms ease;
}

#navigation-panel.collapsed {
    max-height: 0 !important;
    opacity: 0 !important;
    padding-top: 0 !important;
    padding-bottom: 0 !important;
}

/* Mobile specific tweaks to improve readability and reduce padding */
@media (max-width: 639px) {
    /* Reduce overall container padding significantly */
    .max-w-7xl {
        padding-left: 0.5rem !important;
        padding-right: 0.5rem !important;
    }
    
    /* Main grid container - reduce spacing */
    .p-2 {
        padding: 0.25rem !important;
    }
    
    /* Card padding adjustments */
    .p-3 {
        padding: 0.5rem !important;
    }
    
    .navigation-grid {
        grid-template-columns: repeat(3, 1fr) !important;
        gap: 0.375rem !important;
        padding: 0.5rem !important;
        margin: 0 0.25rem !important;
    }

    .nav-button {
        min-width: 3rem !important;
        width: 100% !important;
        height: 3rem !important;
        font-size: 0.875rem !important;
        padding: 0.5rem !important;
        border-radius: 0.375rem !important;
        white-space: nowrap !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
    }

    /* make saving indicator smaller and positioned better on mobile */
    #saving-indicator {
        right: 0.5rem !important;
        top: auto !important;
        bottom: 1rem !important;
        padding: 0.5rem 0.75rem !important;
        font-size: 0.75rem !important;
    }
    
    .question-text {
        font-size: 1rem; /* 16px for mobile */
        line-height: 1.4;
        font-weight: 600;
    }
    
    .choice-text {
        font-size: 0.975rem; /* 15.6px for mobile */
        line-height: 1.4;
        font-weight: 400;
    }
    
    /* Ensure consistency on mobile */
    .choice-text *,
    .choice-text span,
    .choice-text p {
        font-size: inherit !important;
        font-weight: 400 !important;
        line-height: inherit !important;
    }
    
    .choice-text strong,
    .choice-text b {
        font-weight: 700 !important;
        font-size: inherit !important;
    }

    /* Ensure hidden elements stay hidden */
    .hidden {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
    }
    
    /* Ensure saving indicator transitions work properly */
    #saving-indicator.hidden {
        transform: translateX(100%) !important;
        opacity: 0 !important;
        visibility: hidden !important;
    }
    
    /* Remove margins from cards on mobile for tighter layout */
    .space-y-3 > * + * {
        margin-top: 0.5rem !important;
    }
    
    /* Compact form elements on mobile */
    .rounded-xl {
        border-radius: 0.5rem !important;
    }
    
    /* Smaller buttons on mobile */
    .px-8 {
        padding-left: 1rem !important;
        padding-right: 1rem !important;
    }
    
    .py-4 {
        padding-top: 0.75rem !important;
        padding-bottom: 0.75rem !important;
    }
    
    /* Reduce choice letter size */
    .choice-letter {
        width: 1.5rem !important;
        height: 1.5rem !important;
        font-size: 0.7rem !important;
    }
}
    
    /* Ensure no blue boxes appear for math formulas or special elements */
    .MathJax {
        background: transparent !important;
        border: none !important;
        box-shadow: none !important;
    }
    
    .MathJax_Display {
        background: transparent !important;
        border: none !important;
        box-shadow: none !important;
    }
    
    /* Remove any unwanted blue highlighting or boxes */
    .math-formula, .latex-formula {
        background: transparent !important;
        border: none !important;
        box-shadow: none !important;
    }
    
    /* Ensure no unexpected blue boxes on any elements */
    *:not(.nav-button):not(.bg-blue-500):not(.border-blue-600):not([class*="from-blue"]):not([class*="to-blue"]) {
        box-shadow: none !important;
    }
    
    /* Aggressively remove blue styling from content elements */
    .ckeditor-content *:not(.bg-blue-500):not(.border-blue-600) {
        background-color: transparent !important;
        background: transparent !important;
        border-color: transparent !important;
        box-shadow: none !important;
    }
    
    /* Specifically target math formula elements */
    .math-formula, .latex-formula, span[data-latex], span[class*="math"], span[class*="formula"] {
        background-color: transparent !important;
        background: transparent !important;
        border: none !important;
        border-color: transparent !important;
        box-shadow: none !important;
        padding: 0 !important;
        margin: 0 2px !important;
    }
}
</style>

<script>
// Global variable declarations first
// Support both package and single-category tests
const isPackage = {% if is_package %}true{% else %}false{% endif %};
const PACKAGE_ID = {% if package %}{{ package.id }}{% else %}null{% endif %};
const CATEGORY_ID = {% if category %}{{ category.id }}{% else %}null{% endif %};
const storageKeyId = isPackage ? `package_${PACKAGE_ID}` : `category_${CATEGORY_ID}`;
let markedQuestions = JSON.parse(localStorage.getItem('markedQuestions_' + storageKeyId) || '[]');
let currentQuestionNumber = {{ current_question_number }}; // Menggunakan question number, bukan ID

// Timer variables
let remainingTime = {{ time_remaining.total_seconds|default:0|floatformat:0 }}; // seconds from backend
let timerInterval;
let timerStartTime = null;
let initialTimeFromBackend = {{ time_remaining.total_seconds|default:0|floatformat:0 }};

// Konversi answered_questions dari backend ke JavaScript array
let answeredQuestions = [{% for q_num in answered_question_numbers %}{{ q_num }}{% if not forloop.last %},{% endif %}{% endfor %}];
// Timer handle to avoid race between hide/show of the saving flyout
let savingHideTimer = null;

// Global function definitions first (needed for onclick handlers)
// Show submit confirmation modal
function showSubmitConfirmation() {
    const selectedAnswer = document.querySelector('input[name="choice"]:checked');
    
    if (selectedAnswer) {
        // Add current question to answered questions if not already there
        if (!answeredQuestions.includes({{ current_question_number }})) {
            answeredQuestions.push({{ current_question_number }});
        }
        
        // Save the answer via AJAX before showing modal
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        formData.append('choice', selectedAnswer.value);
        
        // Save answer via fetch API
        fetch(window.location.href, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        }).then(response => {
            // show confirmation modal regardless of response success
            showModalGlobal();
        }).catch(error => {
            console.error('Error saving answer before showing modal:', error);
            showModalGlobal();
        });
    } else {
        // No answer selected, show modal directly
        showModalGlobal();
    }
}

// Top-level modal display function (global)
function showModalGlobal() {
    const modal = document.getElementById('submit-modal');
    const answeredCount = answeredQuestions.length;
    const totalQuestions = {{ total_questions }};

    // Update the answered summary count
    const summaryEl = document.getElementById('answered-summary');
    if (summaryEl) {
        summaryEl.textContent = answeredCount;
    }

    const modalText = document.querySelector('#submit-modal-text');
    if (modalText) {
        if (answeredCount === totalQuestions) {
            // All questions answered - show success message
            modalText.classList.remove('text-gray-500', 'dark:text-gray-400');
            modalText.classList.add('text-green-600', 'dark:text-green-400');
            // Update the span styling for success
            if (summaryEl) {
                summaryEl.classList.remove('text-gray-900', 'dark:text-white');
                summaryEl.classList.add('text-green-600', 'dark:text-green-400');
            }
        } else {
            // Some questions remaining - show normal message
            modalText.classList.remove('text-green-600', 'dark:text-green-400');
            modalText.classList.add('text-gray-500', 'dark:text-gray-400');
            // Update the span styling for normal state
            if (summaryEl) {
                summaryEl.classList.remove('text-green-600', 'dark:text-green-400');
                summaryEl.classList.add('text-gray-900', 'dark:text-white');
            }
        }
    }

    console.log('Attempting to show modal:', modal); // Debug log
    console.log('Modal parent:', modal?.parentElement); // Debug log
    console.log('Modal classes:', modal?.className); // Debug log

    if (modal) {
        // Ensure modal is appended to body, not trapped in exam container
        if (modal.parentElement !== document.body) {
            document.body.appendChild(modal);
        }
        
        // Temporarily disable exam focus mode effects on the modal
        modal.style.setProperty('position', 'fixed', 'important');
        modal.style.setProperty('top', '0', 'important');
        modal.style.setProperty('left', '0', 'important');
        modal.style.setProperty('right', '0', 'important');
        modal.style.setProperty('bottom', '0', 'important');
        modal.style.setProperty('width', '100vw', 'important');
        modal.style.setProperty('height', '100vh', 'important');
        
        // Use Flowbite modal classes - remove hidden and add flex to backdrop
        modal.classList.remove('hidden');
        
        // Override any CSS that might be hiding the modal
        modal.style.setProperty('display', 'flex', 'important');
        modal.style.setProperty('visibility', 'visible', 'important');
        modal.style.setProperty('opacity', '1', 'important');
        modal.style.alignItems = 'center';
        modal.style.justifyContent = 'center';
        modal.setAttribute('aria-hidden', 'false');
        // Add backdrop
        modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
        // Ensure modal appears above exam mode content
        modal.style.zIndex = '9999999';
        document.documentElement.classList.add('overflow-hidden');
        document.body.classList.add('overflow-hidden');
        
        // Debug modal content visibility
        const modalContent = modal.querySelector('.bg-white, .dark\\:bg-gray-700');
        if (modalContent) {
            modalContent.style.setProperty('display', 'block', 'important');
            modalContent.style.setProperty('visibility', 'visible', 'important');
            modalContent.style.setProperty('opacity', '1', 'important');
        }
    } else {
        console.error('submit-modal element not found!'); // Debug log
    }
}

// Hide submit confirmation modal
function hideSubmitConfirmation() {
    const modal = document.getElementById('submit-modal');
    if (modal) {
        // Use Flowbite modal hiding approach
        modal.classList.add('hidden');
        modal.style.display = 'none';
        modal.setAttribute('aria-hidden', 'true');
        // Clear backdrop
        modal.style.backgroundColor = '';
        // Reset z-index to default
        modal.style.zIndex = '';
        document.documentElement.classList.remove('overflow-hidden');
        document.body.classList.remove('overflow-hidden');
    }
}

// Close modal when clicking on backdrop or pressing Escape
// Consolidated DOMContentLoaded handler to prevent duplicates and improve performance
document.addEventListener('DOMContentLoaded', function() {
    
    // 1. Modal setup
    const submitModal = document.getElementById('submit-modal');
    if (submitModal) {
        // Handle backdrop clicks
        submitModal.addEventListener('click', function(e) {
            // If click happens on the modal backdrop (the modal container) but not inside the modal content, close
            if (e.target === submitModal) {
                hideSubmitConfirmation();
            }
        });

        // Handle close button clicks
        const closeModalBtn = document.getElementById('close-modal-btn');
        if (closeModalBtn) {
            closeModalBtn.addEventListener('click', hideSubmitConfirmation);
        }

        // Handle Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && !submitModal.classList.contains('hidden')) {
                hideSubmitConfirmation();
            }
        });
    }
    
    // 2. Exam focus setup (simplified - no anti-screenshot)
    try {
        // Elements are already hidden by CSS for exam focus
    } catch (err) {
        console.error('Exam focus mode initialization failed', err);
    }
    
    // 3. Timer initialization with cleanup
    // Clear any existing timer first to prevent multiple timers
    if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
    }
    initTimer();
    
    // 4. Initial UI setup
    const savingIndicator = document.getElementById('saving-indicator');
    if (savingIndicator) {
        savingIndicator.classList.add('hidden');
    }
    
    // 5. Clean up blue elements after initial load
    setTimeout(() => {
        cleanupBlueElements();
    }, 100);
    
    // 6. Set up page exit confirmation and cleanup
    window.addEventListener('beforeunload', function(e) {
        // Clean up intervals to prevent memory leaks
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
        
        // Call the original confirmExit function
        return confirmExit(e);
    });
    
    // Additional cleanup for page visibility changes
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            // Page is hidden - timer continues running in localStorage-based calculation
            // No need to stop interval as it continues to work in background
        } else {
            // Page is visible again - sync with localStorage time
            // Force timer recalculation in case time drifted
            if (timerInterval && remainingTime > 0) {
                const timerKey = `timer_${storageKeyId}`;
                const initialTimeKey = `initial_time_${storageKeyId}`;
                const storedStartTime = localStorage.getItem(timerKey);
                const storedInitialTime = localStorage.getItem(initialTimeKey);
                
                if (storedStartTime && storedInitialTime) {
                    const startTime = parseInt(storedStartTime);
                    const initialTime = parseInt(storedInitialTime);
                    const now = Date.now();
                    const elapsedSeconds = Math.floor((now - startTime) / 1000);
                    const calculatedRemainingTime = Math.max(0, initialTime - elapsedSeconds);
                    
                    // Sync if there's a significant difference (more than 2 seconds)
                    if (Math.abs(remainingTime - calculatedRemainingTime) > 2) {
                        remainingTime = calculatedRemainingTime;
                        updateTimerDisplay();
                    }
                }
            }
        }
    });
    
    // 7. Initialize navigation and stats
    updateNavigationColors();
    updateStats();
    
    // 8. Initialize submit button color
    const totalQuestions = {{ total_questions }};
    const initialAnsweredCount = answeredQuestions.length;
    updateSubmitButtonColor(initialAnsweredCount, totalQuestions);
    
    // 9. Force button color update after a delay to override any conflicts
    setTimeout(() => {
        updateSubmitButtonColor(answeredQuestions.length, totalQuestions);
    }, 1000);
    
    // Add additional button color updates to ensure consistency
    setTimeout(() => {
        updateSubmitButtonColor(answeredQuestions.length, totalQuestions);
    }, 2000);
    
    // Set up periodic button color maintenance - more frequent for button color consistency
    // Removed excessive interval - button colors are updated when needed (on answer change)
    
    // 10. Initialize progress bar based on answered questions
    updateProgressBar(initialAnsweredCount, totalQuestions);
    
    // 11. Set up event listeners for radio buttons - auto-save and update navigation
    document.querySelectorAll('input[name="choice"]').forEach(radio => {
        radio.addEventListener('change', function() {
            saveAnswer();
        });
    });
    
    // 12. Set up event listeners for modal confirmation button
    document.getElementById('cancel-submit')?.addEventListener('click', hideSubmitConfirmation);
    
    // 13. Set up event listeners for submit buttons that use modal
    document.querySelectorAll('button[onclick*="showSubmitConfirmation"]').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            showSubmitConfirmation();
        });
    });

    // Also attach listeners to any element(s) with submit button IDs to guard against inline onclick not firing
    try {
        const submitButtonsById = document.querySelectorAll('#submit-test-btn-primary, #submit-test-btn-secondary');
        submitButtonsById.forEach(btn => {
            // Avoid double-binding by checking a data attribute
            if (btn.dataset.boundForSubmit) return;
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                console.log('Submit button clicked via event listener'); // Debug log
                if (typeof showSubmitConfirmation === 'function') {
                    showSubmitConfirmation();
                }
            });
            btn.dataset.boundForSubmit = '1';
        });
        console.log('Submit button event listeners attached to', submitButtonsById.length, 'buttons');
    } catch (err) {
        console.error('Error attaching listeners to submit buttons', err);
    }
});
const EXAM_HIDERS = [
    '#logo-sidebar', 
    'nav.fixed', 
    'nav',
    'header', 
    '.topbar', 
    '.navbar', 
    '#topbar', 
    '.site-header', 
    'button[data-drawer-target="logo-sidebar"]', 
    'button[data-drawer-toggle="logo-sidebar"]',
    'button[data-dropdown-toggle="dropdown-user"]',
    '#theme-toggle',
    '#dropdown-user',
    '.flex.items-center.ms-3'
];

function enableExamFocusMode() {
    // Hide global chrome elements if present
    EXAM_HIDERS.forEach(sel => {
        document.querySelectorAll(sel).forEach(el => {
            // store previous inline style so we can restore
            if (!el.dataset._prevDisplay) el.dataset._prevDisplay = el.style.display || '';
            el.style.display = 'none';
        });
    });

    // Make the main content take full viewport
    const main = document.querySelector('.max-w-6xl') || document.querySelector('main') || document.body;
    if (main) {
        main.dataset._prevPosition = main.style.position || '';
        main.dataset._prevTop = main.style.top || '';
        main.style.position = 'fixed';
        main.style.inset = '0';
        main.style.width = '100%';
        main.style.height = '100%';
        main.style.overflow = 'auto';
        main.style.zIndex = '99999';
        main.style.background = getComputedStyle(main).backgroundColor || '#ffffff';
    }
}

function disableExamFocusMode() {
    EXAM_HIDERS.forEach(sel => {
        document.querySelectorAll(sel).forEach(el => {
            if (el.dataset._prevDisplay !== undefined) {
                el.style.display = el.dataset._prevDisplay;
                delete el.dataset._prevDisplay;
            }
        });
    });

    const main = document.querySelector('.max-w-6xl') || document.querySelector('main') || document.body;
    if (main) {
        if (main.dataset._prevPosition !== undefined) {
            main.style.position = main.dataset._prevPosition;
            main.style.top = main.dataset._prevTop;
            delete main.dataset._prevPosition;
            delete main.dataset._prevTop;
        }
        main.style.zIndex = '';
    }
}

// Anti-screenshot functions removed - no longer needed

// Update tampilan tombol mark berdasarkan status
function updateMarkButtonState() {
    const bookmarkIcon = document.getElementById('bookmark-icon');
    const checkIcon = document.getElementById('check-icon');
    const markText = document.getElementById('mark-text');
    const markButton = document.getElementById('mark-button');
    
    if (markedQuestions.includes(currentQuestionNumber)) {
        // Soal sudah ditandai
        bookmarkIcon.style.display = 'none';
        checkIcon.style.display = 'block';
        markText.textContent = 'Sudah Ditandai';
        markButton.classList.add('bg-yellow-100', 'border-yellow-400');
        markButton.classList.remove('bg-white', 'border-yellow-200');
    } else {
        // Soal belum ditandai
        bookmarkIcon.style.display = 'block';
        checkIcon.style.display = 'none';
        markText.textContent = 'Tandai Soal';
        markButton.classList.remove('bg-yellow-100', 'border-yellow-400');
        markButton.classList.add('bg-white', 'border-yellow-200');
    }
}

// Initialize timer
// Initialize timer with localStorage persistence for consistency across navigation
function initTimer() {
    // Use storage key based on package or category to avoid conflicts
    const timerKey = `timer_${storageKeyId}`;
    const initialTimeKey = `initial_time_${storageKeyId}`;
    
    // Check if we have a stored start time and initial time
    const storedStartTime = localStorage.getItem(timerKey);
    const storedInitialTime = localStorage.getItem(initialTimeKey);
    
    // Get the initial time - use stored value if available, otherwise use backend value
    let initialTime = storedInitialTime ? parseInt(storedInitialTime) : initialTimeFromBackend;
    
    if (storedStartTime && initialTime > 0) {
        // We have a stored start time - calculate elapsed time
        const startTime = parseInt(storedStartTime);
        const now = Date.now();
        const elapsedSeconds = Math.floor((now - startTime) / 1000);
        
        // Calculate remaining time based on elapsed time
        remainingTime = Math.max(0, initialTime - elapsedSeconds);
    } else if (initialTimeFromBackend > 0) {
        // First time visit - store both the start time and initial time
        timerStartTime = Date.now();
        localStorage.setItem(timerKey, timerStartTime.toString());
        localStorage.setItem(initialTimeKey, initialTimeFromBackend.toString());
        remainingTime = initialTimeFromBackend;
    }
    
    if (remainingTime > 0) {
        // Clear any existing timer first to prevent multiple intervals
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
        
        // Start new timer interval
        timerInterval = setInterval(function() {
            remainingTime--;
            updateTimerDisplay();
            
            // Auto-submit when time is up
            if (remainingTime <= 0) {
                clearInterval(timerInterval);
                timerInterval = null;
                // Clear the timer storage when time is up
                localStorage.removeItem(timerKey);
                localStorage.removeItem(initialTimeKey);
                autoSubmitTest();
            }
            
            // Warning when 5 minutes left
            if (remainingTime === 300) { // 5 minutes
                showTimeWarning();
            }
        }, 1000);
    }
    
    updateTimerDisplay();
}


function updateTimerDisplay() {
    const hours = Math.floor(remainingTime / 3600);
    const minutes = Math.floor((remainingTime % 3600) / 60);
    const seconds = remainingTime % 60;
    
    const display = 
        String(hours).padStart(2, '0') + ':' + 
        String(minutes).padStart(2, '0') + ':' + 
        String(seconds).padStart(2, '0');
    
    const timerElement = document.getElementById('timer-display');
    const mobileTimerElement = document.getElementById('timer-display-mobile');
    
    if (timerElement) {
        timerElement.textContent = display;
        
        // Change color when time is running low
        if (remainingTime <= 300) { // 5 minutes
            timerElement.classList.add('text-red-200');
        }
    }
    
    if (mobileTimerElement) {
        mobileTimerElement.textContent = display;
        
        // Change color when time is running low
        if (remainingTime <= 300) { // 5 minutes
            mobileTimerElement.classList.add('text-red-600', 'dark:text-red-400');
            mobileTimerElement.classList.remove('text-red-700', 'dark:text-red-300');
        }
    }
}

function showTimeWarning() {
    if (confirm('Waktu ujian tinggal 5 menit! Pastikan semua jawaban telah tersimpan.')) {
        // User acknowledged the warning
    }
}

function autoSubmitTest() {
    alert('Waktu ujian telah habis! Ujian akan diselesaikan secara otomatis.');
    
    // Clear localStorage for this test including timer
    localStorage.removeItem('markedQuestions_' + storageKeyId);
    localStorage.removeItem('timer_' + storageKeyId);
    localStorage.removeItem('initial_time_' + storageKeyId);
    
    // Create and submit form (choose package or category submit url)
    const form = document.createElement('form');
    form.method = 'POST';
    {% if is_package %}
    form.action = '{% url "submit_package_test" package.id %}';
    {% else %}
    form.action = '{% url "submit_test" test.id %}';
    {% endif %}
    
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = csrfToken;
    form.appendChild(csrfInput);
    
    document.body.appendChild(form);
    form.submit();
}

// Submit test function
function submitTest() {
    // Clear localStorage when test is submitted manually including timer
    localStorage.removeItem('markedQuestions_' + storageKeyId);
    localStorage.removeItem('timer_' + storageKeyId);
    localStorage.removeItem('initial_time_' + storageKeyId);
    
    // Create and submit form (choose package or single test submission)
    const form = document.createElement('form');
    form.method = 'POST';
    {% if is_package %}
    form.action = '{% url "submit_package_test" package.id %}';
    {% else %}
    form.action = '{% url "submit_test" test.id %}';
    {% endif %}
    
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = csrfToken;
    form.appendChild(csrfInput);
    
    const actionInput = document.createElement('input');
    actionInput.type = 'hidden';
    actionInput.name = 'action';
    actionInput.value = 'submit';
    form.appendChild(actionInput);
    
    document.body.appendChild(form);
    form.submit();
}

// Prevent accidental page close/refresh
function confirmExit() {
    return 'Ujian sedang berlangsung. Jika Anda meninggalkan halaman, progress ujian akan tetap tersimpan tetapi timer akan terus berjalan. Apakah Anda yakin ingin keluar?';
}

// Fungsi toggle navigasi
function toggleNavigation() {
    const panel = document.getElementById('navigation-panel');
    const icon = document.getElementById('nav-toggle-icon');
    const text = document.getElementById('nav-toggle-text');

    if (!panel.classList.contains('collapsed')) {
        // collapse
        panel.classList.add('collapsed');
    // after collapsing the panel, show a down-arrow (indicates expandable)
    icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"></path>';
    text.textContent = 'Tampilkan';
    } else {
        // expand
        panel.classList.remove('collapsed');
    // after expanding the panel, show an up-arrow (indicates collapsible)
    icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7"></path>';
    text.textContent = 'Sembunyikan';
    }
}

// Fungsi menandai soal  
function markAsDoubtful() {
    const btn = event.target.closest('button');
    const bookmarkIcon = document.getElementById('bookmark-icon');
    const checkIcon = document.getElementById('check-icon');
    const markText = document.getElementById('mark-text');
    
    if (!markedQuestions.includes(currentQuestionNumber)) {
        // Tandai soal
        markedQuestions.push(currentQuestionNumber);
        
        // Update visual - show checkmark
        bookmarkIcon.style.display = 'none';
        checkIcon.style.display = 'block';
        markText.textContent = 'Sudah Ditandai';
        
        // Update button style
        btn.classList.add('bg-yellow-100', 'border-yellow-400');
        btn.classList.remove('bg-white', 'border-yellow-200');
    } else {
        // Hapus tanda
        markedQuestions = markedQuestions.filter(num => num !== currentQuestionNumber);
        
        // Update visual - show bookmark
        bookmarkIcon.style.display = 'block';
        checkIcon.style.display = 'none';
        markText.textContent = 'Tandai Soal';
        
        // Update button style
        btn.classList.remove('bg-yellow-100', 'border-yellow-400');
        btn.classList.add('bg-white', 'border-yellow-200');
    }
    
    // use unified storage key id
    localStorage.setItem('markedQuestions_' + storageKeyId, JSON.stringify(markedQuestions));
    updateNavigationColors();
}

// Save answer function
function saveAnswer() {
    const selectedAnswer = document.querySelector('input[name="choice"]:checked');
    if (!selectedAnswer) return;

    // Add current question to answeredQuestions if not already there (for real-time UI)
    if (!answeredQuestions.includes({{ current_question_number }})) {
        answeredQuestions.push({{ current_question_number }});
    }
    // Update progress bar & stats immediately for real-time feedback
    updateNavigationColors();
    updateStats();
    
    // Force button color update with current counts
    invalidateButtonCache(); // Clear cache to ensure fresh DOM queries
    updateSubmitButtonColor(answeredQuestions.length, {{ total_questions }});

    // Show saving indicator flyout (no layout shift)
    showSavingIndicator();

    // Send AJAX request to save answer
    const formData = new FormData();
    formData.append('choice', selectedAnswer.value);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

    fetch(window.location.href, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
    // Hide saving indicator flyout
    hideSavingIndicator();

        if (data.status === 'success') {
            showSaveConfirmation();
            // (No need to update UI again here, already done above)
        } else {
            showSaveError();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        // Hide saving indicator flyout
        hideSavingIndicator();
        showSaveError();
    });
}

// Save essay answer function
function saveEssayAnswer() {
    const textAnswer = document.getElementById('text_answer');
    if (!textAnswer) return;

    const answer = textAnswer.value.trim();
    
    // Add current question to answeredQuestions if not already there (for real-time UI)
    if (!answeredQuestions.includes({{ current_question_number }})) {
        answeredQuestions.push({{ current_question_number }});
    }
    // Update progress bar & stats immediately for real-time feedback
    updateNavigationColors();
    updateStats();

    // Show saving indicator flyout (no layout shift)
    showSavingIndicator();

    // Send AJAX request to save essay answer
    const formData = new FormData();
    formData.append('text_answer', answer);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

    fetch(window.location.href, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        // Hide saving indicator flyout
        hideSavingIndicator();

        if (data.status === 'success') {
            showSaveConfirmation();
            // (No need to update UI again here, already done above)
        } else {
            showSaveError();
        }
    })
    .catch(error => {
        console.error('Error saving essay answer:', error);
        // Hide saving indicator flyout
        hideSavingIndicator();
        showSaveError();
    });
}

// Fungsi update warna navigasi berdasarkan status backend dan localStorage
function updateNavigationColors() {
    const answeredQuestionsSet = new Set(answeredQuestions.map(id => parseInt(id)));
    
    document.querySelectorAll('.nav-button').forEach(button => {
        const questionIndex = parseInt(button.dataset.questionIndex);
        const currentIndex = {{ current_question_number }};
        
        // Reset semua kelas status
        button.classList.remove('marked', 'answered', 'unanswered', 'current');
        
        // Reset warna default
        button.classList.remove('bg-blue-500', 'border-blue-600', 'text-white',
                                'bg-green-500', 'border-green-600', 
                                'bg-yellow-500', 'border-yellow-600',
                                'bg-gray-200', 'border-gray-300', 'text-gray-700');
        
        // Tentukan status berdasarkan prioritas
        if (questionIndex === currentIndex) {
            // Soal sedang dikerjakan (prioritas tertinggi)
            button.classList.add('current', 'bg-blue-500', 'border-blue-600', 'text-white');
        } else if (markedQuestions.includes(questionIndex)) {
            // Soal ditandai (prioritas kedua)
            button.classList.add('marked', 'bg-yellow-500', 'border-yellow-600', 'text-white');
        } else if (answeredQuestionsSet.has(questionIndex)) {
            // Soal sudah dijawab (prioritas ketiga)
            button.classList.add('answered', 'bg-green-500', 'border-green-600', 'text-white');
        } else {
            // Soal belum dijawab (default)
            button.classList.add('unanswered', 'bg-gray-200', 'border-gray-300', 'text-gray-700');
        }
    });
    
    // Update statistik
    updateStats();
}

// Fungsi update statistik
function updateStats() {
    const totalQuestions = {{ total_questions }};

    // Use client-side answeredQuestions array as the source of truth for immediate UI updates
    const uniqueAnswered = new Set(answeredQuestions.map(id => Number(id)));
    const answeredCount = uniqueAnswered.size;

    // Count marked buttons from DOM (localStorage-backed)
    const markedButtons = document.querySelectorAll('.nav-button.marked');
    const markedCount = markedButtons.length;

    const remainingCount = Math.max(0, totalQuestions - answeredCount);

    // Update counters in the UI
    const answeredEl = document.getElementById('answered-count');
    const doubtfulEl = document.getElementById('doubtful-count');
    const remainingEl = document.getElementById('remaining-count');

    if (answeredEl) answeredEl.textContent = answeredCount;
    if (doubtfulEl) doubtfulEl.textContent = markedCount;
    if (remainingEl) remainingEl.textContent = remainingCount;

    // Update progress bar berdasarkan soal yang dijawab (client-side)
    updateProgressBar(answeredCount, totalQuestions);

    // Update submit button color based on completion status
    updateSubmitButtonColor(answeredCount, totalQuestions);
}

// Fungsi update warna tombol selesai ujian - optimized with caching
let cachedSubmitBtns = null;
let cachedNextBtns = null;
let lastButtonUpdate = 0;

function updateSubmitButtonColor(answeredCount, totalQuestions) {
    // Always refresh the button cache to ensure we have current elements
    cachedSubmitBtns = document.querySelectorAll('#submit-test-btn-primary, #submit-test-btn-secondary, button[onclick*="showSubmitConfirmation"]');
    
    cachedSubmitBtns.forEach(submitBtn => {
        if (!submitBtn || !submitBtn.parentNode) return; // Check if element is still in DOM
        
        // Remove all existing color classes that might conflict
        submitBtn.classList.remove(
            'bg-red-600', 'hover:bg-red-700', 'focus:ring-red-500',
            'bg-green-600', 'hover:bg-green-700', 'focus:ring-green-500',
            'text-white', 'bg-white', 'text-gray-500', 'bg-gray-200'
        );
        
        // Clear any existing inline styles first
        submitBtn.style.removeProperty('background-color');
        submitBtn.style.removeProperty('color');
        submitBtn.style.removeProperty('border-color');
        
        if (answeredCount === totalQuestions) {
            // All questions answered - Green button
            submitBtn.classList.add('text-white', 'hover:bg-green-700', 'focus:ring-green-500');
            // Force green background with !important
            submitBtn.style.setProperty('background-color', '#16a34a', 'important');
            submitBtn.style.setProperty('color', 'white', 'important');
            submitBtn.style.setProperty('border-color', '#15803d', 'important');
            submitBtn.title = 'Semua soal telah dijawab. Klik untuk menyelesaikan ujian.';
        } else {
            // Not all questions answered - Red button  
            submitBtn.classList.add('text-white', 'hover:bg-red-700', 'focus:ring-red-500');
            // Force red background with !important
            submitBtn.style.setProperty('background-color', '#dc2626', 'important');
            submitBtn.style.setProperty('color', 'white', 'important');
            submitBtn.style.setProperty('border-color', '#b91c1c', 'important');
            submitBtn.title = `${totalQuestions - answeredCount} soal belum dijawab. Pastikan semua soal telah dijawab sebelum menyelesaikan ujian.`;
        }
    });
    
    // Also ensure the Next button maintains its blue gradient
    if (!cachedNextBtns) {
        cachedNextBtns = document.querySelectorAll('button[name="action"][value="next"]');
    }
    
    cachedNextBtns.forEach(nextBtn => {
        if (!nextBtn || !nextBtn.parentNode) return; // Check if element is still in DOM
        
        // Remove any conflicting classes
        nextBtn.classList.remove('bg-white', 'text-gray-500', 'bg-gray-200');
        
        // Force blue gradient with !important
        nextBtn.style.setProperty('background', 'linear-gradient(to right, #2563eb, #1d4ed8)', 'important');
        nextBtn.style.setProperty('color', 'white', 'important');
        
        // Ensure the blue gradient classes are present
        nextBtn.classList.add('text-white');
    });
}

// Function to invalidate cached elements when DOM changes
function invalidateButtonCache() {
    cachedSubmitBtns = null;
    cachedNextBtns = null;
    lastButtonUpdate = 0; // Reset throttle timer to force immediate update
}

// Fungsi untuk menampilkan feedback visual bahwa jawaban tersimpan
function showSaveConfirmation() {
    // Reuse the saving-indicator flyout to show success state (prevents duplicate notifications)
    const el = document.getElementById('saving-indicator');
    if (!el) return;

    // Replace spinner content with success content
    el.innerHTML = `
        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path>
        </svg>
        <span>Jawaban tersimpan</span>
    `;

    // adjust classes to success look
    el.classList.remove('bg-indigo-50', 'dark:bg-indigo-900/30', 'text-indigo-600', 'dark:text-indigo-400', 'border-indigo-200', 'dark:border-indigo-700');
    el.classList.add('bg-green-500', 'text-white', 'border-green-600');

    // Ensure it's visible (slide in)
    if (savingHideTimer) {
        clearTimeout(savingHideTimer);
        savingHideTimer = null;
    }
    el.classList.remove('hidden');
    requestAnimationFrame(() => {
        el.classList.remove('translate-x-full', 'opacity-0');
        el.classList.add('translate-x-0', 'opacity-100');
    });

    // After short delay, hide again and restore original saving markup for next use
    // keep visible longer so user can notice the confirmation
    savingHideTimer = setTimeout(() => {
        el.classList.remove('translate-x-0', 'opacity-100');
        el.classList.add('translate-x-full', 'opacity-0');
        setTimeout(() => {
            // restore original saving content and classes
            el.innerHTML = `
                <svg class="animate-spin w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                <span>Menyimpan jawaban...</span>
            `;
            el.classList.remove('bg-green-500', 'text-white', 'border-green-600');
            el.classList.add('bg-indigo-50', 'dark:bg-indigo-900/30', 'text-indigo-600', 'dark:text-indigo-400', 'border-indigo-200', 'dark:border-indigo-700');
            el.classList.add('hidden');
            savingHideTimer = null;
        }, 220);
    }, 1500);
}

function showSaveError() {
    // Reuse saving-indicator flyout for error state
    const el = document.getElementById('saving-indicator');
    if (!el) return;

    el.innerHTML = `
        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
        <span>Gagal menyimpan jawaban</span>
    `;

    el.classList.remove('bg-indigo-50', 'dark:bg-indigo-900/30', 'text-indigo-600', 'dark:text-indigo-400', 'border-indigo-200', 'dark:border-indigo-700');
    el.classList.add('bg-red-500', 'text-white', 'border-red-600');

    if (savingHideTimer) {
        clearTimeout(savingHideTimer);
        savingHideTimer = null;
    }
    el.classList.remove('hidden');
    requestAnimationFrame(() => {
        el.classList.remove('translate-x-full', 'opacity-0');
        el.classList.add('translate-x-0', 'opacity-100');
    });

    // show error longer so user sees it
    savingHideTimer = setTimeout(() => {
        el.classList.remove('translate-x-0', 'opacity-100');
        el.classList.add('translate-x-full', 'opacity-0');
        setTimeout(() => {
            // restore original saving content and classes
            el.innerHTML = `
                <svg class="animate-spin w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                <span>Menyimpan jawaban...</span>
            `;
            el.classList.remove('bg-red-500', 'text-white', 'border-red-600');
            el.classList.add('bg-indigo-50', 'dark:bg-indigo-900/30', 'text-indigo-600', 'dark:text-indigo-400', 'border-indigo-200', 'dark:border-indigo-700');
            el.classList.add('hidden');
            savingHideTimer = null;
        }, 220);
    }, 1750);
}

// Fungsi update progress bar
function updateProgressBar(answeredCount, totalQuestions) {
    const percentage = Math.round((answeredCount / totalQuestions) * 100);
    const progressBar = document.getElementById('progress-bar');
    const progressPercentage = document.getElementById('progress-percentage');
    
    if (progressBar && progressPercentage) {
        progressBar.style.width = percentage + '%';
        progressPercentage.textContent = percentage + '%';
    }
}

// Show/hide saving indicator (flyout) without causing layout shifts
function showSavingIndicator() {
    const el = document.getElementById('saving-indicator');
    if (!el) return;
    el.classList.remove('hidden');
    // trigger transition to slide in
    requestAnimationFrame(() => {
        el.classList.remove('translate-x-full', 'opacity-0');
        el.classList.add('translate-x-0', 'opacity-100');
    });
}

function hideSavingIndicator() {
    const el = document.getElementById('saving-indicator');
    if (!el) return;
    // slide out, then hide after transition
    el.classList.remove('translate-x-0', 'opacity-100');
    el.classList.add('translate-x-full', 'opacity-0');
    if (savingHideTimer) {
        clearTimeout(savingHideTimer);
        savingHideTimer = null;
    }
    savingHideTimer = setTimeout(() => {
        el.classList.add('hidden');
        savingHideTimer = null;
    }, 220);
}

// Comprehensive cleanup function for blue elements
function cleanupBlueElements() {
    // Remove blue styling from all math formula elements
    const mathSelectors = [
        '.math-formula',
        '.latex-formula',
        'span[data-latex]',
        'span[class*="math"]',
        'span[class*="formula"]',
        '.ckeditor-content span'
    ];
    
    mathSelectors.forEach(selector => {
        const elements = document.querySelectorAll(selector);
        elements.forEach(el => {
            // Remove blue classes
            const blueClasses = ['bg-blue-500', 'bg-blue-400', 'bg-blue-300', 'bg-indigo-50', 'border-blue-600', 'border-indigo-200'];
            blueClasses.forEach(cls => el.classList.remove(cls));
            
            // Remove blue inline styles
            if (el.style.backgroundColor && (
                el.style.backgroundColor.includes('blue') || 
                el.style.backgroundColor.includes('rgb(59, 130, 246)') ||
                el.style.backgroundColor.includes('rgb(239, 246, 255)') ||
                el.style.backgroundColor.includes('#eff6ff') ||
                el.style.backgroundColor.includes('#3b82f6')
            )) {
                el.style.backgroundColor = 'transparent';
            }
            
            if (el.style.borderColor && (
                el.style.borderColor.includes('blue') ||
                el.style.borderColor.includes('rgb(59, 130, 246)')
            )) {
                el.style.borderColor = 'transparent';
                el.style.border = 'none';
            }
            
            // Remove other styling that might cause visual issues
            if (!el.classList.contains('nav-button') && 
                !el.classList.contains('bg-blue-500') && 
                !el.closest('button')) {
                el.style.boxShadow = 'none';
                el.style.padding = '0';
                el.style.margin = '0 1px';
            }
        });
    });
    
    // Blue element cleanup completed
}

// Main initialization moved to consolidated DOMContentLoaded above
    
    // Ensure saving indicator is properly hidden on page load
    const savingIndicator = document.getElementById('saving-indicator');
    if (savingIndicator) {
        savingIndicator.classList.add('hidden', 'translate-x-full', 'opacity-0');
        savingIndicator.classList.remove('translate-x-0', 'opacity-100');
        savingIndicator.style.display = 'none';
        savingIndicator.style.visibility = 'hidden';
    }
    
    // Ensure submit modal is properly hidden
    const submitModal = document.getElementById('submit-modal');
    if (submitModal) {
        submitModal.classList.add('hidden');
        // Avoid forcing style.display here; class toggles handle visibility
    }
    
    // Remove any stray blue boxes or unwanted elements
    setTimeout(() => {
        // Check for any elements that might be causing blue box appearance (but exclude buttons)
        const unwantedElements = document.querySelectorAll('[style*="background-color: blue"], [style*="background: blue"], .bg-blue-400, .bg-blue-300');
        unwantedElements.forEach(el => {
            if (!el.classList.contains('nav-button') && 
                !el.classList.contains('bg-blue-500') && 
                !el.id?.includes('submit') && 
                !el.getAttribute('onclick')?.includes('showSubmitConfirmation') &&
                el.getAttribute('name') !== 'action') {
                el.style.background = 'transparent';
                el.style.border = 'none';
                el.style.boxShadow = 'none';
            }
        });
        
        // Clean up any math formula elements with blue styling in question content
        const mathElements = document.querySelectorAll('.ckeditor-content .math-formula, .ckeditor-content .latex-formula, .ckeditor-content span[data-latex]');
        mathElements.forEach(el => {
            el.style.background = 'transparent';
            el.style.backgroundColor = 'transparent';
            el.style.border = 'none';
            el.style.borderColor = 'transparent';
            el.style.boxShadow = 'none';
            el.style.padding = '0';
            el.style.margin = '0';
            el.classList.remove('bg-blue-500', 'border-blue-600', 'bg-indigo-50', 'border-indigo-200');
        });
        
        // Remove blue styling from any spans in question content
        const questionSpans = document.querySelectorAll('.ckeditor-content span');
        questionSpans.forEach(span => {
            if (span.style.backgroundColor && (span.style.backgroundColor.includes('blue') || span.style.backgroundColor.includes('rgb(59, 130, 246)'))) {
                span.style.backgroundColor = 'transparent';
                span.style.borderColor = 'transparent';
                span.style.border = 'none';
            }
        });
    }, 100);
    
    // Set up page exit confirmation and cleanup
    window.addEventListener('beforeunload', function(e) {
        // Clean up intervals to prevent memory leaks
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
        
        // Call the original confirmExit function
        return confirmExit(e);
    });
    
    // Inisialisasi progress bar berdasarkan soal yang sudah dijawab
    const currentAnsweredQuestions = document.querySelectorAll('input[name="choice"]:checked');
    updateProgressBar(currentAnsweredQuestions.length, {{ total_questions }});
    
    // Handle image loading in CKEditor content
    function handleImageLoading() {
        const images = document.querySelectorAll('.ckeditor-content img');
        images.forEach(img => {
            img.addEventListener('load', function() {
                this.classList.remove('loading', 'error');
            });
            
            img.addEventListener('error', function() {
                console.warn('Failed to load image:', this.src);
            });
            
            // Add loading class initially
            if (!img.complete) {
                img.classList.add('loading');
            }
        });
    }
    
    // Initialize image loading handlers
    handleImageLoading();
    
    // Update mark button state based on localStorage
    updateMarkButtonState();
    
    // Update navigation colors
    updateNavigationColors();
    
    // Additional cleanup for blue elements after everything is loaded
    setTimeout(() => {
        cleanupBlueElements();
        
        // Set up lightweight mutation observer - only for critical changes
        let observerTimeout;
        const observer = new MutationObserver((mutations) => {
            // Debounce the observer to prevent excessive calls
            if (observerTimeout) {
                clearTimeout(observerTimeout);
            }
            
            observerTimeout = setTimeout(() => {
                let needsUpdate = false;
                
                mutations.forEach((mutation) => {
                    // Only check for specific types of changes that actually matter
                    if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                        mutation.addedNodes.forEach((node) => {
                            if (node.nodeType === 1 && 
                                (node.classList?.contains('math-formula') || 
                                 node.classList?.contains('latex-formula') ||
                                 node.getAttribute?.('data-latex') ||
                                 node.style?.backgroundColor?.includes('blue'))) {
                                needsUpdate = true;
                            }
                        });
                    }
                });
                
                // Only update if we actually found problematic elements
                if (needsUpdate) {
                    cleanupBlueElements();
                    updateSubmitButtonColor(answeredQuestions.length, {{ total_questions }});
                }
            }, 250); // Debounce for 250ms to prevent spam
        });
        
        // Start observing - but only specific attributes to reduce load
        observer.observe(document.body, {
            childList: true,
            subtree: true,
            attributes: false // Disable attribute watching to reduce load
        });
    }, 500);

    // Subtest filtering: if package_subtests present, wire the select to filter nav
    const subtestSelect = document.getElementById('subtest-select');
    if (subtestSelect) {
        function applySubtestFilter() {
            try {
                const val = subtestSelect.value;
                if (val === 'all') {
                    document.querySelectorAll('.nav-button').forEach(b => { b.style.removeProperty('display'); b.removeAttribute('aria-hidden'); });
                } else {
                    const [startStr, endStr] = val.split('-');
                    const start = parseInt(startStr, 10);
                    const end = parseInt(endStr, 10);
                    document.querySelectorAll('.nav-button').forEach(b => {
                        const idx = parseInt(b.dataset.questionIndex, 10);
                        const match = (idx >= start && idx <= end);
                        if (match) { b.style.removeProperty('display'); b.removeAttribute('aria-hidden'); } else { b.style.setProperty('display','none','important'); b.setAttribute('aria-hidden','true'); }
                    });
                }
            } catch (err) {
                console.error('applySubtestFilter error', err);
            }
        }
        subtestSelect.addEventListener('change', applySubtestFilter);
        // apply initial filter on load
        applySubtestFilter();
    } else {
        // no subtest-select present
    }

    // Intercept Next navigation to warn when crossing subtest boundary
    const answerForm = document.getElementById('answer-form');
    const nextButton = answerForm.querySelector('button[name="action"][value="next"]');
    // Build mapping from question index to subtest range from server-provided package_subtests
    let subtestRanges = [];
    {% if is_package and package_subtests %}
    subtestRanges = [
        {% for s in package_subtests %}{ start: {{ s.start }}, end: {{ s.start|add:s.count|add:'-1' }}, name: '{{ s.category_name|escapejs }}' }{% if not forloop.last %},{% endif %}{% endfor %}
    ];
    {% endif %}

    function findSubtestForIndex(idx){
        for (const r of subtestRanges) if (idx >= r.start && idx <= r.end) return r;
        return null;
    }

    if (nextButton) {
        nextButton.addEventListener('click', function(e){
            // determine target index
            const target = {{ current_question_number }} + 1;
            const currentSub = findSubtestForIndex({{ current_question_number }});
            const targetSub = findSubtestForIndex(target);
            if (currentSub && targetSub && currentSub.name !== targetSub.name) {
                // show modal asking to continue to next subtest
                e.preventDefault();
                showNextSubtestModal(currentSub.name, targetSub.name, function(){
                    // when confirmed, add hidden flags and submit the form programmatically
                    let existingConfirm = answerForm.querySelector('input[name="confirm_next_subtest"]');
                    if (!existingConfirm) {
                        existingConfirm = document.createElement('input');
                        existingConfirm.type = 'hidden'; existingConfirm.name = 'confirm_next_subtest'; existingConfirm.value = '1';
                        answerForm.appendChild(existingConfirm);
                    } else {
                        existingConfirm.value = '1';
                    }

                    // Ensure action='next' is present (programmatic submit doesn't include clicked button value)
                    let actionHidden = answerForm.querySelector('input[name="action"]');
                    if (!actionHidden) {
                        actionHidden = document.createElement('input');
                        actionHidden.type = 'hidden'; actionHidden.name = 'action'; actionHidden.value = 'next';
                        answerForm.appendChild(actionHidden);
                    } else {
                        actionHidden.value = 'next';
                    }

                    answerForm.submit();
                });
            }
            // otherwise allow normal submit
        });
    }

    // Modal for confirming moving to next subtest
    function showNextSubtestModal(fromName, toName, onConfirm){
        const modal = document.getElementById('next-subtest-modal');
        if (!modal) {
            if (onConfirm) onConfirm();
            return;
        }

        const modalCard = modal.querySelector('.rounded-2xl');
        const confirmBtn = modal.querySelector('[data-modal-confirm]');
        const dismissBtns = modal.querySelectorAll('[data-modal-dismiss]');
        const backdrop = modal.querySelector('[data-backdrop]');

        modal.querySelector('#next-subtest-from').textContent = fromName;
        modal.querySelector('#next-subtest-to').textContent = toName;

        modal.classList.remove('hidden');
        modal.classList.add('flex');
        requestAnimationFrame(() => {
            modalCard?.classList.add('animate-fade-in');
        });

        const closeModal = (callback) => {
            modalCard?.classList.remove('animate-fade-in');
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                if (callback) callback();
            }, 180);
        };

        const handleConfirm = () => closeModal(onConfirm);
        const handleDismiss = () => closeModal();

        confirmBtn?.addEventListener('click', handleConfirm, { once: true });
        dismissBtns.forEach(btn => btn.addEventListener('click', handleDismiss, { once: true }));
        backdrop?.addEventListener('click', handleDismiss, { once: true });

        confirmBtn?.focus();
    }
 // End of DOMContentLoaded listener
</script>

{% endblock %}
